# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2019-10-08 09:30
from __future__ import unicode_literals

from django.db import migrations
from django.contrib.auth.models import User

from juloserver.julo.models import Agent
from juloserver.minisquad.models import CollectionSquad
from juloserver.portal.object.dashboard.constants import JuloUserRoles


def insert_user_to_agent_table(apps, schema_editor):
    roles = [
        JuloUserRoles.COLLECTION_BUCKET_1,
        JuloUserRoles.COLLECTION_BUCKET_2,
        JuloUserRoles.COLLECTION_BUCKET_3,
        JuloUserRoles.COLLECTION_BUCKET_4,
        JuloUserRoles.COLLECTION_BUCKET_5,
    ]
    users = User.objects.filter(groups__name__in=roles, is_active=True)

    for user in users:
        agent = Agent.objects.filter(user=user)

        if not agent:
            Agent.objects.create(user_extension=user.username,
                                 user=user)


def update_squad_in_agent_data(apps, schema_editor):
    bucket_2_squad_1 = CollectionSquad.objects.get(squad_name='B2.S1')
    bucket_2_squad_2 = CollectionSquad.objects.get(squad_name='B2.S2')
    bucket_3_squad_1 = CollectionSquad.objects.get(squad_name='B3.S1')
    bucket_3_squad_2 = CollectionSquad.objects.get(squad_name='B3.S2')
    bucket_3_squad_3 = CollectionSquad.objects.get(squad_name='B3.S3')
    bucket_4_squad_1 = CollectionSquad.objects.get(squad_name='B4.S1')

    squad_ids = [
        bucket_2_squad_1.id, bucket_2_squad_2.id,
        bucket_3_squad_1.id, bucket_3_squad_2.id,
        bucket_3_squad_3.id, bucket_4_squad_1.id]
    collection_squad_agent_dict = {
        bucket_2_squad_1.id: ['rifani', 'ronaldo', 'alya', 'ulfa'],
        bucket_2_squad_2.id: ['andre', 'akhda', 'maul'],
        bucket_3_squad_1.id: ['rahayu', 'fajar.akbar', 'rofikoh', 'kanty'],
        bucket_3_squad_2.id: ['nungki' 'ardhea', 'fajarudin'],
        bucket_3_squad_3.id: ['diah', 'witri', 'mulyadi', 'shifa'],
        bucket_4_squad_1.id: ['bunga', 'vita', 'willi', 'fajar04']
    }

    for squad_id in squad_ids:
        for agent_username in collection_squad_agent_dict[squad_id]:
            agent = Agent.objects.filter(user__username=agent_username).last()
            if agent:
                agent.update_safely(squad_id=squad_id)


class Migration(migrations.Migration):

    dependencies = [
        ('minisquad', '0006_add_collection_squad_data'),
    ]

    operations = [
        migrations.RunPython(insert_user_to_agent_table),
        migrations.RunPython(update_squad_in_agent_data)
    ]
