{% extends "common/theme1/list/list_footable_theme1.html" %}
{% load template %}
{% load currency %}
{% load format_date %}

{% load model %}

{% load static from staticfiles %}

{% block breadcrumb_title %}{% endblock %}
{% block breadcrumb_path %}
{% endblock %}
{% block custom_css %}
    <style type="text/css">
        .flex {
            display: flex;
            margin-bottom: 10px;
        }

        .mb10 {
            margin-bottom: 10px;
        }

        .ml5 {
            margin-left: 5px;
        }

        .w100 {
            width: 100px;
        }
        .w170 {
            width: 170px;
        }
        .w15{
            width: 20px;
        }
        .w200 {
            width: 200px;
        }
        .grid {
            display: grid;
        }

        textarea {
            resize: vertical;
        }

        .lb-result {
            font-size: larger;
        }

        .center {
            align-items: center;
        }

        .no-border {
            border-top: 0;
            border-right: 0;
            border-left: 0;
            -webkit-box-shadow: none;
            box-shadow: none;
            font-weight:bold;
            color: #67717F;
        }
        .dot-false {
          height: 15px;
          width: 15px;
          background-color: #bbb;
          border-radius: 50%;
          display: inline-block;
        }
        .dot-true {
          height: 15px;
          width: 15px;
          background-color: #5AD3A6;
          border-radius: 50%;
          display: inline-block;
        }
        .txt-align {
            padding: 10px;
        }
        .txt-blue {
            color: blue;
        }
        .error-msg {
            border: 1px solid red;
        }
        .container {
            width : 90% !important;
        }
        .border-grey {
            border-right: 10px solid #cccccc
        }
        .border-blue {
            border: 5px solid #33C4FF;
        }
        .left-div-bg {
            height: 40px !important;
            background-color: #cccccc !important;
            font-size: 14px !important;
            padding: 10px !important;
            font-weight: bold !important;
            line-height: 16px !important;
            font-color: #000000 !important;
        }
        .text-left {
            font-size: 12px !important;;
            font-weight: bold !important;
            padding-left: 15px !important;
            padding-top: 5px !important;
            padding-bottom: 5px !important;
            font-color: #000000 !important;
            line-height: 14px !important;
        }
        .text-right {
            font-size: 12px;
            padding-left: 15px !important;
            text-align: left;
            font-color: #000000 !important;
            line-height: 14px !important;
            padding-top: 5px !important;
            padding-bottom: 5px !important;
        }
        .box-padding {
            padding-bottom: 30px;
        }
        .box-row-ht {
            height: 25px !important;
        }
        .small-text {
            font-size: 8px !important;;
        }
        .right-div-bg-top, .right-div-bg-bottom{
            height: 40px !important;
            background-color: #AB8CE4 !important;
            font-size: 14px !important;
            padding: 10px !important;
            font-weight: bold !important;
            line-height: 16px !important;
            color: white !important;
            text-align: center;
        }
        .right-div-bg-bottom {
            background-color: #AB8BE4 !important;
            font-color: white !important;
        }
        .align-middle {
            text-align: center !important;
        }
        .align-left {
            text-align: left !important;
        }
        .align-right {
            text-align: right !important;
            padding-right: 10px !important;
        }
        .align-right_txt {
            text-align: right !important;
            padding-right: 2% !important;
        }
        .loading-div, .loading-div_simulasi {
            background: gray none repeat scroll 0 0;
            display: inline;
            height: 500px;
            left: 0;
            opacity: 0.20;
            position: absolute;
            width: 100%;
            z-index: 999;
        }
        #loading-div > img, #loading-div_simulasi > img{
            left: 30%;
            position: absolute;
            top: 50px;
        }

        .existing_offer_modal{
            width: 90%!important;
        }
        .btn-circle-portal {
            background-color: #AB8CE4;
            border: none;
            color: white;
            padding: 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 33px 2px;
            border-radius: 8px;
            width: 35%;
        }
        .multiple-ptp-payment-table tbody tr td, .multiple-ptp-payment-table tfoot tr td {
            padding: 8px 40px;
        }
        .edit-link {
            display: inline-block;
            color: #337ab7;
            font-weight: bold;
            text-decoration: underline;
            cursor: pointer;
        }
        .multiple-ptp-payment-message {
            display: inline-block;
            color: #E2574C;
            font-weight: bold;
            margin-left: 20px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
{% endblock %}

{% block list_title %}
    <div style="border-bottom: 1px solid;">
        <h3 class="box-title m-b-0">Collection Offer Recommendations</h3>
    </div>

{% endblock %}
{% block list_subtitle %}{% endblock %}


{% block content-list %}
    <div class="loading-div" style="display:none;padding-left:30px;min-height:800px;" id="loading-div" ><img src="{% static 'images/collections/ajax-loader.gif' %}" ></div>
    <div class="row">
        <div class="col-md-4">
            <form method="get" id="frm_search_loan">
                <div class="center flex">
                    <label class="w100">Loan ID:</label>
                    <div style="width: 200px;">
                        <input type="text" class="form-control" name="loan_id" id="loan_id"
                               value="{{ loan_id }}" maxlength="15"
                               onkeyup="if (/\D/g.test(this.value)) this.value = this.value.replace(/\D/g,'')">
                    </div>
                    <div style="width: 200px;">
                        &nbsp;&nbsp;<button type="button" class="btn btn-primary" id="btn_search_loan">Submit</button>
                    </div>
                </div>
            </form>
        </div>
        {% if show == True %}
        <div class="col-md-5 refinancing_status_layout">
            <table style="margin-bottom: 1%;">
                <tr>
                    <td><label id="refinancing_status">Status: {{ current_loan_refinancing_status }}</label></td>
                    {% if offer_selected_label != '-' %}
                    <td><label>Offer: {{ offer_selected_label }}</label></td>
                    {% endif %}
                </tr>
                <tr>
                    <td colspan="2" id="tips">
                        {{ tips }}
                    </td>
                </tr>
            </table>
        </div>
        <div class="col-md-3 align-right refinancing_status_layout">
            <button type="button" class="btn btn-primary" id="btn_offer_history">Offer History</button>
        </div>
        {% endif %}
    </div>
    {% if show == False and loan_id_list %}
        <div class="row" style="height: 400px;overflow-y: auto;overflow-x: hidden">
            <div id="jstree" class="col-md-6">

        <!-- in this example the tree is populated from inline HTML -->
            {% for bucket, loan_ids in loan_id_list.items %}
                <ul>
                  <li id="{{bucket}}" data-jstree='{"icon":"glyphicon {% if loan_ids %} glyphicon-plus-sign {% else %} glyphicon-remove {% endif %}"}'>{{bucket | waiver_bucket_name}}
                    <ul>
                        {% for loan_id in loan_ids %}
                            <li data-jstree='{"icon":"glyphicon glyphicon-triangle-right"}' onclick="directLink({{ loan_id }})">Loan ID - {{ loan_id }}</li>
                        {% endfor %}
                    </ul>
                  </li>
                </ul>
            {% endfor %}
          </div>
        </div>
    {% endif %}

     <div class="row" id="contain_div" {% if show == False%} style="display: none;min-height:800px;"{% else %} style="min-height:800px;" {%endif %}>
        <div class="col-md-3 border-grey">
            <div id="div_loan_info" class="row">
                <div class="col-md-12">
                    <div class="row left-div-bg">
                        <div class="col-md-12">
                            Loan Info
                        </div>
                    </div>
                    <div class="row">
                         <div class="col-md-12 text-right">
                            <div class="center flex">
                                <label class="w170">Nama Customer:</label>
                                <label class="w20">&nbsp;&nbsp;&nbsp;</label>
                                <label class="w170">{{ customer_name }}</label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                         <div class="col-md-12 text-right">
                            <div class="center flex">
                                <label class="w170">Email:</label>
                                <label class="w20">&nbsp;&nbsp;&nbsp;</label>
                                <label class="w200" id="customer_email" style="word-wrap: break-word;">
                                    {{ email_address }}
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row" id="is_covid_risky_div" style="display:none;">
                         <div class="col-md-12 text-right">
                            <div class="center flex">
                                <label class="w170">COVID-19 Risky Customer?:</label>
                                <label class="w20">&nbsp;&nbsp;&nbsp;</label>
                                <label class="w200" id="is_covid_risky">
                                    {{ is_covid_risky }}
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 box-padding">
                            &nbsp;
                        </div>
                    </div>
                </div>
            </div>
            <div id="div_interview" class="row">
                <div class="col-md-12">
                    <div class="row left-div-bg">
                        <div class="col-md-12">
                            Pertanyaan Interview
                        </div>
                    </div>
                    <div class="row">
                         <div class="col-md-12 text-right">
                            <div class="center flex">
                                <label class="w170">Status Pekerjaan Baru:</label>
                                <label class="w20">&nbsp;&nbsp;&nbsp;</label>
                                <div>
                                    <select class="form-control" id="employment_status">
                                        <option value=""></option>
                                        {% for reason in reasons %}
                                            <option value="{{reason}}" {% if new_employment_status == reason %} selected{% endif %}>{{reason}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                         <div class="col-md-12 text-right">
                            <div class="center flex">
                                <label class="w170">Pendapatan Baru:</label>
                                <label class="w20">&nbsp;&nbsp;&nbsp;</label>
                                <div class="input-group m-t-10" style="width: 210px;">
                                    <span class="input-group-addon">Rp.</span>
                                    <input class="form-control mask" id="new_income" maxlength="15" type="text" value="{{ new_income }}">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                         <div class="col-md-12 text-right">
                            <div class="center flex">
                                <label class="w170">Pengeluaran Baru:</label>
                                 <label class="w20">&nbsp;&nbsp;&nbsp;</label>
                                 <div class="input-group m-t-10" style="width: 210px;">
                                    <span class="input-group-addon">Rp.</span>
                                    <input class="form-control mask" id="new_expense" maxlength="15" type="text" value="{{ new_expense }}">
                                 </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="center flex" style="float:right; padding-top:15px;">
                                <div style="width: 223px;">
                                    <button type="button" class="btn btn-primary" id="generate_offer">Generate Offer</button>&nbsp;
                                </div>

                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <div id="div_offer_recommend" class="row" style="display:none;">
                <div class="col-md-12">
                    <div class="row left-div-bg">
                        <div class="col-md-12">
                            Rekomendasi Offer
                        </div>
                    </div>
                    <div class="row" id="offer_product_div">
                        <div class="col-md-12 text-left">
                            {% csrf_token %}
                            <table width="100%">
                                <tr>
                                    <td width="40%" valign="top" style="font-weight:normal;padding-top:5px;">
                                        Rekomendasi Offer (s):
                                    </td>
                                     <td width="60%" valign="top" id="tab_priority_product">
                                    </td>
                                </tr>
                            </table>
                        </div>

                    </div>
                    <div class="row" id="tenure_extension_div">
                        <div class="col-md-12 text-right">
                            <div class="center flex">
                                <label class="w170" style="font-weight:normal !important;">Dibutuhkan untuk:</label>
                                <div style="width: 100px;">
                                    <input type="text" class="form-control" maxlength="1"
                                           id="tenure_extension" name="tenure_extension"
                                    onkeyup="if (/\D/g.test(this.value)) this.value = this.value.replace(/\D/g,'')">
                                </div>
                                <label class="w100" style="font-weight:normal !important">&nbsp;bulan</label>
                                <p></p>
                            </div>
                        </div>
                    </div>
                    <div class="row" id="recommendation_offer_extension" style="display: none">
                        <div class="col-md-12 text-right">
                            <div class="center flex">
                                    <p style="margin-left: 30%"></p>
                            </div>
                        </div>
                    </div>
                    <div class="row" id="waiver_validity_date_div"  style="display:none">
                         <div class="col-md-12 text-right">
                            <div class="center flex">
                                <label class="w170">Waiver Validity Date:</label>
                                <div>
                                    <input class="form-control datepicker"
                                       id="waiver_validity_date" maxlength="None"
                                       name="waiver_validity_date" placeholder="dd M yyyy"
                                       type="text" value=""><input type="hidden" id="waiver_validity_date_db" value="" name="waiver_validity_date_db">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                         <div class="col-md-12 text-right">
                            <div class="center flex">
                                <label class="w170">Pilihan Offer Lainnya:</label>
                                <div>
                                    <select class="form-control" id="pilihan_offer">

                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="center flex" style="float:right; padding-top:15px;">
                                <div style="width: 100px;padding-bottom:160px;">
                                    <button type="button" class="btn btn-primary" id="submit_product">Simulasi</button>&nbsp;
                                </div>

                            </div>
                        </div>
                    </div>
                 </div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="row right-div-bg-top">
                <div class="col-md-12">
                    Pinjaman yang sedang berjalan
                    <span class="glyphicon glyphicon-forward original_amount_table-forward" aria-hidden="true" style="float: right" onclick="expandTable('original_amount_table')"></span>
                    <span class="glyphicon glyphicon-backward original_amount_table-backward" aria-hidden="true" style="float: right; display: none;" onclick="expandTable('original_amount_table')"></span>
                </div>
            </div>
            <div class="row" id="ongoing_loan_table" style="width: 100%;display: flex;overflow-x: auto; overflow-y: hidden">
            {% if ongoing_loan_data %}
            <div style="width: 100%;">
                <table class="table table-bordered">
                    <thead>
                        <tr style="height: 77px">
                            <th class="align-middle"> Payment# </th>
                            <th class="align-middle"> Telah jatuh tempo? </th>
                            <th class="align-middle"> Tgl jatuh tempo </th>
                            <th class="align-middle"> Status </th>
                            <th class="align-middle"> Total Angsuran </th>
                            <th class="align-middle"> Sisa Principal </th>
                            <th class="align-middle"> Sisa Interest </th>
                            <th class="align-middle"> Sisa Late Fee </th>
                            <th class="align-middle"> Sisa Angsuran </th>
                            <th class="align-middle"> Terbayar </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ongoing_loan_data_payment in ongoing_loan_data %}
                          <tr style="height: 78px;{% if ongoing_loan_data_payment.outstanding == 0 %} background:#DCDCDC;{% endif %}">
                            <td class="align-middle">{{ ongoing_loan_data_payment.payment_number }}</td>
                            <td class="align-middle">{{ ongoing_loan_data_payment.due_status }}</td>
                            <td class="align-middle">{{ ongoing_loan_data_payment.due_date  | format_date_to_locale_format }}</td>
                            <td class="align-middle">{{ ongoing_loan_data_payment.paid_status }}</td>
                            <td class="align-middle">{{ ongoing_loan_data_payment.total_installment | add_rupiah_separator }}</td>
                            <td class="align-middle">{{ ongoing_loan_data_payment.remaining_principal | add_rupiah_separator }}</td>
                            <td class="align-middle">{{ ongoing_loan_data_payment.remaining_interest | add_rupiah_separator }}</td>
                            <td class="align-middle">
                                {% if ongoing_loan_data_payment.remaining_late_fee > 0 %}
                                    {{ ongoing_loan_data_payment.remaining_late_fee | add_rupiah_separator }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="align-middle">{{ ongoing_loan_data_payment.outstanding | add_rupiah_separator }}</td>
                             <td class="align-middle">
                                {% if ongoing_loan_data_payment.paid_amount > 0 %}
                                    {{ ongoing_loan_data_payment.paid_amount | add_rupiah_separator }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td class="align-middle"></td>
                            <td class="align-middle"></td>
                            <td class="align-middle"></td>
                            <td class="align-middle"></td>
                            <td class="align-middle">
                                <b>{{ total_installment_amount_loan | add_rupiah_separator }}</b>
                            </td>
                            <td class="align-middle"><b>{{ total_remaining_principal | add_rupiah_separator }}</b></td>
                            <td class="align-middle"><b>{{ total_remaining_interest | add_rupiah_separator }}</b></td>
                            <td class="align-middle"><b>{{ total_remaining_late_fee | add_rupiah_separator }}</b></td>
                            <td class="align-middle" id="pay_net_due" net_due_amt="{{ total_installment_outstanding_loan }}">
                                <b>{{ total_installment_outstanding_loan | add_rupiah_separator }}</b>
                            </td>
                            <td class="align-middle"><b>{{ total_installment_paid_loan | add_rupiah_separator }}</b></td>

                        </tr>
                    </tfoot>

                </table>
            </div>
            <div>
                <table class="table table-bordered" id="original_amount_table" style="display: none">
                    <thead>
                        <tr style="height: 77px">
                            <th class="align-middle"> Original Principal </th>
                            <th class="align-middle"> Original Interest </th>
                            <th class="align-middle"> Original Late Fee </th>
                            <th class="align-middle"> Tanggal Bayar </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ongoing_loan_data_payment in ongoing_loan_data %}
                          <tr style="height: 78px;{% if ongoing_loan_data_payment.outstanding == 0 %} background:#DCDCDC"{% endif %}">
                            <td class="align-middle">{{ ongoing_loan_data_payment.remaining_principal | add_rupiah_separator }}</td>
                            <td class="align-middle">{{ ongoing_loan_data_payment.remaining_interest | add_rupiah_separator }}</td>
                            <td class="align-middle">
                                {% if ongoing_loan_data_payment.remaining_late_fee > 0 %}
                                    {{ ongoing_loan_data_payment.remaining_late_fee | add_rupiah_separator }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="align-middle">
                                {% if ongoing_loan_data_payment.paid_date %}
                                    {{ ongoing_loan_data_payment.paid_date  | format_date_to_locale_format }}
                                {% else %}
                                     -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td class="align-middle"><b>{{ total_principal_loan | add_rupiah_separator }}</b></td>
                            <td class="align-middle"><b>{{ total_interest_loan | add_rupiah_separator }}</b></td>
                            <td class="align-middle"><b>{{ total_late_fee_loan | add_rupiah_separator }}</b></td>
                        </tr>
                    </tfoot>

                </table>
            </div>
            {% else %}
                <div class="col-md-12" style="text-align:center; padding-top:10px;">
                    No data found...
                </div>
            {% endif %}
            </div>
            <div class="loading-div_simulasi" style="display:none" id="loading-div_simulasi" style="padding-left:30px;"><img src="{% static 'images/collections/ajax-loader.gif' %}" ></div>
            <div class="row">
                <div class="col-md-12 box-padding">
                    &nbsp;
                </div>
            </div>
            <div class="row right-div-bg-bottom" id="div_simulasi_head" style="display:none;">
                <div class="col-md-12" id="div_header_txt">
                </div>
            </div>
            <div class="row" id="div_simulasi_details" style="display:none;">
            </div>
            <div class="row">
                <div class="col-md-12 box-padding">
                    &nbsp;
                </div>
            </div>

            <div class="row right-div-bg-bottom" style="display: none;" id="cp_head">
                <div class="col-md-12">
                    Submit Refinancing untuk {{ customer_name }} dengan detail sebagai berikut:
                </div>
            </div>
            <div class="row" style="display: none;" id="cp_table">
                <div class="col-md-12">
                    <div class="row">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th class="align-middle"> Email Address</th>
                                    <th class="align-middle"> Loan ID </th>
                                    <th class="align-middle"> Covid Product </th>
                                    <th class="align-middle"> Tenure Extension </th>
                                    <th class="align-middle"> New Income </th>
                                    <th class="align-middle"> New Expense </th>
                                    <th class="align-middle"> New Employment Status </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="align-middle" id="cp_email"></td>
                                    <td class="align-middle" id="cp_loan_id"></td>
                                    <td class="align-middle" id="cp_covid_product"></td>
                                    <td class="align-middle" id="cp_tenure_extension"></td>
                                    <td class="align-middle" id="cp_new_income"></td>
                                    <td class="align-middle" id="cp_new_expense"></td>
                                    <td class="align-middle" id="cp_employment_status"></td>
                                </tr>
                                <!--<tr>-->
                                    <!--<td colspan="7" align="right">-->
                                        <!--<button type="button"-->
                                        <!--class="btn btn-primary btn_generate" id="btn_copy">-->
                                        <!--Copy</button>-->
                                    <!--</td>-->
                                <!--</tr>-->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-md-12" style="padding-left:25px;padding-top:25px;">
                    <div class="row">
                        <div class="col-md-12" style="padding-bottom:15px;">
                            <b>Preferensi Channel Reminder</b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3" style="padding-bottom:15px;line-height:15px;">
                            <input type="checkbox" id="comms_channel1_1" name="comms_channel1" value="Email"
                                   style="height:18px; width:18px; vertical-align: middle;"
                                   onChange="return check_comms(1)">&nbsp;<label for="comms_channel1_1">Email</label> &nbsp;&nbsp;
                            <input type="checkbox" id="comms_channel1_2" name="comms_channel1" value="PN"
                                   style="height:18px; width:18px; vertical-align: middle;"
                                   onChange="return check_comms(1)">&nbsp;<label for="y">PN</label> &nbsp;&nbsp;
                            <input type="checkbox" id="comms_channel1_3" name="comms_channel1" value="SMS"
                                   style="height:18px; width:18px; vertical-align: middle;"
                                   onChange="return check_comms(1)">&nbsp;<label for="y">SMS</label>
                        </div>
                        <div class="col-md-3" style="padding-bottom:15px;line-height:15px;">
                            <button type="button" class="btn btn-warning" id="btn_retrigger_notification">
                                Retrigger Notification
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12" style="padding-bottom:15px;line-height:15px;">
                            <input type="checkbox" id="is_customer_confirmed_reactive" name="is_customer_confirmed_reactive"
                                   style="height:18px; width:18px; vertical-align: middle;"
                                   onChange="">&nbsp;<label for="is_customer_confirmed_reactive">Customer tertarik dengan program ini dan sudah menyetujui pilihannya sekarang</label>
                        </div>
                    </div>
                    <div class="row" >
                        <div class="col-md-12" >
                            <button type="button"
                                class="btn btn-primary disabled btn-inactive btn_refinancing_submit"
                                    id="btn_refinancing_submit" disabled>
                                &nbsp;&nbsp;&nbsp;SUBMIT&nbsp;&nbsp;&nbsp;  </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row" id="div_waiver_request_submit" style="display:none;">
                <div class="row" id="waiver_validation">
                        <div class="col-md-12">
                            <p></p>
                        </div>
                    </div>
                <div class="col-md-12" style="padding-left:25px; margin-bottom: 10px;">
                    <div class="row">
                        <div class="col-md-12" style="padding-bottom:15px;line-height:15px;">
                            <input type="checkbox" id="is_multiple_ptp_payment" name="is_multiple_ptp_payment" style="height:18px; width:18px; vertical-align: middle;" onChange="">
                            &nbsp;<label for="is_multiple_ptp_payment">Customer akan membayarkan PTP dalam beberapa kali angsuran</label>
                            <p class="multiple-ptp-payment-message" style="display: none;" data-previous="hide">Bagian ini harus di centang</p>
                            <p class="edit-link" data-toggle="modal" data-target="#multiple_ptp_payment_modal" style="display: none;">(Edit)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-12" style="padding-left:25px;">
                    <div class="row">
                        <div class="col-md-12" style="padding-bottom:15px;">
                            <b>Preferensi Channel Reminder</b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12" style="padding-bottom:15px;line-height:15px;">
                            <input type="checkbox" id="comms_channel2_1" name="comms_channel2" value="Email"
                                   style="height:18px; width:18px; vertical-align: middle;"
                                   onChange="return check_comms(2)">&nbsp;<label for="comms_channel2_1">Email</label> &nbsp;&nbsp;
                            <input type="checkbox" id="comms_channel2_2" name="comms_channel2" value="PN"
                                   style="height:18px; width:18px; vertical-align: middle;"
                                   onChange="return check_comms(2)">&nbsp;<label for="comms_channel2_2">PN</label> &nbsp;&nbsp;
                            <input type="checkbox" id="comms_channel2_3" name="comms_channel2" value="SMS"
                                   style="height:18px; width:18px; vertical-align: middle;"
                                   onChange="return check_comms(2)">&nbsp;<label for="comms_channel2_3">SMS</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12" style="padding-bottom:15px;line-height:15px;">
                            <input type="checkbox" id="is_customer_confirmed_waiver" name="is_customer_confirmed_waiver"
                                   style="height:18px; width:18px; vertical-align: middle;"
                                   onChange="">&nbsp;<label for="is_customer_confirmed_waiver">Customer tertarik dengan program ini dan sudah menyetujui pilihannya sekarang</label>
                        </div>
                    </div>

                    <div class="row" >
                        <div class="col-md-12" >
                            <button type="button"
                                class="btn btn-primary btn-inactive btn_waiver_request_submit"
                                    id="btn_show_note_modal">
                                SUBMIT WAIVER REQUEST</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!--########################### modal box to show no score in db ###############################################-->
<div id="error_pop_up" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header label-warning">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">Collection Offer Recommendations</h4>
            </div>
            <div class="modal-body">
                 <div class="row">
                    <div class="col-md-12 col-sm-12" id="pop_msg">

                    </div>
                 </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default waves-effect" id="close_confirm_delete" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<div id="existing_offer_pop_up" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog existing_offer_modal" role="document">
        <div class="modal-content">
            <div class="modal-header label-warning">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">Offer history</h4>
            </div>
            <div class="modal-body">
                 <div class="row">
                     <div class="col-md-12 col-sm-12 text-center" id="blank_existing_offer_content">
                        Customer ini belum pernah mendapatkan refinancing sebelumnya
                    </div>
                    <div class="col-md-12 col-sm-12" id="existing_offer_content">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th class="align-middle"> No. </th>
                                    <th class="align-middle"> Offer Type </th>
                                    <th class="align-middle"> Request Date </th>
                                    <th class="align-middle"> Principal disc. </th>
                                    <th class="align-middle"> Interest disc. </th>
                                    <th class="align-middle"> Late Fee disc. </th>
                                    <th class="align-middle"> Extension </th>
                                    <th class="align-middle"> Status </th>
                                    <th class="align-middle"> Pre-requisite Amount </th>
                                    <th class="align-middle"> Status Date </th>
                                    <th class="align-middle"> Expire Date </th>
                                </tr>
                            </thead>
                            <tbody id='existing_offer_table_body'>
                            </tbody>
                        </table>
                        <div id="existing_offer_ps">
                        </div>
                    </div>
                 </div>
            </div>
            <div class="modal-footer" id="existing_offer_footer">
            </div>
        </div>
    </div>
</div>
<div id="agent_notes_modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                 <div class="row">
                    <div class="col-md-12 col-sm-12">
                        <h1 align="center"><span class="glyphicon glyphicon-info-sign" aria-hidden="true" style="color: #F9992E"></span></h1>
                        <h3 id="text_agent_note"></h3>
                        <div class="form-group">
                          <textarea class="form-control" rows="5" id="agent_note"></textarea>
                        </div>
                    </div>
                     <div class="col-md-12 col-sm-12 text-center">
                         <button class="btn btn-primary" style="background-color: white; color: #000000; border-color: #0a0a0a" data-dismiss="modal">Tidak</button>
                        <button class="btn btn-primary" id="btn_waiver_request_submit" data-dismiss="modal" disabled>Ya</button>
                     </div>
                 </div>
            </div>
        </div>
    </div>
</div>
<div id="multiple_ptp_payment_modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                 <div class="row">
                    <div class="col-md-9 col-sm-9">
                        <label class="col-md-7 col-md-7">PTP Amount</label>
                        <div class="form-group col-md-5 col-md-5">
                            <div class="input-group">
                                <span class="input-group-addon">Rp.</span>
                                <input class="form-control"name="max_multiple_ptp_amount" type="text" disabled>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-9 col-sm-9">
                        <label class="col-md-7 col-md-7">Dalam berapa kali<br/>angsuran PTP akan dibayar?</label>
                        <div class="form-group col-md-5 col-md-5">
                            <select class="form-control" name="jumlah_angsuran_ptp_payment">
                                <option value="0" selected disabled hidden>Pilih Jumlah Angsuran</option>
                                <option value='2'>2</option>
                                <option value='3'>3</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-12 col-md-12">
                        <table class="table table-bordered multiple-ptp-payment-table" style="display: none;">
                            <thead class="text-center">
                                <th class="text-center" style="width: 50%;">Tanggal Bayar</th>
                                <th class="text-center" style="width: 50%;">Jumlah Yang Dibayar</th>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <div class="input-group">
                                            <span class="input-group-addon">
                                                <span class="glyphicon glyphicon-calendar"></span>
                                            </span>
                                            <input class="form-control datepicker" id="multiple_payment_date_1" maxlength="None" name="multiple_payment_date_1" placeholder="dd M yyyy" type="text" value="">
                                            <input type="hidden" id="multiple_payment_date_1_db" value="" name="multiple_payment_date_1_db">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="input-group">
                                            <span class="input-group-addon">Rp.</span>
                                            <input type="text" class="form-control" maxlength="15" name="multiple_ptp_amount_1">
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td style="text-align: left; font-weight: bold;">Total</td>
                                    <td style="text-align: right; font-weight: bold;" class="total-multiple-payment">Rp. 0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="col-md-12 col-md-12" id="multiple_ptp_payment_validation"></div>
                    <div class="col-md-12 col-md-12">
                        <div style="border-top: solid #00ACF0; background-color: #F3FCFF;">
                            <p>Catatan :</p>
                            <ol>
                                <li>
                                    Total jumlah yang dibayar dalam tabel harus sama dengan&nbsp;
                                    Rp.&nbsp;<span id="multiple_ptp_amount_txt">0</span>
                                </li>
                                <li>
                                    Tanggal bayar terakhir dalam tabel harus jatuh sebelum atau pada tanggal&nbsp;
                                    <span id="multiple_validity_date_txt">00 Xxx 0000</span>
                                </li>
                                <li>
                                    Tanggal bayar dan Jumlah yang dibayar harus diisi
                                </li>
                            </ol>
                        </div>
                    </div>
                    <div class="col-md-12 col-md-12 text-center">
                        <button class="btn btn-primary" id="btn_multiple_ptp_payment_cancel" style="background-color: white; color: #000000; border-color: #0a0a0a" data-dismiss="modal">Cancel</button>
                        <button class="btn btn-primary" id="btn_multiple_ptp_payment_submit" disabled>Submit</button>
                    </div>
                 </div>
            </div>
        </div>
    </div>
</div>
{% include "covid_loan_refinancing/include/collection_offers_portal_modal.html" %}
{% endblock %}
{% block custom_link %}
<link href="{% static 'theme/plugins/bower_components/toast-master/css/jquery.toast.css' %}" rel="stylesheet">
<link href="{% static 'theme/plugins/bower_components/bootstrap-datepicker/bootstrap-datepicker.min.css' %}" rel="stylesheet" type="text/css" />
<link href="{% static 'theme/plugins/bower_components/sweetalert/sweetalert.css' %}" rel="stylesheet" type="text/css">
{% endblock %}
{% block script_additional %}
<script src="{% static 'theme/plugins/bower_components/toast-master/js/jquery.toast.js' %}"></script>
<script src="{% static 'default/theme/js/jquery.maskMoney.min.js' %}"></script>
<script src="{% static 'theme/plugins/bower_components/bootstrap-datepicker/bootstrap-datepicker.min.js' %}"></script>
<script src="{% static 'theme/plugins/bower_components/moment/moment.js' %}"></script>
<!-- Sweet-Alert  -->
<script src="{% static 'theme/plugins/bower_components/sweetalert/sweetalert.min.js' %}"></script>
<script src="{% static 'theme/plugins/bower_components/sweetalert/jquery.sweet-alert.custom.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
<script src="{% static 'default/js/loan-refinancing.js' %}"></script>
{% endblock %}
{% block script_bottom_inside %}
{#<script>#}
var show = '{{ show }}'
var is_julo_one = '{{ is_julo_one }}' == 'True' ? true : false
var loan_id = '{{ loan_id }}'
if (loan_id && show == 'False' && !is_julo_one ) {
    ToastDanger('Failure', 'Invalid Loan ID');
}
ability_score = '{{ ability_score }}'
willingness_score = '{{ willingness_score }}'
max_extension = '{{ max_extension }}'
default_max_extension = '{{ max_extension }}'
refinancing_request_id = '{{ refinancing_request_id }}'
loan_refinancing_request_count = '{{ loan_refinancing_request_count }}'
loan_refinancing_request_date = '{{ loan_refinancing_request_date }}'
new_quadrant = ''
new_income = ''
new_expense = ''
customer_recommended_product = '';
not_allowed_products= null;
is_covid_risky = '{{ is_covid_risky }}'
bucket_name = '{{ bucket }}'
partner_product = '{{partner_product}}'
principal_waiver = 0
if(bucket_name !="") {
    if (bucket_name.toLowerCase() == 'current') {
        bucket = 'Current';
    } else {
        str = bucket_name.split(" ");
        if (str.length == 2)
            bucket = $.trim(str[1]);
        else
            bucket = '';
    }
} else {
    bucket = '';
}
var net_unpaid_principal_r4 = 0;
var net_unpaid_interest_r4 = 0;
var net_unpaid_late_fee_r4 = 0;
var net_outstanding_amount_r4 = 0;
var unpaid_payment_count_r4 = 0;
var unpaid_last_payment_number_r4 = 0;
unpaid_late_fee_calculated_waiver_percent = 0;
unpaid_interest_calculated_waiver_percent = 0;
unpaid_principal_calculated_waiver_percent = 0;
unpaid_late_fee_calculated_waiver_amount = 0;
unpaid_interest_calculated_waiver_amount = 0;
unpaid_principal_calculated_waiver_amount = 0;
waiver_late_fee_percent = 0;
waiver_recommend_late_fee_percent = 0;
waiver_late_fee_amount = 0;
waiver_unpaid_late_fee_amount = 0;
waiver_unpaid_interest_amount = 0;
waiver_unpaid_principal_amount = 0;
waiver_interest_percent = 0;
waiver_refinancing_program = ['r4','r5','r6'];
waiver_recommend_interest_percent = 0;
waiver_interest_amount = 0;
waiver_principal_percent = 0;
waiver_recommend_principal_percent = 0;
waiver_principal_amount = 0;
waiver_outstanding_amount = 0;
waiver_jumlah_pembayaran = 0;
waiver_last_unpaid_payment_number = '';
waiver_recommendation = null;
actual_waiver = null;
selected_payments_waived = null;
selected_payments_waived_details = {outstanding: [], waiver: [], remaining: []};
selected_principal_amount = 0;
selected_interest_amount = 0;
selected_late_fee_amount = 0;
selected_outstanding_amount = 0;
selected_remaining_amount_waived = 0;
recommended_waiver_percentage = null;
recommended_waiver_interest_percentage = null;
recommended_waiver_late_fee_percentage = null;
recommended_waiver_principal_percentage = null;
actual_waiver_percentage = null;
actual_waiver_principal_percentage = null;
actual_waiver_late_fee_percentage = null;
actual_waiver_interest_percentage = null;
waiver_payment_request = null;
var payments = [];
var refinancing_offers = [];
var recommendedExtension = 0;
var maxExtension = 0;
var selected_offer = '';
var total_not_yet_due_installment = '{{total_not_yet_due_installment}}'
var is_can_calculate_r1_until_r6 = '{{is_can_calculate_r1_until_r6}}'
var outstandingPrincipal = parseInt({{ total_remaining_principal }});
var outstandingInterest = parseInt({{ total_remaining_interest }});
var outstandingLateFee = parseInt({{ total_remaining_late_fee }});
var totalPaymentDue = 0;
var remainingPrincipal = parseInt({{ total_remaining_principal }})
var remainingInterest = parseInt({{ total_remaining_interest }})
var remainingLateFee = parseInt({{ total_remaining_late_fee }})
wording_waiver = {
    header_table_waiver: {
        r4: 'principal',
        r5: 'late fee',
        r6: 'interest',
    },
    min_ptp_amount: {
        recommended : {
            r4: 'Recommended Principal',
            r5: 'Recommended Late Fee Waiver',
            r6: 'Recommended Interest Waiver',
        },
        actual: {
            r4: 'Actual Principal Waiver',
            r5: 'Actual Late Fee Waiver',
            r6: 'Actual Interest Waiver',
        },
        repayment: {
            r4: 'Principal Waiver % utk pelunasan PTP amount',
            r5: '100% Late Fee Waiver',
            r6: '100% Interest Waiver'
        }
    },
}
{% for ongoing_loan_data_payment in ongoing_loan_data %}
     var is_restructured = '{{ongoing_loan_data_payment.is_restructured}}'
     if (is_restructured == 'False') {
         payments.push({
             'due_status': '{{ ongoing_loan_data_payment.due_status }}',
             'payment_number': '{{ ongoing_loan_data_payment.payment_number }}',
             'outstanding': '{{ ongoing_loan_data_payment.outstanding }}',
             'late_fee_amount': '{{ ongoing_loan_data_payment.late_fee_amount }}',
             'installment_interest': '{{ ongoing_loan_data_payment.installment_interest }}',
             'installment_principal': '{{ ongoing_loan_data_payment.installment_principal }}',
             'remaining_principal': parseInt({{ ongoing_loan_data_payment.remaining_principal }}),
             'remaining_interest': parseInt({{ ongoing_loan_data_payment.remaining_interest }}),
             'remaining_late_fee': parseInt({{ ongoing_loan_data_payment.remaining_late_fee }}),
             'paid_amount': '{{ ongoing_loan_data_payment.paid_amount }}',
             'is_restructured': '{{ ongoing_loan_data_payment.is_restructured }}',
                'due_date': '{{ ongoing_loan_data_payment.due_date  | format_date_to_locale_format }}',
                'payment_id': '{{ ongoing_loan_data_payment.payment_id }}'

         });
        if ('{{ ongoing_loan_data_payment.due_status }}' == 'Y'){
            totalPaymentDue += 1;
        }
     }
{% endfor %}
{#{% for waiver_request in waivers_request %}#}
{#    waiverRequestLoanId.push(waivers_request.loan)#}
{#{% endfor %}#}
var selected_program_name = '';
er_msg = 'no matching data in reco table';

r4_cnt = 1;
for (var i=0; i<payments.length; i++) {
    if (payments[i].outstanding > 0) {
        net_outstanding_amount_r4+= parseInt(payments[i].outstanding);
        unpaid_payment_count_r4++;
        unpaid_last_payment_number_r4 = payments[i].payment_number;
    }
}
if (unpaid_payment_count_r4 > 0) {
    for (var i=0; i<payments.length; i++) {
        if (payments[i].outstanding > 0 && r4_cnt <= unpaid_payment_count_r4) {
            if(r4_cnt == 1) {
                if (parseInt(payments[i].paid_amount) <= parseInt(payments[i].installment_principal)) {
                    net_unpaid_principal_r4+= parseInt(payments[i].installment_principal) - parseInt(payments[i].paid_amount);
                    net_unpaid_interest_r4+= parseInt(payments[i].installment_interest);

                } else {
                    net_unpaid_principal_r4+= 0;
                    if ((parseInt(payments[i].paid_amount) > parseInt(payments[i].installment_principal)) && (parseInt(payments[i].paid_amount) <= (parseInt(payments[i].installment_principal) + parseInt(payments[i].installment_interest)))) {
                        net_unpaid_interest_r4+= parseInt(payments[i].installment_interest) - (parseInt(payments[i].paid_amount) - parseInt(payments[i].installment_principal));
                    } else {
                        net_unpaid_interest_r4+= 0;
                    }
                }
                if (parseInt(payments[i].paid_amount) <= (parseInt(payments[i].installment_principal) + parseInt(payments[i].installment_interest))) {
                    net_unpaid_late_fee_r4+= parseInt(payments[i].late_fee_amount);
                } else {
                     if ((parseInt(payments[i].paid_amount) > (parseInt(payments[i].installment_principal) + parseInt(payments[i].installment_interest))) && (parseInt(payments[i].paid_amount) <= (parseInt(payments[i].installment_principal) + parseInt(payments[i].installment_interest) + parseInt(payments[i].late_fee_amount)))) {
                        net_unpaid_late_fee_r4+= parseInt(payments[i].late_fee_amount) - (parseInt(payments[i].paid_amount) - parseInt(payments[i].installment_principal) - parseInt(payments[i].installment_interest));
                     } else {
                        net_unpaid_late_fee_r4+= 0;
                     }
                }

            } else {
                net_unpaid_principal_r4+= parseInt(payments[i].installment_principal);
                net_unpaid_interest_r4+= parseInt(payments[i].installment_interest);
                net_unpaid_late_fee_r4+= parseInt(payments[i].late_fee_amount);
            }
        }
    }
}
var is_multiple_ptp_payment_input = false;
var number_of_multiple_ptp_payment = 0;
var multiple_payment_ptp = null;
var startDate = '+0d';

$("#btn_search_loan").on('click', function (e) {
    loan_id = $('#loan_id').val();
    if (!loan_id) {
        ToastDanger('Failure', 'Please enter Loan ID');
        e.preventDefault();
        return false;
    } else {
        $('#loading-div').show();
        {% if is_approver %}
            showModalPortal('loan', loan_id, '/api/loan_refinancing/v1/covid_refinancing_web_portal');
        {% else %}
            $("#frm_search_loan").submit();
        {% endif %}
    }
});

$('#portal_modal').on('hidden.bs.modal', function () {
    $('#loading-div').hide();
});

function directLink(loan_id) {
    window.location.href = "/api/loan_refinancing/v1/covid_refinancing_web_portal?portal_type=approver_portal&loan_id="+loan_id;
}

function ToastDanger (header_msg, body_message, type='') {
    if(type == 1)
        hide_time = 6300
    else
        hide_time = 2800
    $.toast({
        heading: header_msg,
        text: body_message,
        position: 'top-right',
        loaderBg:'#ff6849',
        icon: 'error',
        hideAfter: hide_time
    });
}
function ToastSuccess (header_msg, body_message, type='') {
    if(type == 1)
        hide_time = 6300
    else
        hide_time = 1500
    $.toast({
        heading: header_msg,
        text: body_message,
        position: 'top-right',
        loaderBg:'#ff6849',
        icon: 'success',
        hideAfter: hide_time,
        stack: 6
    });
}
/*$("#new_income").on('change', function (e) {
    score_status = calculate_score();
});
$("#new_expense").on('change', function (e) {
    score_status = calculate_score();
});
$("#employment_status").on('change', function (e) {
    if($('#employment_status').val() != '' && $("#new_income").val() !=""  && $("#new_expense").val() !="") {
        score_status = calculate_score();
    } else {
        $('#waiver_validity_date_div').hide();
        $('#tenure_extension_div').hide();
    }
});*/

function calculate_score() {
    new_income = parseInt($("#new_income").val().replace(/,/g, ''));
    new_expense = parseInt($("#new_expense").val().replace(/,/g, ''));
    if (ability_score == '' || is_can_calculate_r1_until_r6 == 'False') {
        $('#pop_msg').html('Loan ID yang anda masukan tidak terdaftar untuk COVID Refinancing, harap melakukan pengecekan kembali');
        $('#error_pop_up').modal('show');
        return false;
    } else {
        show_hide_divs_right(false);
        if($('#employment_status').val() == '') {
            ToastDanger('Failure', 'Please select Status Pekerjaan Baru');
            return false;
        } else if(!new_income || new_income == 0) {
            ToastDanger('Failure', 'Please enter Pendapatan Baru');
            return false;
        } else if(!new_expense || new_expense == 0) {
            ToastDanger('Failure', 'Please enter Pengeluaran Baru');
            return false;
        } else if(new_income <= new_expense) {
            ToastDanger('Failure', 'Pendapatan Baru should be greater than Pengeluaran Baru');
            return false;
        } else {
            net_due_amt = $('#pay_net_due').attr('net_due_amt')
            if (net_due_amt < 0) {
                ToastDanger('Failure', 'Invalid due_amount');
                return false;
            } else {
                v1 = ability_score * 0.6;
                v2 = net_due_amt / (new_income - new_expense);
                if(v2 < 0.9) {
                    v3 = 3;
                } else {
                    if(v2 < 1) {
                       v3 = 2;
                    } else {
                       v3 = 1;
                    }
                }
                v4 = v3 * 0.2;
                v5 = v1 + v4;
                new_ability_score = v5 + 1*0.2;
                if (ability_score >= 2) {
                    old_quadrant = 'H';
                } else {
                    old_quadrant = 'L';
                }
                if (willingness_score >= 2) {
                    old_quadrant+= 'H';
                } else {
                    old_quadrant+= 'L';
                }
                if (new_ability_score >= 2) {
                    new_quadrant = 'H';
                } else {
                    new_quadrant = 'L';
                }
                if (willingness_score >= 2) {
                    new_quadrant+= 'H';
                } else {
                    new_quadrant+= 'L';
                }
                var str = '<table width="100%">'
                if (new_quadrant == 'HH') {
                    if (total_not_yet_due_installment > 2) {
                        customer_recommended_product = ['R5'];
                        priority_product = '<tr><td width="85%" style="padding-bottom:18px;">Penghapusan Denda (R5)</td>'+
                                        '<td width="15%" style="padding-bottom:18px;align:right;">'+
                                        '<input type="radio" style="height:18px; width:18px; vertical-align: middle;" '+
                                        ' name="selected_offer_recommendation" class="selected_offer_recommendation" value="R5|r5">'+
                                        '</td></tr>';
                        if (not_allowed_products == null || !not_allowed_products.includes('R1')){
                            customer_recommended_product.push('R1');
                            priority_product += '<tr id="r1_offer_recommendation"><td width="85%" style="padding-bottom:18px;">Cicilan Lebih Ringan (R1)</td>'+
                                        '<td width="15%" style="padding-bottom:18px;align:right;">'+
                                        '<input type="radio" style="height:18px; width:18px; vertical-align: middle;" '+
                                        ' name="selected_offer_recommendation" class="selected_offer_recommendation" value="R1|r1">'+
                                        '</td></tr>';
                        };
                        if (not_allowed_products == null || !not_allowed_products.includes('R3')){
                            customer_recommended_product.push('R3');
                            priority_product +=
                                            '<tr><td width="85%" style="padding-bottom:18px;">Penundaan Hutang (R3)</td>'+
                                            '<td width="15%" style="padding-bottom:18px;align:right;">'+
                                            '<input type="radio" style="height:18px; width:18px; vertical-align: middle;" '+
                                            ' name="selected_offer_recommendation" class="selected_offer_recommendation" value="R3|r3">'+
                                            '</td></tr>';
                        };
                    } else {
                        customer_recommended_product = ['R4'];
                        priority_product = '<tr><td width="85%" style="padding-bottom:18px;">Pelunasan Dengan Diskon (R4)</td>'+
                                    '<td width="15%" style="padding-bottom:18px;align:right;">'+
                                    '<input type="radio" style="height:18px; width:18px; vertical-align: middle;" '+
                                    ' name="selected_offer_recommendation" class="selected_offer_recommendation" value="R4|r4">'+
                                    '</td></tr>';
                        if (not_allowed_products == null || !not_allowed_products.includes('R1')){
                            customer_recommended_product.push('R1');
                            priority_product += '<tr id="r1_offer_recommendation"><td width="85%" style="padding-bottom:18px;">Cicilan Lebih Ringan (R1)</td>'+
                                    '<td width="15%" style="padding-bottom:18px;align:right;">'+
                                    '<input type="radio" style="height:18px; width:18px; vertical-align: middle;" '+
                                    ' name="selected_offer_recommendation" class="selected_offer_recommendation" value="R1|r1">'+
                                    '</td></tr>'
                        };
                        if (not_allowed_products == null || !not_allowed_products.includes('R3')){
                            customer_recommended_product.push('R3');
                            priority_product += '<tr><td width="85%" style="padding-bottom:18px;">Penundaan Hutang (R3)</td>'+
                                    '<td width="15%" style="padding-bottom:18px;align:right;">'+
                                    '<input type="radio" style="height:18px; width:18px; vertical-align: middle;" '+
                                    ' name="selected_offer_recommendation" class="selected_offer_recommendation" value="R3|r3">'+
                                    '</td></tr>';
                        };
                     };
                    customer_recommended_product = customer_recommended_product.join(',');
                } else if(new_quadrant == 'LH' || new_quadrant == 'LL') {
                    customer_recommended_product = [];
                    priority_product = '';
                    if (not_allowed_products == null || !not_allowed_products.includes('R1')){
                        customer_recommended_product.push('R1');
                        priority_product += '<tr id="r1_offer_recommendation"><td width="85%" style="padding-bottom:18px;">Cicilan Lebih Ringan (R1)</td>'+
                                    '<td width="15%" style="padding-bottom:18px;align:right;">'+
                                    '<input type="radio" style="height:18px; width:18px; vertical-align: middle;" '+
                                    ' name="selected_offer_recommendation" class="selected_offer_recommendation" value="R1|r1">'+
                                    '</td></tr>';
                    };
                    if (not_allowed_products == null || !not_allowed_products.includes('R2')){
                        customer_recommended_product.push('R2');
                        priority_product += '<tr><td width="85%" style="padding-bottom:18px;">Bayar Bunga (R2)</td>'+
                            '<td width="15%" style="padding-bottom:18px;align:right;">'+
                            '<input type="radio" style="height:18px; width:18px; vertical-align: middle;" '+
                            ' name="selected_offer_recommendation" class="selected_offer_recommendation" value="R2|r2">'+
                            '</td></tr>';
                    };
                    if (not_allowed_products == null || !not_allowed_products.includes('R3')){
                        customer_recommended_product.push('R3');
                        priority_product += '<tr><td width="85%" style="padding-bottom:18px;">Penundaan Hutang (R3)</td>'+
                            '<td width="15%" style="padding-bottom:18px;align:right;">'+
                            '<input type="radio" style="height:18px; width:18px; vertical-align: middle;" '+
                            ' name="selected_offer_recommendation" class="selected_offer_recommendation" value="R3|r3">'+
                            '</td></tr>';
                    };
                    customer_recommended_product = customer_recommended_product.join(',');
                } else if(new_quadrant == 'HL') {
                     if (total_not_yet_due_installment > 2) {
                         customer_recommended_product = 'R5,R6';
                         priority_product = '<tr><td width="85%" style="padding-bottom:18px;">Penghapusan Denda (R5)</td>'+
                                        '<td width="15%" style="padding-bottom:18px;align:right;">'+
                                        '<input type="radio" style="height:18px; width:18px; vertical-align: middle;" '+
                                        ' name="selected_offer_recommendation" class="selected_offer_recommendation" value="R5|r5">'+
                                        '</td></tr>' +
                                        '<tr><td width="85%" style="padding-bottom:18px;">Penghapusan Denda Dan Bunga (R6)</td>'+
                                        '<td width="15%" style="padding-bottom:18px;align:right;">'+
                                        '<input type="radio" style="height:18px; width:18px; vertical-align: middle;" '+
                                        ' name="selected_offer_recommendation" class="selected_offer_recommendation" value="R6|r6">'+
                                        '</td></tr>';
                     } else {
                          customer_recommended_product = 'R4';
                          priority_product = '<tr><td width="85%" style="padding-bottom:18px;">Pelunasan Dengan Diskon (R4)</td>'+
                                        '<td width="15%" style="padding-bottom:18px;align:right;">'+
                                        '<input type="radio" style="height:18px; width:18px; vertical-align: middle;" '+
                                        ' name="selected_offer_recommendation" class="selected_offer_recommendation" value="R4|r4">'+
                                        '</td></tr>';
                     }
                }
                else {
                      priority_product = '';
                }
                if(priority_product == ''){
                    priority_product =  '<tr><td width="85%" style="padding-bottom:18px;">\
                                        Tidak tersedia. Silahkan tawarkan Pilihan Offer Lainnya.</td></td></tr>';
                };
                    if(priority_product != '') {
                    var str1 = '</table>';
                    var body_table = str + priority_product + str1;
                    $('#pilihan_offer').empty();
                    if (new_quadrant == 'HH') {
                         $('#pilihan_offer').append("<option value=''></option>");
                         if (total_not_yet_due_installment > 2) {
                            if (not_allowed_products == null || !not_allowed_products.includes('R2')){
                                $('#pilihan_offer').append("<option value='R2|r2'>Bayar Bunga (R2)</option>");
                            };
                            $('#pilihan_offer').append("<option value='R4|r4'>Pelunasan Dengan Diskon (R4)</option>");
                            $('#pilihan_offer').append("<option value='R6|r6'>Penghapusan Denda Dan Bunga (R6)</option>");

                         } else {
                            if (not_allowed_products == null || !not_allowed_products.includes('R2')){
                                $('#pilihan_offer').append("<option value='R2|r2'>Bayar Bunga (R2)</option>");
                            };
                            $('#pilihan_offer').append("<option value='R5|r5'>Penghapusan Denda (R5)</option>");
                            $('#pilihan_offer').append("<option value='R6|r6'>Penghapusan Denda Dan Bunga (R6)</option>");
                         }
                    } else if (new_quadrant == 'LH') {
                         $('#pilihan_offer').append("<option value=''></option>");
                         $('#pilihan_offer').append("<option value='R4|r4'>Pelunasan Dengan Diskon (R4)</option>");
                         $('#pilihan_offer').append("<option value='R5|r5'>Penghapusan Denda (R5)</option>");
                         $('#pilihan_offer').append("<option value='R6|r6'>Penghapusan Denda Dan Bunga (R6)</option>");
                    } else if (new_quadrant == 'LL') {
                         $('#pilihan_offer').append("<option value=''></option>");
                         $('#pilihan_offer').append("<option value='R4|r4'>Pelunasan Dengan Diskon (R4)</option>");
                         $('#pilihan_offer').append("<option value='R5|r5'>Penghapusan Denda (R5)</option>");
                         $('#pilihan_offer').append("<option value='R6|r6'>Penghapusan Denda Dan Bunga (R6)</option>");
                    } else if (new_quadrant == 'HL') {
                         $('#pilihan_offer').append("<option value=''></option>");
                         if (total_not_yet_due_installment > 2) {
                            if (not_allowed_products == null || !not_allowed_products.includes('R1')){
                                $('#pilihan_offer').append("<option value='R1|r1'>Cicilan Lebih Ringan (R1)</option>");
                            };
                            if (not_allowed_products == null || !not_allowed_products.includes('R2')){
                                $('#pilihan_offer').append("<option value='R2|r2'>Bayar Bunga (R2)</option>");
                            };
                            if (not_allowed_products == null || !not_allowed_products.includes('R3')){
                                $('#pilihan_offer').append("<option value='R3|r3'>Penundaan Hutang (R3)</option>");
                            };
                            $('#pilihan_offer').append("<option value='R4|r4'>Pelunasan Dengan Diskon (R4)</option>");
                         } else {
                             if (not_allowed_products == null || !not_allowed_products.includes('R1')){
                                $('#pilihan_offer').append("<option value='R1|r1'>Cicilan Lebih Ringan (R1)</option>");
                            };
                            if (not_allowed_products == null || !not_allowed_products.includes('R2')){
                                $('#pilihan_offer').append("<option value='R2|r2'>Bayar Bunga (R2)</option>");
                            };
                            if (not_allowed_products == null || !not_allowed_products.includes('R3')){
                                $('#pilihan_offer').append("<option value='R3|r3'>Penundaan Hutang (R3)</option>");
                            };
                             $('#pilihan_offer').append("<option value='R5|r5'>Penghapusan Denda (R5)</option>");
                             $('#pilihan_offer').append("<option value='R6|r6'>Penghapusan Denda Dan Bunga (R6)</option>");
                         }
                    }
                    //$("#div_offer_recommend").show();
                    $("#tab_priority_product").html(body_table);
                    return true;
                } else {
                    $('#pop_msg').html('No Rekomendasi Offer found.');
                    $('#error_pop_up').modal('show');
                    return false;
                };
            };
        };
    };
};
$('#submit_product').on('click', function (e) {
    $("#div_simulasi_head").hide();
    $("#div_simulasi_details").hide();
    $("#cp_head").hide();
    $("#cp_table").hide();
    $('#div_waiver_request_submit').hide();
    if(max_extension == '') {
        $('#pop_msg').html('Feature setting status tidak aktif');
        $('#error_pop_up').modal('show');
    } else {
        if($('#employment_status').val() == '') {
            ToastDanger('Failure', 'Please select Status Pekerjaan Baru');
            return false;
        } else if(!new_income || new_income == 0) {
            ToastDanger('Failure', 'Please enter Pendapatan Baru');
            return false;
        } else if(!new_expense || new_expense == 0) {
            ToastDanger('Failure', 'Please enter Pengeluaran Baru');
            return false;
        } else if(new_income <= new_expense) {
            ToastDanger('Failure', 'Pendapatan Baru should be greater than Pengeluaran Baru');
            return false;
        } else if(!$("input[name='selected_offer_recommendation']:checked").val() && !$('#pilihan_offer').val()) {
            ToastDanger('Failure', 'Please choose Rekomendasi Offer or Pilihan Offer Lainnya');
        } else if((selected_offer == 'r4' || selected_offer == 'r5' || selected_offer == 'r6') && !$('#waiver_validity_date').val()) {
           ToastDanger('Failure', 'Please choose Waiver Validity Date');
           return false;
        } else if((selected_offer == 'r4' || selected_offer == 'r5' || selected_offer == 'r6') && bucket == '') {
           ToastDanger('Failure', 'Bucket name is invalid');
           return false;
        } /*else if((selected_offer == 'r1' || selected_offer == 'r2' || selected_offer == 'r3') && is_can_calculate_r1_until_r3 =='False') {
           ToastDanger('Failure', 'Offer yang Anda pilih hanya berlaku untuk nasabah produk MTL saja. Silakan pilih offer lain untuk nasabah ini.');
           return false;
        }*/ else if((selected_offer == 'r1' || selected_offer == 'r2' || selected_offer == 'r3') && !$('#tenure_extension').val()) {
           ToastDanger('Failure', 'Please enter Dibutuhkan untuk');
           return false;
        } else if((selected_offer == 'r1' || selected_offer == 'r2' || selected_offer == 'r3') && $('#tenure_extension').val() == 0) {
           ToastDanger('Failure', 'Dibutuhkan untuk should be greater than 0');
           return false;
        } else if((selected_offer == 'r1' || selected_offer == 'r2' || selected_offer == 'r3') && $('#tenure_extension').val() > max_extension) {
           ToastDanger('Failure', 'Dibutuhkan untuk should be less than or equal to '+ max_extension);
           return false;
        } else {
            if($("input[name='selected_offer_recommendation']:checked").val()) {
                offer = $("input[name='selected_offer_recommendation']:checked").val().split("|");
            } else {
                 offer = $('#pilihan_offer').val().split("|");
            }
            selected_program_name = offer[1];
            if(offer[1] == 'r4' || offer[1] == 'r5' || offer[1] == 'r6') {
                $.ajax({
                    url: "{%url 'loan_refinancing:ajax_covid_refinancing_waiver_recommendation' %}",
                    type: "POST",
                    headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json',
                                "X-CSRFToken": $("input[name=csrfmiddlewaretoken]").val(),
                            },
                    async: false,
                    data: JSON.stringify({
                        "loan_id": parseInt(loan_id),
                        "selected_offer_recommendation": offer[0],
                        "is_covid_risky": is_covid_risky == 'yes' ? true : false,
                        "bucket": bucket
                    }),
                    success: function (json){
                        if (json.status == 'success'){
                            waiver_recommendation = json.waiver_recommendation;
                            actual_waiver = json.actual_waiver;
                        } else {
                            ToastDanger('Failure', 'rekomendasi waiver tidak ditemukan');
                            $('#loading-div_simulasi').hide();
                            return;
                        }
                    },
                    error: function (xhr, errmsg, err) {
                        ToastDanger('Failure', "Mohon maaf. Silakan coba lagi", 1);
                        console.log(xhr.responseText);
                        $('#loading-div_simulasi').hide();
                        return;
                    }
                })
                $('#loading-div_simulasi').show();
                if (!waiver_recommendation) {
                    $('#loading-div_simulasi').hide();
                    return;
                }
                if (offer[1] == 'r5' && remainingLateFee <= 0) {
                    ToastDanger('Failure', "Pinjaman ini tidak mempunyai denda", 1);
                    $('#loading-div_simulasi').hide();
                    return;
                }
                $('#is_covid_risky_div').show();
                net_due_amt = parseInt($('#pay_net_due').attr('net_due_amt'))
                resultCalculation = initialCalculationFormulas(
                    payments,
                    offer[1],
                    {
                        'principal_waiver' : waiver_recommendation.principal_waiver_percentage,
                        'interest_waiver' : waiver_recommendation.interest_waiver_percentage,
                        'late_fee_waiver': waiver_recommendation.late_fee_waiver_percentage
                    },
                    {
                        'principal_waiver' : actual_waiver.principal_waiver_percentage,
                        'interest_waiver' : actual_waiver.interest_waiver_percentage,
                        'late_fee_waiver': actual_waiver.late_fee_waiver_percentage
                    },
                    {
                        remaining_principal: remainingPrincipal,
                        remaining_interest: remainingInterest,
                        remaining_late_fee: remainingLateFee,
                    }
                )
                ptp_amount = resultCalculation.ptp_amount
                waiver_outstanding_amount = resultCalculation.outstanding_amount.total_need_to_pay
                principal_waiver = resultCalculation.min_paid_off;
                actual_principal_waiver = resultCalculation.min_actual;
                recommended_interest_waiver = resultCalculation.min_recommended;

                recommended_waiver_percentage = parseFloat(waiver_recommendation.principal_waiver_percentage) * 100
                if (offer [1] == 'r5') {
                    recommended_waiver_percentage = parseFloat(waiver_recommendation.late_fee_waiver_percentage) * 100
                } else if (offer [1] == 'r6') {
                    recommended_waiver_percentage = parseFloat(waiver_recommendation.interest_waiver_percentage) * 100
                }
                actual_waiver_percentage = parseFloat(actual_waiver.principal_waiver_percentage) * 100;
                if (offer [1] == 'r5') {
                    actual_waiver_percentage = parseFloat(actual_waiver.late_fee_waiver_percentage) * 100;
                } else if (offer [1] == 'r6') {
                    actual_waiver_percentage = parseFloat(actual_waiver.interest_waiver_percentage) * 100;
                }

                id_form_actual_waiver = ''
                if (offer[1] == 'r4'){
                    actual_waiver_principal_percentage = '<div class="input-group m-t-10" style="width: 150px;float:right;">'+
                                                                `<input class="form-control mask" id="actual_waiver_principal_percentage" maxlength="10" type="text" onchange="grayedOut('actual_waiver')">`+
                                                                '<span class="input-group-addon">%</span>'+
                                                        '</div>';
                }else if(offer[1] == 'r5'){
                    actual_waiver_late_fee_percentage = '<div class="input-group m-t-10" style="width: 150px;float:right;">'+
                                                                `<input class="form-control mask" id="actual_waiver_late_fee_percentage" maxlength="10" type="text" onchange="grayedOut('actual_waiver')">`+
                                                                '<span class="input-group-addon">%</span>'+
                                                        '</div>';
                }else if(offer[1] == 'r6'){
                    actual_waiver_interest_percentage = '<div class="input-group m-t-10" style="width: 150px;float:right;">'+
                                                                `<input class="form-control mask" id="actual_waiver_interest_percentage" maxlength="10" type="text" onchange="grayedOut('actual_waiver')">`+
                                                                '<span class="input-group-addon">%</span>'+
                                                        '</div>';
                };
                unpaid_late_fee_calculated_waiver_percent = 100;
                waiver_late_fee_percent = unpaid_late_fee_calculated_waiver_percent;
                form_waiver = '<div class="row" id="wiaver_form">' +
                                    '<div class="col-md-3 text-left">' +
                                        '<div class="center flex">' +
                                            '<label class="w170" style="font-weight:normal !important;">ptp amount</label>' +
                                            '<div class="input-group" style="width: 150px">' +
                                                '<span class="input-group-addon">Rp.</span>' +
                                                `<input type="text" class="form-control" maxlength="15" id="ptp_amount" name="ptp_amount_waiver" value="${addComma(ptp_amount)}" onkeyup="grayedOut('ptp_amount')">` +
                                            '</div>' +
                                            '<p></p>' +
                                        '</div>' +
                                        '<div class="center flex">' +
                                            '<label class="w170" style="font-weight:normal !important;">Jumlah angsuran</label>' +
                                            '<div class="input-group" style="width: 80px">' +
                                                `<input type="text" class="form-control" maxlength="15" id="total_installment_waived" name="total_installment_waived" value="${resultCalculation.total_installments_waived}" disabled>` +
                                            '</div>' +
                                            '<p></p>' +
                                        '</div>' +
                                        '<button class="btn btn-primary btn_calculate_waiver" id="btn_calculate_waiver" disabled>Calculate</button>' +
                                        '<button class="btn btn-warning" id="btn_reset" style="margin: 5%" disabled>reset</button>' +
                                    '</div>';

                tab_minimal_ptp_amount = '<div class="col-md-9" style="display: inline-flex;">' +
                                                '<table class="table table-bordered" style="display: block">' +
                                                    '<thead>'+
                                                        '<tr>'+
                                                            '<th class="align-middle" colspan="3" style="background-color: #AB8CE4; color: white">MIN.PTP AMOUNT</th>'+
                                                        '</tr>'+
                                                        '<tr style="height: 77px">'+
                                                            '<th class="align-middle"></th>'+
                                                            '<th class="align-middle">Melunasi angsuran jatuh tempo</th>'+
                                                            '<th class="align-middle hide-for-r4">Melunasi angsuran yang dipilih</th>'+
                                                        '</tr>' +
                                                    '</thead>' +
                                                    '<tbody>' +
                                                            '<tr style="height: 77px">'+
                                                                `<td class="align-middle">${wording_waiver.min_ptp_amount.recommended[offer[1]]} [${recommended_waiver_percentage}%]</td>` +
                                                                `<td class="align-middle" id="recommended_interest_waiver">${numberWithCommas(recommended_interest_waiver)}</td>` +
                                                                '<td class="align-middle hide-for-r4" id="selected_recommended_waiver"></td>' +
                                                            '</tr>'+
                                                            '<tr style="height: 77px">'+
                                                                `<td class="align-middle" id="wording_actual_waiver">${wording_waiver.min_ptp_amount.actual[offer[1]]} [${actual_waiver_percentage}%]</td>` +
                                                                `<td class="align-middle" id="actual_principal_waiver">${numberWithCommas(actual_principal_waiver)}</td>` +
                                                                '<td class="align-middle hide-for-r4" id="selected_actual_waiver"></td>' +
                                                            '</tr>' +
                                                            '<tr style="height: 77px">'+
                                                                `<td class="align-middle">${wording_waiver.min_ptp_amount.repayment[offer[1]]}</td>` +
                                                                `<td class="align-middle" id="principal_waiver">${offer[1] == 'r4' ? parseFloat(principal_waiver) * 100 : numberWithCommas(principal_waiver)}${offer[1] == 'r4' ? '%' : ''}</td>` +
                                                                '<td class="align-middle hide-for-r4" id="selected_100_waiver"></td>' +
                                                            '</tr>' +
                                                    '</tbody>' +
                                                '</table>';

                perbandingan_waiver = '<table class="table table-bordered" style="display: block">' +
                                                    '<thead>'+
                                                        '<tr>'+
                                                            '<th class="align-middle" colspan="3" style="background-color: #7455C4; color: white">Perbandingan Waiver %</th>'+
                                                        '</tr>'+
                                                        '<tr style="height: 77px">'+
                                                            '<th class="align-middle"></th>'+
                                                            '<th class="align-middle">Recommended</th>'+
                                                            '<th class="align-middle">Actual</th>'+
                                                        '</tr>' +
                                                    '</thead>' +
                                                    '<tbody>' +
                                                            '<tr id="waiver_recommendation_late_fee" style="height: 77px">'+
                                                                '<td class="align-middle">Late fee waiver</td>' +
                                                                `<td class="align-middle">${parseFloat(waiver_recommendation.late_fee_waiver_percentage) * 100}%</td>` +
                                                                `<td class="align-middle" id="actual_late_fee_percentage">${parseFloat(actual_waiver.late_fee_waiver_percentage) * 100}%</td>` +
                                                            '</tr>'+
                                                            '<tr id="waiver_recommendation_interest" style="height: 77px">'+
                                                                '<td class="align-middle">Interest waiver</td>' +
                                                                `<td class="align-middle">${parseFloat(waiver_recommendation.interest_waiver_percentage) * 100}%</td>` +
                                                                `<td class="align-middle" id="actual_interest_percentage">${parseFloat(actual_waiver.interest_waiver_percentage) * 100}%</td>` +
                                                            '</tr>' +
                                                            '<tr id="waiver_recommendation_principal" style="height: 77px">'+
                                                                '<td class="align-middle">Principal waiver</td>' +
                                                                `<td class="align-middle">${parseFloat(waiver_recommendation.principal_waiver_percentage) * 100}%</td>` +
                                                                `<td class="align-middle" id="actual_principal_percentage">${parseFloat(actual_waiver.principal_waiver_percentage) * 100}%</td>` +
                                                            '</tr>' +
                                                    '</tbody>' +
                                                '</table>' +
                                            '</div>' +
                                    '</div>';
                table2 = '<div id="wiaver_table_2" style="margin-top: 2%;display: flex; overflow-x: auto; ">';
                outstanding_amount = ()=> {
                                                let table_head = '<div><table id="outstanding_amount_table" class="table table-bordered" style="display:none;">' +
                                                    '<thead>'+
                                                        '<tr>'+
                                                            '<th class="align-middle" colspan="5" style="background-color: #AB8CE4; color: white">Outstanding amount</th>'+
                                                        '</tr>'+
                                                        '<tr style="height: 78px">'+
                                                            '<th class="align-middle">Jatuh tempo</th>'+
                                                            '<th class="align-middle">Principal</th>'+
                                                            '<th class="align-middle">Interest</th>'+
                                                            '<th class="align-middle">Late fee</th>'+
                                                            '<th class="align-middle">Need to pay</th>'+
                                                        '</tr>' +
                                                    '</thead>' +
                                                    '<tbody>';
                                                let table_body = ''
                                                        for (let i = 0; i < resultCalculation['outstanding_amount']['payments'].length ; i++){
                                                            table_body += '<tr style="height: 65px">'+
                                                                `<td class="align-middle">${payments[i].due_status}</td>` +
                                                                `<td class="align-middle">${payments[i].outstanding <= 0 ? "-" : numberWithCommas(resultCalculation["outstanding_amount"]["payments"][i].principal)}</td>` +
                                                                `<td class="align-middle">${payments[i].outstanding <= 0 ? "-" : numberWithCommas(resultCalculation["outstanding_amount"]["payments"][i].interest)}</td>` +
                                                                `<td class="align-middle">${payments[i].outstanding <= 0 ? "-" : numberWithCommas(resultCalculation["outstanding_amount"]["payments"][i].late_fee)}</td>` +
                                                                `<td class="align-middle">${payments[i].outstanding <= 0 ? "-" : numberWithCommas(resultCalculation["outstanding_amount"]["payments"][i].need_to_pay)}</td>` +
                                                            '</tr>';
                                                        }

                                                let table_end = '</tbody>' +
                                                                '<tfoot>'+
                                                                        '<tr>'+
                                                                            '<td class="align-middle"></td>'+
                                                                            `<td class="align-middle"><b>${numberWithCommas(resultCalculation["outstanding_amount"].principal_total)}</b></td>`+
                                                                            `<td class="align-middle"><b>${numberWithCommas(resultCalculation["outstanding_amount"].interest_total)}</b></td>`+
                                                                            `<td class="align-middle"><b>${numberWithCommas(resultCalculation["outstanding_amount"].late_fee_total)}</b></td>`+
                                                                            `<td class="align-middle"><b>${numberWithCommas(resultCalculation["outstanding_amount"].total_need_to_pay)}</b></td>`+
                                                                        '</tr>'+
                                                                    '</tfoot>' +
                                                                '</table></div>';
                                                return table_head + table_body + table_end;
                                                }
                waiver_amount = () => {
                                                    let table_head = '<div><table class="table table-bordered" id="waiver_amount_table">' +
                                                                        '<thead>'+
                                                                            '<tr>'+
                                                                                '<th class="align-middle" colspan="6" style="background-color: #7455C4; color: white"><span style="align-items: flex-start; margin-left: -35%"><span class="glyphicon glyphicon-backward outstanding_amount_table-backward" onclick="expandTable(\'outstanding_amount_table\')" aria-hidden="true"></span><span style="display: none;" class="glyphicon glyphicon-forward outstanding_amount_table-forward" onclick="expandTable(\'outstanding_amount_table\')" aria-hidden="true"></span></span><span style="margin-left: 35%">Waiver amount</span></th>'+
                                                                            '</tr>'+
                                                                            '<tr style="height: 78px;">'+
                                                                                '<th class="align-middle">payment</th>'+
                                                                                '<th class="align-middle">Principal</th>'+
                                                                                `<th class="align-middle">apply ${wording_waiver.header_table_waiver[offer[1]]} waiver</th>`+
                                                                                '<th class="align-middle">Interest</th>'+
                                                                                '<th class="align-middle">Late fee</th>'+
                                                                                '<th class="align-middle">total_waiver</th>'+
                                                                            '</tr>' +
                                                                        '</thead>';
                                                    let table_body =  ''
                                                    for (let i = 0; i < resultCalculation['waiver_amount']['payments'].length ; i++){
                                                        table_body += '<tr style="height: 65px;">'+
                                                            `<td class="align-middle">${resultCalculation["waiver_amount"]['payments'][i].payment_number}</td>` +
                                                            '<td class="align-middle waiver_principal_cell">' +
                                                                '<div class="center flex">' +
                                                                            '<div class="input-group">' +
                                                                                '<span class="input-group-addon">Rp.</span>' +
                                                                                `<input type="text" class="form-control mask waiver-amount principal-waiver" maxlength="15" id="waiver_principal_${payments[i].payment_id}" name="waiver-principal-${payments[i].payment_id}" value="${payments[i].outstanding <= 0 ? '-' : addComma(resultCalculation['waiver_amount']['payments'][i].principal)}" style="width: 100px" onkeyup="grayedOut('cell_waiver_amount')" ${payments[i].outstanding <= 0 || offer[1] != 'r4' ? "disabled" : ""} >` +
                                                                            '</div>' +
                                                                            '<p></p>' +
                                                                '</div>' +
                                                            '</td>' +
                                                            `<td class="align-middle waiver_checkbox_cell">` +
                                                                    `<label>` +
                                                                      `<input class="waiver-checkbox" style="width: 65px;" type="checkbox" id="waiver_check_${payments[i].payment_id}" name="waiver_checkbox[]" data-index="${i}" value="${payments[i].payment_id}" onchange="grayedOut('waiver_checkbox')" ${payments[i].outstanding <= 0 || offer[1] == 'r4' ? 'disabled' : ''}>` +
                                                                    `</label>` +
                                                            '</td>' +
                                                            '<td class="align-middle waiver_interest_cell">' +
                                                                '<div class="center flex">' +
                                                                            '<div class="input-group">' +
                                                                                '<span class="input-group-addon">Rp.</span>' +
                                                                                `<input type="text" class="form-control mask waiver-amount interest-waiver" maxlength="15" id="waiver_interest_${payments[i].payment_id}" name="waiver-interest-${payments[i].payment_id}" value="${payments[i].outstanding <= 0 ? '-' : addComma(resultCalculation['waiver_amount']['payments'][i].interest)}" style="width: 100px" onkeyup="grayedOut('cell_waiver_amount')" ${payments[i].outstanding <= 0 || offer[1] != 'r6' ? "disabled" : ""}>` +
                                                                            '</div>' +
                                                                            '<p></p>' +
                                                                '</div>' +
                                                            '</td>' +
                                                            '<td class="align-middle waiver_late_fee_cell">' +
                                                                '<div class="center flex">' +
                                                                            '<div class="input-group">' +
                                                                                '<span class="input-group-addon">Rp.</span>' +
                                                                                `<input type="text" class="form-control mask waiver-amount late-fee-waiver" maxlength="15" id="waiver_late_fee_${payments[i].payment_id}" name="waiver-late_fee-${payments[i].payment_id}" value="${payments[i].outstanding <= 0 ? '-' : addComma(resultCalculation['waiver_amount']['payments'][i].late_fee)}" style="width: 100px" onkeyup="grayedOut('cell_waiver_amount')" ${payments[i].outstanding <= 0 || offer[1] != 'r5' ? "disabled" : ""}>` +
                                                                            '</div>' +
                                                                            '<p></p>' +
                                                                '</div>' +
                                                            '</td>' +
                                                            `<td class="align-middle">${payments[i].outstanding <= 0 ? "-" : numberWithCommas(resultCalculation["waiver_amount"]["payments"][i].total_waiver)}</td>` +
                                                        '</tr>';
                                                    }
                                                     let table_end = '</tbody>' +
                                                                    '<tfoot>'+
                                                                        '<tr>'+
                                                                            '<td class="align-middle"></td>'+
                                                                            `<td class="align-middle"><b>${numberWithCommas(resultCalculation["waiver_amount"].principal_total)}</b></td>`+
                                                                            '<td class="align-middle"></td>'+
                                                                            `<td class="align-middle"><b>${numberWithCommas(resultCalculation["waiver_amount"].interest_total)}</b></td>`+
                                                                            `<td class="align-middle"><b>${numberWithCommas(resultCalculation["waiver_amount"].late_fee_total)}</b></td>`+
                                                                            `<td class="align-middle"><b></b></td>`+
                                                                        '</tr>'+
                                                                    '</tfoot>' +
                                                                    '</table></div>';
                                                    return table_head + table_body + table_end
                                                    }
                remaining_installments = () => {
                                                    let tableHead = '<div><table id="remaining_installments_table" class="table table-bordered">' +
                                                                        '<thead>'+
                                                                            '<tr>'+
                                                                                '<th class="align-middle" colspan="5" style="background-color: #7455C4; color: white">Sisa angsuran</th>'+
                                                                            '</tr>'+
                                                                            '<tr style="height: 78px">'+
                                                                                '<th class="align-middle">Principal</th>'+
                                                                                '<th class="align-middle">Interest</th>'+
                                                                                '<th class="align-middle">Late fee</th>'+
                                                                                '<th class="align-middle">sisa angsuran</th>'+
                                                                                '<th class="align-middle">paid off status</th>'+
                                                                            '</tr>' +
                                                                        '</thead>';
                                                    let tableBody = '<tbody>';
                                                    for (let idx in resultCalculation['remaining_installments']){
                                                        tableBody += '<tr style="height: 65px">'+
                                                                        `<td class="align-middle">${numberWithCommas(resultCalculation['remaining_installments'][idx].principal)}</td>` +
                                                                        `<td class="align-middle">${numberWithCommas(resultCalculation['remaining_installments'][idx].interest)}</td>` +
                                                                        `<td class="align-middle">${numberWithCommas(resultCalculation['remaining_installments'][idx].late_fee)}</td>` +
                                                                        `<td class="align-middle">${numberWithCommas(resultCalculation['remaining_installments'][idx].remaining_installment)}</td>` +
                                                                        `<td class="align-middle">${resultCalculation['remaining_installments'][idx].paid_off_status}</td>` +
                                                                    '</tr>';
                                                    }
                                                    let tableEnd = '</tbody>' +
                                                                    '<tfoot>'+
                                                                        '<tr>'+
                                                                            '<td class="align-middle"></td>'+
                                                                            '<td class="align-middle"></td>'+
                                                                            `<td class="align-middle"></td>`+
                                                                            `<td class="align-middle" id="total_remaining_installments"><b>${numberWithCommas(resultCalculation['total_remaining_installments'])}</b></td>`+
                                                                            `<td class="align-middle"></td>`+
                                                                        '</tr>'+
                                                                    '</tfoot>'
                                                                   '</table></div>';
                                                    return tableHead + tableBody + tableEnd
                                                    }
                table2_end = '</div>'

{#                var tab = tab_begin + tab_head + tab_body + tab_end#}
                var tab = form_waiver + tab_minimal_ptp_amount + perbandingan_waiver + table2 + outstanding_amount() + waiver_amount() + remaining_installments() + table2_end;
                $("#div_header_txt").html('Perhitungan Waiver');
                $("#div_simulasi_head").show();
                $("#div_simulasi_details").html(tab);
                $("#ptp_amount").maskMoney({thousands:',', decimal:'.', allowZero: true, suffix: '', precision:0});
                $("#div_simulasi_details").show();
                $('#loading-div_simulasi').hide();
                selected_payments_waived = null;
                setColumnWaiver();
                checkWaiverPercentage();
                thickApplyWaiver();
                $('#div_waiver_request_submit').show();
                selected_payments_waived = $("input[name='waiver_checkbox[]']:checked").map(function () {
                    return this.value;
                }).get();
                $("#selected_recommended_waiver").text(numberWithCommas(resultCalculation.selected_recommended_waiver));
                $("#selected_actual_waiver").text(numberWithCommas(resultCalculation.selected_actual_waiver));
                $("#selected_100_waiver").text(numberWithCommas(resultCalculation.selected_100_waiver));

                if (offer[1] == 'r4') {
                    $(".hide-for-r4").hide();
                } else {
                    $(".hide-for-r4").show();
                }
            } else {
                $('#loading-div_simulasi').show();
                $('#is_covid_risky_div').hide();
                $.ajax({
                    url: "{%url 'loan_refinancing:ajax_covid_refinancing_calculate_offer_simulation' %}", // the endpoint
                    type: "POST", // http method
                    data: {
                        csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
                        loan_id: parseInt(loan_id),
                        selected_offer_recommendation: offer[1],
                        new_income: new_income,
                        new_expense: new_expense,
                        tenure_extension: parseInt($('#tenure_extension').val()),
                        new_employment_status: $('#employment_status').val()
                    }, // data sent with the post request
                    // handle a successful response
                    success: function (json) {
                        if(json.status == 'success') {
                            if (json.data) {
                                var tab_begin = '<table class="table table-bordered">';
                                if (offer[1] == 'r1' || offer[1] == 'r2') {
                                    col_head = 'Late Fee';
                                } else {
                                    col_head = 'Admin Fee';
                                }
                                var tab_head = '<thead>'+
                                                    '<tr>'+
                                                        '<th class="align-middle"> Payment# </th>'+
                                                        '<th class="align-middle"> Tgl jatuh tempo </th>'+
                                                        '<th class="align-middle"> Tgl dibayar </th>'+
                                                        '<th class="align-middle"> Telah jatuh tempo? </th>'+
                                                        '<th class="align-middle"> Principal </th>'+
                                                        '<th class="align-middle"> Interest </th>'+
                                                        '<th class="align-middle"> '+col_head+' </th>'+
                                                        '<th class="align-middle"> Total </th>'+
                                                        '<th class="align-middle"> Terbayar </th>'+
                                                        '<th class="align-middle"> Outstanding </th>'+
                                                    '</tr>'+
                                                '</thead>';
                                var tab_body = '<tbody>';
                                for(i = 0; i < json.data.simulated_payments.length; i++) {
                                    var str = json.data.simulated_payments[i]['due_date'];
                                    if (str == '-')
                                        var due_date = str
                                    else
                                        var due_date = str.replace(/-/g, " ");

                                    var str1 = json.data.simulated_payments[i]['paid_date'];
                                    if (str1 == '-')
                                        var paid_date = str1
                                    else
                                        var paid_date = str1.replace(/-/g, " ");

                                    tab_body+= '<tr>'+
                                                    '<td class="align-middle">'+ json.data.simulated_payments[i]['payment_number'] +'</td>'+
                                                    '<td class="align-middle">'+ due_date +'</td>'+
                                                    '<td class="align-middle">'+ paid_date +'</td>'+
                                                    '<td class="align-middle">'+ json.data.simulated_payments[i]['due_status'] +'</td>'+
                                                    '<td class="align-middle">'+ numberWithCommas(json.data.simulated_payments[i]['installment_principal']) +'</td>'+
                                                    '<td class="align-middle">'+ numberWithCommas(json.data.simulated_payments[i]['installment_interest']) +'</td>'+
                                                    '<td class="align-middle">'+ numberWithCommas(json.data.simulated_payments[i]['installment_late_fee']) +'</td>'+
                                                    '<td class="align-middle">'+ numberWithCommas(json.data.simulated_payments[i]['total_installment_amount']) +'</td>'+
                                                    '<td class="align-middle">'+ numberWithCommas(json.data.simulated_payments[i]['paid_amount']) +'</td>'+
                                                    '<td class="align-middle" style="background:yellow">'+ numberWithCommas(json.data.simulated_payments[i]['outstanding']) +'</td>'+
                                                '</tr>';
                                }
                                tab_body+= '</tbody>';
                                var tab_footer = '<tfoot>'+
                                                    '<tr>'+
                                                        '<td class="align-middle">  </td>'+
                                                        '<td class="align-middle">  </td>'+
                                                        '<td class="align-middle">  </td>'+
                                                        '<td class="align-middle">  </td>'+
                                                        '<td class="align-middle"><b>'+ numberWithCommas(json.data.total_principal) +'</b></td>'+
                                                        '<td class="align-middle"><b>'+ numberWithCommas(json.data.total_interest) +'</b></td>'+
                                                        '<td class="align-middle"><b>'+ numberWithCommas(json.data.total_late_fee) +'</b></td>'+
                                                        '<td class="align-middle"><b>'+ numberWithCommas(json.data.total_all_installment_amount) +'</b></td>'+
                                                        '<td class="align-middle"><b>'+ numberWithCommas(json.data.total_paid_amount) +'</b></td>'+
                                                        '<td class="align-middle" style="background:yellow"><b>'+ numberWithCommas(json.data.total_outstanding_amount) +'</b></td>'+
                                                    '</tr>'+
                                                '</tfoot>';
                                var tab_end = '</table>';
                                if (waiver_refinancing_program.includes(offer[1])){
                                    const expandableTableOutstanding =  '<table id="outstanding-amount-table" class="table table-bordered" align="left">'
                                                                            '<thead>'+
                                                                                '<tr>'+
                                                                                    '<th class="align-middle"> Payment# </th>'+
                                                                                    '<th class="align-middle"> Tgl jatuh tempo </th>'+
                                                                                    '<th class="align-middle"> Tgl dibayar </th>'+
                                                                                    '<th class="align-middle"> Telah jatuh tempo? </th>'+
                                                                                    '<th class="align-middle"> Principal </th>'+
                                                                                    '<th class="align-middle"> Interest </th>'+
                                                                                    '<th class="align-middle"> '+col_head+' </th>'+
                                                                                    '<th class="align-middle"> Total </th>'+
                                                                                    '<th class="align-middle"> Terbayar </th>'+
                                                                                    '<th class="align-middle"> Outstanding </th>'+
                                                                                '</tr>'+
                                                                            '</thead>'
                                                                        '</table>'
                                }
                                var tab= tab_begin + tab_head + tab_body +  tab_footer + tab_end
                                $("#div_header_txt").html('Simulasi offer');
                                $("#div_simulasi_head").show();
                                $("#div_simulasi_details").html(tab);
                                $("#div_simulasi_details").show();
                                $("#cp_head").show();
                                $("#cp_table").show();
                                $('#cp_loan_id').text(loan_id);
                                $('#cp_covid_product').text(offer[0]);
                                $('#cp_tenure_extension').text($('#tenure_extension').val());
                                $('#cp_new_income').text(numberWithCommas($('#new_income').val()));
                                $('#cp_new_expense').text(numberWithCommas($('#new_expense').val()));
                                $('#cp_employment_status').text($('#employment_status').val());
                                $('#cp_email').text($('#customer_email').text());
                            } else {
                                ToastDanger('Failure', 'No Simulasi offer');
                            }
                            $('#loading-div_simulasi').hide();
                        } else {
                            ToastDanger('Failure', 'No Simulasi offer');
                            $('#loading-div_simulasi').hide();
                        }
                    },
                     // handle a non-successful response
                    error: function (xhr, errmsg, err) {
                        ToastDanger('Failure', "Mohon maaf. Silakan coba lagi", 1);
                        $('#loading-div_simulasi').hide();
                        console.log(xhr.responseText);
                    }
                })
            }
        }
    }
});

function thickApplyWaiver(){
    $(".waiver-checkbox").prop('checked', false);
    if ($("#pilihan_offer").val()!= "" && $("#pilihan_offer").val() != null) {
        var offer = $('#pilihan_offer').val().split("|");
    }
    if($("input[name='selected_offer_recommendation']:checked").val()) {
        var offer = $("input[name='selected_offer_recommendation']:checked").val().split("|");
    }

    force_payment = false;
    already_checked = true;
    if (offer[1] != 'r4') {
        force_payment = true;
        already_checked = false;
        for (let idx in payments){
            if (offer[1] == 'r5' && payments[idx].remaining_late_fee > 0 && payments[idx].due_status == "Y" ||
                offer[1] == 'r6' && payments[idx].remaining_late_fee > 0 && payments[idx].due_status == "Y" ||
                offer[1] == 'r6' && payments[idx].remaining_interest > 0 && payments[idx].due_status == "Y"){
                force_payment = false;
                already_checked = true;
            }
        }
    }

    for (let idx in payments){
        if (selected_payments_waived){
            if (selected_payments_waived.includes(payments[idx].payment_id)){
                $(`#waiver_check_${payments[idx].payment_id}`).prop('checked', true);
            } else {
                $(`#waiver_check_${payments[idx].payment_id}`).prop('checked', false);
            }
        } else {
            due_status = "Y";
            if (force_payment) {
                if (!already_checked) {
                    due_status = "N"
                }
            }
            if (payments[idx].outstanding > 0 && offer[1] == 'r4' ||
                offer[1] == 'r5' && payments[idx].remaining_late_fee > 0 && payments[idx].due_status == due_status ||
                offer[1] == 'r6' && payments[idx].remaining_late_fee > 0 && payments[idx].due_status == due_status ||
                offer[1] == 'r6' && payments[idx].remaining_interest > 0 && payments[idx].due_status == due_status){
                $(`#waiver_check_${payments[idx].payment_id}`).prop('checked', true);
                force_payment = false;
                already_checked = true;
            } else {
                $(`#waiver_check_${payments[idx].payment_id}`).prop('checked', false);
            }
        }
    }
}

function checkWaiverPercentage(){
    if ($("#pilihan_offer").val()!= "" && $("#pilihan_offer").val() != null) {
        var offer = $('#pilihan_offer').val().split("|");
    }
    if($("input[name='selected_offer_recommendation']:checked").val()) {
        var offer = $("input[name='selected_offer_recommendation']:checked").val().split("|");
    }

    if (offer[1] == 'r4') {
        const html = '<td class="align-middle">' +
                        '<div class="center flex">' +
                                    '<div class="input-group">' +
                                        `<input type="text" class="form-control actual-waiver-percentage" maxlength="15" id="actual_principal_percentage" name="actual_principal_percentage" value="${parseFloat(actual_waiver.principal_waiver_percentage) * 100}" onkeyup="grayedOut('actual_waiver')" data-actual="${parseFloat(actual_waiver.principal_waiver_percentage)}">` +
                                        '<span class="input-group-addon">%</span>' +
                                    '</div>' +
                                    '<p></p>' +
                        '</div>' +
                    '</td>';
        $("#waiver_recommendation_principal :last-child").remove();
        $("#waiver_recommendation_principal").append(html);
    } else if (offer[1] == 'r6') {
        const html = '<td class="align-middle">' +
                        '<div class="center flex">' +
                                    '<div class="input-group">' +
                                        `<input type="text" class="form-control actual-waiver-percentage" maxlength="15" id="actual_interest_percentage" name="actual_interest_percentage" value="${parseFloat(actual_waiver.interest_waiver_percentage) * 100}" onkeyup="grayedOut('actual_waiver')" data-actual="${parseFloat(actual_waiver.interest_waiver_percentage)}">` +
                                        '<span class="input-group-addon">%</span>' +
                                    '</div>' +
                                    '<p></p>' +
                        '</div>' +
                    '</td>';
        $("#waiver_recommendation_interest :last-child").remove();
        $("#waiver_recommendation_interest").append(html);
    } else if (offer[1] == 'r5') {
        const html = '<td class="align-middle">' +
                        '<div class="center flex">' +
                                    '<div class="input-group">' +
                                        `<input type="text" class="form-control actual-waiver-percentage" maxlength="15" id="actual_late_fee_percentage" name="actual_late_fee_percentage" value="${parseFloat(actual_waiver.late_fee_waiver_percentage) * 100}" onkeyup="grayedOut('actual_waiver')" data-actual="${parseFloat(actual_waiver.late_fee_waiver_percentage)}">` +
                                        '<span class="input-group-addon">%</span>' +
                                    '</div>' +
                                    '<p></p>' +
                        '</div>' +
                    '</td>';
        $("#waiver_recommendation_late_fee :last-child").remove();
        $("#waiver_recommendation_late_fee").append(html);
    }
}

$('.actual-waiver-percentage').on("change", function() {
    if ($("#pilihan_offer").val()!= "" && $("#pilihan_offer").val() != null) {
        var offer = $('#pilihan_offer').val().split("|");
    }
    if($("input[name='selected_offer_recommendation']:checked").val()) {
        var offer = $("input[name='selected_offer_recommendation']:checked").val().split("|");
    }
    actual_waiver_principal_percentage = parseFloat($('#actual_principal_percentage').text()) / 100;
    actual_waiver_late_fee_percentage = parseFloat($('#actual_late_fee_percentage').text()) / 100;
    actual_waiver_interest_percentage = parseFloat($('#actual_interest_percentage').text()) / 100;
    if (offer[1] == 'r4') {
        actual_waiver_principal_percentage = parseFloat($('#actual_principal_percentage').val()) / 100;
    } else if (offer[1] == 'r5') {
        actual_waiver_late_fee_percentage = parseFloat($('#actual_late_fee_percentage').val()) / 100;
    } else if (offer[1] == 'r6') {
        actual_waiver_interest_percentage = parseFloat($('#actual_interest_percentage').val()) / 100;
    }

})

function getActualWaiverPercentage() {
    if ($("#pilihan_offer").val()!= "" && $("#pilihan_offer").val() != null) {
        var offer = $('#pilihan_offer').val().split("|");
    }
    if($("input[name='selected_offer_recommendation']:checked").val()) {
        var offer = $("input[name='selected_offer_recommendation']:checked").val().split("|");
    }
    actual_waiver_principal_percentage = parseFloat($('#actual_principal_percentage').text()) / 100;
    actual_waiver_late_fee_percentage = parseFloat($('#actual_late_fee_percentage').text()) / 100;
    actual_waiver_interest_percentage = parseFloat($('#actual_interest_percentage').text()) / 100;
    if (offer[1] == 'r4') {
        actual_waiver_principal_percentage = parseFloat($('#actual_principal_percentage').val()) / 100;
    } else if (offer[1] == 'r5') {
        actual_waiver_late_fee_percentage = parseFloat($('#actual_late_fee_percentage').val()) / 100;
    } else if (offer[1] == 'r6') {
        actual_waiver_interest_percentage = parseFloat($('#actual_interest_percentage').val()) / 100;
    }

}

function expandTable(tableName){
    $("#" + tableName).toggle();
    $("." + tableName + "-backward").toggle();
    $("." + tableName + "-forward").toggle();
}

function numberWithCommas(x) {
    num = x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    if (num == '-')
        formatted_num = '-';
    else
        formatted_num = 'Rp. ' + num;
    return formatted_num;
}

function addComma(x) {
    num = x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return num
}

$(".btn_generate").click(function() {
  str = '';
  for (i = 0; i <= 6; i++) {
     if (i == 4 || i == 5)  {
        str+= $.trim($(this).parents('tr').prev().children().eq(i).text()).replace(/Rp. |,/g, "")+ '\t';
     } else {
        str+= $.trim($(this).parents('tr').prev().children().eq(i).text()) + '\t';
     }
  }
  let text = document.createElement('input');
  text.setAttribute('type', 'text');
  text.value = str;
  document.body.appendChild(text);
  text.select();
  document.execCommand('copy');
  document.body.removeChild(text);
  ToastSuccess('Success', 'Data copied successfully');
});
$(".mask").maskMoney({thousands:',', decimal:'.', allowZero: true, suffix: '', precision:0});
function getCellByCellWaiverAmount() {
    let cellWaiverAmounts = {
        late_fee: {},
        interest: {},
        principal: {},
        total_late_fee: 0,
        total_interest: 0,
        total_principal: 0,
        waiver_amount_total: 0,
    }
    let selectedProgram = 'principal'
    if (offer[1] == 'r5') {
        selectedProgram = 'late_fee'
    } else if (offer[1] == 'r6') {
        selectedProgram = ['interest', 'late_fee']
    }

    for (let i = 0; i < selected_payments_waived.length ; i++){
        let principalValue = $(`#waiver_principal_${selected_payments_waived[i]}`).map(function () {
                                                return this.value;
                                            }).get()[0].replace(/,/g, '');
        cellWaiverAmounts['principal'][`${selected_payments_waived[i]}`] = (parseInt(principalValue | 0))
        cellWaiverAmounts.total_principal += (parseInt(principalValue | 0))
        let interestValue = $(`#waiver_interest_${selected_payments_waived[i]}`).map(function () {
                                                return this.value;
                                            }).get()[0].replace(/,/g, '');
        cellWaiverAmounts['interest'][`${selected_payments_waived[i]}`] = (parseInt(interestValue | 0))
        cellWaiverAmounts.total_interest += (parseInt(interestValue | 0))
        let lateFeeValue = $(`#waiver_late_fee_${selected_payments_waived[i]}`).map(function () {
                                                return this.value;
                                            }).get()[0].replace(/,/g, '');
        cellWaiverAmounts['late_fee'][`${selected_payments_waived[i]}`] = (parseInt(lateFeeValue | 0))
        cellWaiverAmounts.total_late_fee += (parseInt(lateFeeValue | 0))
    }
    cellWaiverAmounts.waiver_amount_total = cellWaiverAmounts.total_principal + cellWaiverAmounts.total_interest + cellWaiverAmounts.total_late_fee;
    return cellWaiverAmounts
}
$('body').on('click','#btn_calculate_waiver', function() {
    ptp_amount = parseInt($("#ptp_amount").val().replace(/,/g, ''));
    if ($("#ptp_amount").val() == '') {
        ToastDanger('Failure', 'Please enter PTP Amount (setelah waiver)');
    } else if ($("#ptp_amount").val() == 0) {
        ToastDanger('Failure', 'PTP Amount tidak boleh diisi dengan 0');
    }  else {
        if (!$("#pilihan_offer").val() && !$("input[name='selected_offer_recommendation']:checked").val()) {
            ToastDanger('Failure', 'Please choose Rekomendasi Offer or Pilihan Offer Lainnya');
        } else {
            $("#is_multiple_ptp_payment").prop("checked", false).trigger("change");
            $('#error_pop_up').modal('hide');
            $("#btn_calculate_waiver").prop("disabled", true);
            $('#waiver_validation').empty()
            if ($("#pilihan_offer").val()!= "" && $("#pilihan_offer").val() != null) {
                var offer = $('#pilihan_offer').val().split("|");
            }
            if($("input[name='selected_offer_recommendation']:checked").val()) {
                var offer = $("input[name='selected_offer_recommendation']:checked").val().split("|");

            }
            selected_payments_waived = $("input[name='waiver_checkbox[]']:checked").map(function () {
                                        return this.value;
                                    }).get();
            $("#ptp_amount").prop('disabled', false);
            $("#principal_waiver").css('background', 'white');
            $("#btn_show_note_modal").prop("disabled", false);
            $("#selected_recommended_waiver").text('')
            $("#selected_recommended_waiver").css('background', 'white')
            $("#selected_actual_waiver").text('')
            $("#selected_actual_waiver").css('background', 'white')
            $("#selected_100_waiver").text('')
            $("#selected_100_waiver").css('background', 'white')
            let cellByCellWaiverAmount = getCellByCellWaiverAmount()
            let waiver_actual_percentage = {
                principal_waiver: parseFloat($("#actual_principal_percentage").text()) / 100,
                interest_waiver: parseFloat($("#actual_interest_percentage").text()) / 100,
                late_fee_waiver: parseFloat($("#actual_late_fee_percentage").text()) /100
            }
            let waiver_recommended_percentage = {
                principal_waiver: parseFloat(waiver_recommendation.principal_waiver_percentage),
                interest_waiver: parseFloat(waiver_recommendation.interest_waiver_percentage),
                late_fee_waiver: parseFloat(waiver_recommendation.late_fee_waiver_percentage)
            }
            if (offer[1] == 'r4'){
                waiver_actual_percentage.principal_waiver = parseFloat($("#actual_principal_percentage").attr("data-actual"));
            } else if (offer[1] == 'r5'){
                waiver_actual_percentage.late_fee_waiver = parseFloat($("#actual_late_fee_percentage").attr("data-actual"));
            } else if (offer[1] == 'r6'){
                waiver_actual_percentage.interest_waiver = parseFloat($("#actual_interest_percentage").attr("data-actual"));
            }
            let remainingAmount = {
                remaining_principal: remainingPrincipal,
                remaining_interest: remainingInterest,
                remaining_late_fee: remainingLateFee,
            }
            let resultRecalculateWaiver = recalculateWaiver(resultCalculation, offer[1], cellByCellWaiverAmount, remainingAmount, net_due_amt, selected_payments_waived, ptp_amount, waiver_actual_percentage, payments, waiver_recommended_percentage)
            resultCalculation = resultRecalculateWaiver.tab_waiver_calculation
            waiver_outstanding_amount = resultCalculation.outstanding_amount.total_need_to_pay
            $("#wiaver_table_2").empty();
            var tab = outstanding_amount() + waiver_amount() + remaining_installments()
            checkWaiverPercentage()
            $("#wiaver_table_2").html(tab);
            setColumnWaiver();
            thickApplyWaiver();
            $("#ptp_amount").val(addComma(resultRecalculateWaiver.ptp_amount));
            $("#total_installment_waived").val(selected_payments_waived.length);
            let actualPercentage = (resultRecalculateWaiver.waiver_actual_percentage * 100).toFixed(2).replace(".00", "");
            let realActualPercentage = resultRecalculateWaiver.real_waiver_actual_percentage;
            let recommendedPercentage = null;
            if (offer[1] == 'r4') {
                recommendedPercentage = waiver_recommended_percentage.principal_waiver;
                $("#actual_principal_percentage").val(actualPercentage);
                $("#actual_principal_percentage").attr("data-actual", realActualPercentage);
                actual_waiver_principal_percentage = resultRecalculateWaiver.waiver_actual_percentage;
                actualPercentage = resultRecalculateWaiver.waiver_actual_percentage;
            } else if (offer[1] == 'r5') {
                recommendedPercentage = waiver_recommended_percentage.late_fee_waiver;
                $("#actual_late_fee_percentage").val(actualPercentage);
                $("#actual_late_fee_percentage").attr("data-actual", realActualPercentage);
                actual_waiver_late_fee_percentage = resultRecalculateWaiver.waiver_actual_percentage;
                actualPercentage = resultRecalculateWaiver.waiver_actual_percentage;
            } else if (offer[1] == 'r6') {
                recommendedPercentage = waiver_recommended_percentage.interest_waiver;
                $("#actual_interest_percentage").val(actualPercentage);
                $("#actual_interest_percentage").attr("data-actual", realActualPercentage);
                actual_waiver_interest_percentage = resultRecalculateWaiver.waiver_actual_percentage;
                actualPercentage = resultRecalculateWaiver.waiver_actual_percentage;
            }
            $("#wording_actual_waiver").text(wording_waiver.min_ptp_amount.actual[offer[1]] + " [" + (actualPercentage * 100).toFixed(2).replace(".00", "") + "%]");
            $("#actual_principal_waiver").text(numberWithCommas(resultCalculation.min_actual));
            $("#principal_waiver").text(offer[1] == 'r4' ? ((parseFloat(resultCalculation.min_paid_off) * 100).toFixed(2).replace(".00", "") + '%') : numberWithCommas(resultCalculation.min_paid_off));
            $("#recommended_interest_waiver").text(numberWithCommas(resultCalculation.min_recommended));
            $("#selected_recommended_waiver").text(numberWithCommas(resultRecalculateWaiver.selected_recommended_waiver));
            $("#selected_actual_waiver").text(numberWithCommas(resultRecalculateWaiver.selected_actual_waiver));
            $("#selected_100_waiver").text(numberWithCommas(resultRecalculateWaiver.selected_100_waiver));
            let disableSubmitButton = false;
            validationWaiverPercentage(recommendedPercentage, actualPercentage);
            if (offer[1] == 'r4' && validationPtpAmount(resultRecalculateWaiver.ptp_amount, resultCalculation.min_actual, resultCalculation.min_paid_off, resultCalculation.total_remaining_installments)){
                disableSubmitButton = true;
            } else if (offer[1] != 'r4' && validationPTPAmountforR5andR6(resultRecalculateWaiver.ptp_amount, resultRecalculateWaiver.selected_actual_waiver)) {
                disableSubmitButton = true;
            }
            $("#btn_show_note_modal").prop("disabled", disableSubmitButton);

            if (offer[1] == 'r4') {
                $(".hide-for-r4").hide();
                // it's magic
                if (waiver_actual_percentage.principal_waiver != realActualPercentage) {
                    $('#btn_calculate_waiver').prop("disabled", false);
                    $('#btn_calculate_waiver').trigger("click");
                }
            } else {
                $(".hide-for-r4").show();
            }
        }
    }

});

function validationWaiverPercentage(recommendedPercentage, actualPercentage){
    if ( parseFloat(actualPercentage) > parseFloat(recommendedPercentage) ) {
        let html = '<div style="border-top: solid #E2574C; background-color: #FDEFEE; color: #E2574C"><p>Waiver request anda diluar rekomendasi SOP dan akan bergantung pada approval atasan anda</p></div>';
        $('#waiver_validation').html(html);
    }
}

function validationPTPAmountforR5andR6(ptpAmount, actualInterestWaiver) {
    if (!selected_payments_waived.includes(payments[payments.length - 1].payment_id)) {
        return false;
    }
    let result = false;
    if (ptpAmount > actualInterestWaiver) {
        let html = `<div style="border-top: solid #E2574C; background-color: #FDEFEE; color: #E2574C"><p>PTP Amount yang diisi harus LEBIH KECIL atau SAMA DENGAN ${numberWithCommas(actualInterestWaiver)}.` +
                    ` </p></div>`;
        $('#waiver_validation').html(html);
        result = true;
    }
    return result;
}

function validationPtpAmount(ptpAmount, actualWaiver, minPaidOff, totalRemainingInstallments) {
    let result = false;
    if ( ptpAmount <  actualWaiver ) {
        let html = `<div style="border-top: solid #E2574C; background-color: #FDEFEE; color: #E2574C"><p>Waiver tidak dapat di-submit karena masih ada sisa angsuran sebesar ${numberWithCommas(totalRemainingInstallments)}.` +
                    ` Mohon naikkan PTP amount menjadi IDR ${actualWaiver} atau naikkan Actual Waiver percentage menjadi` +
                    ` ${minPaidOff * 100}%</p></div>`;
        $('#waiver_validation').html(html);
        result = true;
    }
    return result;
}

function setColumnWaiver(){
    $('.principal-waiver').each(function(){
        let valueCell = $(this).val()
        if ( parseInt(valueCell) <= 0 || valueCell == '-') {
            $(this).parent().parent().hide()
            $(this).parent().parent().parent().append('-')
        }
    })
    $('.interest-waiver').each(function(){
        let valueCell = $(this).val()
        if ( parseInt(valueCell) <= 0 || valueCell == '-') {
            $(this).parent().parent().hide()
            $(this).parent().parent().parent().append('-')
        }
    })
    $('.late-fee-waiver').each(function(){
        let valueCell = $(this).val()
        if ( parseInt(valueCell) <= 0 || valueCell == '-') {
            $(this).parent().parent().hide()
            $(this).parent().parent().parent().append('-')
        }
    })
}

function unset_values() {
    /*$('#pop_msg').html('Jumlah pembayaran is 0');
    $('#error_pop_up').modal('show');*/
    ToastDanger('Failure', 'Jumlah pembayaran is 0');
    $('#jumlah_pembayaran').text('');
    $('#perhitungan_waiver_outstanding_amt').text('');
    $('#perhitungan_waiver_unpaid_late_fee').text('');
    $('#perhitungan_waiver_min_ptp_amount').text('');
    $('#unpaid_late_fee_calculated_waiver_percent').text('');
    $('#unpaid_late_fee_calculated_waiver_amount').text('');
    $('#perhitungan_waiver_unpaid_interest').text('');
    $('#unpaid_interest_recommended_waiver_percent').text('');
    $('#recommended_interest_waiver_amount').text('');
    $('#unpaid_interest_calculated_waiver_percent').text('');
    $('#unpaid_interest_calculated_waiver_amount').text('');
    $('#div_waiver_request_submit').hide();
}

$('body').on('change','#pilihan_offer',function() {
    if ($("#pilihan_offer").val()!= "") {
        max_extension = default_max_extension
        $("#recommendation_offer_extension").hide();
        $("#recommendation_offer_extension p").empty();
        var pilihan_offer = $('#pilihan_offer').val().split("|");
        if(pilihan_offer[1] == 'r4' || pilihan_offer[1] == 'r5' || pilihan_offer[1] == 'r6') {
            $("#waiver_validity_date_div").show();
            $("#tenure_extension_div").hide();
        } else {
            $("#waiver_validity_date_div").hide();
            $("#tenure_extension_div").show();
            if(pilihan_offer[1] == 'r1'){
                max_extension = maxExtension
                $("#recommendation_offer_extension").show();
                let textTenureExtension = max_extension != 1 ? `tersedia pilihan 1 - ${max_extension} bulan` : `tersedia pilihan 1 bulan`
                $("#recommendation_offer_extension p").text(textTenureExtension);
            }
        }
        selected_offer = pilihan_offer[1];
        $("input[name='selected_offer_recommendation']:radio").prop( "checked", false );
    } else {
        $("#waiver_validity_date_div").hide();
        $("#tenure_extension_div").hide();
        selected_offer = '';
    }
    $('#waiver_validity_date').val('');
    $('#loading-div_simulasi').hide();
});

$('body').on('change','.selected_offer_recommendation',function() {
    if($("input[name='selected_offer_recommendation']:checked").val()) {
        $("#recommendation_offer_extension").hide();
        offer = $("input[name='selected_offer_recommendation']:checked").val().split("|");
        max_extension = default_max_extension
        if(offer[1] == 'r4' || offer[1] == 'r5' || offer[1] == 'r6') {
            $("#waiver_validity_date_div").show();
            $("#tenure_extension_div").hide();
        } else {
            if(offer[1] == 'r1' && recommendedExtension != 0){
                max_extension = maxExtension
            }
            check_tenure_extension(offer[0]);
            $("#waiver_validity_date_div").hide();
            $("#tenure_extension_div").show();
        }
        selected_offer = offer[1];
        $("#pilihan_offer").prop("selectedIndex", 0).val();
    } else {
        selected_offer = '';
        $("#waiver_validity_date_div").hide();
        $("#tenure_extension_div").hide();
    }
    $('#waiver_validity_date').val('');
    $('#loading-div_simulasi').hide();
});
function round_numbers(num) {
    if (!Number.isInteger(num)) {
       num = num.toFixed(0);
    }
    return num
}
function round_numbers_percent(num) {
    if (!Number.isInteger(num)) {
       num = num.toFixed(2);
    }
    return num
}
jQuery('.datepicker, #waiver_validity_date').datepicker({
    format: 'dd M yyyy',
    buttonClasses: ['btn', 'btn-sm'],
    applyClass: 'btn-danger',
    cancelClass: 'btn-inverse',
    dateLimit: {
    days: 6
    },
    autoclose: true,
    startDate:'+0d',
    endDate:'+90d',
    todayHighlight: true,
    todayBtn: "linked",
});
$('#waiver_validity_date').on('changeDate', function(e){
   $('#waiver_validity_date_db').val(moment(e.date).format('YYYY-MM-DD'));
    ptp_payment_message = $(".multiple-ptp-payment-message");
    if (get_validity_date_diff() > 40) {
        ptp_payment_message.show();
        ptp_payment_message.attr("data-previous", "show");
    } else {
        ptp_payment_message.hide();
        ptp_payment_message.attr("data-previous", "hide");
    }
});

$(document).on('change', 'input[name="waiver_checkbox[]"]', function() {
      selected_payments_waived = $("input[name='waiver_checkbox[]']:checked").map(function () {
                                        return this.value;
                                    }).get();
    $("#btn_show_note_modal").prop("disabled", false);
    $("#btn_calculate_waiver").prop("disabled", false);
    last_index = -1;
    $("input[name='waiver_checkbox[]']:checked").each(function(index, elm){
        if (last_index >= 0 && (last_index + 1 != $(elm).attr("data-index"))) {
            ToastDanger('Failure', 'Payment yang dipilih harus berurutan', 1);
            $("#btn_show_note_modal").prop("disabled", true);
            $("#btn_calculate_waiver").prop("disabled", true);
        }
        last_index = parseInt($(elm).attr("data-index"));
    });
});

$("#btn_show_note_modal").click(function() {
    let actualWaiverPercentage = null;
    let recommendedWaiverPercentage = null;
    if (selected_program_name == 'r4') {
        actualWaiverPercentage = parseFloat($('#actual_principal_percentage').val());
        recommendedWaiverPercentage = parseFloat(waiver_recommendation.principal_waiver_percentage) * 100;
    } else if (selected_program_name == 'r5') {
        actualWaiverPercentage = parseFloat($('#actual_late_fee_percentage').val());
        recommendedWaiverPercentage = parseFloat(waiver_recommendation.late_fee_waiver_percentage) * 100;
    } else if (selected_program_name == 'r6') {
        actualWaiverPercentage = parseFloat($('#actual_interest_percentage').val());
        recommendedWaiverPercentage = parseFloat(waiver_recommendation.interest_waiver_percentage) * 100;
    }
    let textModal = 'Apakah anda yakin untuk submit waiver ini?'
    if (actualWaiverPercentage > recommendedWaiverPercentage) {
        textModal = 'Waiver request anda di luar rekomendasi SOP, Apakah anda yakin untuk submit waiver ini'
    }
    $("#text_agent_note").text(textModal)
    $("#agent_notes_modal").modal('show')
});

$("#agent_note").keyup(function() {
    if (this.value != '') {
        $("#btn_waiver_request_submit").prop("disabled", false);
    } else {
        $("#btn_waiver_request_submit").prop("disabled", true);
    }
});

function getSelectedPayments(){
    selected_payments_waived_details = {outstanding: [], waiver: [], remaining: []};
    for (let idx in resultCalculation.waiver_amount.payments){
        if (selected_payments_waived.includes(resultCalculation.waiver_amount.payments[idx].payment_id)){
            for (let key in selected_payments_waived) {
                if (selected_payments_waived[key] == resultCalculation.waiver_amount.payments[idx].payment_id) {
                    selected_payments_waived_details.waiver.push(resultCalculation.waiver_amount.payments[idx])
                    selected_payments_waived_details.outstanding.push(resultCalculation.outstanding_amount.payments[idx])
                    selected_payments_waived_details.remaining.push(resultCalculation.remaining_installments[idx])
                    selected_principal_amount += resultCalculation.waiver_amount.payments[idx].principal;
                    selected_interest_amount += resultCalculation.waiver_amount.payments[idx].interest;
                    selected_late_fee_amount += resultCalculation.waiver_amount.payments[idx].late_fee;
                    selected_outstanding_amount += parseInt(payments[idx].outstanding);
                    waiver_unpaid_interest_amount += parseInt(payments[idx].remaining_interest);
                    waiver_unpaid_principal_amount += parseInt(payments[idx].remaining_principal);
                    waiver_unpaid_late_fee_amount += parseInt(payments[idx].remaining_late_fee);
                    selected_remaining_amount_waived += resultCalculation.remaining_installments[idx].principal + resultCalculation.remaining_installments[idx].interest + resultCalculation.remaining_installments[idx].late_fee;
                }
            }
        }
    }
}

$("#btn_waiver_request_submit").click(function() {
    agent_notes = $("#agent_note").val().trim();
    if (agent_notes == "") {
        ToastDanger('Failure', 'Agent note harus diisi');
        return;
    }
    getActualWaiverPercentage()
    coms_status = check_comms(2)
    selected_program_name = selected_program_name;
    let totalRemainingInstallments = parseInt($('#total_remaining_installments').text())
    let actualWaiver = parseInt($('#actual_principal_waiver').text().replace(/[^\d]/g, ''))
    ptp_amount = parseInt($('#ptp_amount').val().replace(/,/g, ''));
    let actualsPercentage = actual_waiver_principal_percentage;
    if (selected_program_name == 'r6') {
        actualsPercentage = actual_waiver_interest_percentage
    } else if (selected_program_name == 'r5') {
        actualsPercentage = actual_waiver_late_fee_percentage
    }
    if (selected_program_name == 'r4' && totalRemainingInstallments > 0) {
        ToastDanger('Failure', `Waiver tidak dapat di-submit karena masih ada sisa angsuran sebesar ${totalRemainingInstallments}. Mohon naikkan PTP amount menjadi IDR ${ptp_amount - actualWaiver} atau naikkan Actual Principal Waiver percentage menjadi`, 1);
    } else if(actualsPercentage <= 0 || actualsPercentage >= 100) {
        ToastDanger('Failure', `Waiver percentage harus LEBIH BESAR dari 0% dan LEBIH KECIL dari 100%`, 1);
    } else if (validateWaiverAmount()) {
        ToastDanger('Failure', 'Waiver Amount untuk payment ID yang di-tick harus lebih besar dari 0', 1);
    } else if (validateWaiverAmountNotGreaterThanOutstanding()){
        ToastDanger('Failure', `Waiver Amount Principal/Interest/Late Fee yang di-input harus kurang dari outstanding principal/interest/late fee untuk payment ID tersebut`, 1);
    } else if (validateWaiverAmountNotGreaterThanPrevious()) {
        ToastDanger('Failure', `Waiver Amount untuk payment sebelumnya harus >= dari payment setelahnya`, 1);
    } else if (validateMultiplePtpPaymentCheckbox()) {
        ToastDanger('Failure', 'Bagian "Customer akan membayarkan PTP dalam beberapa kali angsuran" harus di centang', 1);
    } else if(coms_status == true) {
        bucket_name = bucket;
        loan_id = loan_id;
        is_covid_risky_bool = is_covid_risky;
        if(is_covid_risky_bool == 'yes') {
            is_covid_risky_bool = 'True'
        } else {
            is_covid_risky_bool = 'False'
        }
        waiver_validity_date = $('#waiver_validity_date_db').val();
        reason = $('#employment_status').val();
        ptp_amount = parseInt($('#ptp_amount').val().replace(/,/g, ''));
        is_automated = true;
        getSelectedPayments()
        is_customer_confirmed = $('#is_customer_confirmed_waiver').prop("checked");
        requested_late_fee_waiver_percentage = $('#actual_late_fee_percentage').text().replace(/%/g, '');
        requested_interest_waiver_percentage = $('#actual_interest_percentage').text().replace(/%/g, '');
        requested_principal_waiver_percentage = $('#actual_principal_percentage').text().replace(/%/g, '');
        outstanding_amount = selected_outstanding_amount;
        requested_waiver_amount = selected_principal_amount + selected_interest_amount + selected_late_fee_amount;
        unpaid_principal = waiver_unpaid_principal_amount;
        unpaid_interest = waiver_unpaid_interest_amount;
        unpaid_late_fee = waiver_unpaid_late_fee_amount;
        if (selected_program_name == 'r4') {
            unpaid_payment_count = unpaid_payment_count_r4;
            waiver_last_unpaid_payment_number = unpaid_last_payment_number_r4;
            recommended_unpaid_waiver_percentage = parseFloat(waiver_recommendation.principal_waiver_percentage);
            calculated_unpaid_waiver_percentage = parseFloat($('#actual_principal_percentage').val()) / 100;
            if (calculated_unpaid_waiver_percentage > recommended_unpaid_waiver_percentage) {
                is_automated = false;
            }
            requested_principal_waiver_percentage = $('#actual_principal_percentage').val();
        } else if (selected_program_name == 'r5') {
            unpaid_payment_count = waiver_jumlah_pembayaran;
            waiver_last_unpaid_payment_number = waiver_last_unpaid_payment_number;
            recommended_unpaid_waiver_percentage = parseFloat(waiver_recommendation.late_fee_waiver_percentage);
            calculated_unpaid_waiver_percentage = parseFloat($('#actual_late_fee_percentage').val()) / 100;
            if (calculated_unpaid_waiver_percentage > recommended_unpaid_waiver_percentage) {
                is_automated = false;
            }
            requested_late_fee_waiver_percentage = $('#actual_late_fee_percentage').val();
        } else {
            unpaid_payment_count = waiver_jumlah_pembayaran;
            waiver_last_unpaid_payment_number = waiver_last_unpaid_payment_number;
            recommended_unpaid_waiver_percentage = parseFloat(waiver_recommendation.interest_waiver_percentage);
            calculated_unpaid_waiver_percentage = parseFloat($('#actual_interest_percentage').val()) / 100;
            if (calculated_unpaid_waiver_percentage > recommended_unpaid_waiver_percentage) {
                is_automated = false;
            }
            requested_interest_waiver_percentage = $('#actual_interest_percentage').val();
        }

        $.ajax({
            url: "{%url 'loan_refinancing:ajax_covid_refinancing_submit_waiver_request' %}", // the endpoint
            type: "POST", // http method
            data: {
                csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
                loan_id: parseInt(loan_id),
                is_covid_risky: is_covid_risky_bool,
                selected_program_name: selected_program_name,
                waiver_validity_date: waiver_validity_date,
                bucket_name: bucket_name,
                reason: reason,
                ptp_amount: ptp_amount,
                outstanding_amount: outstanding_amount,
                unpaid_principal: unpaid_principal,
                unpaid_interest: unpaid_interest,
                unpaid_late_fee: unpaid_late_fee,
                unpaid_payment_count: unpaid_payment_count,
                recommended_unpaid_waiver_percentage: recommended_unpaid_waiver_percentage,
                calculated_unpaid_waiver_percentage: calculated_unpaid_waiver_percentage,
                is_automated: is_automated,
                new_income: new_income,
                new_expense: new_expense,
                comms_channels: generate_comms_data(2),
                is_customer_confirmed: is_customer_confirmed,
                partner_product: partner_product,
                requested_late_fee_waiver_percentage: requested_late_fee_waiver_percentage,
                requested_interest_waiver_percentage: requested_interest_waiver_percentage,
                requested_principal_waiver_percentage: requested_principal_waiver_percentage,
                requested_late_fee_waiver_amount: selected_late_fee_amount,
                requested_interest_waiver_amount: selected_interest_amount,
                requested_principal_waiver_amount: selected_principal_amount,
                requested_waiver_amount: requested_waiver_amount,
                remaining_amount_for_waived_payment: selected_remaining_amount_waived,
                waiver_recommendation_id: parseInt(waiver_recommendation.id),
                first_waived_payment: parseInt(selected_payments_waived[0]),
                last_waived_payment: selected_payments_waived.length > 1 ? parseInt(selected_payments_waived[selected_payments_waived.length - 1]) : parseInt(selected_payments_waived[0]),
                agent_notes: agent_notes,
                waived_payment_count: parseInt(selected_payments_waived.length),
                outstanding_principal_amount: outstandingPrincipal,
                outstanding_interest_amount: outstandingInterest,
                outstanding_late_fee_amount: outstandingLateFee,
                selected_payments_waived: JSON.stringify(selected_payments_waived_details),
                is_multiple_ptp_payment: is_multiple_ptp_payment_input,
                number_of_multiple_ptp_payment: number_of_multiple_ptp_payment,
                multiple_payment_ptp: JSON.stringify(multiple_payment_ptp),
            }, // data sent with the post request
            // handle a successful response
            success: function (json) {
                msg = '<span style="line-height:24px">'+json.message+'</span>';

                if(json.status == 'success') {
                    swal({
                        title: "Sukses!",
                        html: true,
                        text: msg,
                        type: "success",
                        showCancelButton: false,
                        confirmButtonColor: "#7cd1f9",
                        confirmButtonText: "OK",
                        closeOnConfirm: true,
                    });
                    $('#contain_div').hide();
                    $('.refinancing_status_layout').hide();
                } else{
                    negative_response_swal(msg);
                }
            },
             // handle a non-successful response
            error: function (xhr, errmsg, err) {
                msg = '<span style="line-height:24px">Mohon maaf. Silakan coba lagi</span>';
                negative_response_swal(msg);
                console.log(xhr.responseText);
            }
        })

    } else {
        ToastDanger('Failure', "Please select preferensi channel reminder");
        console.log(xhr.responseText);
    }
});
function generate_offer(is_auto_populated=false) {
    $('#existing_offer_pop_up').modal('hide');
    score_status = calculate_score();
    refinancing_offers = [];
    if (is_auto_populated==false){
        $('#submit_product').show();
        $('input[name="comms_channel1"]').prop('disabled', false);
        $('input[name="comms_channel1"]').prop('checked', false);
        $('input[name="is_customer_confirmed_reactive"]').prop('checked', false);
        $('#btn_refinancing_submit').show();
        $('#btn_retrigger_notification').hide();
        $('#offer_selected').hide();
    };
    if(score_status) {
         $.ajax({
                url: "{%url 'loan_refinancing:ajax_generate_reactive_refinancing_offer' %}", // the endpoint
                type: "POST", // http method
                data: {
                    csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
                    new_income: new_income,
                    new_expense: new_expense,
                    new_employment_status: $('#employment_status').val(),
                    recommendation_offer_products: customer_recommended_product,
                    loan_id: parseInt(loan_id),
                    is_auto_populated:is_auto_populated
                }, // data sent with the post request
                // handle a successful response
                success: function (json) {
                    if(json.status == 'success') {
                        let data = json.data
                        refinancing_offers = data.refinancing_offers;
                        $("#div_offer_recommend").show();
                        show_hide_divs_right(true);
                        if(is_auto_populated==true && data.selected_refinancing_offers != ''){
                            selected_refinancing_offer = JSON.parse(data.selected_refinancing_offers);
                            product = selected_refinancing_offer.product_type + "|" + selected_refinancing_offer.product_type.toLowerCase();
                            $('#tenure_extension').val(selected_refinancing_offer.loan_refinancing_request__loan_duration);
                            $('.selected_offer_recommendation[value="'+ product +'"]').prop('checked', true).attr('extension_value',selected_refinancing_offer.loan_refinancing_request__loan_duration);
                            $('#pilihan_offer').val(product);
                            $('#submit_product').trigger('click').hide();
                            $('input[name="comms_channel1"][value="'+selected_refinancing_offer.loan_refinancing_request__comms_channel_1+'"]').prop('checked', true);
                            if(selected_refinancing_offer.loan_refinancing_request__comms_channel_1 != null){
                                $('input[name="comms_channel1"][value="'+selected_refinancing_offer.loan_refinancing_request__comms_channel_1+'"]').prop('disabled', 'disabled');
                            };
                            $('input[name="comms_channel1"][value="'+selected_refinancing_offer.loan_refinancing_request__comms_channel_2+'"]').prop('checked', true);
                            if(selected_refinancing_offer.loan_refinancing_request__comms_channel_2 != null){
                                $('input[name="comms_channel1"][value="'+selected_refinancing_offer.loan_refinancing_request__comms_channel_2+'"]').prop('disabled', 'disabled');
                            };
                            $('input[name="comms_channel1"][value="'+selected_refinancing_offer.loan_refinancing_request__comms_channel_3+'"]').prop('checked', true);
                            if(selected_refinancing_offer.loan_refinancing_request__comms_channel_3 != null){
                                $('input[name="comms_channel1"][value="'+selected_refinancing_offer.loan_refinancing_request__comms_channel_3+'"]').prop('disabled', 'disabled');
                            };
                            $('#is_customer_confirmed_reactive').prop('checked', true);
                            $('#btn_refinancing_submit').hide();
                            if (selected_refinancing_offer.product_type == 'R4' || selected_refinancing_offer.product_type == 'R5' || selected_refinancing_offer.product_type == 'R6'){
                                $("#waiver_validity_date_div").show();
                                $('#waiver_validity_date').datepicker("setStartDate", data.datepicker_start_date);
                                let waiverValidityDate = data.waiver_validity.split('-');
                                $('#waiver_validity_date').datepicker("setDate", new Date(parseInt(waiverValidityDate[0]), parseInt(waiverValidityDate[1]-1), parseInt(waiverValidityDate[2])))
                                $('#waiver_validity_date_db').val(`${waiverValidityDate[0]}-${waiverValidityDate[1]}-${waiverValidityDate[2]}`);
                                waiver_payment_request = data.waiver_payment_request;
                                autoPopulateWaiver(waiver_payment_request);
                                $("#wiaver_table_2").empty();
                                let tab = outstanding_amount() + waiver_amount() + remaining_installments()
                                checkWaiverPercentage()
                                $("#wiaver_table_2").html(tab);
                                setColumnWaiver();
                                thickApplyWaiver();
                                $("#ptp_amount").val(addComma(data.ptp_amount));
                                $("#total_installment_waived").val(data.waived_payment_count);
                                $("#actual_principal_percentage").text(data.requested_principal_waiver_percentage);
                                $("#actual_late_fee_percentage").text(data.requested_late_fee_waiver_percentage);
                                $("#actual_interest_percentage").text(data.requested_interest_waiver_percentage);
                                if (selected_refinancing_offer.product_type == 'R4') {
                                    $("#actual_principal_percentage").val(data.requested_principal_waiver_percentage);
                                } else if (selected_refinancing_offer.product_type == 'R5') {
                                    $("#actual_late_fee_percentage").val(data.requested_late_fee_waiver_percentage);
                                } else if (selected_refinancing_offer.product_type == 'R6') {
                                    $("#actual_interest_percentage").val(data.requested_interest_waiver_percentage);
                                }
                                $('#tenure_extension_div').hide();
                                // it's magic
                                $('#btn_calculate_waiver').prop("disabled", false);
                                $('#btn_calculate_waiver').trigger("click");
                                new_ptp_amount = parseInt($('#ptp_amount').val().replace(/,/g, ''));
                                if (data.ptp_amount != new_ptp_amount) {
                                    $("#ptp_amount").val(addComma(data.ptp_amount)).trigger('keyup');
                                    $('#btn_calculate_waiver').trigger("click");
                                }
                            }

                            startDate = data.datepicker_start_date;
                            multiple_payment_ptp_auto_populate = data.multiple_payment_ptp;
                            if (multiple_payment_ptp_auto_populate.is_multiple_ptp_payment) {
                                $("#is_multiple_ptp_payment").prop("checked", true);
                                setMultiplePtpPaymentsData(true);
                                $("select[name=jumlah_angsuran_ptp_payment]").val("{{ number_of_multiple_ptp_payment }}").trigger('change');
                                multiple_payment_ptp_auto_populate.multiple_payment_ptp_data.forEach(function(multiple_payment_ptp_data){
                                    multiplePaymentDate = multiple_payment_ptp_data.promised_payment_date.split('-');
                                    date_key = '#multiple_payment_date_' + multiple_payment_ptp_data.sequence;
                                    $(date_key).datepicker("setDate", new Date(parseInt(multiplePaymentDate[0]), parseInt(multiplePaymentDate[1])-1, parseInt(multiplePaymentDate[2])));
                                    $(date_key + '_db').val(`${multiplePaymentDate[0]}-${multiplePaymentDate[1]}-${multiplePaymentDate[2]}`);
                                    $("input[name=multiple_ptp_amount_" + multiple_payment_ptp_data.sequence + "]").val(addComma(multiple_payment_ptp_data.promised_payment_amount)).trigger("change");
                                });
                                $("#btn_multiple_ptp_payment_submit").trigger("click");
                            }
                        };
                        if (data.recommended_extension == 0){
                            $("#r1_offer_recommendation").hide();
                        } else {
                            max_extension = data.max_tenure_extension
                            recommendedExtension = data.recommended_extension
                        }
                        maxExtension = data.max_tenure_extension
                        if (data.current_loan_refinancing_request_status != null){
                            refinancing = data.current_loan_refinancing_request_status;
                            $('#refinancing_status').text('Status: '+refinancing.current_loan_refinancing_status)
                            $('#tips').text(refinancing.tips)
                        }
                    } else {
                        ToastDanger('Failure', json.message);
                        show_hide_divs_right(false);
                        refinancing_offers = [];
                    };
                },
                 // handle a non-successful response
                error: function (xhr, errmsg, err) {
                    ToastDanger('Failure', "Mohon maaf. Silakan coba lagi.");
                    console.log(xhr.responseText);
                    show_hide_divs_right(false);
                }
         }).done(function(){
            if ($('.selected_offer_recommendation:checked').val() == 'R1|r1'){
                $('.selected_offer_recommendation:checked').trigger('change')
                $('#tenure_extension').val($('.selected_offer_recommendation:checked').attr('extension_value'))
            }
        })
    } else {
        ToastDanger('Failure', 'Something went wrong!!');
        show_hide_divs_right(false);
    }
}

function validateWaiverAmountNotGreaterThanPrevious(){
    return_value = false;
    previous = {"late_fee": 0, "interest": 0, "principal": 0};
    for (let idx in resultCalculation.waiver_amount.payments) {
        ["late_fee", "interest", "principal"].forEach(function(amount_type){
            amount = resultCalculation.waiver_amount.payments[idx][amount_type];
            if (idx > 0) {
                if (amount > 0 && previous[amount_type] > 0) {
                    if (resultCalculation.outstanding_amount.payments[idx-1][amount_type] >= resultCalculation.outstanding_amount.payments[idx][amount_type]) {
                        if (amount > 0 && amount > previous[amount_type] && amount < payments[idx]["remaining_" + amount_type]) {
                            return_value = true;
                        }
                    }
                }
            }
            previous[amount_type] = amount;
        });
    }
    return return_value;
}

function validateWaiverAmountNotGreaterThanOutstanding(){
    for (let idx in resultCalculation.waiver_amount.payments) {
        if (resultCalculation.waiver_amount.payments[idx].interest > payments[idx].remaining_interest) {
            return true;
        }
        if (resultCalculation.waiver_amount.payments[idx].principal > payments[idx].remaining_principal) {
            return true;
        }
        if (resultCalculation.waiver_amount.payments[idx].late_fee > payments[idx].remaining_late_fee) {
            return true;
        }
    }
    return false
}

function validateWaiverAmount(){
    for (let idx in resultCalculation.waiver_amount.payments) {
        if (selected_payments_waived.includes(resultCalculation.waiver_amount.payments[idx].payment_id)) {
            if (selected_program_name == 'r4') {
                if (parseInt(payments[idx].remaining_principal) > 0 && resultCalculation.waiver_amount.payments[idx].principal <= 0) {
                    return true;
                }
            } else if (selected_program_name == 'r5') {
                if (parseInt(payments[idx].remaining_late_fee) > 0 && resultCalculation.waiver_amount.payments[idx].late_fee <= 0) {
                    return true;
                }
            } else if (selected_program_name == 'r6') {
                waiverInterestAndLateFee = [
                    parseInt(payments[idx].remaining_interest) > 0 && resultCalculation.waiver_amount.payments[idx].interest <= 0,
                    parseInt(payments[idx].remaining_late_fee) > 0 && resultCalculation.waiver_amount.payments[idx].late_fee <= 0
                ]
                if ( waiverInterestAndLateFee.includes(true) ) {
                    return true;
                }
            }
        }
    }
    return false;
}

function autoPopulateWaiver(waiverPaymentsRequest){
    selected_payments_waived = [];
    resultCalculation.waiver_amount.principal_total = 0
    resultCalculation.waiver_amount.interest_total = 0
    resultCalculation.waiver_amount.late_fee_total = 0
    resultCalculation.outstanding_amount.interest_total = 0
    resultCalculation.outstanding_amount.principal_total = 0
    resultCalculation.outstanding_amount.late_fee_total = 0
    resultCalculation.outstanding_amount.total_need_to_pay = 0

    for(let idx in waiverPaymentsRequest){
        if (waiverPaymentsRequest[idx] === null) {
            continue;
        }
        selected_payments_waived.push(String(waiverPaymentsRequest[idx].payment_id))
        resultCalculation.waiver_amount.payments[idx].interest = waiverPaymentsRequest[idx].requested_interest_waiver_amount
        resultCalculation.waiver_amount.payments[idx].principal = waiverPaymentsRequest[idx].requested_principal_waiver_amount
        resultCalculation.waiver_amount.payments[idx].late_fee = waiverPaymentsRequest[idx].requested_late_fee_waiver_amount
        resultCalculation.waiver_amount.payments[idx].total_waiver = waiverPaymentsRequest[idx].total_requested_waiver_amount
        resultCalculation.waiver_amount.principal_total += waiverPaymentsRequest[idx].requested_principal_waiver_amount
        resultCalculation.waiver_amount.interest_total += waiverPaymentsRequest[idx].requested_interest_waiver_amount
        resultCalculation.waiver_amount.late_fee_total += waiverPaymentsRequest[idx].requested_late_fee_waiver_amount

        resultCalculation.outstanding_amount.payments[idx].interest = waiverPaymentsRequest[idx].outstanding_interest_amount
        resultCalculation.outstanding_amount.payments[idx].principal = waiverPaymentsRequest[idx].outstanding_principal_amount
        resultCalculation.outstanding_amount.payments[idx].late_fee = waiverPaymentsRequest[idx].outstanding_late_fee_amount
        resultCalculation.outstanding_amount.payments[idx].need_to_pay = waiverPaymentsRequest[idx].outstanding_interest_amount + waiverPaymentsRequest[idx].outstanding_principal_amount + waiverPaymentsRequest[idx].outstanding_late_fee_amount
        resultCalculation.outstanding_amount.interest_total += waiverPaymentsRequest[idx].outstanding_interest_amount
        resultCalculation.outstanding_amount.principal_total += waiverPaymentsRequest[idx].outstanding_principal_amount
        resultCalculation.outstanding_amount.late_fee_total += waiverPaymentsRequest[idx].outstanding_late_fee_amount
        resultCalculation.outstanding_amount.total_need_to_pay += waiverPaymentsRequest[idx].outstanding_interest_amount + waiverPaymentsRequest[idx].outstanding_principal_amount + waiverPaymentsRequest[idx].outstanding_late_fee_amount

        resultCalculation.remaining_installments[idx].interest = waiverPaymentsRequest[idx].remaining_interest_amount
        resultCalculation.remaining_installments[idx].principal = waiverPaymentsRequest[idx].remaining_principal_amount
        resultCalculation.remaining_installments[idx].late_fee = waiverPaymentsRequest[idx].remaining_late_fee_amount
        resultCalculation.remaining_installments[idx].remaining_installment = waiverPaymentsRequest[idx].remaining_interest_amount + waiverPaymentsRequest[idx].remaining_principal_amount +waiverPaymentsRequest[idx].remaining_late_fee_amount
    }
}

function check_tenure_extension(product_type) {
    for(i=0; i < refinancing_offers.length; i++) {
        pr_type = refinancing_offers[i]['product_type'];
        loan_dur = refinancing_offers[i]['loan_duration'];
        if (product_type == pr_type) {
            if(product_type == 'R1' && recommendedExtension != 0){
                max_extension = maxExtension
                $("#recommendation_offer_extension").show();
                $('#tenure_extension').val(recommendedExtension);
                let textTenureExtension = max_extension != 1 ? `tersedia pilihan 1 - ${max_extension} bulan` : `tersedia pilihan 1 bulan`
                $("#recommendation_offer_extension p").text(textTenureExtension);
            }else{
                $('#tenure_extension').val(loan_dur);
                max_extension = default_max_extension
            }
            break;
        }
    }
}
function show_hide_divs_right(type) {
    if (type)  {
    } else {
        $("#div_simulasi_head").hide();
        $("#div_simulasi_details").hide();
        $("#cp_head").hide();
        $("#cp_table").hide();
        $("#div_offer_recommend").hide();
    }
}
$("#generate_offer").click(function() {
    not_allowed_products = null;
    show_hide_divs_right(false);
    $('#waiver_validity_date_div').hide();
    $('#tenure_extension_div').hide();
    $("#recommendation_offer_extension p").empty();
    new_income = parseInt($("#new_income").val().replace(/,/g, ''));
    new_expense = parseInt($("#new_expense").val().replace(/,/g, ''));
    if($('#employment_status').val() == '') {
        ToastDanger('Failure', 'Please select Status Pekerjaan Baru');
        return false;
    } else if(!new_income || new_income == 0) {
        ToastDanger('Failure', 'Please enter Pendapatan Baru');
        return false;
    } else if(!new_expense || new_expense == 0) {
        ToastDanger('Failure', 'Please enter Pengeluaran Baru');
        return false;
    } else if(new_income <= new_expense) {
        ToastDanger('Failure', 'Pendapatan Baru should be greater than Pengeluaran Baru');
        return false;
    } else {
        loan_id = loan_id;
        $.ajax({
            url: "{%url 'loan_refinancing:ajax_check_refinancing_request_status' %}", // the endpoint
            type: "POST", // http method
            data: {
                csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
                loan_id: parseInt(loan_id)
            }, // data sent with the post request
            // handle a successful response
            success: function (json) {
                if(json.status == 'success') {
                    response = json.response
                    not_allowed_products = response.not_allowed_products;
                    loan_refinancing_request_count = response.loan_refinancing_request_count
                    if (loan_refinancing_request_count == 0) {
                         generate_offer();
                    } else {
                        loan_refinancing_request_available_count = response.loan_refinancing_request_available_count;
                        loan_refinancing_generated_count = response.loan_refinancing_generated_count;
                        repeated_request = response.repeated_request
                        if (loan_refinancing_request_available_count == 1) {
                            refinancing_request_id = response.available_refinancing_request_id;
                            loan_refinancing_request_date = response.available_cdate;
                            loan_refinancing_product_type = response.available_product_type;
                            generate_offer();
                        } else if (loan_refinancing_generated_count == 1){
                            refinancing_request_id = response.generated_refinancing_request_id;
                            loan_refinancing_request_date = response.generated_cdate;
                            loan_refinancing_product_type = response.generated_product_type;
                            offer_generated_swal(refinancing_request_id, loan_refinancing_request_date);
                        } else if (repeated_request == 1){
                            refinancing_request_id = response.generated_refinancing_request_id;
                            loan_refinancing_request_date = response.generated_cdate;
                            loan_refinancing_product_type = response.generated_product_type;
                            repeated_offer_swal(response.existing_offers, true);
                        } else {
                            ToastDanger('Failure', "Mohon maaf. Silakan coba lagi.");
                            show_hide_divs_right(false);
                        }
                    }
                } else{
                    ToastDanger('Failure', "Mohon maaf. Silakan coba lagi.");
                    show_hide_divs_right(false);
                }
            },
             // handle a non-successful response
            error: function (xhr, errmsg, err) {
                ToastDanger('Failure', "Mohon maaf. Silakan coba lagi.");
                console.log(xhr.responseText);
                show_hide_divs_right(false);
            }
        })
    }
});

function negative_response_swal(msg) {
    swal({
      title: "Gagal!",
      html:true,
      text: msg,
      type: "error",
      showCancelButton: true,
      showConfirmButton: false,
      cancelButtonColor: "#ffffff",
      cancelButtonText: "Kembali",
      closeOnCancel: true
    });
}
function offer_generated_swal(refinancing_request_id, loan_refinancing_request_date) {
    msg = '<span style="line-height:24px"><strong>{{customer_name}} (ID: {{ application_id }})</strong> saat ini sedang berada pada tahap <strong>“Offer Generated”</strong>,' +
          'atau sudah pernah melakukan pemilihan program keringanan sebelumnya pada tanggal '+
          '<br/><strong>'+loan_refinancing_request_date+'</strong>. Apakah Anda yakin ingin membuat offer baru untuk customer ini?</span>';
    swal({
      title: "Sukses!",
      html:true,
      text: msg,
      type: "success",
      showCancelButton: true,
      confirmButtonColor: "#7cd1f9",
      confirmButtonText: "Ya",
      cancelButtonColor: "#ffffff",
      cancelButtonText: "Kembali",
      closeOnConfirm: true,
      closeOnCancel: true
    },
    function(isConfirm) {
      if (isConfirm) {
        if($('#employment_status').val() != '' && $("#new_income").val() !=""  && $("#new_expense").val() !="") {
            generate_offer();
        } else {
            $('#waiver_validity_date_div').hide();
            $('#tenure_extension_div').hide();
            show_hide_divs_right(false);
        }
      } else {
        show_hide_divs_right(false);
      }
    });
}

$('body').on('click', "#btn_reset", function() {
    is_multiple_ptp_payment_input = false;
    number_of_multiple_ptp_payment = 0;
    multiple_payment_ptp = null;
    selected_payments_waived = null
    $("#is_multiple_ptp_payment").prop("checked", false).trigger("change");
    $('#waiver_validation').empty()
    if (current_status == "Offer Generated" || current_status == "-"){
        $("#submit_product").click()
    } else if (current_status == 'Offer Selected'){
        generate_offer(true)
    }
});

$("#btn_offer_history").click(function() {
    $.ajax({
        url: "{%url 'loan_refinancing:ajax_get_exisiting_offers' %}",
        type: "POST",
        data: {
            csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
            loan_id: parseInt(loan_id)
        },
        success: function (json) {
            if(json.status == 'success') {
                response = json.response
                repeated_offer_swal(response.existing_offers);
            } else{
                ToastDanger('Failure', "Mohon maaf. Silakan coba lagi.");
                show_hide_divs_right(false);
            }
        },
         // handle a non-successful response
        error: function (xhr, errmsg, err) {
            ToastDanger('Failure', "Mohon maaf. Silakan coba lagi.");
            console.log(xhr.responseText);
            show_hide_divs_right(false);
        }
    });
});

function repeated_offer_swal(existing_offers, show_button=false) {
    if(existing_offers.length > 0){
        msg = ''
        for(var i = 0; i < existing_offers.length; i++) {
            var offer = existing_offers[i];
            if(offer.status == 'Activated'){
                status_class = 'success';
            }else if(offer.status == 'Expired'){
                status_class = 'danger';
            }else{
                status_class = 'warning';
            }
            var number = i+1 ;
            msg += '<tr>\
                        <td class="align-middle"> '+ number.toString() +' </td>\
                        <td class="align-middle"> '+ offer.product_type +' </td>\
                        <td class="align-middle"> '+ offer.request_date +' </td>\
                        <td class="align-middle"> '+ offer.principal_discount +' </td>\
                        <td class="align-middle"> '+ offer.interest_discount +' </td>\
                        <td class="align-middle"> '+ offer.latefee_discount +' </td>\
                        <td class="align-middle"> '+ offer.extension +' </td>\
                        <td class="align-middle '+ status_class +'"> '+ offer.status +' </td>\
                        <td class="align-middle"> '+ offer.prerequisite_amount +' </td>\
                        <td class="align-middle"> '+ offer.status_date +' </td>\
                        <td class="align-middle"> '+ offer.expire_date +' </td>\
                    </tr>';
        }

        $('#existing_offer_table_body').html(msg);
        if(show_button){
            button_html = '<button type="button" class="btn btn-primary waves-effect" onclick="generate_offer()">Generate Offer</button>\
            <button type="button" class="btn btn-default waves-effect" id="close_confirm_delete" data-dismiss="modal">Kembali</button>';
            post_script_html = '<p>Customer sudah mendapatkan keringanan sebelumnya.</p>\
                                <p>Apakah ingin memberikan keringanan kembali? </p>'
        }else{
            button_html = '';
            post_script_html = '';
        }
        $('#existing_offer_footer').html(button_html);
        $('#existing_offer_ps').html(post_script_html);
        $('#blank_existing_offer_content').hide();
        $('#existing_offer_content').show();
    }else{
        $('#blank_existing_offer_content').show();
        $('#existing_offer_content').hide();
    };
    $('#existing_offer_pop_up').modal('show');
}

function check_comms(type) {
    if(type == 1) {
        id = 'btn_refinancing_submit';
    } else {
        id = 'btn_waiver_request_submit';
    }
    if($('input[id="comms_channel'+type+'_1"]').is(":not(:checked)") && $('input[id="comms_channel'+type+'_2"]').is(":not(:checked)") && $('input[id="comms_channel'+type+'_3"]').is(":not(:checked)")) {
        $("#"+id).removeClass("btn-active").addClass("disabled btn-inactive");
        $("#"+id).attr("disabled", true);
        return false;
    } else {
        $("#"+id).removeClass("disabled btn-inactive").addClass("btn-active");
        $("#"+id).attr("disabled", false);
        return true;
    }
}
function generate_comms_data(type) {
    comms_channels = []
    $.each($("input[name='comms_channel"+type+"']:checked"), function(){
        comms_channels.push($(this).val());
    });
    return comms_channels.join();
}

$("#btn_refinancing_submit").click(function() {
    coms_status = check_comms(1)
    if(coms_status == true) {
        loan_id = loan_id;
        selected_product = $("#cp_covid_product").html()
        tenure_extension = parseInt($("#cp_tenure_extension").html())
        new_income = parseInt($('#cp_new_income').html().replace('Rp. ', '').replace(/,/g,''))
        new_expense = parseInt($('#cp_new_expense').html().replace('Rp. ', '').replace(/,/g,''))
        new_employment_status = $("#cp_employment_status").html()
        is_customer_confirmed = $('#is_customer_confirmed_reactive').prop("checked");

        $.ajax({
            url: "{%url 'loan_refinancing:ajax_covid_refinancing_submit_refinancing_request' %}", // the endpoint
            type: "POST", // http method
            dataType: "json",
            data: {
                csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
                loan_id: parseInt(loan_id),
                selected_product: selected_product,
                tenure_extension: tenure_extension,
                new_employment_status: new_employment_status,
                new_income: new_income,
                new_expense: new_expense,
                comms_channels: generate_comms_data(1),
                is_customer_confirmed: is_customer_confirmed
            }, // data sent with the post request
            // handle a successful response
            success: function (json) {
                if(json.status == true) {
                    msg = '<span style="line-height:24px">'+json.message+'</span>';
                     swal({
                      title: "Sukses!",
                      html:true,
                      text: msg,
                      type: "success",
                      confirmButtonColor: "#7cd1f9",
                      confirmButtonText: "Ya",
                      closeOnConfirm: true
                    },
                    function(isConfirm) {
                      if (isConfirm) {
                         $('#contain_div').hide();
                         $('.refinancing_status_layout').hide();
                      }
                    });
                } else{
                     msg = '<span style="line-height:24px">'+json.message+'</span>';
                     negative_response_swal(msg);
                }
            },
             // handle a non-successful response
            error: function (xhr, errmsg, err) {
                msg = '<span style="line-height:24px">Terjadi kesalahan pada koneksi</span>';
                negative_response_swal(msg);
                console.log(xhr.responseText);
            }
        })
    } else {
        ToastDanger('Failure', "Please select preferensi channel reminder");
        console.log(xhr.responseText);
    }
});

$("#btn_retrigger_notification").click(function() {
    comms_channel_1 = null
    comms_channel_2 = null
    comms_channel_3 = null
    if($('#comms_channel1_1').is(':checked')){
        comms_channel_1 = $('#comms_channel1_1').val()
    }
    if($('#comms_channel1_2').is(':checked')){
        comms_channel_2 = $('#comms_channel1_2').val()
    }
    if($('#comms_channel1_3').is(':checked')){
        comms_channel_3 = $('#comms_channel1_3').val()
    }
    loan_id = loan_id;
    $.ajax({
        url: "{%url 'loan_refinancing:ajax_retrigger_comms' %}", // the endpoint
        type: "POST", // http method
        dataType: "json",
        data: {
            csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
            loan_id: parseInt(loan_id),
            comms_channel_1:comms_channel_1,
            comms_channel_2:comms_channel_2,
            comms_channel_3:comms_channel_3,
        }, // data sent with the post request
        // handle a successful response
        beforeSend: function( xhr ) {
            $("#btn_retrigger_notification").text("Loading...").prop('disabled', 'disabled')
        },
        success: function (json) {
            if(json.status == true) {
                msg = '<span style="line-height:24px">'+json.message+'</span>';
                 swal({
                  title: "Sukses!",
                  html:true,
                  text: msg,
                  type: "success",
                  confirmButtonColor: "#7cd1f9",
                  confirmButtonText: "Ya",
                  closeOnConfirm: true
                },
                function(isConfirm) {
                  if (isConfirm) {
                  }
                });
                $('input[name="comms_channel1"][value="'+json.comms_channel_1+'"]').prop('disabled', 'disabled');
                $('input[name="comms_channel1"][value="'+json.comms_channel_2+'"]').prop('disabled', 'disabled');
                $('input[name="comms_channel1"][value="'+json.comms_channel_3+'"]').prop('disabled', 'disabled');
            } else{
                 msg = '<span style="line-height:24px">'+json.message+'</span>';
                 negative_response_swal(msg);
            }
        },
         // handle a non-successful response
        error: function (xhr, errmsg, err) {
            msg = '<span style="line-height:24px">Terjadi kesalahan pada koneksi</span>';
            negative_response_swal(msg);
            console.log(xhr.responseText);
        }
    })
        .done(function( data ) {
            $("#btn_retrigger_notification").text("Retrigger Notification").prop('disabled', false)
        });

});
$("#btn_retrigger_notification").hide()
current_status = '{{ current_loan_refinancing_status }}'
if ( '{{ is_auto_populated }}' == 'True'){
    $.ajax({
            url: "{%url 'loan_refinancing:ajax_check_refinancing_request_status' %}", // the endpoint
            type: "POST", // http method
            data: {
                csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
                loan_id: parseInt(loan_id)
            }, // data sent with the post request
            // handle a successful response
            success: function (json) {
                if(json.status == 'success') {
                    response = json.response
                    not_allowed_products = response.not_allowed_products;
                    generate_offer(true);
                    email_comms = $("input[name=comms_channel2][value=Email]");
                    {% if dpd > 90 %}
                    email_comms.attr("data-checked", true);
                    email_comms.prop("checked", true).trigger("change");
                    {% else %}
                    email_comms.attr("data-checked", false);
                    email_comms.prop("checked", false).trigger("change");
                    {% endif %}
                } else{
                    ToastDanger('Failure', "Mohon maaf. Silakan coba lagi.");
                    show_hide_divs_right(false);
                }
            },
             // handle a non-successful response
            error: function (xhr, errmsg, err) {
                ToastDanger('Failure', "Mohon maaf. Silakan coba lagi.");
                console.log(xhr.responseText);
                show_hide_divs_right(false);
            }
        })
    if(current_status == 'Offer Selected' || current_status == 'Approved'){
        $("#btn_retrigger_notification").show()
    }else{
        $('#tenure_extension_div').hide()
    }
}
function grayedOut(changeValue){
    $("#btn_calculate_waiver").prop("disabled", false);
    $("#btn_reset").prop("disabled", false);
    $("#btn_show_note_modal").prop("disabled", true);
    if (changeValue == 'ptp_amount'){
        $("#remaining_installments_table td").html('-')
        $("#remaining_installments_table td").css('background', 'lightgrey')
        $("#outstanding_amount_table td").html('-')
        $("#outstanding_amount_table td").css('background', 'lightgrey')
    } else if (changeValue == 'actual_waiver'){
        $('.waiver-amount').prop('disabled', true)
        $("#remaining_installments_table td").html('-')
        $("#remaining_installments_table td").css('background', 'lightgrey')
        $("#outstanding_amount_table td").html('-')
        $("#outstanding_amount_table td").css('background', 'lightgrey')
        $("#selected_recommended_waiver").text('-')
        $("#selected_recommended_waiver").css('background', 'lightgrey')
        $("#selected_actual_waiver").text('-')
        $("#selected_actual_waiver").css('background', 'lightgrey')
        $("#selected_100_waiver").text('-')
        $("#selected_100_waiver").css('background', 'lightgrey')
        if (selected_program_name == "r4") {
            percentInput = $("#actual_principal_percentage");
        } else if (selected_program_name == "r5") {
            percentInput = $("#actual_late_fee_percentage");
        } else if (selected_program_name == "r6") {
            percentInput = $("#actual_interest_percentage");
        }
        percentInput.attr("data-actual", percentInput.val() / 100);
    } else if (changeValue == 'cell_waiver_amount'){
        $("#ptp_amount").prop('disabled', true);
        $("#principal_waiver").css('background', 'lightgrey');
        $("#principal_waiver").text('');
        if (selected_program_name == 'r4'){
            $("#actual_principal_percentage").prop('disabled', true);
        } else if (selected_program_name == 'r5'){
            $("#actual_late_fee_percentage").prop('disabled', true);
        } else if (selected_program_name == 'r6'){
            $("#actual_interest_percentage").prop('disabled', true);
        }
        $("#selected_recommended_waiver").text('-')
        $("#selected_recommended_waiver").css('background', 'lightgrey')
        $("#selected_actual_waiver").text('-')
        $("#selected_actual_waiver").css('background', 'lightgrey')
        $("#selected_100_waiver").text('-')
        $("#selected_100_waiver").css('background', 'lightgrey')
        $("#remaining_installments_table td").html('-')
        $("#remaining_installments_table td").css('background', 'lightgrey')
        $("#outstanding_amount_table td").html('-')
        $("#outstanding_amount_table td").css('background', 'lightgrey')
    } else if(changeValue == 'waiver_checkbox') {
        $('.waiver-amount').prop('disabled', true)
        $("#remaining_installments_table td").html('-')
        $("#remaining_installments_table td").css('background', 'lightgrey')
        $("#outstanding_amount_table td").html('-')
        $("#outstanding_amount_table td").css('background', 'lightgrey')
        $("#selected_recommended_waiver").text('-')
        $("#selected_recommended_waiver").css('background', 'lightgrey')
        $("#selected_actual_waiver").text('-')
        $("#selected_actual_waiver").css('background', 'lightgrey')
        $("#selected_100_waiver").text('-')
        $("#selected_100_waiver").css('background', 'lightgrey')
    }
}
$(function () {
    // 6 create an instance when the DOM is ready
    $('#jstree').jstree();
    // 7 bind to events triggered on the tree
    $('#jstree').on("changed.jstree", function (e, data) {
    });
  });
if(is_julo_one){
    let msg = 'Mohon maaf untuk sementara loan dari Limit Kredit JULO tidak bisa dilakukan refinancing'
    swal({
      title: "",
      html:true,
      text: msg,
      type: "error",
      showCancelButton: true,
      showConfirmButton: false,
      cancelButtonColor: "#ffffff",
      cancelButtonText: "OK",
      closeOnCancel: true
    });
}

function set_validation_message(message) {
    html = document.createElement("div");
    html.style = "border-top: solid #E2574C; background-color: #FDEFEE; color: #E2574C";
    p = document.createElement("p");
    p.innerHTML = message;

    html.append(p);
    $('#multiple_ptp_payment_validation').append(html);
    return false;
}

function get_validity_date_diff() {
    today_date = new Date();
    validity_date = $("#waiver_validity_date").datepicker('getDate');
    return Math.floor((validity_date - today_date) / (1000 * 60 * 60 * 24)) + 1;
}

function validateMultiplePtpPaymentCheckbox() {
    if (get_validity_date_diff() > 40 && is_multiple_ptp_payment_input == false) {
        return true;
    }
}

function validateMultiplePtpPayment() {
    $('#multiple_ptp_payment_validation').empty();
    message = "";
    ptp_amount = parseInt($("input[name=max_multiple_ptp_amount]").val().replace(/,/g, ''));
    total_multiple_ptp_amount = 0;

    $('.multiple_ptp_amount').each(function(){
        if ($(this).val() != "" && parseInt($(this).val().replace(/,/g, '')) > 0) {
            total_multiple_ptp_amount += parseInt($(this).val().replace(/,/g, ''));
        } else {
            message = 'Tanggal bayar dan jumlah yang dibayar tidak boleh kosong';
            return false;
        }
    });
    if (message != "") { return set_validation_message(message); }

    if (ptp_amount != total_multiple_ptp_amount) {
        return set_validation_message(
            'Total dari "Jumlah yang dibayar" didalam tabel harus sesuai dengan total PTP Amount yang telah diinput'
        );
    }

    previous_date = null;
    $(".multiple_payment_date").each(function(){
        index = $(this).attr("data-index");
        current_date = $("#multiple_payment_date_" + index).datepicker('getDate');
        if (!current_date) {
            message = 'Tanggal bayar dan jumlah yang dibayar tidak boleh kosong';
            return false;
        } else if (previous_date && (previous_date >= current_date)) {
            message = "Tanggal bayar harus berurutan";
            return false;
        }
        previous_date = current_date;
    });
    if (message != "") { return set_validation_message(message); }

    if (current_date > $("#waiver_validity_date").datepicker('getDate')) {
        return set_validation_message(
            'Tanggal bayar terakhir harus jatuh sebelum atau saat tanggal Waiver Validity Date yang telah di input'
        );
    }
    return true;
}

function setMultiplePtpPayments() {
    is_multiple_ptp_payment_input = true;
    max_sequence = parseInt($("select[name=jumlah_angsuran_ptp_payment]").val());
    if (max_sequence < 1) {
        number_of_multiple_ptp_payment = 0;
        multiple_payment_ptp = null;
        return;
    }
    number_of_multiple_ptp_payment = max_sequence;
    multiple_payment_ptp = [];
    for (let index = 0; index < max_sequence; index++) {
        sequence = index + 1;
        multiple_payment_ptp.push({
            "sequence": sequence,
            "promised_payment_amount": parseInt($("input[name=multiple_ptp_amount_" + sequence + "]").val().replace(/,/g, '')),
            "promised_payment_date": $("input[name=multiple_payment_date_" + sequence + "_db]").val(),
        })
    }
}

function setMultiplePtpPaymentsData(checked) {
    email_comms = $("input[name=comms_channel2][value=Email]");
    ptp_payment_message = $(".multiple-ptp-payment-message");
    if (!checked) {
        if (email_comms.attr("data-checked") == "true") {
            email_comms.prop("checked", true).trigger("change");
        } else {
            email_comms.prop("checked", false).trigger("change");
        }
        if (ptp_payment_message.attr("data-previous") == "hide") {
            ptp_payment_message.hide();
        } else {
            ptp_payment_message.show();
        }
        $(".edit-link").hide();
        is_multiple_ptp_payment_input = false;
        number_of_multiple_ptp_payment = 0;
        multiple_payment_ptp = null;
        return false;
    }
    email_comms.prop("checked", true).trigger("change");
    ptp_payment_message.hide();
    $(".edit-link").show();
    $(".multiple-ptp-payment-table").hide();
    $(".multiple-ptp-payment-table tbody").empty();
    $('#multiple_ptp_payment_validation').empty();
    $("input[name=max_multiple_ptp_amount]").val($("#ptp_amount").val());
    $("select[name=jumlah_angsuran_ptp_payment]").val("0").trigger("change");
    $(".total-multiple-payment").html("Rp. 0");
    $("#multiple_ptp_amount_txt").html($("#ptp_amount").val());
    $("#multiple_validity_date_txt").html($("#waiver_validity_date").val());
    return true;
}

$("input[name=is_multiple_ptp_payment]").on("change", function() {
    if (setMultiplePtpPaymentsData($(this).prop("checked"))) {
        $('#multiple_ptp_payment_modal').modal('show');
    }
});

$("select[name=jumlah_angsuran_ptp_payment]").on("change", function() {
    tbody = $(".multiple-ptp-payment-table tbody");
    tbody.html("");
    if (!$(this).val()) {
        $("#btn_multiple_ptp_payment_submit").prop("disabled", true);
        return;
    }
    $("#btn_multiple_ptp_payment_submit").prop("disabled", false);
    $(".multiple-ptp-payment-table").show();
    for (let index = 0; index < parseInt($(this).val()); index++) {
        key = index + 1;
        tr = document.createElement('tr');
        calendartd = document.createElement('td');
        calendarinputgroup = document.createElement('div');
        calendarinputgroup.className = 'input-group';

        addon = document.createElement('span');
        addon.className = 'input-group-addon';

        iconcalendar = document.createElement('span');
        iconcalendar.className = 'glyphicon glyphicon-calendar';

        dateinput = document.createElement('input');
        dateinput.className = "form-control datepicker multiple_payment_date";
        dateinput.id = "multiple_payment_date_" + key;
        dateinput.name = "multiple_payment_date_" + key;
        dateinput.type = 'text';
        dateinput.setAttribute("data-index", key);

        hiddeninput = document.createElement('input');
        hiddeninput.id = "multiple_payment_date_" + key + "_db";
        hiddeninput.name = "multiple_payment_date_" + key + "_db";
        hiddeninput.type = 'hidden';

        addon.append(iconcalendar);
        calendarinputgroup.append(addon);
        calendarinputgroup.append(dateinput);
        calendarinputgroup.append(hiddeninput);
        calendartd.append(calendarinputgroup);
        tr.append(calendartd);

        paymenttd = document.createElement('td');
        paymentinputgroup = document.createElement('div');
        paymentinputgroup.className = 'input-group';

        rpaddon = document.createElement('span');
        rpaddon.className = 'input-group-addon';
        rpaddon.innerHTML = 'Rp.';

        ptpinput = document.createElement('input');
        ptpinput.className = "form-control multiple_ptp_amount";
        ptpinput.name = "multiple_ptp_amount_" + key;
        ptpinput.maxlength = "15";
        ptpinput.type = 'text';

        paymentinputgroup.append(rpaddon);
        paymentinputgroup.append(ptpinput);
        paymenttd.append(paymentinputgroup);
        tr.append(paymenttd);
        tbody.append(tr);
    }
    $(".multiple_ptp_amount").maskMoney({thousands:',', decimal:'.', allowZero: true, suffix: '', precision:0});
    $(".multiple_payment_date").datepicker({
        format: 'dd M yyyy',
        buttonClasses: ['btn', 'btn-sm'],
        applyClass: 'btn-danger',
        cancelClass: 'btn-inverse',
        autoclose: true,
        startDate: startDate,
        endDate: $("#waiver_validity_date").datepicker('getDate'),
        todayHighlight: true,
    });
});

$("#btn_multiple_ptp_payment_cancel").on("click", function() {
    $("#is_multiple_ptp_payment").prop("checked", false).trigger("change");
});

$('body').on('changeDate','.multiple_payment_date', function(e) {
    $('#' + $(this).attr("id") + "_db").val(moment(e.date).format('YYYY-MM-DD'));
});

$('body').on('change keypress keyup keydown','.multiple_ptp_amount', function(e) {
    total_multiple_ptp_amount = 0;
    $('.multiple_ptp_amount').each(function(){
        if ($(this).val() != "") {
            total_multiple_ptp_amount += parseInt($(this).val().replace(/,/g, ''));
        }
    });

    $(".total-multiple-payment").html(numberWithCommas(total_multiple_ptp_amount));
});

$("#btn_multiple_ptp_payment_submit").on("click", function(){
    if (validateMultiplePtpPayment()) {
        setMultiplePtpPayments();
        $(".multiple-ptp-payment-message").hide();
        $(".edit-link").show();
        $('#multiple_ptp_payment_modal').modal('hide');
    }
})

$('#multiple_ptp_payment_modal').on('hidden.bs.modal', function (event) {
    if (!is_multiple_ptp_payment_input) {
        $("#is_multiple_ptp_payment").prop("checked", false).trigger("change");
    };
})
{% endblock %}
