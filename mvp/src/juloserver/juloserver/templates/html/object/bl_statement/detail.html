{% extends "common/theme1/list/list_footable_theme1.html" %}
{% load model %}
{% load unit %}
{% load static from staticfiles %}
{% load checkusergroup from common %}
{% block custom_link %}


{% endblock %}


{% block css_inside %}
  #status {
    opacity: 0;
    position: fixed;
    right: 20px;
    top: 20px;
    background: hsla( 0, 0%, 0%, 0.8);
    padding: 20px;
    border-radius: 10px;
    z-index: 2; /* over other stuff */
  }
  .smt_event {
    margin-top:10px !important;
  }
  td.day{
    position:relative;
  }
  .enabled a{
    color:black !important;
    background:green !important;
  }
    td.day{
    position:relative;
  }

  td.day.disabled:hover:before {
      content: 'This date is disabled';
      color: white;
      background-color: grey;
      top: 28px;
      position: absolute;
      width: 136px;
      left: -34px;
      z-index: 1000;
      text-align: center;
      padding: 2px;
  }

  td.disabled-date {
      background-color: red !important;
      color: white !important;
  }

  .modal-content {
    width: 120%;
  }

  #id_save_note {
    background-color: #03a9f3;
  }
  #id_save_note:hover {
    opacity: 0.8;
    border: 1px solid #03a9f3;
    color: #fff;
  }

  .red{color: red;}
  .green{color: green;}
  .no-left{padding-left:0px;}
{% endblock %}

{% block breadcrumb_title %}{% endblock %}
{% block breadcrumb_path %}
    <li><a href="{% url 'loan_app:status_changes' %}">Status Payment</a></li>
    <li class="active">Ubah/Update</li>
{% endblock %}

{% block list_title %}
    {% with statement_obj as object %}
      <div class="row m-b-10">
        <div class="col-md-4 col-xs-12 label-danger p-t-10">
          <small>statement-id</small>: {{ object.id|default:"-"|safe  }}
        </div>
        <div class="col-md-4 col-xs-12 label-success p-t-10">
          <small>code</small>: <code>{{ statement_obj.statement_status.status_code|default:"-"|safe  }}</code>
        </div>
        <div class="col-md-4 col-xs-12 label-danger p-t-10">
          <small>full name</small>: {{ customer_obj.fullname|default:"-"|safe  }}
        </div>
      </div>
    {% endwith %}
{% endblock %}

{% block list_subtitle %}{% endblock %}

{% block content-list %}

<div class="row m-b-10 p-t-0">
  <div class="col-md-12 col-xs-12">
    <div class="row">
      <!-- Application detail -->
      <div class="col-md-6 col-xs-12">
          {% include "object/bl_statement/include/app_details.html" %}
      </div>
      <!-- Statement detail -->
      <div class="col-md-6 col-xs-12">
       <div class="row">
          {% with statement_obj as statement %}
            <div class="col-md-4 col-xs-6 label-warning text-center">
              <small>Limit</small><br/>
              <strong>{{ statement.account_credit_limit.account_credit_limit|f_rupiahs:"no"|safe}}</strong>
            </div>
            <div class="col-md-4 col-xs-6 label-success text-center">
              <small>Usage</small><br/>
              <strong>{{ statement.account_credit_limit.used_credit_limit|f_rupiahs:"no"|safe }}</strong>
            </div>
            <div class="col-md-4 col-xs-6 label-primary text-center">
              <small>Subscription Fee</small><br/>
              <strong>{{ statement.statement_interest_amount|f_rupiahs:"no"|default:"-"|safe  }}</strong>
            </div>
            <div class="col-md-4 col-xs-6 label-default text-center">
              <small>Late Fee</small><br/>
              <strong>{{ statement.statement_late_fee_amount|f_rupiahs:"no"|default:"-"|safe  }}</strong>
            </div>
            <div class="col-md-4 col-xs-6 label-default text-center">
              <small>Total</small><br/>
              <strong>{{ statement.statement_total_due_amount|f_rupiahs:"no"|default:"-"|safe  }}</strong>
            </div>
          {% endwith %}
        </div>

        <div class="row">
          <div class="col-md-12 col-xs-12">
            {% include "object/bl_statement/include/smt_details.html" %}
          </div>
        </div>
      </div>
    </div>
    <!-- end of row -->
    <!-- form start -->
    <div class="row">
      <hr>
      <div class="col-md-6 col-xs-12" id="block_form" style="height:300px;">
        <form class="form-horizontal" id="status_form" role="form" method="GET">
          <div class="row">
            <div class="col-md-6 col-md-offset-3 col-xs-12 m-t-30" id="id_form_selection">
              <button id="id_btn_simpan_note" class="btn btn-danger btn-block text-uppercase waves-effect waves-light" type="button">
                <i class="fa fa-sticky-note fa-fw"></i> Tambah Note
              </button>
              {%if show_unlock_button %}
                  <button id="id_btn_unlock_statement" class="btn btn-success btn-block text-uppercase waves-effect waves-light" type="button">
                    <i class="fa fa-unlock fa-fw"></i> Unlock Statement
                  </button>
              {% endif %}
            </div>
          </div>
          <div class="row">
            <div class="col-md-12 col-xs-12" id="id_form_selection">
                <div class="row collapse" id="id_form_simpan_note" aria-expanded="false" style="height: 0px;">
                  <div class="row m-t-10">
                    <div class="col-md-12 col-sm-12 form-group m-r-10">
                        <textarea class="form-control" rows="6" id="note_content" placeholder="notes here" required></textarea>
                    </div>
                  </div>
                  <div class="row m-t-10">
                      <div class="col-md-6 col-sm-4 col-xs-6">
                        <button id="id_batal_simpan_note" class="btn btn-primary btn-block text-uppercase waves-effect waves-light" type="button">Batal</button>
                      </div>
                      <div class="form-group col-md-6 col-sm-4 col-xs-6">
                        <button id="id_save_note" class="form-control btn btn-default btn-block text-uppercase waves-effect waves-light" name="simpan_note" type="submit">Simpan Note</button>
                      </div>
                  </div>
                </div>
            </div>
          </div>
          <!-- end row -->
        </div>
        <div class="col-md-6 col-xs-12">
            <!-- <div id="slim_history_note"> -->
             {% with payment_obj as object %}
                 {% include "object/bl_statement/include/history.html" %}
             {% endwith %}
        </div>
      </form>
<div class="row m-t-10 m-b-10">
</div>
<!-- MODAL SET CALLED + NOTES -->
<div id="responsive-modal-set-called"
     class="modal fade"
     tabindex="-1"
     role="dialog"
     aria-labelledby="myModalLabel"
     aria-hidden="true"
     style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header label-warning">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">Note Set Called</h4></div>
            <div class="modal-body">
              {% with payment_obj as object %}
                {% include "object/payment_status/include/form_set_payment_called.html" %}
              {% endwith %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">Batal</button>
                <button type="button"
                        id="btn_save_set_called"
                        class="btn btn-danger waves-effect waves-light"
                        onclick="set_called_onclick()">Simpan
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal PTP EVENT -->
<!-- /.modal PTP event-->
<div id="responsive-modal-statement-ptp-date"
     class="modal fade"
     tabindex="-1"
     role="dialog"
     aria-labelledby="myModalLabel"
     aria-hidden="true"
     style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header label-warning">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">Update PTP Date</h4></div>
            <div class="modal-body">
              {% with payment_obj as object %}
                {% include "object/bl_statement/include/form_update_ptp_date.html" %}
              {% endwith %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">Batal</button>
                <button type="button" id="btn_use_uptdate_ptp_date"
                        class="btn btn-danger waves-effect waves-light"
                        data-toggle="modal"
                        onclick="updatePTPDateConfirm()">Simpan</button>
            </div>
        </div>
    </div>
</div>
<!--########################### modal statement event ###############################################-->
<div id="responsive-modal-statement-event" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header label-warning">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">Add Statement Event</h4> </div>
            <div class="modal-body">
              <div class="row" id="LayoutStatementEventForms">
                <div class="col-md-12 col-sm-12 form_event-group">
                    <label class="col-md-12 col-sm-12"> Pilih Form: </label>
                    <div class="col-md-12 col-sm-12">
                      <select class="form-control" id="StatementEventForms" onchange="ChooseStatementEventForm()">
                        <option value="" selected="selected">-- Pilih --</option>
                        {% for dropdown in statement_events_details %}
                          <option value="{{dropdown.value}}">{{dropdown.desc}}</option>
                        {% endfor %}
                      </select>
                      <span class="help-block">
                        <small>Pilih Form Payment Event ...</small>
                      </span>
                    </div>
                </div>
              </div>
              <div id="FormEventTypeWaiveLateFee">
                {% with statement_obj as object %}
                  {% include "object/bl_statement/include/form_event_type_waive_late_fee.html" %}
                {% endwith %}
              </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default waves-effect" id="back_statement_event" onclick="BackFormStatementEvent();">Kembali</button>
                <button type="button" class="btn btn-default waves-effect" id="close_statement_event" data-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-danger waves-effect waves-light" id="save_statement_event" data-loading-text="<i class='fa fa-spinner fa-spin '></i> Processing" onclick="ActionAddStatementEvent();">Simpan</button>
            </div>
        </div>
    </div>
</div>
<!-- /.modal Confirm PTP event-->
<div id="responsive-modal-confirm-ptpdate"
     class="modal fade"
     tabindex="-1"
     role="dialog"
     aria-labelledby="myModalLabel"
     aria-hidden="true"
     style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header label-warning">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">Konfirmasi Update PTP Date </h4></div>
            <div class="modal-body">
              {% with payment_obj as object %}
                {% include "object/bl_statement/include/form_update_ptp_date_confirm.html" %}
              {% endwith %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">Batal</button>
                <button type="button" id="btn_confirm_update_ptp_date" class="btn btn-danger waves-effect waves-light" onclick="updatePTPDateAction();">Setuju</button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block script_additional %}

  <script src="{% static 'theme/plugins/bower_components/switchery/dist/switchery.min.js' %}"></script>

  <!-- Magnific popup JavaScript -->
  <script src="{% static 'theme/plugins/bower_components/Magnific-Popup-master/dist/jquery.magnific-popup.min.js' %}"></script>
  <script src="{% static 'theme/plugins/bower_components/Magnific-Popup-master/dist/jquery.magnific-popup-init.js' %}"></script>

  <!-- Footable -->
  <script src="{% static 'theme/plugins/bower_components/footable/js/footable.all.min.js' %}"></script>
  <script src="{% static 'theme/plugins/bower_components/bootstrap-select/bootstrap-select.min.js' %}" type="text/javascript"></script>

  <!--FooTable init-->
  <script src="{% static 'theme/nav-inverse/js/footable-init.js' %}"></script>

  <!--slimscroll JavaScript -->
  <script src="{% static 'theme/nav-inverse/js/jquery.slimscroll.js' %}"></script>

  <script src="{% static 'theme/plugins/bower_components/blockUI/jquery.blockUI.js' %}"></script>
  <script src="{% static 'theme/plugins/bower_components/blockUI/imagesloaded.pkgd.js' %}"></script>
  <script src="{% static 'theme/plugins/bower_components/blockUI/imagesloaded.pkgd.min.js' %}"></script>

    <!-- Footable -->
  <script src="{% static 'theme/plugins/bower_components/footable/js/footable.all.min.js' %}"></script>
  <script src="{% static 'theme/plugins/bower_components/bootstrap-select/bootstrap-select.min.js' %}" type="text/javascript"></script>
   <!--FooTable init-->
  <!-- <script src="{% static 'theme/nav-mini/js/footable-init.js' %}"></script> -->

  <!--Wave Effects -->
  <script src="{% static 'default/theme/js/waves.js' %}"></script>
  <script src="{% static 'theme/plugins/bower_components/toast-master/js/jquery.toast.js' %}"></script>
  <script src="{% static 'default/theme/js/jquery.maskMoney.min.js' %}"></script>
  <script src="{% static 'theme/plugins/bower_components/bootstrap-datepicker/bootstrap-datepicker.min.js' %}"></script>
  <script src="{% static 'theme/plugins/bower_components/timepicker/bootstrap-timepicker.min.js' %}"></script>

  <script src="{% static 'theme/plugins/bower_components/tinymce/tinymce.min.js' %}"></script>
  <script type="text/javascript" charset="utf8" src="{% static 'theme/plugins/DataTables/js/jquery.dataTables.js' %}"></script>
  <script type="text/javascript" charset="utf8" src="{% static 'default/js/Skiptrace.js' %}"></script>
  <script type="text/javascript" charset="utf8" src="{% static 'theme/plugins/moment/moment.min.js' %}"></script>
  <script type="text/javascript" charset="utf8" src="{% static 'default/js/change.status.js' %}"></script>
  <script type="text/javascript" charset="utf8" src="{% static 'theme/plugins/qtip/jquery.qtip.min.js' %}"></script>
  <script type="text/javascript" charset="utf8" src="{% static 'theme/plugins/qtip/jquery.qtip.js' %}"></script>
  <script type="text/javascript" charset="utf8" src="{% static 'theme/plugins/jquery-ui-autocomplete/jquery-ui-autocomplete.min.js' %}"></script>
  <script src="{% static 'theme/plugins/datetimepicker/jquery.datetimepicker.full.min.js' %}"></script>

{% endblock %}

{% block script_bottom_inside %}
// JQUERY ON LOAD
  jQuery(document).ready(function() {
    //SkipTrace document ready for load table
    //$('#dvc').removeClass('active');
    //$('#st').addClass('active');
    reset_statement_event();
    GLOBAL_TABLE = $('#skiptraceTable').DataTable( {
        "paging": false,
        "searching": false,
        "lengthChange": false,
        "bInfo": false,
        "order": [[ 3, 'desc' ], [ 6, 'asc' ]],
        "columnDefs": [
          {
            "targets"  : "no-sort",
            "orderable": false,
          },
          {
            "targets": [0,1,2,3,4,5,8],
            "orderSequence": ["desc"]
          },
          {
            "targets": [6,7],
            "visible": false
          },
          {"targets": [0], "data": "NAME"},
          {"targets": [1], "data": "SOURCE"},
          {"targets": [2], "data": "ACTION"},
          {"targets": [3], "data": "EFF"},
          {"targets": [4], "data": "REC"},
          {"targets": [5], "data": "FREQ"},
          {"targets": [6], "data": "ID"},
          {"targets": [7], "data": "NUMBER_PHONE"},
          {"targets": [8], "data": "OPERATOR"},
        ]
    } );

    $('#skiptraceTable tbody').on('click', 'td #id_call_skip_trace', function () {
        var tr = $(this).closest('tr');
        var row = GLOBAL_TABLE.row( tr );
        var row_data = GLOBAL_TABLE.row( tr ).data();
        var is_iso_inactive = '{{ is_iso_inactive }}'
        if ( row.child.isShown() ) {
            //ActionCall(1,row_data.ID);
            if(GLOBAL_HOLD_ACTION){
              $(this).find('i').attr( 'class', 'fa fa-chevron-circle-down' );
              $(this).attr( 'class', 'btn btn btn-success btn-rounded' );
              row.child.hide();
              tr.removeClass('shown');
            }
        }
        else {
            GLOBAL_OBJ_START_TS.id = row_data.ID;
            $(this).find('i').attr( 'class', 'fa fa-times' );
            $(this).attr( 'class', 'btn btn btn-danger btn-rounded' );
            row.child(format(row.data(), '', is_iso_inactive, 'statement')).show();
            tr.addClass('shown');
        }
      } );

    $('#id_btn_add_skip_trace').on( 'click', function () {
      SaveSkipTrace();
    } );

    $('#id_btn_update_skip_trace').on( 'click', function () {
      UpdateSkipTrace();
    } );

    $.ajaxSetup({
      data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
    });

    $('#id_form2_reminder_call_date').datetimepicker({
      format:'d-m-Y H:i'
    });

    //load_call_result example
    $.ajax({
          url :  "{% url 'payment_status:load_call_result' %}/", // the endpoint
          type : "GET", // http method

          // handle a successful response
          success : function(json) {
              GLOBAL_ARR_BTN_CALL = json.data;
              GLOBAL_ARR_BTN_CALL.shift();
          },

          // handle a non-successful response
          error : function(xhr,errmsg,err) {
              console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
          }
      });

    // alert("Document is ready");
    $('#id_status_to').on('change', function() {
      // alert( this.value );
      if(this.value != ''){
        set_reason_list(this.value);
      }
    });

    window.scroll(0,80);

    $(".mask").maskMoney({thousands:'.', decimal:',', allowZero: true, suffix: '', precision:0});
    jQuery('.mydatepicker, #datepicker').datepicker({
      format: 'dd-mm-yyyy',
      buttonClasses: ['btn', 'btn-sm'],
      applyClass: 'btn-danger',
      cancelClass: 'btn-inverse',
      dateLimit: {
        days: 6
      },
      autoclose: true,
      todayHighlight: true,
      todayBtn: "linked",
    });
    $('#id_reason')
        .empty()
        .append('<option selected="selected" value>-- Pilih Alasan --</option>');

    if($("#mymce").length > 0){
      tinymce.init({
        selector: "textarea#mymce",
        theme: "modern",
        height:250,
        plugins: [
        "advlist autolink link image lists charmap print preview hr anchor pagebreak spellchecker",
        "searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking","save table contextmenu directionality emoticons template paste textcolor"
        ],
        toolbar: "insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview media fullpage | forecolor backcolor emoticons",
      });
    }

    reset_statement_event()

    function set_reason_list(status_to) {
      var csrftoken = getCookie('csrftoken');
      if(status_to==''){
        // set empty reason list
        $('#id_reason')
            .empty()
            .append('<option selected="selected" value>-- Pilih Alasan--</option>')
        ;
        return -1;
      }

      $.ajax({
          url :  "{%url 'payment_status:populate_reason' %}/", // the endpoint
          type : "GET", // http method
          data : { status_code   : status_to,
               csrfmiddlewaretoken: csrftoken,
            }, // data sent with the get request

          // handle a successful response
          success : function(json) {
              // console.log(json); // log the returned json to the console
              // console.log(json.reason_list);
              // console.log(json.result);

              if (json.result == "successful!"){
                // set empty reason list
                $('#id_reason')
                    .empty()
                    .append('<option selected="selected" value>-- Pilih Alasan--</option>')
                ;
                $.each(json.reason_list, function(i, value) {
                    $('#id_reason').append($('<option>').text(value[1]).attr('value', value[0]));
                });
              }
              // console.log("success"); // another sanity check
          },

          // handle a non-successful response
          error : function(xhr,errmsg,err) {
              console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
          }
      });

    } // end function set_reason_list

    function reset_statement_event() {
      $('#save_statement_event').hide()
      $('#FormEventTypeWaiveLateFee').hide();
      $('#LayoutPaymentEventForms').show();
    }
    //check form active
    //check_active_form();

    //check if status_id has value
    $("#id_status_to :selected").map(function(i, el) {
       if($(el).val()!=''){
        set_reason_list($(el).val());
       }
    });
       /**/

    tinymce.init({
      selector: "textarea#email_content",
      theme: "modern",
      height:250,
      fontsize_formats: '12pt 14pt 18pt 24pt 36pt',
      plugins: [
       "advlist autolink link image lists charmap print preview hr anchor pagebreak spellchecker",
       "searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking",
       "save table contextmenu directionality emoticons template paste textcolor"
      ],
      toolbar: "insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview media fullpage | forecolor backcolor emoticons | fontsizeselect",
    });

    $("#id_btn_unlock_app").button().click(function(){
      $('#responsive-modal-unlock-app').modal('show');
    });

    //button click
    $("#id_unlock_payment").button().click(function(){
        set_unlocked_payment("{{payment_obj.id}}");
    });
    //set blocked div
    if({{lock_status}}){
        $('#block_form').block({
            message: "You Are Not Allowed to Change Status, status has been locked by: {{lock_by|default:"-"|safe}}"
            , overlayCSS: {
                backgroundColor: '#000'
            }
            , css: {
                border: '1px solid #fff'
            }
        });
    };
    if({{is_set_called}}){
        $("#send_called_button").addClass("disabled");
        $("#send_called_button").attr("disabled", true);
    };
  }); //end document ready

  $.ajaxSetup({
    data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
  });

  window.onload = function () {
    //$('#id_btn_update_app').hide();
    //var note_only = document.getElementById("id_notes_only");
    //var status_change = document.getElementById("id_status_to");
    //var reason_change = document.getElementById("id_reason");

    //note_only.onkeyup = formValidationNote;
    //status_change.onchange = formValidationStatus;
    //reason_change.onchange = formValidationStatus;

    //DOM Manipulation For Skip Tracing
    $('#st').removeClass('active');
    $('#dvc').addClass('active');
    $('#skiptraceTable').find('th').css( 'background', 'none' );
    $('#skiptraceTable').find('th').css( 'pointer-events', 'none' );
  }

  function toast_success(header_msg, body_message){
    $.toast({
            heading: header_msg,
            text: body_message,
            position: 'top-right',
            loaderBg:'#ff6849',
            icon: 'success',
            hideAfter: 1500,
            stack: 6
          });
    }

  function toast_danger(header_msg, body_message){
    $.toast({
            heading: header_msg,
            text: body_message,
            position: 'top-right',
            loaderBg:'#ff6849',
            icon: 'error',
            hideAfter: 2800

          });
    }

  $('#slim_images').slimScroll({
      // position: 'left',
      height: '42vh',
      railVisible: true,
      alwaysVisible: true
  });

  $('#slim_apps').slimScroll({
      // position: 'left',
      height: '42vh',
      railVisible: true,
      alwaysVisible: true
  });


  $('#slim_smts').slimScroll({
      // position: 'left',
      height: '38vh',
      railVisible: true,
      alwaysVisible: true
  });

  $('#slim_history_note').slimScroll({
      // position: 'left',
      height: '450px',
      railVisible: true,
      alwaysVisible: true
  });
  //febby
  $("#phone_selects").change(function(){
    value = $("#phone_selects").val();
    $("#number").val(value);
    if (value == 0){
      $('#number').val('');
      $("#number").removeAttr('disabled');
    }
  });

  $("#id_btn_simpan_note").click(function(){
      $("#id_form_selection").hide();
      $("#id_form_simpan_note").show();
      localStorage.app_status_btn_selected = 'simpan_note';
  });

  $("#id_batal_simpan_note").button().click(function(){
      $("#id_form_selection").show();
      $("#id_form_simpan_note").hide();
  });

  $("#id_btn_unlock_statement").button().click(function() {
    $.ajax({
      url :  "{%url 'bl_statement:ajax_unlock_statement' %}",
      type : "POST",
      data : {
            statement_id: "{{ statement_obj.id }}"
      },
      success : function(json) {
        if(json.result == 'success') {
          window.close()
        } else {
          toast_danger('Error','Gagal Unlock Statement');
        }
      },
      // handle a non-successful response
      error : function(xhr,errmsg,err) {
        toast_danger('Error','Gagal memasukkan note');
      }
    })
  });
  function reset_statement_event() {
    $('#save_statement_event').hide();
    $('#FormEventTypeWaiveLateFee').hide();
    $('#back_statement_event').hide();
    $('#LayoutStatementEventForms').show();
    $('#StatementEventForms').val('');
  }

  $("#id_save_note").click(function(e){
    e.preventDefault();
    note = $("#note_content").val().trim();

    if (note.length == 0) {
      toast_danger('Gagal', 'Note tidak boleh kosong')
    } else {
      $.ajax({
        url :  "{%url 'bl_statement:ajax_create_statement_note' %}",
        type : "POST",
        data : {
              note : note,
              statement_id: "{{ statement_obj.id }}"
        },
        success : function(json) {
            if(json.status == 'success'){
              toast_success('Success', 'Berhasil menambahkan note');
              window.location.reload();
            }else {
              console.log(json.message);
              toast_danger('Error','Gagal menambahkan note');
            }
        },
        // handle a non-successful response
        error : function(xhr,errmsg,err) {
          toast_danger('Error','Gagal memasukkan note');
        }
      })
    }
  })

  function ActionAddStatementEvent() {
    form_event_selected = $('#StatementEventForms').val();
    response = [false , 'Add Statement Event gagal!'];

    if (form_event_selected == 'waive_late_fee') {
      WaiveStatementLateFee(form_event_selected)
    }
  }

  function BackFormStatementEvent() {
    reset_statement_event();
  }

  function WaiveStatementLateFee(statement_event) {
    var waive_note = $('#WaiveLateFeeNote').val();
    var waive_late_fee_amount = $('#WaiveLateFeeAmount').val()
    var waive_late_fee_amount = waive_late_fee_amount.replace(/[.]/g,'');
    var statement_late_fee_amount = Number({{statement_obj.statement_late_fee_amount}});

    if (!waive_late_fee_amount || !waive_note) {
      toast_danger('Gagal', 'amount dan catatan tidak boleh kosong');

      return ;
    }

    if (statement_late_fee_amount < waive_late_fee_amount) {
      toast_danger('Gagal', 'waive late fee tidak boleh lebih kecil dari statement late fee');

      return ;
    }

    if (waive_late_fee_amount <= 0) {
      toast_danger('Gagal', 'waive late fee tidak boleh 0 rupiah');

      return ;
    }

    $.ajax({
      url :  "{% url 'bl_statement:ajax_add_statement_event' %}",
      type : "POST",
      data : {
            statement : {{statement_obj.id}},
            statement_event : statement_event,
            note: waive_note,
            waive_late_fee_amount: waive_late_fee_amount
      },
      statusCode: {
        500: function(json) {
          toast_danger('Warning 500!', json['responseText'])
        },
        404: function(json) {
          toast_warning('Warning 404!',json['responseText']);
        },
        400: function(json) {
          toast_warning('Warning 400!',json['responseText']);
        },
        405: function(json) {
          toast_warning('Warning 405!',json['responseText']);
        },
        200: function(json) {
          window.location.reload(true);
          toast_success('Sukses!','Sukses menambahkan waive late fee');
        },
      },

      // handle a successful response
      success : function(json) {
          //console.log("success add: "+json.data);
      },
      // handle a non-successful response
      error : function(xhr, errmsg, err) {
          console.log(xhr.status + ": " + xhr.responseText);
      }
    });
  }

  function ChooseStatementEventForm() {
    var form_event_selected = $("#StatementEventForms").val()
    $('#back_statement_event').show();

    if (form_event_selected == 'waive_late_fee') {
      $("#FormEventTypeWaiveLateFee").show();
    }

    $('#save_statement_event').show()
    $('#LayoutStatementEventForms').hide()
  }

  function btn_selection_show(){
      $("#id_form_selection").show();
      $("#id_form_simpan_note").hide();
      $("#id_form_ubah_status").hide();
  }

// Function skiptrace actions
  function SaveSkipTrace(){
    var obj_skiptrace = GetFormSkipTrace();
    var result = ValidateFormSkipTrace(obj_skiptrace);
    if(result.isValid){
      $.ajax({
          url :  "{% url 'bl_statement:ajax_add_skiptrace' %}",
          type : "POST",
          data : {
                customer : {{customer_obj.id}},
                contact_name : obj_skiptrace.name,
                contact_source : obj_skiptrace.source,
                phone_number: obj_skiptrace.number_phone
          },

          statusCode: {
            404: function(json) {
              toast_warning('Warning 404!',json['responseText']);
            },
            400: function(json) {
              toast_warning('Warning 400!',json['responseText']);
            },
            405: function(json) {
              toast_warning('Warning 405!',json['responseText']);
            },
            200: function(json) {
              toast_success('Success','Add skiptrace '+json.data.contact_name);
              GLOBAL_TABLE.row.add( {
                "NAME": json.data.contact_name,
                "SOURCE": json.data.contact_source,
                "OPERATOR": formating(json.data.phone_operator),
                "EFF": formating(json.data.effectiveness),
                "REC": formatingDate(json.data.recency),
                "FREQ": formating(json.data.frequency),
                "ID": json.data.id,
                "NUMBER_PHONE": json.data.phone_number,
                "ACTION": '<button type="button" id="id_call_skip_trace" class="btn btn btn-success btn-rounded"> <i class="fa fa-chevron-circle-down"></i></button>'
              } ).order( [ 3, 'desc' ], [ 6, 'asc' ] ).draw(false);
              ResetFormSkipTrace();
              HideFormSkipTrace();
            },
          },

          // handle a successful response
          success : function(json) {
              //console.log("success add: "+json.data);
          },
          // handle a non-successful response
          error : function(xhr, errmsg, err) {
              console.log(xhr.status + ": " + xhr.responseText);
          }
      });
    }else{
      toast_warning('Warning',result.reason);
    }
  }

  function UpdateSkipTrace(){
    var obj_skiptrace = GetFormSkipTrace();
    var result = ValidateFormSkipTrace(obj_skiptrace);
    if(result.isValid){
      $.ajax({
          url :  "{% url 'bl_statement:ajax_update_skiptrace' %}/",
          type : "POST",
          data : {
                skiptrace_id: obj_skiptrace.id,
                customer : {{customer_obj.id}},
                contact_name : obj_skiptrace.name,
                contact_source : obj_skiptrace.source,
                phone_number: obj_skiptrace.number_phone
          },

          statusCode: {
            404: function(json) {
              toast_warning('Warning 404!',json['responseText']);
            },
            400: function(json) {
              toast_warning('Warning 400!',json['responseText']);
            },
            405: function(json) {
              toast_warning('Warning 405!',json['responseText']);
            },
            200: function(json) {
              toast_success('Success','Update skiptrace '+json.data.contact_name);
              var tr = $(obj_skiptrace.row_table).parents('tr').prev();
              var data = GLOBAL_TABLE.row( tr ).data();
              var row = GLOBAL_TABLE.row( tr );
              row.child.hide();
              tr.removeClass('shown');
              data.NAME =  json.data.contact_name;
              data.SOURCE = json.data.contact_source;
              data.OPERATOR = formating(json.data.phone_operator);
              data.EFF = formating(json.data.effectiveness);
              data.REC = formatingDate(json.data.recency);
              data.FREQ = formating(json.data.frequency);
              data.ID = json.data.id;
              data.NUMBER_PHONE = json.data.phone_number;
              data.ACTION = '<button type="button" id="id_call_skip_trace" class="btn btn btn-success btn-rounded"> <i class="fa fa-chevron-circle-down"></i></button>';
              GLOBAL_TABLE.row(tr)
                    .data(data)
                    .order( [ 3, 'desc' ], [ 6, 'asc' ] ).draw(false);
              ResetFormSkipTrace();
              HideFormSkipTrace();
            },
          },

          // handle a successful response
          success : function(json) {
              //console.log("success update: "+json.data);
          },
          // handle a non-successful response
          error : function(xhr, errmsg, err) {
              console.log(xhr.status + ": " + xhr.responseText);
          }
      });
    }else{
      toast_warning('Warning',result.reason);
    }
  }
// End Skiptrace Action

// Function PTP
  function onModalPTPShow(){
    $("#responsive-modal-statement-ptp-date").modal("show")
  }
  function updatePTPDateConfirm(){
    var ptp_date = $("#id_form2-ptp_date").val();
    var ptp_amount = $("#id_ptp_amount").val();
    // show change to ptp modal confirm
    $("#id_new_ptp_date_text").text(ptp_date);
    $("#id_new_ptp_amount_text").text(ptp_amount);
    $("#responsive-modal-statement-ptp-date").modal("hide");
    $("#responsive-modal-confirm-ptpdate").modal("show");
  }

  function updatePTPDateAction() {
    var ptp_date = $("#id_form2-ptp_date").val();
    var ptp_amount = ($("#id_ptp_amount").val()).replace(/\./g, '');
    if (ptp_date == '' ) {
      toast_danger('Alert!!','Isi PTP Date');
    } else if (ptp_amount == '' || ptp_amount <= 0) {
      toast_danger('Alert!!','Isi PTP Amount');
    } else {
      $.ajax({
          url :  "{% url 'bl_statement:ajax_update_ptp' %}/",
          type : "POST",
          data : {
            statement_id : {{statement_obj.id}},
            ptp_date : ptp_date,
            ptp_amount : ptp_amount,
          },
          // handle a successful response
          success : function(json) {
            if (json.status == "success"){
              $('#responsive-modal-confirm-ptpdate').hide()
              toast_success('Sukses!!',json.message);
              window.location.reload(true);
            } else if(json.status == "failed"){
              console.log(json);
              toast_danger('Failed Update',json.message);
              $('#responsive-modal-confirm-ptpdate').hide()
              onModalPTPShow();
            }
          },
          // handle a non-successful response
          error : function(xhr, errmsg, err) {
            console.log(err, errmsg, 'halo')
              console.log(xhr.status + ": " + xhr.responseText);
              toast_danger('Failed Update',xhr.responseText);
              $('#btn_confirm_update_ptp_date').show()
          }
      });
    }
  }
// End Function PTP

// Function Set Call
  function set_called_onclick(){
    var note_text = $("#set-called-note-id").val();
    console.log('note_text')
    $.ajax({
      url :  "{% url 'bl_statement:ajax_statement_set_called' %}/",
      type : "POST",
      data : {
        statement_id : {{statement_obj.id}},
        note_text : note_text,
      },
      // handle a successful response
      success : function(json) {
        if (json.status == "success"){
          $('#responsive-modal-set-called').hide();
          toast_success('Sukses!!',json.message);
          setTimeout(window.top.close(), 1000);
        } else if(json.status == "failed"){
          console.log(json);
          toast_danger('Failed Update',json.message);
          $('#responsive-modal-set-called').hide();
        }
      },
      // handle a non-successful response
      error : function(xhr, errmsg, err) {
        console.log(err, errmsg, 'halo')
          console.log(xhr.status + ": " + xhr.responseText);
          toast_danger('Failed Update',xhr.responseText);
      }
    });
  }
// End Function Set Called

  //Action Call function
  function ActionCall(id,skiptrace_id,self) {
    var objIsValid = false
    var obj = {};
    obj.id = id;
    obj.skiptrace_id = skiptrace_id;
    obj.statement_id = {{statement_obj.id}};
    obj.account_credit_limit_id = {{statement_obj.account_credit_limit.id}}

    if (obj.id && obj.skiptrace_id && obj.statement_id && obj.account_credit_limit_id) {
      objIsValid = true
    }

    if (objIsValid) {
      $.ajax({
          url :  "{% url 'bl_statement:ajax_create_skiptrace_history' %}/",
          type : "POST",
          data : {
                skiptrace : obj.skiptrace_id,
                statement : obj.statement_id,
                account_credit_limit: obj.account_credit_limit_id,
                call_result: obj.id
          },
          statusCode: {
            404: function(json) {
              toast_warning('Warning 404!',json['responseText']);
            },
            400: function(json) {
              toast_warning('Warning 400!',json['responseText']);
            },
            405: function(json) {
              toast_warning('Warning 405!',json['responseText']);
            },
            200: function(json) {
              var tr = $(self).parents('tr').prev();
              var data = GLOBAL_TABLE.row( tr ).data();
              var row = GLOBAL_TABLE.row( tr );
              row.child.hide();
              tr.removeClass('shown');
              data.ACTION = '<button type="button" id="id_call_skip_trace" class="btn btn btn-success btn-rounded"> <i class="fa fa-chevron-circle-down"></i></button>';
              GLOBAL_TABLE.row(tr)
                    .data(data)
                    .order( [ 3, 'desc' ], [ 6, 'asc' ] ).draw(false);
              ResetFormSkipTrace();
              HideFormSkipTrace();
              toast_success('Success!!', 'menambahkan skip trace history');
            }
          },

          // handle a successful response
          success : function(json) {
              //console.log("success ",json);
          },
          // handle a non-successful response
          error : function(xhr, errmsg, err) {
              console.log({{payment_obj.id}})
              console.log(xhr.status + ": " + xhr.responseText);
          }
      });
    } else {
      toast_danger('Failed!!','Please try again later!');
    }
  }
  //End Action Call function

  function SendSmsAndGenerateVa() {
    toast_danger('Gagal', 'VA dan SMS sudah tidak bisa di generate');
    //let statement_id = {{statement_obj.id}};

    // $.ajax({
    //  url :  "{% url 'bl_statement:ajax_create_va_and_send_sms' %}/",
    //  type : "POST",
    //  data : {
    //        statement_id : statement_id
    //  },
    //  success : function(json) {
    //    if (json.status === 'success') {
    //      toast_danger('Gagal', 'Terjadi kesalahan, mohon dicoba kembali');
    //    } else {
    //      toast_danger('Gagal', 'Terjadi kesalahan, mohon dicoba kembali');
    //    }
    //  }
    // })
  }

{% endblock %}
