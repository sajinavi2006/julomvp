{% extends "common/theme1/crup/app_status_theme1.html" %}
{% load model %}
{% load unit %}
{% load static from staticfiles %}

{% block additional_title %}New Product{% endblock %}
 
{% block css_inside %}
.scroll_app {
    overflow-y: scroll;
    height: 629;
}
{% endblock %}
{% block breadcrumb_title %}{% endblock %}
{% block breadcrumb_path %}{% endblock %}
 
{% block list_title %} 
{% endblock %}
{% block list_subtitle %}<h4> Add New Product Profile</h4>{% endblock %}

{% block content-list %}
<div class="row m-b-12 p-t-0" id="add-product-profile">
    <br />
        <div class="col-md-12 col-xs-12">
            {% if isError %}
                <span class="error-msg" style="color:red; text-align: center">{{ err_msg }}</span>
            {% endif %}
            <div class="panel col-md-6 col-xs-12 panel-default">
                <div class="panel-heading">
                    <h5>Product Criteria</h5>
                </div>
                <div class="panel-body">
                    <div class="form-group row">
                        <div class="col-md-6">
                            <label for="code">Product Code</label>
                            <input
                                type="text"
                                class="form-control"
                                v-model="product.code"
                                required="true" />
                        </div>
                        <div class="col-md-6">
                            <label for="code">Product Name</label>
                            <input
                                type="text"
                                class="form-control"
                                v-model="product.name" required="true" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-md-6">
                            <label for="code">Min interest rate</label>
                            <input
                                type="number"
                                step="0.0000"
                                class="form-control"
                                v-model="product.min_interest_rate" />
                        </div>
                        <div class="col-md-6">
                            <label for="code">Max interest rate</label>
                            <input
                                type="number"
                                class="form-control"
                                step="0.0000"
                                v-model="product.max_interest_rate" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-md-6">
                            <label for="code">Min origination fee</label>
                            <input
                                type="number"
                                step="0.0000"
                                class="form-control"
                                v-model="product.min_origination_fee" />
                        </div>
                        <div class="col-md-6">
                            <label for="code">Max origination fee</label>
                            <input
                                type="number"
                                step="0.0000"
                                class="form-control"
                                v-model="product.max_origination_fee" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-md-6">
                            <label for="code">interest rate increment</label>
                            <input
                                type="number"
                                step="0.0000"
                                class="form-control"
                                v-model="product.interest_rate_increment" />
                        </div>
                        <div class="col-md-6">
                            <label for="code">origination fee increment</label>
                            <input
                                type="number"
                                step="0.0000"
                                class="form-control"
                                v-model="product.origination_fee_increment" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-md-6">
                            <label for="code">Min Amount</label>
                            <input
                                type="number"
                                class="form-control"
                                v-model="product.min_amount" />
                        </div>
                        <div class="col-md-6">
                            <label for="code">Max Amount</label>
                            <input
                                type="number"
                                class="form-control"
                                v-model="product.max_amount" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-md-6">
                            <label for="code">Min duration</label>
                            <input
                                type="number"
                                class="form-control"
                                v-model="product.min_duration" />
                        </div>
                        <div class="col-md-6">
                            <label for="code">Max duration</label>
                            <input
                                type="number"
                                class="form-control"
                                v-model="product.max_duration" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-md-6">
                            <label for="code">payment frequency</label>
                            <select
                                class="form-control"
                                v-model="product.payment_frequency"
                                required="true">
                                {% for payment_freq in PAYMENT_FREQ_CHOICES %}
                                    <option value='{{ payment_freq }}'>{{ payment_freq }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="code">late fee</label>
                            <input
                                type="number"
                                step="0.0000"
                                class="form-control"
                                v-model="product.late_fee" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-md-6">
                            <label for="code">cashback initial</label>
                            <input
                                type="number"
                                step="0.0000"
                                class="form-control"
                                v-model="product.cashback_initial" />
                        </div>
                        <div class="col-md-6">
                            <label for="code">cashback payment</label>
                            <input
                                type="number"
                                step="0.0000"
                                class="form-control"
                                v-model="product.cashback_payment" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-md-6">
                            <label for="code">debt income ratio</label>
                            <input
                                type="number"
                                step="0.0000"
                                class="form-control"
                                v-model="product.debt_income_ratio" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-md-3">
                        <input 
                            type="checkbox"
                            name="product__is_active"
                            @change="handleCheck"
                        />
                        &nbsp;&nbsp;
                        <label for="code">is active</label>
                        </div>
                        <div class="col-md-3">
                            <input 
                                type="checkbox"
                                name="product__is_initial"
                                @change="handleCheck"
                            />
                            &nbsp;&nbsp;
                            <label for="code">is initial</label>
                        </div>
                        <div class="col-md-6">
                            <input 
                                type="checkbox"
                                name="product__is_product_exclusive"
                                @change="handleCheck" />
                            &nbsp;&nbsp;
                            <label for="code">is product exclusive</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel col-sm-6 col-xs-12 panel-default">
                <div class="panel-heading">
                    <h5>Customer Criteria</h5>
                </div>
                <div class="panel-body">
                    <div class="form-group row">
                        <div class="col-md-6">
                            <label for="code">min age</label>
                            <input
                                type="number"
                                class="form-control"
                                v-model="customer_criteria.min_age" />
                        </div>
                        <div class="col-md-6">
                            <label for="code">max age</label>
                            <input
                                type="number"
                                class="form-control"
                                v-model="customer_criteria.max_age" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-md-6">
                            <label for="code">min income</label>
                            <input
                                type="number"
                                class="form-control"
                                v-model="customer_criteria.min_income" />
                        </div>
                        <div class="col-md-6">
                            <label for="code">max income</label>
                            <input
                                type="number"
                                class="form-control"
                                v-model="customer_criteria.max_income" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-md-6">
                            <label for="code">job type</label>
                            <select class="form-control" v-model="customer_criteria.job_type" multiple="multiple">
                                {% for job_type in JOB_TYPE_CHOICES %}
                                    <option value='{{job_type}}'>{{ job_type }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="code">job industry</label>
                            <select
                                class="form-control"
                                v-model="customer_criteria.job_industry"
                                multiple="multiple">
                                {% for job_industry in JOB_INDUSTRY_CHOICES %}
                                    <option value='{{job_industry}}'>{{ job_industry }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-md-6">
                            <label for="code">job description</label>
                            <select
                                class="form-control"
                                v-model="customer_criteria.job_description"
                                multiple="multiple">
                                {% for job_description in JOB_DESCRIPTION_CHOICES %}
                                    <option value='{{job_description}}'>{{ job_description }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="code">credit score</label>
                            <select
                                class="form-control"
                                v-model="customer_criteria.credit_score"
                                multiple="multiple">
                                {% for credit_score in CREDIT_SCORE_CHOICES %}
                                    <option value='{{credit_score}}'>{{ credit_score }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-group row">
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-12 col-xs-12" style="text-align: center">
            <button 
                class="button btn-primary"
                style="min-width: 40px"
                v-on:click="saveProductProfile">save
            </button>
        </div>
    }
</div>
{% endblock %}

{% load static from staticfiles %}

{% block custom_link %}
<link href="{% static 'theme/plugins/bower_components/bootstrap-select/bootstrap-select.min.css' %}" rel="stylesheet" />
<link href="{% static 'theme/plugins/bower_components/toast-master/css/jquery.toast.css' %}" rel="stylesheet">
{% endblock %}

{% block script_additional %}
<script src="{% static 'theme/plugins/bower_components/bootstrap-select/bootstrap-select.min.js' %}" type="text/javascript"></script>
<script src="{% static 'theme/plugins/bower_components/toast-master/js/jquery.toast.js' %}"></script>
<!-- vue js -->
<script src="{% static 'default/js/vue.js' %}"></script>
<script src="{% static 'default/js/filter.js' %}"></script>
<script type="text/javascript">
var AddProductProfile = new Vue({
    el: '#add-product-profile',
    delimiters: ["<%", "%>"],
    data: {
        csrftoken:'{{csrf_token}}',
        product: {
            code: null,
            name: null,
            min_amount: null,
            max_amount: null,
            min_duration: null,
            max_duration: null,
            min_interest_rate: '0.0000',
            max_interest_rate: '0.0000',
            interest_rate_increment: '0.0000',
            min_origination_fee: '0.0000',
            max_origination_fee: '0.0000',
            origination_fee_increment: '0.0000',
            payment_frequency: 'Monthly',
            late_fee: '0.0000',
            cashback_payment: '0.0000',
            cashback_initial: '0.0000',
            debt_income_ratio: null,
            is_active: false,
            is_initial: false,
            is_product_exclusive: false
        },
        customer_criteria: {
            min_age: null,
            max_age: null,
            min_income: null,
            max_income: null,
            job_type: [],
            job_industry: [],
            job_description: [],
            location: [],
            credit_score: [],
        },
    },
    beforeMount(){
        console.log('ada')
    },
    methods: {
        reAssignEmptyFields: function() {
            self = this
            // Product
            if (self.product.min_interest_rate === '') {
                self.product.min_interest_rate = '0.0000'
            }
            if (self.product.max_interest_rate === '') {
                self.product.max_interest_rate = '0.0000'
            }
            if (self.product.interest_rate_increment === '') {
                self.product.interest_rate_increment = '0.0000'
            }
            if (self.product.min_origination_fee === '') {
                self.product.min_origination_fee = '0.0000'
            }
            if (self.product.max_origination_fee === '') {
                self.product.max_origination_fee = '0.0000'
            }
            if (self.product.origination_fee_increment === '') {
                self.product.origination_fee_increment = '0.0000'
            }
            if (self.product.cashback_initial === '') {
                self.product.cashback_initial = '0.0000'
            }
            if (self.product.cashback_payment === '') {
                self.product.cashback_payment = '0.0000'
            }
            if (self.product.late_fee === '') {
                self.product.late_fee = '0.000'
            }
            if (self.product.debt_income_ratio === '') {
                self.product.debt_income_ratio = null
            }
            // Customer Criteria
            if (self.customer_criteria.min_age === '') {
                self.customer_criteria.min_age = null
            }
            if (self.customer_criteria.max_age === '') {
                self.customer_criteria.max_age = null
            }
            if (self.customer_criteria.min_income === '') {
                self.customer_criteria.min_income = null
            }
            if (self.customer_criteria.max_income === '') {
                self.customer_criteria.max_income = null
            }
        },
        integerFieldValidation: function() {
            self = this
            if (String(self.product.min_amount).indexOf('.') !== -1) {
                self.ToastDanger('invalid value', 'min amount could not be decimal value!!')
                return false
            }
            if (String(self.product.max_amount).indexOf('.') !== -1) {
                self.ToastDanger('invalid value', 'max amount could not be decimal value!!')
                return false
            }
            if (String(self.product.min_duration).indexOf('.') !== -1) {
                self.ToastDanger('invalid value', 'min duration could not be decimal value!!')
                return false
            }
            if (String(self.product.max_duration).indexOf('.') !== -1) {
                self.ToastDanger('invalid value', 'max duration could not be decimal value!!')
                return false
            }
            // Customer Criteria
            if (self.customer_criteria.min_age !== null) {
                if (String(self.customer_criteria.min_age).indexOf('.') !== -1) {
                    self.ToastDanger('invalid value', 'min age could not be decimal value!!')
                    return false 
                }
            }
            
            if (self.customer_criteria.max_age !== null) {
                if (String(self.customer_criteria.max_age).indexOf('.') !== -1) {
                    self.ToastDanger('invalid value', 'max age could not be decimal value!!')
                    return false 
                }
            }

            if (self.customer_criteria.min_income !== null) {
                if (String(self.customer_criteria.min_income).indexOf('.') !== -1) {
                    self.ToastDanger('invalid value', 'min income could not be decimal value!!')
                    return false 
                }
            }

            if (self.customer_criteria.max_income !== null) {
                if (String(self.customer_criteria.max_income).indexOf('.') !== -1) {
                    self.ToastDanger('invalid value', 'max income could not be decimal value!!')
                    return false 
                }
            }

            return true
        },
        requiredFieldValidation: function() {
            self = this
            if (self.product.code === null || self.product.code === "") {
                self.ToastDanger('missing required field', 'product code could not be empty!!')
                return false
            }
            if (self.product.name === null || self.product.name === "") {
                self.ToastDanger('missing required field', 'product name could not be empty!!')
                return false
            }
            if (self.product.min_amount === null || self.product.min_amount === "") {
                self.ToastDanger('missing required field', 'min amount could not be empty!!')
                return false
            }
            if (self.product.max_amount === null || self.product.max_amount === "") {
                self.ToastDanger('missing required field', 'max amount could not be empty!!')
                return false
            }
            if (self.product.min_duration === null || self.product.min_duration === "") {
                self.ToastDanger('missing required field', 'min duration could not be empty!!')
                return false
            }
            if (self.product.max_duration === null || self.product.max_duration === "") {
                self.ToastDanger('missing required field', 'max duration could not be empty!!')
                return false
            }

            return true
        },
        saveProductProfile: function() {
            console.log(JSON.stringify(this.product))
            self = this
            self.reAssignEmptyFields();
            if(self.requiredFieldValidation() === true && self.integerFieldValidation() === true) {
                $.ajax({
                    url :  "{%url 'product_profile:ajax_add' %}", // the endpoint
                    type : "POST", // http method
                    data : {
                      product_profile: JSON.stringify(self.product),
                      customer_criteria: JSON.stringify(self.customer_criteria),
                      csrfmiddlewaretoken: self.csrftoken
                    }, // data sent with the get request
                      // handle a successful response
                    success : function(json) {
                        console.log(json)
                        self.ToastSuccess('success add product profile')
                        window.location.href = json.url
                    },
                      // handle a non-successful response
                    error : function(xhr,errmsg,err) {
                        console.log(xhr)
                        self.ToastDanger('failed add product profile!!',
                            xhr.responseText)
                    }
                });
            }
        },
        handleMultipleChange: function(e) {
            self = this
            val_arr = e.target.value.toLowerCase().replace(/, /g, ',').replace(/ ,/g, ',').split(',')
            model_name = e.target.name.split('__')[0]
            field_name = e.target.name.split('__')[1]
            self[model_name][field_name] = val_arr
        },
        handleCheck: function(e) {
            self = this
            model_name = e.target.name.split('__')[0]
            field_name = e.target.name.split('__')[1]
            self[model_name][field_name] = !JSON.parse(self[model_name][field_name])
        },
        ToastSuccess: function(header_msg, body_message){
         $.toast({
           heading: header_msg,
           text: body_message,
           position: 'top-right',
           loaderBg:'#ff6849',
           icon: 'success',
           hideAfter: 1500,
           stack: 6
         });
        },
        ToastDanger: function(header_msg, body_message){
         $.toast({
           heading: header_msg,
           text: body_message,
           position: 'top-right',
           loaderBg:'#ff6849',
           icon: 'error',
           hideAfter: 2800
         });
        }
    }
});
</script>
{% endblock %}