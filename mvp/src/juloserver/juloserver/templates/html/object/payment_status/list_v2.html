{% extends "common/theme1/list/list_footable_theme1.html" %}

{% load model template default unit %}
{% load checkusergroup from common %}
{% load ifusergroup from common %}

{% block additional_title %}Julo Pmt - status: {{ status_title }}{% endblock %}
{% block breadcrumb_title %}Data Payment {% endblock %}
{% block breadcrumb_path %}
<li><a href="#">Data Payment</a></li>
<li class="active">{{ status_title }}</li>
{% endblock %}

{% block list_title %}Payment : <code>{{status_title}} {%if status_title == 'all'%} 300's{%endif%}</code> {% endblock %}

{% block css_inside %}
.table tr {
    cursor: pointer;
}
.hiddenRow {
    padding: 0 4px !important;
    background-color: #e4e7ea;
    font-size: 13px;
}

td {
  word-wrap: break-word;
  max-width: 160px;
}

.dropdown-pos {
  position: relative;
}

.disabled {
  pointer-events: none;
}

.pagination > li > a:focus {
    background-color: #fff;
}
{% endblock %}
{% block content-list %}
<div id="payment-list">
  <div class="row">
    <div class="col-md-2 col-xs-12 p-l-10 p-r-10">
      <label class="col-md-12 col-sm-12">Pencarian</label>
      <div class="input-group m-t-10">
        <span class="input-group-addon"><i class="fa fa-search"></i></span>
        <input type="text" class="form-control" aria-describedby="basic-addon1" v-on:keyup.enter="SearchAction" placeholder="Pencarian" v-model="search">
      </div>
      <span class="help-block">
        <small>*app-id, email, hp, fullname, ktp, product-line-type, VA number, dll, partner</small>
      </span>
    </div>
    <div class="col-md-2 col-xs-12 p-l-10 p-r-10">
      <label class="col-md-12 col-sm-12">Kondisi Spesial</label>
      <div class="m-t-4">
          <select v-model="filter_special_condition" class="form-control" style="width:auto;">
            <option value="">-----------</option>
            <option v-for="special_condition in special_conditions" v-bind:value="special_condition.flag">
              <% special_condition.name %>
            </option>
          </select>
      </div>
    </div>
    {% if status_title == 'all' %}
      <div class="col-md-2 col-xs-12 p-l-10 p-r-10">
        <label class="col-md-12 col-sm-12">Status</label>
        <div class="m-t-10">
          <select v-model="filter_status" class="form-control"  style="width:auto;">
            <option value="">-----------</option>
            <option v-for="status in list_status" v-bind:value="status.status_code">
              <% status.status_code + ' - ' + status.status %>
            </option>
          </select>
        </div>
        <span class="help-block">
          <small>*pilih salah satu status app</small>
        </span>
      </div>
      <div v-if="status_code!='partner'" class="col-md-2 col-xs-12 p-l-10 p-r-10">
        <label class="col-md-12 col-sm-12">Sorting Agent</label>
        <div class="m-t-10">
          <select v-model="sort_agent_selected" class="form-control">
            <option value="">-----------</option>
            <option v-for="agent in list_agent" v-bind:value="agent.id">
              <% agent.username %>
            </option>
          </select>
        </div>
        <span class="help-block">
          <small>*pilih salah satu untuk sort agent</small>
        </span>
      </div>
    {% elif status_title in list_show_filter_agent %}
      <div v-if="status_code!='partner'" class="col-md-2 col-xs-12 p-l-10 p-r-10">
        <label class="col-md-12 col-sm-12">Sorting Agent</label>
        <div class="m-t-10">
          <select v-model="sort_agent_selected" class="form-control">
            <option value="">-----------</option>
            <option v-for="agent in list_agent" v-bind:value="agent.id">
              <% agent.username %>
            </option>
          </select>
        </div>
        <span class="help-block">
          <small>*pilih salah satu untuk sort agent</small>
        </span>
      </div>
    {% else %}
      <div class="col-md-3 col-xs-12 p-l-10 p-r-10">
        <label class="col-md-12 col-sm-12">Status</label>
        <div class="m-t-10">
          <select v-model="filter_status" class="form-control">
            <option value="">-----------</option>
            <option v-for="status in list_status" v-bind:value="status.status_code">
              <% status.status_code + ' - ' + status.status %>
            </option>
          </select>
        </div>
        <span class="help-block">
          <small>*pilih salah satu status app</small>
        </span>
      </div>
    {% endif %}

      <!-- Only show for Partner -->
    {% if status_code == 'partner' %}
      <div class="col-md-2 col-xs-12 p-l-10 p-r-10">
        <label class="col-md-12 col-sm-12">Partner</label>
        <div class="m-t-10">
          <select v-model="partner_selected" class="form-control">
            <option value="">-----------</option>
            <option v-for="partner in list_partner" v-bind:value="partner.id">
              <% partner.name %>
            </option>
          </select>
        </div>
        <span class="help-block">
          <small>*pilih salah satu untuk partner</small>
        </span>
      </div>
    {% endif %}

    <div class="col-md-4 col-xs-12 m-t-30">
      <div class="col-md-4 col-xs-12">
        <button type="submit" class="btn btn-primary btn-rounded btn-block" v-on:click="SearchAction">
          <strong><i class="fa fa-search" ></i> Cari</strong>
        </button>
      </div>
      <div class="col-md-5 col-xs-12">
        <button type="button" class="btn btn-info btn-rounded" v-on:click="EmptyAction">
          <strong><i class="fa fa-eraser fa-fw"></i> Kosongkan</strong>
        </button>
      </div>
      <div class="col-md-3 col-xs-12">
        <a class="btn btn-danger center btn-rounded" role="button" data-toggle="collapse" href="#id_pencarian_tgl" aria-expanded="false" aria-controls="id_pencarian_tgl">
          <i class="fa fa-calendar fa-fw"></i><i class="fa fa-arrow-down fa-fw"></i>
        </a>
      </div>
    </div>
  </div>
  <div class="collapse m-t-15" id="id_pencarian_tgl">
    <div class="well">
      <div class="row">
        <div class="col-md-4 col-xs-12">
          <label class="col-md-12 col-sm-12">Periode</label>
          <div class="col-md-12 col-sm-12">
            <input type="checkbox" id="checkbox" v-model="today_checked" v-on:click="TodayAction">
            <label for="checkbox"> Hari ini </label>
            &nbsp;&nbsp;&nbsp;
            <input type="checkbox" id="checkbox" v-model="freeday_checked" v-on:click="FreedayAction">
            <label for="checkbox"> Bebas hari </label>
          </div>
        </div>
        <div class="collapse col-md-8 col-xs-12" id="id_toggle_tgl_entry">
          <h5 class="m-t-0">Tanggal Entry : </h5>
            <div class="input-group m-t-10 ">
              <span class="input-group-addon"><i class="fa fa-calendar fa-fw"></i></span>
              <input class="form-control input-daterange-timepicker" id="id_datetime_range" name="datetime_range" type="text">
            </div>
        </div>
      </div>
    </div>
  </div>
  <div class="collapse m-t-15" id="id_pencarian_tgl">
    <span class="input-group-addon"><i class="fa fa-calendar fa-fw"> Reassign</i></span>
  </div>
  <table id="demo-foo-row-toggler" class="table toggle-circle table-hover" :data-page-size="max_row_per_page">
    <thead>
      <tr id="julo-sort-form" data-julo-sort-form="search-form" data-julo-sort-query-field="id_sort_q">
        <th data-toggle="true" data-sort-ignore="true"> No </th>
        <th colspan="2" data-sort-ignore="true" class="julo-sort-header" data-julo-sort="id"> Pmt-ID </th>
        <th class="text-center" data-sort-ignore="true" class="julo-sort-header" data-julo-sort="loan__application__product_line__product_line_type"> PLine</th>
        <th data-sort-ignore="true" class="julo-sort-header" data-julo-sort="loan__customer__email"> Email </th>
        <th data-hide="phone" data-sort-ignore="true" class="julo-sort-header" data-julo-sort="loan__application__fullname"> Full Name</th>
        <th data-toggle="phone" data-sort-ignore="true" class="hidden">Squad</th>
        {% if 'Supervisor' in status_title and status_code != 'partner' %}
          <th data-toggle="phone" data-sort-ignore="true" class="julo-sort-header" data-julo-sort="agent">Agent</th>
          <th data-toggle="phone" data-sort-ignore="true" class="julo-sort-header" data-julo-sort="is_robocall_active || payment.payment__is_robocall_active ">Robocall ON/OFF</th>
        {% endif %}
          <th data-toggle="phone" data-sort-ignore="true" class="julo-sort-header" data-julo-sort="payment_status__status_code"> Status </th>
        {% if status_title == "PTP" %}
          <th data-hide="phone" data-sort-ignore="true" class="julo-sort-header" data-julo-sort="dpd_ptp"> dpd ptp</th>
        {% else %}
          <th data-hide="phone" data-sort-ignore="true" class="julo-sort-header" data-julo-sort="dpd"> dpd</th>
        {% endif %}
        {% if 'agent' in status_title %}
        <th data-hide="phone" data-sort-ignore="true" class="julo-sort-header" data-julo-sort="dpd">reminder date</th>
        {% endif %}
        <th data-hide="phone" data-sort-ignore="true" class="julo-sort-header" data-julo-sort="payment_number"> Pmt#</th>
        <th data-hide="phone" data-sort-ignore="true" class="julo-sort-header" data-julo-sort-double = "y" data-julo-sort="loan_and_status"> LoanID-Status</th>
        <th data-toggle="phone" data-sort-ignore="true" class="julo-sort-header" data-julo-sort="udate"> <i class="fa fa-clock-o"></i> UDate </th>
        <th data-sort-ignore="true" class="julo-sort-header" data-julo-sort="loan__application__partner">Partner</th>
        <th data-hide="phone" data-sort-ignore="true" class="min-width text-center">Actions</th>
      </tr>
    </thead>
    <div class="form-inline padding-bottom-15">
      <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12 hidden-xs">
        </div>
      </div>
      <div class="row">
        <div class="col-sm-6 col-xs-12 hidden-xs">
        </div>
      </div>
    </div>
    <tbody>
      <template v-for="(payment, index) in payments">
        <tr class="parent-row">
          <td v-on:click="ShowToogle(payment.payment__id || payment.id)"><% start_index+index+1 %></td>
          <td>
            <a v-if="GetDpd(payment.payment__due_date || payment.due_date, payment.payment__paid_date || payment.paid_date, payment.payment_status_id) >= -5" v-on:click="CheckLockedData(payment.payment__id || payment.id)" target="_blank">
              <% (payment.payment__id || payment.id) %>
            </a>
            <a v-else :href="GetUrl(payment.payment__id || payment.id, payment.payment_status_id)" target="_blank">
              <% (payment.payment__id || payment.id) %>
            </a>
          </td>
          <td v-if="GetDpd(payment.payment__due_date || payment.due_date, payment.payment__paid_date || payment.paid_date, payment.payment_status_id) >= -5" class="text-center" v-on:click="ShowToogle(payment.payment__id || payment.id)">
            <span v-if="payment_lock_list.indexOf(payment.payment__id || payment.id) != -1" class="label label-danger lbl-sm lbl-rounded pull-right"><i class="fa fa-lock"></i></span>
            <span v-else class="label label-custom lbl-sm lbl-rounded pull-right"><i class="fa fa-unlock"></i></span>
          </td>
          <td v-else v-on:click="ShowToogle(payment.payment__id || payment.id)"></td>
          <td class="text-center" v-on:click="ShowToogle(payment.payment__id || payment.id)">
            <span v-if="payment.loan__application__product_line_id == 10" class="label label-rouded label-info pull-center small">MTL1</span>
            <span v-else-if="payment.loan__application__product_line_id == 11" class="label label-rouded label-warning pull-center small">MTL2</span>
            <span v-else-if="payment.loan__application__product_line_id == 20" class="label label-rouded label-primary pull-center small">STL1</span>
            <span v-else-if="payment.loan__application__product_line_id == 21" class="label label-rouded label-danger pull-center small">STL2</span>
            <span v-else-if="payment.loan__application__product_line_id == 40" class="label label-rouded label-danger pull-center small">BRI1</span>
            <span v-else-if="payment.loan__application__product_line_id == 41" class="label label-rouded label-danger pull-center small">BRI2</span>
            <span v-else-if="payment.loan__application__product_line_id == 50" class="label label-rouded label-success pull-center small">GRAB1</span>
            <span v-else-if="payment.loan__application__product_line_id == 51" class="label label-rouded label-danger pull-center small">GRAB2</span>
            <span v-else-if="payment.loan__application__product_line_id == 70" class="label label-rouded label-danger pull-center small">GRABF1</span>
            <span v-else-if="payment.loan__application__product_line_id == 92" class="label label-rouded label-danger pull-center small">ICARE1</span>
            <span v-else-if="payment.loan__application__product_line_id == 93" class="label label-rouded label-danger pull-center small">ICARE2</span>
            <span v-else-if="payment.loan__application__product_line_id == 94" class="label label-rouded label-success pull-center small">AXIATA1</span>
            <span v-else-if="payment.loan__application__product_line_id == 95" class="label label-rouded label-success pull-center small">AXIATA2</span>
            <span v-else class="label label-rouded label-success pull-center small"><% payment.loan__application__product_line_id %></span>
          </td>
          <td v-on:click="ShowToogle(payment.payment__id || payment.id)"> <% payment.loan__application__email %> </td>
          <td v-on:click="ShowToogle(payment.payment__id || payment.id)"> <% payment.loan__application__fullname %> </td>
          <td v-if="!payment.hasOwnProperty('squad__squad_name')" class="hidden">
            <div v-on:click="ShowToogle(payment.payment__id || payment.id)"
                v-if="payment.collection_bucket_1.squad || payment.collection_bucket_2.squad ||
                        payment.collection_bucket_3.squad || payment.collection_bucket_4.squad ||
                        payment.collection_bucket_5.squad">
              <div v-if="payment.collection_bucket_1.id != ''"><% payment.collection_bucket_1.squad %></div>
              <div v-else-if="payment.collection_bucket_2.id != ''"><% payment.collection_bucket_2.squad %></div>
              <div v-else-if="payment.collection_bucket_3.id != ''"><% payment.collection_bucket_3.squad %></div>
              <div v-else-if="payment.collection_bucket_4.id != ''"><% payment.collection_bucket_4.squad %></div>
              <div v-else-if="payment.collection_bucket_5.id != ''"><% payment.collection_bucket_5.squad %></div>
            </div>
            <div v-else><code>-</code></div>
          </td>
          <td v-else>
            <div><% payment.squad__squad_name %></div>
          </td>
          {% if 'Supervisor' in status_title and status_code != 'partner' %}
            <td v-on:click="ShowToogle(payment.payment__id || payment.id)" v-if="payment.collection_bucket_1.username || payment.collection_bucket_2.username ||
                  payment.collection_bucket_3.username || payment.collection_bucket_4.username ||
                  payment.collection_bucket_5.username">
              <div v-if="payment.collection_bucket_1.id != ''"><% payment.collection_bucket_1.username %></div>
              <div v-else-if="payment.collection_bucket_2.id != ''"><% payment.collection_bucket_2.username %></div>
              <div v-else-if="payment.collection_bucket_3.id != ''"><% payment.collection_bucket_3.username %></div>
              <div v-else-if="payment.collection_bucket_4.id != ''"><% payment.collection_bucket_4.username %></div>
              <div v-else-if="payment.collection_bucket_5.id != ''"><% payment.collection_bucket_5.username %></div>
            </td>
            <td v-else><code>-</code></td>
          <td class="text-center">
            <button :id="'btn-robo-'+(payment.payment__id || payment.id)" type="button" :class="(payment.payment__is_robocall_active || payment.is_robocall_active) | robo_class" title="Toggle Robocall" v-on:click="UpdateRobocall(payment.payment__id || payment.id)">
              <i class="fa fa-android"></i>
            </button>
          </td>
          {% endif %}
          <td v-on:click="ShowToogle(payment.payment__id || payment.id)"><code><% payment.payment_status_id || payment.payment__payment_status_id %></code></td>
          {% if status_title == "PTP" %}
            <td v-on:click="ShowToogle(payment.payment__id || payment.id)"><code><% GetDpd(payment.payment__ptp_date || payment.ptp_date, payment.payment__paid_date || payment.paid_date, payment.payment_status_id) %></code></td>
          {% else %}
            <td v-on:click="ShowToogle(payment.payment__id || payment.id)"><code><% GetDpd(payment.due_date || payment.payment__due_date, payment.payment__paid_date || payment.paid_date, payment.payment_status_id) %></code></td>
          {% endif %}
          {% if 'agent' in status_title %}
          <td v-on:click="ShowToogle(payment.payment__id || payment.id)"><strong><% (payment.reminder_call_date || payment.payment__reminder_call_date) | formatDate %></strong></td>
          {% endif %}
          <td v-on:click="ShowToogle(payment.payment__id || payment.id)">
            <span class="label label-success"><% payment.payment_number || payment.payment__payment_number %></span>
          </td>
          <td v-on:click="ShowToogle(payment.payment__id || payment.id)">
            <% payment.loan_id %> <code><% payment.loan__loan_status_id %></code>
          </td>
          <td v-on:click="ShowToogle(payment.payment__id || payment.id)">
            <strong>
              <% (payment.udate || payment.payment__udate) | formatDate %>
            </strong>
          </td>
          <td v-on:click="ShowToogle(payment.payment__id || payment.id)"><% payment.loan__application__partner__name %></td>
          <td class='text-center'>
            <div class="btn-group m-r-10">
              <button aria-expanded="false" data-toggle="dropdown" class="btn btn-primary btn-rounded dropdown-toggle waves-effect waves-light" type="button">
                --Pilih-- <span class="caret"></span>
              </button>
              <ul role="menu" class="dropdown-menu dropdown-pos">
                <li>
                  <a :href="GetUrl(payment.payment__id || payment.id)" title='detail' target="_blank">
                    <button class="btn btn-danger btn-block">Detail</button>
                  </a>
                </li>
                <li v-if="GetDpd(payment.payment__due_date || payment.due_date, payment.payment__paid_date || payment.paid_date, payment.payment_status_id) >= -5">
                  <a href="#" v-if="payment_lock_list.indexOf(payment.id || payment.payment__id) != -1" title='lock payment ini' v-on:click="SetPaymentUnLocked(payment.id || payment.payment__id);">
                    <button class="btn btn-danger btn-block">Unlock Payment</button>
                  </a>
                  <a href="#" v-else title='lock payment ini' v-on:click="SetPaymentLocked(payment.id || payment.payment__id);">
                    <button class="btn btn-danger btn-block">Lock Payment</button>
                  </a>
                </li>
              </ul>
            </div>
          </td>
        </tr>
        <tr>
          <td colspan="17" class="hiddenRow">
            <table class="collapse" :id="'collapse-'+(payment.payment__id || payment.id)">
              <tbody>
                <tr>
                  <td class='m-r-10'> Application ID </td>
                  <td>
                    &nbsp;&nbsp;<i class='fa fa-arrow-circle-o-right fa-fw'></i>
                    <strong> <% payment.loan__application_id %></strong>
                  </td>
                </tr>
                <tr>
                  <td class='m-r-10'> Customer ID </td>
                  <td>
                    &nbsp;&nbsp;<i class='fa fa-arrow-circle-o-right fa-fw'></i>
                    <strong> <% payment.loan__application__customer_id %></strong>
                  </td>
                </tr>
                <tr>
                  <td colspan=2><hr></td>
                </tr>
                <tr>
                  <td> Due Date </td>
                  <td>
                    &nbsp;&nbsp;<i class='fa fa-arrow-circle-o-right fa-fw'></i>
                    <strong> <% payment.due_date || payment.payment__due_date %></strong>
                  </td>
                </tr>
                <tr>
                  <td class='m-r-10'> Due Amount </td>
                  <td>
                    &nbsp;&nbsp;<i class='fa fa-arrow-circle-o-right fa-fw'></i>
                    <strong><% payment.due_amount || payment.payment__due_amount %></strong>
                  </td>
                </tr>
                <tr>
                  <td class='m-r-10'> Late Fee Amount </td>
                  <td>
                    &nbsp;&nbsp;<i class='fa fa-arrow-circle-o-right fa-fw'></i>
                    <strong><% payment.late_fee_amount || payment.payment__late_fee_amount %></strong>
                  </td>
                </tr>
                <tr>
                  <td class='m-r-10'> Cash Back Earned </td>
                  <td>
                    &nbsp;&nbsp;<i class='fa fa-arrow-circle-o-right fa-fw'></i>
                    <strong><% payment.cashback_earned || payment.payment__cashback_earned %></strong>
                  </td>
                </tr>
                <tr>
                  <td colspan=2> <hr> </td>
                </tr>
                <tr>
                  <td>Nama Lengkap</td>
                  <td>
                    &nbsp;&nbsp;<i class='fa fa-arrow-circle-o-right fa-fw'></i>
                    <strong> <% payment.loan__application__fullname %></strong>
                  </td>
                </tr>
                <tr>
                  <td class='m-r-10'> No. HP </td>
                  <td>
                    &nbsp;&nbsp;<i class='fa fa-arrow-circle-o-right fa-fw'></i>
                    <strong><% payment.loan__application__mobile_phone_1 %></strong>
                  </td>
                </tr>
                <tr>
                  <td class='m-r-10'> No KTP </td>
                  <td>
                    &nbsp;&nbsp;<i class='fa fa-arrow-circle-o-right fa-fw'></i>
                    <strong><% payment.loan__application__ktp %></strong>
                  </td>
                </tr>
                <tr>
                  <td class='m-r-10'> Tgl Lahir </td>
                  <td>
                    &nbsp;&nbsp;<i class='fa fa-arrow-circle-o-right fa-fw'></i>
                    <strong><% payment.loan__application__dob %></strong>
                  </td>
                </tr>
                <tr>
                  <td> Loan Amount </td>
                  <td>
                    &nbsp;&nbsp;<i class='fa fa-arrow-circle-o-right fa-fw'></i>
                    <strong> <% payment.loan__loan_amount %></strong>
                  </td>
                </tr>
                <tr>
                  <td> Loan Duration </td>
                  <td>
                    &nbsp;&nbsp;<i class='fa fa-arrow-circle-o-right fa-fw'></i>
                    <strong> <% payment.loan__loan_duration %></strong>
                  </td>
                </tr>
                <tr>
                  <td> CDate </td>
                  <td>
                    &nbsp;&nbsp;<i class='fa fa-arrow-circle-o-right fa-fw'></i>
                    <strong> <% payment.cdate || payment.payment__cdate %></strong>
                  </td>
                </tr>
              </tbody>
            </table>
          </td>
        </tr>
      </template>
    </tbody>
  </table>
  <tfoot>
    <div v-if="payments.length < 1" class="text-center">
      -- tidak ada data --
    </div>
    <tr>
      <td>
        <div class="text-center">
          <ul class="pagination">
            <li v-for="(n, index) in page_array" v-bind:class="GetClassPagination(n)" v-on:click="ChoosePage(n)">
              <a v-if="n == 0" href="#">...</a>
              <a v-else href="#"><% n %></a>
            </li>
          </ul>
        </div>
      </td>
    </tr>
  </tfoot>
  <!-- /.modal update agent-->
  <div id="responsive-modal-edit-agent" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="AsignAgent" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header label-danger">
          <h4 class="modal-title">Assign Agent</h4> </div>
          <div class="modal-body">
            <div class="form-group">
              <label>Select Type</label>
              <select v-model="form_agent_type_selected" class="form-control" v-on:change="SelectedAgentType">
                <option value=""> -- </option>
                <option  v-for="agent_type in list_agent_type" v-bind:value="agent_type.value">
                  <% agent_type.label %>
                </option>
              </select>
            </div>
            <div class="form-group" v-show="form_agent_type_selected != ''">
              <label>Select Agent</label>
              <select v-model="form_agent_selected" class="form-control">
                <option value=""> -- </option>
                <option  v-for="agent in list_filter_agent_selected" v-bind:value="agent.id">
                  <% agent.username %>
                </option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default waves-effect" data-dismiss="modal" v-on:click="CleanFormSelectedAgent">Batal</button>
            <button type="button" class="btn btn-success waves-effect" v-on:click="UpdateAgent">Update</button>
          </div>
        </div>
    </div>
  </div>

  <!-- modal lock payment-->
  <div id="modal-locked-payment" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header label-success">
          <h4 class="modal-title"><% title_payment_lock %></h4>
        </div>
        <div class="modal-body">
          <% body_payment_lock %>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-warning waves-effect" data-dismiss="modal" v-on:click="OpenNewTab();">Lihat Payment</button>
          <button type="button" class="btn btn-custom waves-effect" data-dismiss="modal" v-on:click="SetPaymentLocked(payment_id_selected);" v-if="status_lock_payment">Lock dan Edit Payment</button>
          <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">Batal</button>
        </div>
      </div>
    </div>
  </div>

  <!-- modal success-->
  <div id="responsive-modal-success" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header label-warning">
          <h4 class="modal-title" id="modal_title">Title</h4> </div>
        <div class="modal-body" id="modal_body">
          Body
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default waves-effect" data-dismiss="modal" onclick="close_btn()">Tutup</button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% load static from staticfiles %}
{% block custom_link %}
<link href="{% static 'theme/plugins/bower_components/bootstrap-select/bootstrap-select.min.css' %}" rel="stylesheet" />

<!-- Page plugins css -->
<link href="{% static 'theme/plugins/bower_components/clockpicker/dist/jquery-clockpicker.min.css' %}" rel="stylesheet">
<!-- Date picker plugins css -->
<link href="{% static 'theme/plugins/bower_components/bootstrap-datepicker/bootstrap-datepicker.min.css' %}" rel="stylesheet" type="text/css" />
<!-- Daterange picker plugins css -->
<link href="{% static 'theme/plugins/bower_components/timepicker/bootstrap-timepicker.min.css' %}" rel="stylesheet">
<link href="{% static 'theme/plugins/bower_components/bootstrap-daterangepicker/daterangepicker.css' %}" rel="stylesheet">
<link href="{% static 'theme/plugins/bower_components/toast-master/css/jquery.toast.css' %}" rel="stylesheet">
<link href="{% static 'default/css/julo-sorting.css' %}" rel="stylesheet">
{% endblock %}


{% block script_additional %}
<!-- Plugin JavaScript -->
<script src="{% static 'theme/plugins/bower_components/moment/moment.js' %}"></script>

<!-- Date Picker Plugin JavaScript -->
<script src="{% static 'theme/plugins/bower_components/bootstrap-datepicker/bootstrap-datepicker.min.js' %}"></script>
<!-- Date range Plugin JavaScript -->
<script src="{% static 'theme/plugins/bower_components/timepicker/bootstrap-timepicker.min.js' %}"></script>
<script src="{% static 'theme/plugins/bower_components/bootstrap-daterangepicker/daterangepicker-julo.js' %}"></script>

<!-- Footable -->
<script src="{% static 'theme/plugins/bower_components/bootstrap-select/bootstrap-select.min.js' %}" type="text/javascript"></script>

<!--Style Switcher -->
<script src="{% static 'theme/plugins/bower_components/styleswitcher/jQuery.style.switcher.js' %}"></script>
<script src="{% static 'theme/plugins/bower_components/toast-master/js/jquery.toast.js' %}"></script>

<!-- vue js -->
<script src="{% static 'default/js/vue.js' %}"></script>
<script src="{% static 'default/js/filter.js' %}"></script>
<script type="text/javascript">
var AppPaymentList = new Vue({
  el: '#payment-list',
  delimiters: ["<%", "%>"],
  data: {
    csrftoken:'{{csrf_token}}',
    status_code: '{{status_code}}',
    status_show: '{{status_show}}',
    payments: '',
    filter_status: '{{status_app}}',
    filter_special_condition: '{{filter_special_condition}}',
    filter_status_q: '{{status_app}}',
    sort_agent_selected: '',
    partner_selected: '',
    list_status: [],
    list_agent: [],
    list_partner: [],
    list_agent_type: [],
    list_filter_agent_selected: [],
    sort: null,
    search: null,
    filter: null,
    count_page: 0,
    current_page: 0,
    page_choose: 1,
    start_index: 0,
    max_row_per_page: 50,
    payment_lock_list: [],
    opened: [],
    okay: false,
    old_agent_id_selected:'',
    search_q:'{{search_q}}',
    search:'{{search_q}}',
    today_checked: false,
    freeday_checked: false,
    today_checked_q: false,
    freeday_checked_q: false,
    range_date:null,
    sort_q:'',
    form_agent_selected:'',
    form_agent_type_selected: '',
    payment_id_agent:'',
    autodialer_result:[],
    payment_id_selected:null,
    status_lock_payment:false,
    title_payment_lock:'',
    body_payment_lock:'',
    window_tab_status:true,
    usergroup:'',
    isCheckAll: false,
    selected_payments: [],
    page_array:[],
    payment_paid_status: 330,
    special_conditions: [],
  },
  beforeMount(){
    self = this
    document.addEventListener('DOMContentLoaded', function(){
        var elements = document.getElementsByClassName("julo-sort-header");
        for (var i = 0; i < elements.length; i++) {
            self.AddToggles(elements[i]);
        };
        self.UpdateSortState(self.sort_q);
    }, false);

    this.GetPaymentList();
  },

  methods: {
    GetPaymentList: function() {
      if (!this.window_tab_status){return}
      console.log('Get list')
      var self = this
      $.ajax({
          url :  "{%url 'payment_status:ajax_payment_list_view' %}/", // the endpoint
          type : "GET", // http method
          data : {
              status_code: self.status_code,
              status_app: self.filter_status_q,
              page: self.page_choose,
              search_q: self.search_q,
              today_checked: self.today_checked_q,
              freeday_checked: self.freeday_checked_q,
              range_date:self.range_date,
              sort_q:self.sort_q,
              sort_agent: self.sort_agent_selected,
              max_per_page: self.max_row_per_page,
              sort_partner: self.partner_selected,
              filter_special_condition: self.filter_special_condition
            }, // data sent with the get request
          // handle a successful response
          success : function(json) {
              // console.log(json); // log the returned json to the console
              if(json.status == 'success'){
                self.list_partner = json.list_partner
                self.payments = json.data
                console.log(self.payments)
                self.count_page = json.count_page
                self.current_page = json.current_page
                self.payment_lock_list = json.payment_lock_list
                self.list_status = json.list_status
                self.list_agent = json.list_agent
                self.autodialer_result = json.autodialer_result
                self.list_agent_type = json.list_agent_type
                self.payment_paid_status = json.payment_paid_status
                self.special_conditions = json.special_conditions
                if(self.sort_q){
                  self.UpdateSortState(self.sort_q)
                }
                self.UpdatePageArray();
              }else{
                console.log(json.message);
                self.ToastDanger('Error','Update get payment list');
              }
          },
          // handle a non-successful response
          error : function(xhr,errmsg,err) {
            self.ToastDanger('Error','Update get payment list');
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            this.callProcess = 'we have an erorr while getting data'
          }
      }); // end of ajax
    },
    UpdateAgent: function(){
      self = this
      $.ajax({
         url :  "{% url 'payment_status:ajax_update_agent' %}/",
         type : "POST",
         data : {
           payment_id : self.payment_id_agent,
           new_agent_id : self.form_agent_selected,
           current_agent_id : self.old_agent_id_selected,
           usergroup : self.form_agent_type_selected,
           csrfmiddlewaretoken: self.csrftoken
         },
         // handle a successful response
         success : function(json) {
             if (json.status == "success"){
               $("#responsive-modal-edit-agent").modal('hide');
               self.ToastSuccess('Success','Update Agent');
               self.GetPaymentList()
             } else if(json.status == "failed"){
               console.log(json);
               self.ToastDanger('Failed',json.message);
             }
         },
         // handle a non-successful response
         error : function(xhr, errmsg, err) {
          console.log(xhr.status + ": " + xhr.responseText);
          self.ToastDanger('Failed',err);
         }
      });
    },
    UpdateRobocall: function(payment_id){
     self = this
      $.ajax({
        url :  "{% url 'payment_status:update_robocall' %}/",
        type : "GET",
        data : {
          payment_id : payment_id,
          csrfmiddlewaretoken: self.csrftoken
        },
        // handle a successful response
        success : function(json) {
          if (json.status == "success"){
           self.ToastSuccess('Robocall Update',json.message);
           self.GetPaymentList()
          } else if(json.status == "failed"){
           self.ToastDanger('Robocall Update',json.message);
          }
        },
        // handle a non-successful response
        error : function(xhr, errmsg, err) {
          self.ToastDanger('Robocall Update Failed!', err);
        }
      })
    },
    CheckLockedData: function(payment_id){
      self = this
      $.ajax({
          url :  "{%url 'payment_status:check_payment_locked' %}/", // the endpoint
          type : "GET", // http method
          data : {
            payment_id: payment_id,
            csrfmiddlewaretoken: self.csrftoken
          }, // data sent with the get request
          // handle a successful response
          success : function(json) {
              self.payment_id_selected = payment_id;
              if (json.code == "03"){
                //show notification that payment free to locked
                self.status_lock_payment = true;
                self.title_payment_lock = "Payment Masih Belum di-Lock!";
                self.body_payment_lock = "Payment masih blum diproses dan di-lock oleh Agent, Silahkan Pilih tombol aksi dibawah ini!";
                $('#modal-locked-payment').modal('show');
              }
              else if (json.code == "02"){
                //show notification that payment was locked and not allowed edit status changes
                self.title_payment_lock = "Payment Sudah di-Lock";
                self.body_payment_lock = "Payment telah di lock oleh " + (json.reason[1]) + " dengan TS: " + (json.reason[3]) + ", Apakah Ingin Lanjut?";
                $('#modal-locked-payment').modal('show');
              }
              else if (json.code == "09"){
                //show notification that payment was locked and not allowed edit status changes
                self.title_payment_lock = "Perhatian!!!";
                self.body_payment_lock = json.reason;
                $('#modal-locked-payment').modal('show');
              }else if(json.code == "01"){
                self.OpenNewTab()
              }else {
                self.ToastDanger('Check Lock Failed!', json.reason);
              }
          },
          // handle a non-successful response
          error : function(xhr, errmsg, err) {
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            self.ToastDanger('Check Lock Failed!', err);
          }
      }); // end of ajax
    },
    SetPaymentLocked: function(payment_id){
      self = this
      $.ajax({
          url :  "{%url 'payment_status:set_payment_locked' %}/", // the endpoint
          type : "GET", // http method
          data : {
            payment_id: payment_id,
            csrfmiddlewaretoken: self.csrftoken,
          }, // data sent with the get request
          // handle a successful response
          success : function(json) {
              if (json.result == "successful!"){
                self.payment_id_selected = payment_id
                self.OpenNewTab();
              }
              else {
                console.log(json.reason);
                self.ToastDanger('Check Lock Failed!', 'err');
              }
          },
          // handle a non-successful response
          error : function(xhr,errmsg,err) {
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            self.ToastDanger('Check Lock Failed!', err);
          }
      }); // end of ajax
    },
    SetPaymentUnLocked: function(payment_id){
      self = this
      $.ajax({
          url :  "{%url 'payment_status:set_payment_unlocked' %}/", // the endpoint
          type : "GET", // http method
          data : {
            payment_id: payment_id,
            csrfmiddlewaretoken: self.csrftoken,
          }, // data sent with the get request
          // handle a successful response
          success : function(json) {
            if (json.result == "successful!"){
              //redirect this page
              self.ToastSuccess('Un-Lock Success',json.reason);
              self.GetPaymentList();
            }
            else {
              //show notification that payment was locked
              console.log(json.reason);
              self.ToastDanger('Un-Lock Gagal', json.reason);
            }
          },
          // handle a non-successful response
          error : function(xhr, errmsg, err) {
              console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
              self.ToastDanger('Un-Lock Gagal', err);
          }
      }); // end of ajax
    },
    GetClassPagination: function(index) {
      if (index==0) return {'disabled':1};
      return{
        'active': this.current_page == index
      }
    },
    ChoosePage: function(page) {
      this.page_choose = page
      this.start_index = (page-1) * this.max_row_per_page
      this.GetPaymentList()
    },
    GetDpd: function(due_date, paid_date, status_code) {
      if (!due_date){
        return "-"
      }
      var now = moment();
      var dt1 = new Date(due_date);
      var dt2 = new Date(now);
      if (status_code >= this.payment_paid_status){
        if (!paid_date){
          return "-"
        }
        var dt2 = new Date(paid_date);
      }
      return Math.floor((Date.UTC(dt2.getFullYear(), dt2.getMonth(), dt2.getDate()) - Date.UTC(dt1.getFullYear(), dt1.getMonth(), dt1.getDate()) ) /(1000 * 60 * 60 * 24));
    },
    toggle: function(id) {
    	const index = this.opened.indexOf(id);
      if (index > -1) {
      	this.opened.splice(index, 1)
      } else {
      	this.opened.push(id)
      }
    },
    GetUrl: function(payment_id){
      var url = "{% url 'payment_status:change_status' 123456 %}".replace(/123456/, payment_id)
      return url
    },
    SearchAction: function(){
      if(this.freeday_checked){
        this.range_date = $("#id_datetime_range").val();
      }
      this.freeday_checked_q = this.freeday_checked;
      this.today_checked_q = this.today_checked;
      this.search_q = this.search;
      this.filter_status_q = this.filter_status
      this.page_choose = 1
      this.GetPaymentList()
    },
    EmptyAction: function(){
      this.search=''
      this.filter_status=''
      this.filter_special_condition=''
      this.today_checked=false
      this.freeday_checked=false
      this.search_q=''
      this.filter_status_q=''
      this.today_checked_q=false
      this.freeday_checked_q=false
      $("#id_datetime_range").val('')
      this.range_date=''
      this.GetPaymentList()
    },
    TodayAction: function(){
      this.freeday_checked = false;
      $("#id_toggle_tgl_entry").toggle(false);
    },
    FreedayAction: function(){
      this.today_checked = false;
      if(this.freeday_checked){
        $("#id_toggle_tgl_entry").toggle(false);
      }else {
        $("#id_toggle_tgl_entry").toggle(true);
      }
    },
    UpdateSortState: function(sort_value){
      if (sort_value != ""){
          var id;
          if (sort_value.includes("_desc")){id = sort_value.replace("_desc", "") + "-sort-toggle";}
          else if (sort_value.includes("_asc")){id = sort_value.replace("_asc", "") + "-sort-toggle";}
          else{id = sort_value.replace("-", "") + "-sort-toggle";};
          var toggle_element = document.getElementById(id);
          this.ResetState(toggle_element);
          toggle_element.setAttribute( "data-julo-sort",  sort_value);
          if (sort_value.includes("-") || sort_value.includes("_desc") ){
              toggle_element.classList.remove( "julo-sort-indicator-default");
              toggle_element.classList.remove( "julo-sort-indicator-asc");
              toggle_element.classList.add("julo-sort-indicator-desc");
          }else{
              toggle_element.classList.remove( "julo-sort-indicator-default");
              toggle_element.classList.remove( "julo-sort-indicator-desc");
              toggle_element.classList.add("julo-sort-indicator-asc");
          }
      }
    },
    ResetState: function(element){
      $(".julo-sort-indicator-asc").attr('class', 'julo-sort-indicator julo-sort-indicator-default');
      $(".julo-sort-indicator-desc").attr('class', 'julo-sort-indicator julo-sort-indicator-default');
      $(".julo-sort-indicator-asc").removeAttr('data-julo-sort');
      $(".julo-sort-indicator-desc").removeAttr('data-julo-sort');
    },
    AddToggles: function(item) {
        var sortVar = item.getAttribute("data-julo-sort");
        var node = document.createElement("span");
        var is_double = item.getAttribute("data-julo-sort-double");
        if(is_double){
          node.setAttribute("data-julo-sort-double", "y");
        };
        node.setAttribute("id", sortVar+"-sort-toggle");
        node.setAttribute("class", "julo-sort-indicator julo-sort-indicator-default");
        node.setAttribute("data-julo-sort", "");
        node.setAttribute("onclick", "SortBySubmit('"+sortVar+"-sort-toggle');");
        item.appendChild(node);
    },
    SortingAction: function(query){
      if (this.sort_q != '' && this.sort_q == query){
        var toggle_element = document.getElementById(this.sort_q+'-sort-toggle');
        toggle_element.classList.add( "julo-sort-indicator-default");
        toggle_element.classList.remove( "julo-sort-indicator-desc");
        toggle_element.classList.remove("julo-sort-indicator-asc");
      }
      this.sort_q = query
      this.GetPaymentList()
    },
    EditAgent: function(payment_id){
      this.payment_id_agent = payment_id
      $('#responsive-modal-edit-agent').modal('show');
    },
    SelectedAgentType: function(){
      this.list_filter_agent_selected = this.list_agent.filter(item => item.groups__name == this.form_agent_type_selected)
      payment_selected = this.payments.filter(payment => payment.id == this.payment_id_agent)
      if(this.form_agent_type_selected == 'collection_agent_2'){
        this.form_agent_selected = payment_selected[0].agent_2.id
        this.old_agent_id_selected = payment_selected[0].agent_2.id
      }else if (this.form_agent_type_selected == 'collection_agent_3') {
        this.form_agent_selected = payment_selected[0].agent_3.id
        this.old_agent_id_selected = payment_selected[0].agent_3.id
      }else if (this.form_agent_type_selected == 'collection_agent_4') {
        this.form_agent_selected = payment_selected[0].agent_4.id
        this.old_agent_id_selected = payment_selected[0].agent_4.id
      }else if (this.form_agent_type_selected == 'collection_agent_5') {
        this.form_agent_selected = payment_selected[0].agent_5.id
        this.old_agent_id_selected = payment_selected[0].agent_5.id
      }
    },
    CleanFormSelectedAgent: function(){
      this.form_agent_type_selected = ''
      this.payment_id_agent= ''
      this.list_filter_agent_selected= []
    },
    OpenNewTab: function(){
      var url_selected = "/payment_status/change_status/"+this.payment_id_selected;
      var win = window.open(url_selected, '_blank');
      win.focus();
    },
    SetWindowTabStatus: function(status){
      this.window_tab_status = status
    },
    ShowToogle(payment_id){
      $("#collapse-"+payment_id).toggle();
    },
    ToastSuccess: function(header_msg, body_message){
     $.toast({
       heading: header_msg,
       text: body_message,
       position: 'top-right',
       loaderBg:'#ff6849',
       icon: 'success',
       hideAfter: 1500,
       stack: 6
     });
    },
    ToastDanger: function(header_msg, body_message){
     $.toast({
       heading: header_msg,
       text: body_message,
       position: 'top-right',
       loaderBg:'#ff6849',
       icon: 'error',
       hideAfter: 2800
     });
    },
    SelectPayment: function(payment_id){
      var self = this
      console.log('check', self.selected_payments.indexOf(payment_id))
        if (self.selected_payments.indexOf(payment_id) == -1) {
          self.selected_payments.push(payment_id)
        } else {
          const idx = self.selected_payments.indexOf(payment_id)
          self.selected_payments.splice(idx, 1)
        }
        if(self.payments.length == self.selected_payments) {
          self.isCheckAll = true
        } else {
          self.isCheckAll = false
        }
      console.log('selected_payment', self.selected_payments)
    },
    SelectAll: function() {
      var self = this
      self.isCheckAll = true;
      self.selected_payments = [];
      if(self.isCheckAll){ // Check all
        for (var key in this.payments) {
          this.selected_payments.push(this.payments[key].id);
        }
      }
    },
    UpdatePageArray: function() {
      var self = this;
      if (self.count_page==1)
        return;
      self.page_array = [1];
      if (self.current_page>4)
        self.page_array.push(0);
      if (self.current_page>3)
        self.page_array.push(self.current_page-2);
      if (self.current_page>2)
        self.page_array.push(self.current_page-1);
      if (self.current_page>1)
        self.page_array.push(self.current_page);
      if (self.current_page<self.count_page)
        self.page_array.push(self.current_page+1);
      if (self.current_page+1<self.count_page)
        self.page_array.push(self.current_page+2);
      if (self.current_page+2<self.count_page)
        self.page_array.push(0);
    },
  }
})

$(document).ready(function(){
  setInterval(function () {
    AppPaymentList.GetPaymentList();
  }, 180000)
});

// Active
 window.addEventListener('focus', ActionActiveTab);

 // Inactive
 window.addEventListener('blur', ActionInactiveTab);

function ActionActiveTab(){
  console.log('Active tab')
  AppPaymentList.SetWindowTabStatus(true);
}
function ActionInactiveTab(){
  console.log('Inactive tab')
  AppPaymentList.SetWindowTabStatus(false);
}

// Daterange picker
$('.input-daterange-timepicker').daterangepicker({
    timePicker: true,
    format: 'DD/MM/YYYY H:mm',
    timePickerIncrement: 5,
    timePicker12Hour: true,
    timePickerSeconds: false,
    buttonClasses: ['btn', 'btn-sm'],
    applyClass: 'btn-danger',
    cancelClass: 'btn-inverse'
});

function SortBySubmit(id){
    var toggle_element = document.getElementById(id);
    var is_double = toggle_element.getAttribute("data-julo-sort-double");
    var sort_data = toggle_element.getAttribute("data-julo-sort");
    var form = document.getElementById("julo-sort-form")
    var form_id = form.getAttribute("data-julo-sort-form");
    var form_field_id = form.getAttribute("data-julo-sort-query-field");
    var form_element = document.getElementById(form_id);
    var field_element = document.getElementById(form_field_id);
    if(sort_data == ""){
        if (is_double){
            query_data =  id.replace("-sort-toggle", "")+ "_asc";
        }else{
            query_data =  id.replace("-sort-toggle", "");
        };
    }else{
        if (is_double){
            if(sort_data.includes('_desc')){
                query_data = sort_data.replace("_desc", "_asc");
            }else{
                query_data = sort_data.replace("_asc", "_desc");
            };
        }else{
            if(sort_data.includes('-')){
                query_data = sort_data.replace("-", "");
            }else{
                query_data = "-"+sort_data;
            };
        };
    };
    AppPaymentList.SortingAction(query_data);
}
</script>
{% endblock %}
