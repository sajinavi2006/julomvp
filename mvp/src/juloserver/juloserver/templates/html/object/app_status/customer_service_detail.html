{% extends "common/theme1/crup/app_status_theme1.html" %}
{% load model %}
{% load unit %}
{% load static from staticfiles %}
{% load checkusergroup from common %}

{% block additional_title %}Julo-{{ app_obj.id }} {% endblock %}


{% block custom_link %}
{% endblock %}


{% block css_inside %}
  #status {
    opacity: 0;
    position: fixed;
    right: 20px;
    top: 20px;
    background: hsla( 0, 0%, 0%, 0.8);
    padding: 20px;
    border-radius: 10px;
    z-index: 2; /* over other stuff */
  }

  .checkbox label::before{
    border: 1px solid;
  }

  .btn-grp-default {
    width:30px !important;
    padding-left:8px !important;
  }

  .select { overflow: hidden; }
  .select::-webkit-scrollbar { width: 0 !important }
  .select { -ms-overflow-style: none; }
  .select { overflow: -moz-scrollbars-none; }
  .select:active { pointer-events: none; }
  .select_cls {
      width: 232px;
      height: 36px;
      border: solid 1px #d5d6d6;
      background-color: #ffffff;
  }
  td.day{
    position:relative;
  }
  .enabled a{
    color:black !important;
    background:green !important;
  }
    td.day{
    position:relative;
  }

  td.day.disabled:hover:before {
      content: 'This date is disabled';
      color: white;
      background-color: grey;
      top: 28px;
      position: absolute;
      width: 136px;
      left: -34px;
      z-index: 1000;
      text-align: center;
      padding: 2px;
  }

  td.disabled-date {
      background-color: red !important;
      color: white !important;
  }

  .red{color: red;}
  .green{color: green;}
  .no-left{padding-left:0px;}

  .modal-content {
    width: 120%;
  }

  /* Chrome, Safari, Edge, Opera */
  input::-webkit-outer-spin-button,
  input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  /* Firefox */
  input[type=number] {
    -moz-appearance: textfield;

  .sweet-alert .sa-confirm-button-container button {
    background-color: #03a9f3 !important;
    border: 1px solid #03a9f3 !important;
  }
  .sweet-alert button.cancel {
    background-color: #fff !important;
    color: #333 !important;
    border-color: #efefef !important;
    border: 1px solid !important;
  }
  .sweet-alert p {
    color: #333 !important;
    font-family: "Poppins", sans-serif !important;
    font-weight: normal !important;
    font-size: 15px !important;
  }
  .sweet-alert button {
   margin: 30px 5px 10px 5px !important;
  }
{% endblock %}

{% block breadcrumb_title %}{% endblock %}
{% block breadcrumb_path %}
    <li><a href="{% url 'loan_app:status_changes' %}">Status Aplikasi</a></li>
    <li class="active">Ubah/Update</li>
{% endblock %}



{% block list_title %}
    {% with app_obj as object %}
      <div class="row m-b-10">
        <div class="col-md-2 col-xs-12 label-danger  p-t-10 p-b-10">
          <small>app-id</small>: {{ object.id|default:"-"|safe  }}&ensp;
          {% if object.is_warning %}<code class="text-right">ALERT</code>{% endif %}
        </div>
        <div class="col-md-1 col-xs-12 label-primary text-center p-t-10 p-b-10">
          <code>{{ object.application_status.status_code|default:"-"|safe }}</code>
        </div>
        <div class="col-md-3 col-xs-12 label-success p-t-10 p-b-10">
          <small>email</small>: {{ object.email|default:"-"|safe  }}
        </div>
        <div class="col-md-3 col-xs-12 label-danger p-t-10 p-b-10">
          <small>name</small>: {{ object.fullname|default:"-"|safe  }}
        </div>
       <div class="col-md-3 col-xs-12 label-warning p-t-10 p-b-10">
          <small>phone</small>: {{object.mobile_phone_1|no_hp|default:"-"|safe}}
        </div>
      </div>
    {% endwith %}
{% endblock %}
{% block list_subtitle %}{% endblock %}

{% block content-list %}
    <div class="row m-b-10 p-t-0">
      <div class="col-md-12 col-xs-12">

        <div class="row">
          <div class="col-md-6 col-xs-12">
            {% with app_obj as object %}
              {% include "object/app_status/include/cs_details.html" %}
            {% endwith %}
          </div>

          <!-- IMAGES -->
          <div class="col-md-6 col-xs-12">
            {% with app_obj as object %}
              {% include "object/app_status/include/app_details2.html" %}
            {% endwith %}
          </div>

        </div>
      </div>
    </div>
{% endblock %}


{% block button_part %}
{% endblock %}



{% block script_bottom_inside %}
  // display loan purpose
  $("#id_form2-loan_purpose_desc").hover(function(){
    $("#id_loan_purpose_content_extend").text($("#id_form2-loan_purpose_desc").val());
    if ($("#id_form2-loan_purpose_desc").val()) {
      $("#id_loan_purpose_content_extend_div").show();
    };
    }, function(){
    $("#id_loan_purpose_content_extend_div").hide();
  });
  // check ca check_list is predicted pd bank scraped model
  if ( $("#ca_checklist_monthly_income_dv").length ) {
    var pd_bank_scrape_model_result = "{{ pd_bank_scrape_model_result }}";
    if (pd_bank_scrape_model_result == 'True') {
        $("#ca_checklist_monthly_income_dv").removeClass( "fa-square-o" ).addClass( "fa-check-square-o");
        $("#ca_checklist_monthly_income_dv").prop('onclick', null).off('click');
    }
  }

  function open_new_tabs(url_selected){
    var win = window.open(url_selected, '_blank');
    win.focus();
  }

  $(document).on('click', '.see_app', function() {
    var url_selected = "/app_status/change_status/"+ $(this).text();
    //console.log(url_selected);
    open_new_tabs(url_selected);
  })

  var current_app_status = {{ app_obj.application_status.status_code }};
  var expr = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
  var old_email = '{{app_obj.email}}';
  var is_app_julo_one = "{{ app_obj.is_julo_one }}";
  var security_note_active = "{{ security_note_active }}";
  if(security_note_active == '1') {
    toast_success("Success", "Security note added successfully!!");
  }
  function reload_name_bank_validation(name_bank_validation_data) {
    var bank_name_val = 'None';
    if (name_bank_validation_data.bank_name != null) {
        bank_name_val = name_bank_validation_data.bank_name
    }
    $("#id_disbursement_bank_name").val(bank_name_val);
    var bank_account_number_val = 'None';
    if (name_bank_validation_data.bank_account_number != null) {
        bank_account_number_val = name_bank_validation_data.bank_account_number
    }
    $("#id_account_number").val(bank_account_number_val);
    var name_in_bank_val = 'None';
    if (name_bank_validation_data.name_in_bank != null) {
        name_in_bank_val = name_bank_validation_data.name_in_bank
    }
    $("#validation_name_in_bank_id").val(name_in_bank_val);
    var validated_name_val = 'None';
    if (name_bank_validation_data.validated_name != null) {
        validated_name_val = name_bank_validation_data.validated_name
    }
    $("#id_validated_name").val(validated_name_val);
    var method_val = '-';
    if (name_bank_validation_data.method != null) {
        method_val = name_bank_validation_data.method
    }
    $("#name_bank_validation_method_id").val(method_val);
    var validation_id_val = '-';
    if (name_bank_validation_data.validation_id != null) {
        validation_id_val = name_bank_validation_data.validation_id
    }
    $("#id_validation_id").text(validation_id_val);
    var validation_status_val = '-';
    if (name_bank_validation_data.validation_status != null) {
        validation_status_val = name_bank_validation_data.validation_status
    }
    $("#id_validation_status > p > code").text(validation_status_val);
    var reason_val = '-';
    if (name_bank_validation_data.reason != null) {
        reason_val = name_bank_validation_data.reason
    }
    $("#id_bank_validate_reason > p > code").text(reason_val);
    var partner_val = '-';
    if (name_bank_validation_data.partner != null) {
        partner_val = name_bank_validation_data.partner
    }
    $("#id_partner").text(partner_val);
  };
  $("#btn_reload_bank_validation_status").click(function(){
    var csrftoken = getCookie('csrftoken');
    $.ajax({
        url :  "{%url 'app_status:ajax_bank_validation' %}/",
        type : "GET",
        async: false,
        data : {
          csrfmiddlewaretoken: csrftoken,
          app_id: '{{app_obj.id}}',
        },
        // handle a successful response
        success : function(json) {
            if (json.status == 'success') {
                reload_name_bank_validation(json.data);
            } else {
                toast_danger('Wrong params!', json.messages)
            }
        },
        // handle a non-successful response
        error : function(xhr,errmsg,err) {
            console.log(xhr.status + ": " + xhr.responseText);
        }
    });
  });
  $("#btn_validate_bank").click(function(){
    $('#name_bank_vaidation_table').hide();
    $('#preloader_name_bank_validation').show();
    $.ajax({
        url :  "{%url 'app_status:ajax_bank_validation' %}/",
        type : "POST",
        data : {
          app_id: '{{app_obj.id}}',
          name_bank_validation_id: '{{name_bank_validation.id}}',
          bank_name: $("#id_disbursement_bank_name").val(),
          bank_account_number: $("#id_account_number").val(),
          name_in_bank: $("#validation_name_in_bank_id").val(),
          validation_method: $("#name_bank_validation_method_id").val(),
        },

        // handle a successful response
        success : function(json) {
            $('#preloader_name_bank_validation').hide();
            $('#name_bank_vaidation_table').show();
            if (json.status == 'success') {
                reload_name_bank_validation(json.data);
            } else {
                toast_danger('Wrong params!', json.messages)
            }
        },
        // handle a non-successful response
        error : function(xhr,errmsg,err) {
            $('#preloader_name_bank_validation').hide();
            $('#name_bank_vaidation_table').show();
            console.log(xhr.status + ": " + xhr.responseText);
        }
    });
  });
  var global_note_update_app = "";
  var bank_name_list = {{ bank_name_list|safe }};

  // using jQuery
  function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie != '') {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
              var cookie = jQuery.trim(cookies[i]);
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, name.length + 1) == (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      //console.log(cookieValue);
      return cookieValue;
  }

  function toast_warning(header_msg, body_message){
    $.toast({
        heading: header_msg,
        text: body_message,
        position: 'top-right',
        loaderBg:'#ff6849',
        icon: 'warning',
        hideAfter: 1000,
        stack: 6
      });
  }

  function toast_success(header_msg, body_message){
    $.toast({
            heading: header_msg,
            text: body_message,
            position: 'top-right',
            loaderBg:'#ff6849',
            icon: 'success',
            hideAfter: 2500,
            stack: 6
          });
  }

  function toast_danger(header_msg, body_message){
    $.toast({
            heading: header_msg,
            text: body_message,
            position: 'top-right',
            loaderBg:'#ff6849',
            icon: 'error',
            hideAfter: 3800

          });
  }

  function set_unlocked_app(app_id){
    //console.log("set_locked_app dulu ya ");
    //check using ajax
    var csrftoken = getCookie('csrftoken');

    $.ajax({
        url :  "{%url 'app_status:set_app_unlocked' %}/", // the endpoint
        type : "GET", // http method
        data : { application_id: app_id,
                 csrfmiddlewaretoken: csrftoken,
                }, // data sent with the get request

        // handle a successful response
        success : function(json) {
            //console.log(json); // log the returned json to the console

            if (json.result == "successful!"){
              //redirect this page
              //console.log("sukses");
              /*$("#modal_title").html("Un-Lock Success");
              $("#modal_body").html(""+ json.reason);
              $('#responsive-modal-success').modal('show');
              */
              toast_success("Un-Lock Success", ""+ json.reason);
              setTimeout(closeWin(), 1000);
            }
            else {
              //show notification that app was locked
              //console.log(json.reason);
              $("#modal_title").html("Un-Lock Gagal");
              $("#modal_body").html(""+ json.reason);
              $('#responsive-modal-success').modal('show');
            }
        },

        // handle a non-successful response
        error : function(xhr,errmsg,err) {
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            $("#modal_title").html("!! Error !!");
            $("#modal_body").html("Error on getting data from server");
            $('#responsive-modal-success').modal('show');
        }
    }); // end of ajax
  }//end of function


  //button kirim ulang click
  function ImageResubmissionClick(image_id){
    // show toast info
    toast_warning('Sending', 'Wait until it is done');

    var button_title = $("#btn_kirim_ulang_"+image_id).html();
    //console.log("button_title: " + button_title);
    if(button_title == "Mohon Dikirim Ulang"){
      image_resubmission(image_id, "KirimUlang");
    }
    else{
      image_resubmission(image_id, "BatalKirimUlang");
    }
  }

  //button kirim ulang voice click
  function VoiceResubmissionClick(voice_id){
    // show toast info
    toast_warning('Sending', 'Wait until it is done');

    var button_title = $("#btn_kirim_ulang_voice_"+voice_id).html();
    //console.log("button_title: " + button_title);
    if(button_title == "Mohon Dikirim Ulang"){
      voice_resubmission(voice_id, "KirimUlang");
    }
    else{
      voice_resubmission(voice_id, "BatalKirimUlang");
    }
  }

  function image_resubmission(image_id, action_str){
    //console.log("image_resubmission ya ");
    //check using ajax
    var csrftoken = getCookie('csrftoken');

    $.ajax({
        url :  "{%url 'app_status:image_resubmission' %}/", // the endpoint
        type : "GET", // http method
        data : { image_id: image_id,
                 image_action: action_str,
                 csrfmiddlewaretoken: csrftoken,
                }, // data sent with the get request

        // handle a successful response
        success : function(json) {
            //console.log(json); // log the returned json to the console

            if (json.result == "successful!"){
              //redirect this page
              //console.log("sukses");
              if(action_str=="KirimUlang"){
                $("#btn_kirim_ulang_"+image_id).html("Batalkan Kirim Ulang");
                $("#btn_kirim_ulang_"+image_id).removeClass("btn-default");
                $("#btn_kirim_ulang_"+image_id).addClass("btn-danger");
              }else{
                $("#btn_kirim_ulang_"+image_id).html("Mohon Dikirim Ulang");
                $("#btn_kirim_ulang_"+image_id).removeClass("btn-danger");
                $("#btn_kirim_ulang_"+image_id).addClass("btn-default");
              }

              toast_success("Done", "Update data ImageID:"+ image_id + " Success");
            }
            else {
              //show notification that app was locked
              //console.log(json.reason);
              toast_danger("Fail", "Update data ImageID:"+ image_id + " Fail");
            }
        },

        // handle a non-successful response
        error : function(xhr,errmsg,err) {
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            toast_danger("Error", json.reason);
        }
    }); // end of ajax
  }//end of function

  function voice_resubmission(voice_id, action_str){
    //console.log("image_resubmission ya ");
    //check using ajax
    var csrftoken = getCookie('csrftoken');

    $.ajax({
        url :  "{%url 'app_status:voice_resubmission' %}/", // the endpoint
        type : "GET", // http method
        data : { voice_id: voice_id,
                 voice_action: action_str,
                 csrfmiddlewaretoken: csrftoken,
                }, // data sent with the get request

        // handle a successful response
        success : function(json) {
            //console.log(json); // log the returned json to the console

            if (json.result == "successful!"){
              //redirect this page
              //console.log("sukses");
              if(action_str=="KirimUlang"){
                $("#btn_kirim_ulang_voice_"+voice_id).html("Batalkan Kirim Ulang");
                $("#btn_kirim_ulang_voice_"+voice_id).removeClass("btn-default");
                $("#btn_kirim_ulang_voice_"+voice_id).addClass("btn-danger");
              }else{
                $("#btn_kirim_ulang_voice_"+voice_id).html("Mohon Dikirim Ulang");
                $("#btn_kirim_ulang_voice_"+voice_id).removeClass("btn-danger");
                $("#btn_kirim_ulang_voice_"+voice_id).addClass("btn-default");
              }

              toast_success("Done", "Update data VoiceID:"+ voice_id + " Success");
            }
            else {
              //show notification that app was locked
              console.log(json.reason);
              toast_danger("Fail", "Update data VoiceID:"+ voice_id + " Fail");
            }
        },

        // handle a non-successful response
        error : function(xhr,errmsg,err) {
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            toast_danger("Error", json.reason);
        }
    }); // end of ajax
  }//end of function

  //Function Cashback Redeeem
  function process_cashback_transfer_request(status, cashback_transfer_trans_id){
    console.log(status, cashback_transfer_trans_id)
    var csrftoken = getCookie('csrftoken');
    var note_text =  $("#cashback_note_id").val();
    $("#approve_redeem_cashback").attr("disabled", true)
    $("#reject_redeem_cashback").attr("disabled", true)
    $.ajax({
      url :  "{%url 'app_status:process_cashback_transfer_request' %}/", // the endpoint
      type : "GET", // http method
      data : { status: status,
               cashback_transfer_transaction_id: cashback_transfer_trans_id,
               note_text: note_text,
               csrfmiddlewaretoken: csrftoken,
              }, // data sent with the get request

      // handle a successful response
      success : function(json) {
          console.log(json); // log the returned json to the console
          if (json.result == "successful!"){
            toast_success("Success", json.reason);
            setTimeout(reload_btn());
          }
          else {
            //console.log(json.reason);
            $("#modal_reload_title").html("process redeem cashback Gagal");
            $("#modal_reload_body").html(""+ json.reason);
            $("#modal-success-reload").modal('show');
          }
      },

      // handle a non-successful response
      error : function(xhr,errmsg,err) {
          console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
          $("#modal_reload_title").html("!! Error !!");
          $("#modal_reload_body").html("Error on getting data from server");
          $('#modal-success-reload').modal('show');
      }
    });
  }//end of function

  $("#id_btn_ubah_status").button().click(function(){
      $("#id_form_selection").hide();
      $("#id_form_ubah_status").show();

      localStorage.app_status_btn_selected = 'ubah_status';
  });

  $("#id_batal_ubah_status").button().click(function(){
      $("#id_form_selection").show();
      $("#id_form_ubah_status").hide();

      localStorage.app_status_btn_selected = 'ubah_status_batal';
  });

  $("#id_btn_simpan_note").button().click(function(){
      $("#id_form_selection").hide();
      $("#id_form_simpan_note").show();

      localStorage.app_status_btn_selected = 'simpan_note';
  });

  $("#id_batal_simpan_note").button().click(function(){
      $("#id_form_selection").show();
      $("#id_form_simpan_note").hide();
      localStorage.app_status_btn_selected = 'simpan_note_batal';
  });

  $("#id_btn_unlock_app").button().click(function(){
    $('#responsive-modal-unlock-app').modal('show');
  });

  $("#btn_show_obsolete").button().click(function(){
      var title = $("#btn_show_obsolete").html();
      console.log("title: "+ title);
      if(title == '<i class="fa fa-image fa-fw"></i>Tampilkan Gbr Tidak Terpakai'){
        $("#btn_show_obsolete").html('<i class="fa fa-image fa-fw"></i>Sembunyikan Gbr Tidak Terpakai');
      }
      else{
        $("#btn_show_obsolete").html('<i class="fa fa-image fa-fw"></i>Tampilkan Gbr Tidak Terpakai');
      }
  });

  //button click
  $("#id_unlock_app").button().click(function(){
      set_unlocked_app("{{app_obj.id}}");
  });

  function close_btn(){
    //window.location.reload(true);
    closeWin();
  }

  function closeWin() {
    window.top.close();
  }

  function reload_btn(){
    window.location.reload(true);
  }

  /*
  setTimeout(function(){
      closeWin()
  }, 1000);
  */

  $('#slim_apps2').slimScroll({
      // position: 'left',
      height: '46vh',
      railVisible: true,
      alwaysVisible: true
  });

  $('#slim_apps').slimScroll({
      // position: 'left',
      height: '42vh',
      railVisible: true,
      alwaysVisible: true
  });

  $('#slim_history_note').slimScroll({
      // position: 'left',
      height: '450px',
      railVisible: true,
      alwaysVisible: true
  });


  jQuery.fn.delay = function(time,func){
      this.each(function(){
          setTimeout(func,time);
      });

      return this;
  };

  /*
  function initMap() {
    // Create a map object and specify the DOM element for display.
    var map = new google.maps.Map(document.getElementById('overlayermap'), {
      center: {lat: -34.397, lng: 150.644},
      scrollwheel: false,
      zoom: 8
    });
  }
  */

  // triggered after each item is loaded
  function onProgress( imgLoad, image ) {
    // change class if the image is loaded or broken
    var $item = $( image.img ).parent();
    $item.removeClass('is-loading');
    if ( !image.isLoaded ) {
      $item.addClass('is-broken');
    }
  }

  // hide status when done
  function onAlways() {
    // unblock div area
    $('div.block_image').unblock();
  }

  // loading image src and href for image list
  function loading_image(cnt_data) {
    var $container = $('#image_row');
    $("#unblock_image").toggle();
    $("#unblock_wait").toggle();

    $.each({{ json_image_list|safe }}, function(i, obj) {
      //console.log(obj, i);
      var href_id = $("#href_"+obj.pk);
      var src_id = $("#img_"+obj.pk);
      var but_href_id = $("#button_href_"+obj.pk)
      $.each(obj, function(i, obj_item) {
        // console.log(obj_item);

        if(obj_item.image_ext == '.pdf'){
          src_id.attr('src', '{% static 'images/collections/image-pdf.png' %}');
          but_href_id.attr('href', obj_item.image_url)
        }
        else {
          src_id.attr('src', obj_item.image_url);
        }
        href_id.attr('href', obj_item.image_url);
      });

    });

     $.each({{ json_image_list_1|safe }}, function(i, obj) {
      //console.log(obj, i);
      var href_id = $("#href_"+obj.pk);
      var src_id = $("#img_"+obj.pk);
      var but_href_id = $("#button_href_"+obj.pk)
      $.each(obj, function(i, obj_item) {
        //console.log(obj_item);

        if(obj_item.image_ext == '.pdf'){
          src_id.attr('src', '{% static 'images/collections/image-pdf.png' %}');
          but_href_id.attr('href', obj_item.image_url);
        }
        else {
          src_id.attr('src', obj_item.image_url);
        }
        href_id.attr('href', obj_item.image_url);
      });

    });

    //for voice image
    $.each({{ json_voice_list|safe }}, function(i, obj) {
      var img_voice_id = $('#img_voice_'+obj.pk);
      img_voice_id.attr('src', '{% static 'images/collections/audio.png' %}');
      img_voice_id.attr('src', '{% static 'images/collections/audio.png' %}');
    });
    $.each({{ json_voice_list_1|safe }}, function(i, obj) {
      var img_voice_id = $('#img_voice_'+obj.pk);
      img_voice_id.attr('src', '{% static 'images/collections/audio.png' %}');
      img_voice_id.attr('src', '{% static 'images/collections/audio.png' %}');
    });

     $container.imagesLoaded()
        .progress( onProgress )
        .always( onAlways );
      // reset progress counter
      imageCount = $container.find('img').length;
      //console.log(imageCount);
  }

   $('#submit_status').on("click",function(e) {
      var to_app_status = $('#id_status_to').val();
      var name_bank_validation_status = $("#id_julo_one_validation_status").text();
      if (current_app_status == 124 && to_app_status == 130 && is_app_julo_one == 'True' && name_bank_validation_status != 'SUCCESS') {
          e.preventDefault();
          $('#id_modal_failed_bank_name_validation').modal('show');
      } else {
          var arr_reason = [];
          $("#id_reason :selected").map(function(i, el) {
             arr_reason.push($(el).val());
          });
          var reason_selected = arr_reason.join(', ');
          //console.log(reason_selected);
          $("#id_reason_str").val(reason_selected);
      };
    });

  function btn_selection_show(){
      $("#id_form_selection").show();
      $("#id_form_simpan_note").hide();
      $("#id_form_ubah_status").hide();
  }

  function check_active_form(){
    var active_form = localStorage.app_status_btn_selected;
    if(active_form=='ubah_status'){
      if({{ubah_status_active}}){
        $("#id_form_selection").hide();
        $("#id_form_ubah_status").show();
      } else {
        btn_selection_show()
      }

    }
    else if(active_form=='simpan_note'){
      if({{simpan_note_active}}){
        $("#id_form_selection").hide();
        $("#id_form_simpan_note").show();
      }else{
        btn_selection_show();
      }
    }
    else {
      btn_selection_show();
    }
  }

  var blocking_html = "" +
    "<button class='button btn-lg btn-primary btn-block' id='unblock_image'><i class='fa fa-search fa-fw'></i>Cek Dokumen</button>\n" +
    "<div id='unblock_wait' style='display:None;'><h4><img src='/static/theme/plugins/images/busy.gif'/> Tunggu Sebentar...</h4></div>\n";

  jQuery(document).ready(function() {

    //SkipTrace document ready for load table
    $('#dvc').removeClass('active');
    $('#st').addClass('active');
    
    checked_mycroft()

    $("#id_form2-is_assisted_selfie").on('click', function () {
      checked_mycroft()
    })

    function checked_mycroft() {
      if ($("#id_form2-is_assisted_selfie").is(":checked")) {
        $('.mycroft-checkbox').addClass('blue-border')
      } else {
        $('.mycroft-checkbox').removeClass('blue-border')
      }
    }

    GLOBAL_TABLE = $('#skiptraceTable').DataTable( {
        "paging": false,
        "searching": false,
        "lengthChange": false,
        "bInfo": false,
        "order": [[ 3, 'desc' ], [ 6, 'asc' ]],
        "columnDefs": [
          {
            "targets"  : "no-sort",
            "orderable": false,
          },
          {
            "targets": [0,1,2,3,4,5,8],
            "orderSequence": ["desc"]
          },
          {
            "targets": [6,7],
            "visible": false
          },
          {"targets": [0], "data": "NAME"},
          {"targets": [1], "data": "SOURCE"},
          {"targets": [2], "data": "ACTION"},
          {"targets": [3], "data": "EFF"},
          {"targets": [4], "data": "REC"},
          {"targets": [5], "data": "FREQ"},
          {"targets": [6], "data": "ID"},
          {"targets": [7], "data": "NUMBER_PHONE"},
          {"targets": [8], "data": "OPERATOR"},
        ]
    } );

    $('#skiptraceTable tbody').on('click', 'td #id_call_skip_trace', function () {
        var tr = $(this).closest('tr');
        var row = GLOBAL_TABLE.row( tr );
        var row_data = GLOBAL_TABLE.row( tr ).data();
        var application_status = '{{app_obj.application_status_id}}'

        if ( row.child.isShown() ) {
            ActionCall(1,row_data.ID);
            $(this).find('i').attr( 'class', 'fa fa-chevron-circle-down' );
            $(this).attr( 'class', 'btn btn btn-success btn-rounded' );
            row.child.hide();
            tr.removeClass('shown');
        }
        else {
            GLOBAL_OBJ_START_TS.id = row_data.ID;
            GLOBAL_OBJ_START_TS.time = GetTime();
            GLOBAL_ARR_START_TS.push(GLOBAL_OBJ_START_TS);
            GLOBAL_OBJ_START_TS = {};
            $(this).find('i').attr( 'class', 'fa fa-times' );
            $(this).attr( 'class', 'btn btn btn-danger btn-rounded' );
            row.child( format(row.data(), application_status , '', 'applications') ).show();
            tr.addClass('shown');
        }
      } );

    $('#id_btn_add_skip_trace').on( 'click', function () {
      SaveSkipTrace();
    } );

    $('#id_btn_update_skip_trace').on( 'click', function () {
      UpdateSkipTrace();
    } );

    $.ajaxSetup({
      data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
    });

    preventNotAllowedChar();

    //load_call_result example
    $.ajax({
          url :  "{%url 'payment_status:load_call_result' %}/", // the endpoint
          type : "GET", // http method

          // handle a successful response
          success : function(json) {
              GLOBAL_ARR_BTN_CALL = json.data;
              GLOBAL_ARR_BTN_CALL.shift();
          },

          // handle a non-successful response
          error : function(xhr,errmsg,err) {
              console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
          }
      });

    // Switchery
    var elems = Array.prototype.slice.call(document.querySelectorAll('.js-switch'));
    $('.js-switch').each(function() {
        new Switchery($(this)[0], $(this).data());

    });

    // alert("Document is ready");
    $('#id_status_to').on('change', function() {
      //alert(this.value);
      if(this.value != ''){
        set_reason_list(this.value);
      }
    });

    window.scroll(0,80);

    $(".mask").maskMoney({thousands:'.', decimal:',', allowZero: true, suffix: '', precision:0});
    $(".maskNumber").maskMoney({thousands:'', decimal:'', allowZero: true, suffix: '', precision:0});
    jQuery('.mydatepicker, #datepicker').datepicker({
               format: 'dd-mm-yyyy',
               buttonClasses: ['btn', 'btn-sm'],
               applyClass: 'btn-danger',
               cancelClass: 'btn-inverse',
               dateLimit: {
                   days: 6
               },
               autoclose: true,
               todayHighlight: true,
               todayBtn: "linked",
           });

    //set blocked div for image
    $('div.block_image').block({
      message: blocking_html
      , overlayCSS: {
          backgroundColor: '#000'
      }
      , css: {
          border: '1px solid #fff'
      }
    });

    //set disabled update application by restricted_update_app
    if({{agent_update_app_status}} === 0) {
      // button update status
      $('#id_btn_update_app').addClass("disabled");
      $("#id_btn_update_app").attr("disabled", true);

      // Button Approve Cashback
      $('#approve_redeem_cashback').addClass("disabled");
      $('#approve_redeem_cashback').attr("disabled", true);

      // Button Reject cashback
      $('#reject_redeem_cashback').addClass("disabled");
      $('#reject_redeem_cashback').attr("disabled", true);
    }

    //set blocked div for image
    if({{lock_status}}){
      $('div.block_form').block({
          message: "You Are Not Allowed to Change Status, status has been locked by: {{lock_by|default:"-"|safe}}"
          , overlayCSS: {
              backgroundColor: '#000'
          }
          , css: {
              border: '1px solid #fff'
          }
      });

      // block update aplikasi
      $("#id_btn_update_app").addClass("disabled");
      $("#id_btn_update_app").attr("disabled", true);

      // hide upload document
      $("#id_upload_doc").hide();

      //block disbursement
      $("#id_cek_saldo_doku").addClass("disabled");
      $("#id_cek_saldo_doku").attr("disabled", true);

      // Block Button Approve Cashback
      $('#approve_redeem_cashback').addClass("disabled");
      $('#approve_redeem_cashback').attr("disabled", true);

      // Block Button Reject cashback
      $('#reject_redeem_cashback').addClass("disabled");
      $('#reject_redeem_cashback').attr("disabled", true);
    }

    $('#unblock_image').click(function () {
      loading_image({{ image_list.count }});

    });

    $('#id_reason')
        .empty()
        .append('<option selected="selected" value>-- Pilih Alasan --</option>');

    function set_reason_list(status_to) {
      var csrftoken = getCookie('csrftoken');
      $.ajax({
          url :  "{%url 'loan_app:populate_reason' %}/", // the endpoint
          type : "GET", // http method
          data : { status_code   : status_to,
                    csrfmiddlewaretoken: csrftoken,
                    application_id: '{{app_obj.id}}',
                }, // data sent with the get request

          // handle a successful response
          success : function(json) {
              // console.log(json); // log the returned json to the console
              // console.log(json.reason_list);
              // console.log(json.result);

              if (json.result == "successful!"){
                // set empty reason list
                $('#id_reason')
                    .empty()
                    .append('<option selected="selected" value>-- Pilih --</option>')
                ;
                {% if app_obj.status == 141 and app_obj.is_julo_one%}
                    json.reason_list.sort(function(x,y){ return x[1] == 'IPV verified' ? -1 : y[1] == 'IPV verified' ? 1 : 0; });
                {% endif %}
                $.each(json.reason_list, function(i, value) {
                    $('#id_reason').append($('<option>').text(value[1]).attr('value', value[0]));
                });
              }
              // console.log("success"); // another sanity check
          },

          // handle a non-successful response
          error : function(xhr,errmsg,err) {
              console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
          }
      });

    };

    //check form active
    check_active_form();

    //check if status_id has value
    $("#id_status_to :selected").map(function(i, el) {
       if($(el).val()!=''){
        set_reason_list($(el).val());
       }
    });

    //check marial status
    validationMaritalStatus();
    //set default
    $("#id_form2-loan_purpose").val("{{app_obj.loan_purpose|safe}}");
    {% if offers %}
      GLOBAL_CALCULATE_LIST_LENGTH = {{offers|length}};
    {% else %}
      $("#id_form2-product_line").val("{{app_obj.product_line.product_line_code|safe}}");
    {% endif %}
    $(".mask").maskMoney({thousands:'.', decimal:',', allowZero: true, suffix: '', precision:0});
    $(".maskNumber").maskMoney({thousands:'', decimal:'', allowZero: true, suffix: '', precision:0});
    {% checkusergroup notin ['bo_outbond_caller_3rd_party'] %}
      set_disable_simpan_btn(1);
      var due_date = $("#p_date_init").text();
      $("#p_installment_date").val(due_date);
      var first_due_amount = $("#p_amount_init").text();
      $("#p_installment_amount").val(first_due_amount);
    {% endcheckusergroup %}

    if($("#mymce").length > 0){
      tinymce.init({
        selector: "textarea#mymce",
        theme: "modern",
        height:250,
        plugins: [
        "advlist autolink link image lists charmap print preview hr anchor pagebreak spellchecker",
        "searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking","save table contextmenu directionality emoticons template paste textcolor"
        ],
        toolbar: "insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview media fullpage | forecolor backcolor emoticons",
      });
    }

   $( "#id_form2-bank_name" ).autocomplete({
      source: bank_name_list
   });
  }); //end of document ready

  function formValidationNote(oEvent) {
    //oEvent = oEvent || window.event;
    //var txtField = oEvent.target || oEvent.srcElement;
    //alert("validation");
    if(document.getElementById("id_notes_only").value.length > 0 )
    {
      document.getElementById("id-submit-simpan-note").disabled = false;
      $("#id-submit-simpan-note").removeClass("btn-default");
      $("#id-submit-simpan-note").addClass("btn-info");
    }else {
      document.getElementById("id-submit-simpan-note").disabled = true;
      $("#id-submit-simpan-note").addClass("btn-default");
      $("#id-submit-simpan-note").removeClass("btn-info");
    }
  }
  function formValidationSecurityNote(oEvent) {
    if(document.getElementById("id_security_note").value.length > 0 )
    {
      document.getElementById("id-submit-security-note").disabled = false;
      $("#id-submit-security-note").removeClass("btn-default");
      $("#id-submit-security-note").addClass("btn-primary");
    }else {
      document.getElementById("id-submit-security-note").disabled = true;
      $("#id-submit-security-note").addClass("btn-default");
      $("#id-submit-security-note").removeClass("btn-primary");
    }
  }

  function validateEmail(oEvent) {
    if( $('#id_change_email').length ) {
        if (!expr.test($("#id_new_email").val())) {
             $('#errEmail').html("<font color='red' size='2px'>Please enter valid email.</font>");
             document.getElementById("id_change_email").disabled = true;
             $("#id_change_email").addClass("btn-default");
             $("#id_change_email").removeClass("btn-primary");

        }
        else {
            $('#errEmail').hide();
            document.getElementById("id_change_email").disabled = false;
            $("#id_change_email").removeClass("btn-default");
            $("#id_change_email").addClass("btn-info");
        }
    }
  }

  function formValidationStatus(oEvent) {
    //alert("validation status");
    if($('#id_status_to').val() != "" && $('#id_reason').val() != ""){
      document.getElementById("submit_status").disabled = false;
      $("#submit_status").removeClass("btn-default");
      $("#submit_status").addClass("btn-danger");
    } else {
      document.getElementById("submit_status").disabled = true;
      $("#submit_status").addClass("btn-default");
      $("#submit_status").removeClass("btn-danger");
    }
  }

  function resetForm(){
    document.getElementById("id_notes_only").disabled = true;
    document.getElementById("id_notes_status").disabled = true;
  }

  window.onload = function () {
    {%  for key, value in app_data.items %}
      {% if key not in deprecated_list %}
        {%  for obj in value.groups %}
            var temp_checklist=[];
            var temp_comment=[];
            temp_checklist.push('{{key}}-{{obj.group_name}}-checklist');
            temp_comment.push('{{key}}-{{obj.group_name}}-comment');
            temp_checklist.push('{{obj.checklist_value}}');
            temp_comment.push('{{obj.comments.0.comment|breakjs}}');
            temp_checklist.push('');
            temp_comment.push('');
            temp_checklist.push('#ca_checklist_value_{{key}}_{{obj.group_name}}');
            temp_comment.push('#ca_comment_value_temp_{{key}}_{{obj.group_name}}');
            temp_checklist.push('{{key}}');
            temp_comment.push('{{key}}');
            temp_checklist.push('{{obj.group_name}}');
            temp_comment.push('{{obj.group_name}}');
            GLOBAL_CHECKLIST_CA.push(temp_checklist);
            GLOBAL_CHECKLIST_CA.push(temp_comment);
        {% endfor %}
      {% endif %}
    {% endfor %}

    {%  for objects in app_data.total_current_debt.undisclosed_expenses %}
      var obj={};
      obj.id='{{objects.id}}';
      obj.amount='{{objects.amount}}';
      obj.description='{{objects.description}}';
      GLOBAL_EXPENSE.push(obj);
      GLOBAL_RESULT_EXPENSE[1] = GLOBAL_RESULT_EXPENSE[1] + '({{objects.description}}'+' - '+'{{objects.amount}})';
    {% endfor %}

    {%  for objects in product_line %}
      var obj={};
      obj.code = {{objects.product_code}};
      obj.name = '{{objects.product_name}}';
      GLOBAL_PRODUCT_LINE.push(obj);
    {% endfor %}

    {% if offers %}
      $('#calculate_offer_0').hide();
    {% else %}
      $('#calculate_offer_0').hide();
      $('#calculate_offer_1').hide();
      $('#calculate_offer_2').hide();
    {% endif %}

    {%  for offer in offers %}
      {% if offer.is_accepted %}
        GLOBAL_IS_ACCEPTED=true;
      {% endif %}
    {% endfor %}

    GLOBAL_LENGTH_EXPENSE = GLOBAL_EXPENSE.length;

    var note_only = document.getElementById("id_notes_only");
    var status_change = document.getElementById("id_status_to");
    var reason_change = document.getElementById("id_reason");

    var status_merriage = document.getElementById("id_form2-marital_status");
    note_only.onkeyup = formValidationNote;
    if(document.getElementById("id_security_note")) {
        var security_note = document.getElementById("id_security_note");
        security_note.onkeyup = formValidationSecurityNote;
    }
    if(document.getElementById("id_new_email")) {
        var new_email = document.getElementById("id_new_email");
        new_email.onkeyup = validateEmail;
    }
    status_change.onchange = formValidationStatus;
    reason_change.onchange = formValidationStatus;
    status_merriage.onchange = validationMaritalStatus;

    //DOM Manipulation For Skip Tracing
    $('#st').removeClass('active');
    $('#dvc').addClass('active');
    $('#skiptraceTable').find('th').css( 'background', 'none' );
    $('#skiptraceTable').find('th').css( 'pointer-events', 'none' );

    //DragScroll for Skrip Trace
    $(function(){
      var curDown = false,
          curYPos = 0,
          curXPos = 0;
      $('#st').mousemove(function(m){
        if(curDown === true){
         $('#st').scrollTop($('#st').scrollTop() + (curYPos - m.pageY));
         $('#st').scrollLeft($('#st').scrollLeft() + (curXPos - m.pageX));
        }
      });

      $('#st').mousedown(function(m){
        $(this).css( 'cursor', 'move' );
        $(this).css('user-select', 'none');
        curDown = true;
        curYPos = m.pageY;
        curXPos = m.pageX;
      });

      $('#st').mouseup(function(){
        $(this).css( 'cursor', 'default' );
        $(this).css('user-select', 'auto');
        curDown = false;
      });
    })
    {% if app_obj.application_status.status_code in calculation_view_statuses %} // here!!!
      var offer_product = document.getElementById("id_form2-product");
      var offer_amount = document.getElementById("id_form2-loan_amount_offer");
      var offer_duration = document.getElementById("id_form2-loan_duration_offer");
      var payment_due_date = document.getElementById("p_installment_date");

      offer_product.onchange = autoComputeInstalment;
      offer_amount.onchange = autoComputeInstalment;
      offer_duration.onchange = autoComputeInstalment;
      payment_due_date.onchange = simulate_adjusted_payment_auto;

      disableDay();
    {% endif %}

    GLOBAL_TEMPLATE_EMAIL1 = "Halo {{ app_obj.gender|bapak_or_ibu|safe }} {{app_obj.fullname|default:""|safe|escapejs}}<br><br>Saya Putri, saya bekerja dengan"+
    " Pak Ari di Tim Kredit yang meng-acc pengajuan {{ app_obj.gender|bapak_or_ibu|safe }}. "+
    "Karena dana JULO telah cair ke rekening {{ app_obj.gender|bapak_or_ibu|safe }} 2 minggu yang lalu, "+
    "saya ingin bersilaturahmi saja bahwa dana tersebut telah membantu kebutuhan {{ app_obj.gender|bapak_or_ibu|safe }}"+
    " untuk {{app_obj.loan_purpose_desc|default:'kebutuhan'}}. Oh ya, apakah {{ app_obj.gender|bapak_or_ibu|safe }} sudah memberikan "+
    "review dan rating untuk aplikasi JULO di Google Play Store dan/atau Facebook?<br> Jika sudah, terima kasih :) <br>"+
    "Jika belum, tinggal klik di link dibawah & kami tunggu ya review bintang 5-nya.<br><br>"+
    "link : https://play.google.com/store/apps/details?id=com.julofinance.juloapp  <br><br>"+
    "Untuk kerjasamanya selama ini, kami ucapkan terima kasih. "+
    "Semoga kerjasama kita lancar terus, sehingga JULO dapat terus membantu kebutuhan {{ app_obj.gender|bapak_or_ibu|safe }} di masa depan.<br><br>"+
    "Salam & hormat kami,<br>Putri Wulandari<br><br>Tim Kredit JULO";

    GLOBAL_TEMPLATE_EMAIL2 = "<p>Yth {{ app_obj.gender|bapak_or_ibu|safe }} {{app_obj.fullname|default:""|safe|escapejs}},</p>"+
    "<p>Terima kasih telah mengajukan pinjaman ke JULO!</p>"+
    "<p>Saat ini pengajuan Anda terhambat karena kekurangan dokumentasi.</p>"+
    "<p>Mohon kembali ke aplikasi JULO untuk mengunggah dokumen berikut ini:<br />- Foto KTP asli yang dapat terlihat jelas<br />"+
    "- Slip gaji/ Surat Keterangan Penghasilan (SKP)/ rekening koran 3 bulan terakhir<br />- Foto selfie</p>"+
    "<p>Perlu kami ingatkan, jika kelengkapan dokumen tidak terpenuhi, pengajuan Anda akan kadaluarsa dalam 48 jam ke depan.</p>"+
    "<p>Atas kerjasamanya, kami ucapan terima kasih.<br />CS JULO</p>";

    GLOBAL_TEMPLATE_EMAIL3 = "<p>Yth {{ app_obj.gender|bapak_or_ibu|safe }} {{app_obj.fullname|default:""|safe|escapejs}},</p>"+
    "<p>Terima kasih telah mengajukan pinjaman ke JULO!<br/>"+
    "Saat ini pengajuan Anda terhambat karena kami belum berhasil menghubungi referensi kantor (HRD/ Atasan) Anda.</p>"+
    "<p>Mohon bantuan Anda untuk:</p>"+
    "<p>mengabarkan kantor untuk standby menerima telpon dari JULO, ATAU<br />"+
    "melampirkan beberapa dokumen berikut dengan me-reply email kami ini (cs138@julofinance.com):<br />"+
    "a. Email kantor Anda (misalnya. Anda@NamaPerusahaan.com) yang dapat dicek & di-reply oleh Anda sendiri<br />"+
    "b. Surat Kontrak atau Surat Keterangan Karyawan Tetap dengan kop surat resmi, cap perusahaan & tanda tangan pejabat perusahaan<br />"+
    "c. Rekening koran yang memuat setoran gaji dari 3 bulan terakhir ini</p>"+
    "<p>Perlu kami ingatkan, jika referensi Anda tidak berhasil dihubungi lebih dari 5x di 5 waktu yang berbeda, pengajuan Anda akan tertolak oleh sistem.</p>"+
    "<p>Atas kerjasamanya, kami ucapan terima kasih.<br />CS JULO</p>";
  }

  $("#id_btn_clipboard_app").click(function(){
      var text_copy = '{{ app_data_fields }}' + "\n" +  '{{ app_data_values }}';
      copyToClipboard(text_copy);
      $("#modal_default_title").html("Copy into Clipboard Success");
      $("#modal_default_body").html(""+ 'data copied into clipboard'); //
      $('#modal-success-default').modal('show');
  });

  function copyDataDisburse(){
    var text_copy = ["{{ app_obj.fullname|default:""|safe|escapejs }}","{{ app_obj.email }}","{{ app_obj.loan.loan_disbursement_amount|f_rupiahs:"no"|safe }}","{{app_obj.bank_name|default:"-"|safe}}","{{app_obj.bank_account_number|default:"-"|safe}}"]
    var ret_values = text_copy.join('\t')
    copyToClipboard(ret_values);
    $("#modal_default_title").html("Copy into Clipboard Success");
    $("#modal_default_body").html(""+ 'data copied into clipboard'); //
    $('#modal-success-default').modal('show');
  }

  function add_row_table(field_name, field_default, field_change){
    var header_table = "<tr>\n" +
      "<td  style='width: 30%;overflow: hidden;word-break: break-all;'>" + field_name + "</td>\n" +
      "<td  style='width: 40%;overflow: hidden;word-break: break-all;'>" + field_default + "</td>\n" +
      "<td  style='width: 40%;overflow: hidden;word-break: break-all;'>" + field_change + "</td>\n" +
      "</tr>\n";
    return header_table;
  }

  function preventNotAllowedChar() {

    var ctrlDown = false,
        ctrlKey = [17, 91, 224];

    $(document).keydown(function(e) {
        if (e.ctrlKey || ctrlKey.indexOf(e.keyCode) > -1) ctrlDown = true;
    }).keyup(function(e) {
        if (e.ctrlKey || ctrlKey.indexOf(e.keyCode) > -1) ctrlDown = false;
    });

    $('input[type=number]').on("keydown", function(e) {
        var charCode = (e.which) ? e.which : event.keyCode
        if (ctrlDown) return;
        if (charCode > 31 && (charCode < 37 || charCode > 57) || /[!@#$%^&*(),.?":{}|<>]/.test(e.key)) {
            e.preventDefault();
        }
    });
  }

  function validation_update_app(){
    ret_err = "";
    var app_status = '{{ app_obj.application_status_id|default:"-"|safe }}';
    var score_reason = "{{ app_obj.creditscore|get_credit_score_reason|default:"-"|safe}}";
    var is_grab = '{{ is_grab }}';
    var exclude_status = ['100', '106'];
    var exclude_revival = false;
    var bank_name_input = $("#id_form2-bank_name").val();
    $('.mask_currency').each(function(i, obj) {
        obj.value = obj.value.replaceAll('.','');
    });
    var onboarding_id = '{{ app_obj.onboarding_id }}';
    // Define Julo Starter Experiment as onboarding_id 6
    var jstarter_experiment_id = 6;

    if($("#id_form2-loan_purpose").val()==''){
      ret_err += '<br/>Tujuan Pinjaman Tidak Boleh Kosong';
    }
    var revival = "MTL to J1 Revival";

    if ((app_status == '175' && score_reason.toLowerCase() == revival.toLowerCase()) || exclude_status.includes(app_status)) {
        exclude_revival = true;
    }

    if (exclude_revival == false) {
        if($("#id_form2-loan_purpose_desc").val()==''){
          ret_err += '<br/>Uraian Tujuan Pinjaman Tidak Boleh Kosong';
        }
        if($("#id_form2-loan_purpose_description_expanded").val()==''){
          ret_err += '<br/>Uraian Tujuan Pinjaman Tidak Boleh Kosong(Detail)';
        }
        if($("#id_form2-dependent").val()==''){
          ret_err += '<br/>Jumlah Tanggungan Tidak Boleh Kosong';
        }
        if($("#id_form2-marital_status").val() != 'Menikah' &&  $("#id_form2-kin_name").val()==''){
          ret_err += '<br/>Nama Keluarga Kandung Tidak Boleh Kosong';
        }
        if($("#id_form2-kin_relationship").val()=='' && onboarding_id != jstarter_experiment_id && onboarding_id != 3 && onboarding_id != 1){
          ret_err += '<br/>Hubungan Tidak Boleh Kosong';
        }
        if(is_grab!='True' && $("#id_form2-loan_amount_request").val()=='' && $("#id_form2-product_line").val() != '{{ julo_one_product_code }}'){
          ret_err += '<br/>Jumlah Pinjaman Tidak Boleh Kosong';
        }
        if(is_grab!='True' && $("#id_form2-loan_duration_request").val()=='' && $("#id_form2-product_line").val() != '{{ julo_one_product_code }}'){
          ret_err += '<br/>Jangka Waktu Tidak Boleh Kosong';
        }
        if($("#id_form2-monthly_income").val()==''){
          ret_err += '<br/>Penghasilan Bersih Per Bulan Tidak Boleh Kosong';
        }
        if($("#id_form2-payday").val()==''){
          ret_err += '<br/>Tanggal Gajian Tidak Boleh Kosong';
        } else {
          val = parseInt($("#id_form2-payday").val());
          if (val < 1 || val > 31) {
            ret_err = validate_jstarter_app_fields(ret_err, "payday", '<br/>Tanggal Gajian Harus Antara 1 dan 31');
          }
        }
        if($("#id_form2-monthly_expenses").val()==''){
          ret_err += '<br/>Pengeluaran Rutin per Bulan Tidak Boleh Kosong';
        }
    }

    var ktp_regexp =/^[0-9]{16}$/;
    if(ktp_regexp.test($("#id_form2-ktp").val())==false){
        ret_err += '<br/>KTP harus 16 digit angka';
    } else if('{{app_obj.ktp|default:''|safe}}' != $("#id_form2-ktp").val()) {
        var ktp_response = check_if_ktp_exists();
        if (ktp_response.status != "success") {
            ret_err += '<br/>';
            ret_err += ktp_response.messages;
        }
    }

    //phoneno: start with 08 and 10-15 digits
    var grab_phone_regex = /^628[0-9]{8,13}$/;
    var phone_regex = /^08[0-9]{8,13}$/;
    var phone_regex_non_required = /^(|08[0-9]{8,13})$/;
    var comp_phone_regex = /^0[0-9]{8,14}$/;
    if(is_grab=='True' && !grab_phone_regex.test($("#id_form2-mobile_phone_1").val())){
        ret_err += '<br/>No HP1 harus 10 hingga 15 digit angka diawali dengan 628';
    }
    if(is_grab!='True' && !phone_regex.test($("#id_form2-mobile_phone_1").val())){
        ret_err += '<br/>No HP1 harus 10 hingga 15 digit angka diawali dengan 08';
    }
    if(!phone_regex_non_required.test($("#id_form2-mobile_phone_2").val())){
        ret_err += '<br/>No HP2 harus 10 hingga 15 digit angka diawali dengan 08';
    }
    if(!phone_regex_non_required.test($("#id_form2-close_kin_mobile_phone").val())){
        ret_err += '<br/>No HP Close Kin harus 10 hingga 15 digit angka diawali dengan 08';
    }
    if(!phone_regex_non_required.test($("#id_form2-kin_mobile_phone").val())){
        ret_err += '<br/>No HP Kin harus 10 hingga 15 digit angka diawali dengan 08';
    }
    if(!phone_regex_non_required.test($("#id_form2-spouse_mobile_phone").val())){
        ret_err += '<br/>No HP Spouse harus 10 hingga 15 digit angka diawali dengan 08';
    }
    if(is_grab!='True' && !comp_phone_regex.test($("#id_form2-company_phone_number").val())){
        ret_err += '<br/>No Telp Perusahaan harus 9 hingga 15 digit angka diawali dengan 0';
    }

    var dob = $("#id_form2-dob").val()
    if(dob.length > 10){
      ret_err += '<br/> Format tanggal lahir tidak boleh lebih dari 10 karakter';
    }

    var validate_expense = true;

    for (i = 1; i <= GLOBAL_LENGTH_EXPENSE; i++) {
      var id_desc= '#undisclosed_expense_desc_'+i;
      var id_amount= '#undisclosed_expense_amount_'+i;
      var id_stat = '#undisclosed_expense_stat_'+i;
      var desc = $(id_desc).val();
      var amount = $(id_amount).val();
      var stat = $(id_stat).val();
      if(stat != 'deleted'){
        if(desc == '' || amount == '' ){
          validate_expense = false;
        }
      }
    }
    if( !validate_expense ){
      ret_err += '<br/>Total Cicilan Hutang per Bulan Tidak Boleh Kosong';
    }

    if (ret_err == ""){
        return 'OK';
    }
    else {
      return ret_err;
    }
  }


  function show_fields_latest_change(){
    global_note_update_app = "Perubahan Data Aplikasi:";
    var field_changes_html = "<table class='table' id='id_tbl_app_update' style='width:100%;'>" +
        "<thead><tr>\n" +
        "<th> Field </th>\n" +
        "<th> From </th>\n" +
        "<th> Update</th>\n" +
        "</tr>\n</thead>\n<tbody>";

    {% autoescape on %}
    // looping for the changes
    var fields_list = [
      ['Tujuan Pinjaman','{{app_obj.loan_purpose|default:''}}',$("#id_form2-loan_purpose :selected").val(),'loan_purpose'],
      ['Uraian Tujuan Pinjaman','{{app_obj.loan_purpose_desc|default:''|escapejs}}',$("#id_form2-loan_purpose_desc").val(),'loan_purpose_desc'],
      ['Uraian Tujuan Pinjaman detail','{{app_obj.loan_purpose_description_expanded|default:''|escapejs}}',$("#id_form2-loan_purpose_description_expanded").val(),'loan_purpose_description_expanded'],
      ['Nama Lengkap','{{app_obj.fullname|default:''|safe|escapejs}}',$("#id_form2-fullname").val(),'fullname'],
      ['Tgl. Lahir','{{app_obj.dob|date:'d-m-Y'|default:''|safe}}',$("#id_form2-dob").val(),'dob'],
      ['Email','{{app_obj.email|default:''|safe}}',$("#id_form2-email").val(),'email'],
      ['Tempat Lahir','{{app_obj.birth_place|default:''|safe|escapejs}}',$("#id_form2-birth_place").val(),'birth_place'],
      ['No. KTP','{{app_obj.ktp|default:''|safe}}',$("#id_form2-ktp").val(),'ktp'],
      ['Nama Jalan','{{app_obj.address_street_num|default:''|escapejs}}',$("#id_form2-address_street_num").val(),'address_street_num'],
      ['Kecamatan','{{app_obj.address_kecamatan|default:''}}',$("#id_form2-address_kecamatan").val(),'address_kecamatan'],
      ['Kelurahan','{{app_obj.address_kelurahan|default:''}}',$("#id_form2-address_kelurahan").val(),'address_kelurahan'],
      ['Kabupaten','{{app_obj.address_kabupaten|default:''}}',$("#id_form2-address_kabupaten").val(),'address_kabupaten'],
      ['Propinsi','{{app_obj.address_provinsi|default:''}}',$("#id_form2-address_provinsi").val(),'address_provinsi'],
      ['Kodepos','{{app_obj.address_kodepos|default:''}}',$("#id_form2-address_kodepos").val(),'address_kodepos'],
      ['No HP1','{{app_obj.mobile_phone_1|default:''|safe}}',$("#id_form2-mobile_phone_1").val(),'mobile_phone_1'],
      ['Ada WA1','{{app_obj.has_whatsapp_1|default:'False'|safe}}',$('input[name=form2-has_whatsapp_1]:radio:checked').val(),'has_whatsapp_1'],
      ['No HP2','{{app_obj.mobile_phone_2|default:''|safe}}',$("#id_form2-mobile_phone_2").val(),'mobile_phone_2'],
      ['Ada WA2','{{app_obj.has_whatsapp_2|default:'False'|safe}}',$('input[name=form2-has_whatsapp_2]:radio:checked').val(),'has_whatsapp_2'],
      ['Bahasa Daerah','{{app_obj.dialect|default:''|safe}}',$("#id_form2-dialect").val(),'dialect'],
      ['Status Pernikahan','{{app_obj.marital_status|default:''}}',$("#id_form2-marital_status :selected").val(),'marital_status'],
      ['Jumlah Tanggungan','{{app_obj.dependent|default:''|safe}}',$("#id_form2-dependent").val(),'dependent'],
      ['Nama Pasangan',"{{app_obj.spouse_name|default:''|escapejs}}",$("#id_form2-spouse_name").val(),'spouse_name'],
      ['Tgl Lahir Pasangan','{{app_obj.spouse_dob|date:"d-m-Y"|default:''|safe}}',$("#id_form2-spouse_dob").val(),'spouse_dob'],
      ['No HP Pasangan','{{app_obj.spouse_mobile_phone|default:''|safe}}',$("#id_form2-spouse_mobile_phone").val(),'spouse_mobile_phone'],
      ['HP Pasangan Ada WA','{{app_obj.spouse_has_whatsapp|default:'False'|safe}}',$('input[name=form2-spouse_has_whatsapp]:radio:checked').val(),'spouse_has_whatsapp'],
      ['Nama Keluarga Kandung',"{{app_obj.kin_name|default:''}}",$("#id_form2-kin_name").val(),'kin_name'],
      ['Tanggal Lahir Keluarga Kandung','{{app_obj.kin_dob|date:"d-m-Y"|default:''|safe}}',$("#id_form2-kin_dob").val(),'kin_dob'],
      ['Jenis Kelamin Keluarga Kandung','{{app_obj.kin_gender|default:''|safe}}',$("#id_form2-kin_gender :selected").val(),'kin_gender'],
      ['Jenis Kelamin','{{app_obj.gender|default:''|safe}}',$("#id_form2-gender :selected").val(),'gender'],
      ['No HP Keluarga Kandung','{{app_obj.kin_mobile_phone|default:''|safe}}',$("#id_form2-kin_mobile_phone").val(),'kin_mobile_phone'],
      ['Hubungan','{{app_obj.kin_relationship|default:''}}',$("#id_form2-kin_relationship").val(),'kin_relationship'],
      ['Nama Keluarga Kandung Terdekat',"{{app_obj.close_kin_name|default:''}}",$("#id_form2-close_kin_name").val(),'close_kin_name'],
      ['No HP Keluarga Kandung Terdekat','{{app_obj.close_kin_mobile_phone|default:''|safe}}',$("#id_form2-close_kin_mobile_phone").val(),'close_kin_mobile_phone'],
      ['Hubungan Keluarga Terdekat','{{app_obj.close_kin_relationship|default:''}}',$("#id_form2-close_kin_relationship").val(),'close_kin_relationship'],
      ['No Telp Perusahaan','{{app_obj.company_phone_number|default:''|safe}}',$("#id_form2-company_phone_number").val(),'company_phone_number'],
      ['Penghasilan Bersih Per Bulan','{{app_obj.monthly_income|default:''|safe}}',$("#id_form2-monthly_income").val(),'monthly_income'],
      ['Tanggal Gajian','{{app_obj.payday|default:''|safe}}',$("#id_form2-payday").val(),'payday'],
      ['Besar Penghasilan','{{app_obj.other_income_amount|default:''|safe}}',$("#id_form2-other_income_amount").val(),'other_income_amount'],
      ['Biaya Sewa/Cicilan Rumah per Bulan','{{app_obj.monthly_housing_cost|default:''|safe}}',$("#id_form2-monthly_housing_cost").val(),'monthly_housing_cost'],
      ['Pengeluaran Rutin per Bulan','{{app_obj.monthly_expenses|default:''|safe}}',$("#id_form2-monthly_expenses").val(),'monthly_expenses'],
      ['Kepemilikan Kendaraan','{{app_obj.vehicle_ownership_1|default:''|safe}}',$("#id_form2-vehicle_ownership_1").val(),'vehicle_ownership_1'],
      ['Nama Perusahaan',"{{app_obj.company_name|default:''|escapejs}}",$("#id_form2-company_name").val(),'company_name'],
      ['Tanggal Mulai Kerja','{{app_obj.job_start|date:'d-m-Y'|default:''|safe}}',$("#id_form2-job_start").val(),'job_start'],
      ['Nama sesuai rekening bank',"{{app_obj.name_in_bank|default:''|escapejs}}",$("#id_form2-name_in_bank").val(),'name_in_bank'],
      ['Cabang Bank','{{app_obj.bank_branch|default:''}}',$("#id_form2-bank_branch").val(),'bank_branch'],
      ['Nama Bank',"{{app_obj.bank_name|default:''|escapejs}}",$("#id_form2-bank_name").val(),'bank_name'],
      ['Nomor Rekening','{{app_obj.bank_account_number|default:''|safe}}',$("#id_form2-bank_account_number").val(),'bank_account_number'],
      ['Nama hrd/Atasan',"{{app_obj.hrd_name|default:''|escapejs}}",$("#id_form2-hrd_name").val(),'hrd_name'],
      ['Alamat Kantor/Penempatan','{{app_obj.company_address|default:''|escapejs}}',$("#id_form2-company_address").val(),'company_address'],
      ['Jumlah Karyawan','{{app_obj.number_of_employees|default:''|safe}}',$("#id_form2-number_of_employees").val(),'number_of_employees'],
      ['Posisi Karyawan','{{app_obj.position_employees|default:''|safe}}',$("#id_form2-position_employees").val(),'position_employees'],
      ['Status Kepegawaian','{{app_obj.employment_status|default:''}}',$("#id_form2-employment_status").val(),'employment_status'],
      ['Penagihan/Tunggakan dikantor','{{app_obj.billing_office|default:''|safe|escapejs}}',$("#id_form2-billing_office").val(),'billing_office'],
      ['Mutasi/Resign','{{app_obj.mutation|default:''}}',$("#id_form2-mutation").val(),'mutation'],
      ['Nama Bank',"{{app_obj.bank_name|default:''|escapejs}}",$("#id_form3_bank_name").val(),'bank_name'],
      ['Cabang Bank','{{app_obj.bank_branch|default:''|escapejs}}',$("#id_form3_bank_branch").val(),'bank_branch'],
      ['No Rekening Bank','{{app_obj.bank_account_number|default:''}}',$("#id_form3_bank_account_number").val(),'bank_account_number'],
      ['Nama sesuai rekening bank', "{{app_obj.name_in_bank|default:''|escapejs}}",$("#id_form3_name_in_bank").val(),'name_in_bank'],
      ['Selfie Difotoin', "{{app_obj.is_assisted_selfie|default:''|escapejs}}",$("#id_form2-is_assisted_selfie").is(":checked"),'is_assisted_selfie']
      ]
    {% endautoescape %}
    {% if not offers %}
      var jumlahPinjam = ['Jumlah Pinjaman','{{app_obj.loan_amount_request|default:''|safe}}',$("#id_form2-loan_amount_request").val(),'loan_amount_request'];
      var jangkaWaktu = ['Jangka Waktu','{{app_obj.loan_duration_request|default:''|safe}}',$("#id_form2-loan_duration_request").val(),'loan_duration_request']
      var productLine = ['Product','{{app_obj.product_line.product_line_code|default:''|safe}}',$("#id_form2-product_line").val(),'product_line']
      fields_list.push(jumlahPinjam);
      fields_list.push(jangkaWaktu);
      fields_list.push(productLine);
    {% endif %}

    //add checklist
    for (i = 0; i < GLOBAL_CHECKLIST_CA.length; i++) {
      var id = GLOBAL_CHECKLIST_CA[i][3];
      var str_value = GLOBAL_CHECKLIST_CA[i][1];
      GLOBAL_CHECKLIST_CA[i][2] = $(id).val();
      GLOBAL_CHECKLIST_CA[i][1] = str_value.replace(/&lt;br&gt;/g, '\n');
      fields_list.push(GLOBAL_CHECKLIST_CA[i]);
    }

    //add expense
    GLOBAL_RESULT_EXPENSE[2] = '';
    for (i = 1; i <= GLOBAL_LENGTH_EXPENSE; i++) {
      var id_desc = '#undisclosed_expense_desc_'+i;
      var id_amount = '#undisclosed_expense_amount_'+i;
      var id_stat = '#undisclosed_expense_stat_'+i;
      var desc = $(id_desc).val();
      var amount = $(id_amount).val();
      var stat = $(id_stat).val();
      if(stat != 'deleted'){
        GLOBAL_RESULT_EXPENSE[2] = GLOBAL_RESULT_EXPENSE[2] +'('+ desc + ' - ' + amount.toString() + ')';
      }
    }
    fields_list.push(GLOBAL_RESULT_EXPENSE);

    var rows_data = "";
    var index_change = 0;

    //fields_list
    GLOBAL_SAVE_CHECKLIST=[];
    $.each(fields_list, function(id, obj_item) {
      var obj0 = obj_item[0];
      var obj1 = html_unescape(obj_item[1]);
      var obj2 = obj_item[2];
      var obj3 = obj_item[3];

      if (obj0 == 'Tgl Lahir Pasangan'){
        if('{{app_obj.marital_status|default:''|safe}}' != 'Menikah'){
          obj1 = '';
          obj2 = '';
        }
      }
      if (obj0 == 'Penghasilan Bersih Per Bulan' || obj0 == 'Besar Penghasilan' || obj0 == 'Biaya Sewa/Cicilan Rumah per Bulan' || obj0 == 'Pengeluaran Rutin per Bulan'|| obj0 == 'Total Cicilan Hutang per Bulan'){
        //console.log(obj0);
        //console.log('obj2-1: ' + obj2);
        obj2 = obj2.replace('.', '').replace('.', '').replace('.', '').replace('.', '');
        //console.log('obj2-2: ' + obj2);
      }

      if (obj2 != undefined) {
          if ((obj1 != obj2) && !(obj1 === '' && obj2 === '0')){
            rows_data += add_row_table(obj0, obj1, obj2);
            global_note_update_app += " \r\n* " + obj0 + ": " + obj1 + " >> " + obj2;
            index_change++;

            var obj = { "field_name" : "",
                        "group" : "-",
                        "agent" : "",
                        "type" : "",
                        "undisclosed_expense" : [],
                        "value" : ""
                      };

            if(obj0.includes('checklist')){
              obj.field_name = obj_item[4];
              obj.group = obj_item[5];
              obj.type = "checklist";
              obj.value =  formatChecklist(obj2);
              GLOBAL_SAVE_CHECKLIST.push(obj);
            }else if(obj0.includes('comment')){
              obj.field_name = obj_item[4];
              obj.group = obj_item[5];
              obj.type = "comment";
              obj.value =  obj2;
              obj.agent =  '{{ user.id }}';
              GLOBAL_SAVE_CHECKLIST.push(obj);
            }else if(obj0 == 'Undisclosed Expense'){
              var arr_undisclosed_expense = [] ;
              var total = 0 ;
              var group = '';
              {% checkusergroup in ['bo_sd_verifier'] %}
                group = 'sd';
              {% endcheckusergroup %}
              {% checkusergroup in ['bo_credit_analyst'] %}
                group = 'ca';
              {% endcheckusergroup %}
              for (i = 1; i <= GLOBAL_LENGTH_EXPENSE; i++) {
                var id_expense = '#undisclosed_expense_id_'+i;
                var id_desc = '#undisclosed_expense_desc_'+i;
                var id_amount = '#undisclosed_expense_amount_'+i;
                var id_stat = '#undisclosed_expense_stat_'+i;
                var desc = $(id_desc).val();
                var amount = $(id_amount).val();
                var stat = $(id_stat).val();
                var id = $(id_expense).val();

                if(stat == 'activate'){
                  var temp_obj = {"id" : "","desc" : "","amount" : ""};
                  temp_obj.id = id;
                  temp_obj.desc = desc;
                  temp_obj.amount = Number(amount);
                  arr_undisclosed_expense.push(temp_obj);
                  total += Number(amount);
                }else if(stat == 'added'){
                  var temp_obj = {"desc" : "","amount" : ""};
                  temp_obj.desc = desc;
                  temp_obj.amount = Number(amount);
                  arr_undisclosed_expense.push(temp_obj);
                  total += Number(amount);
                }
              }

              obj.field_name = 'total_current_debt';
              obj.type = "undisclosed_expense";
              obj.group = group;
              obj.value =  total;
              obj.undisclosed_expense = arr_undisclosed_expense;
              GLOBAL_SAVE_CHECKLIST.push(obj);
            }else{
              obj.field_name = obj3;
              obj.type = "field";
              obj.value =  obj2;
              GLOBAL_SAVE_CHECKLIST.push(obj);
            }
          }
          //console.log(obj_item[0],obj_item[1],obj_item[2]);
      }
    });

    // closing table tag
    field_changes_html += rows_data + "\n</tbody>\n</table>";
    //console.log(field_changes_html);

    if (index_change==0){
      return index_change
    }else {
      return field_changes_html;
    }
  }

  function setDefaultValue(id_obj, def_value){
    $("#"+id_obj).val(def_value);
  }

  function failed_validation_display(ret_validate) {
        $("#modal_default_title").html(""+ "Update Aplikasi Gagal !");
        $("#modal_default_body").html(""+ ret_validate + " !!!");
        $('#modal-success-default').modal('show');
  }

  $("#id_btn_update_app").click(function(){
    //validate
    var ret_validate = validation_update_app();
    if(ret_validate!='OK'){
        failed_validation_display(ret_validate);
        return;
    }

    // and show changes
    var field_change_tbl = show_fields_latest_change();
    var init_title = "Aplikasi <b>{{app_obj.id|safe}}</b> akan di update, apakah anda yakin?";

    if (field_change_tbl == 0){
      $("#modal_default_title").html(""+ "Update Aplikasi !");
      $("#modal_default_body").html(""+ "Tidak ada perubahan data !!!");
      $('#modal-success-default').modal('show');
    }else{
      $("#modal_update_app_body").html("\n" + field_change_tbl +"\n <div>" + init_title +"</div>");
      $('#modal-update-app').modal('show');
    }
  });

  $("#id_update_app").click(function(){
      console.log(GLOBAL_SAVE_CHECKLIST);
      update_app_selected_field();
  });

   function check_if_ktp_exists(){
    var csrftoken = getCookie('csrftoken');
    var ret_value;
    $.ajax({
        url :  "{%url 'app_status:ajax_check_ktp' %}/",
        type : "POST",
        async: false,
        data : {
              customer_id   : '{{app_obj.customer_id}}',
              application_id : '{{app_obj.id}}',
              ktp: $("#id_form2-ktp").val()
          },
        // handle a successful response
        success : function(json) {
            ret_value = json;
        },
        // handle a non-successful response
        error : function(xhr,errmsg,err) {
            console.log(xhr.status + ": " + xhr.responseText);
        }
    });
    return ret_value;
  }

   function update_app_selected_field(){
    var csrftoken = getCookie('csrftoken');
    $.ajax({
        url :  "{%url 'app_status:update_checklist' %}/", // the endpoint
        type : "POST", // http method
        data : {
              application_id   : '{{app_obj.id}}',
              data: JSON.stringify(GLOBAL_SAVE_CHECKLIST)
          },
        // handle a successful response
        success : function(json) {
            if (json.status == "success"){
              console.log(json);
              toast_success("Update Aplikasi Success", ""+ json.messages);
              setTimeout(reload_btn(), 1200);
            }
            else {
              $("#modal_default_title").html(""+ json.status);
              $("#modal_default_body").html(""+ json.messages);
              $('#modal-success-default').modal('show');
            }
        },

        // handle a non-successful response
        error : function(xhr,errmsg,err) {
            console.log(xhr.status + ": " + xhr.responseText);
        }
    });
  }

  function disabled_btn(id_element, disabled_status){
    if(disabled_status == 0)
    {
      document.getElementById(id_element).disabled = false;
      $("#"+id_element).removeClass("btn-default");
      $("#"+id_element).addClass("btn-info");
    }else {
      document.getElementById(id_element).disabled = true;
      $("#"+id_element).addClass("btn-default");
      $("#"+id_element).removeClass("btn-info");
    }
  }

  function validationMaritalStatus(oEvent){
    if($("#id_form2-marital_status").val() == 'Menikah'){
      $("#id_form2-spouse_name").removeAttr('readonly');
      $("#id_form2-spouse_mobile_phone").removeAttr('readonly');
      $("#id_form2-spouse_has_whatsapp_0").removeAttr('disabled');
      $("#id_form2-spouse_has_whatsapp_1").removeAttr('disabled');
      $("#id_form2-spouse_name").val("{{app_obj.spouse_name|default:''|safe}}");
      $("#id_form2-spouse_mobile_phone").val('{{app_obj.spouse_mobile_phone|default:''|safe}}');
      if('{{app_obj.spouse_has_whatsapp|default:'False'|safe}}'=='False'){
        $("#id_form2-spouse_has_whatsapp_1").attr('checked', true);
      } else {
        $("#id_form2-spouse_has_whatsapp_0").attr('checked', true);
      }
      //enable button
      disabled_btn("id_btn-spouse_name", 0);
      $( "#id_form2-spouse_dob" ).prop( "disabled", false );
      $("#id_form2-spouse_dob").removeClass("btn-default");
      disabled_btn("id_btn-spouse_mobile_phone", 0);
    }
    else {
      $("#id_form2-spouse_name").attr('readonly','readonly');
      $("#id_form2-spouse_mobile_phone").attr('readonly','readonly');
      $("#id_form2-spouse_has_whatsapp_0").attr('disabled',"true");
      $("#id_form2-spouse_has_whatsapp_1").attr('disabled','true');

      $("#id_form2-spouse_name").val('');
      $("#id_form2-spouse_dob").val('');
      $("#id_form2-spouse_mobile_phone").val('');
      $("#id_form2-spouse_has_whatsapp_1").attr('checked', true);

      //disable button
      disabled_btn("id_btn-spouse_name", 1);
      $( "#id_form2-spouse_dob" ).prop( "disabled", true );
      $("#id_form2-spouse_dob").addClass("btn-default");
      disabled_btn("id_btn-spouse_mobile_phone", 1);
    }
  }

  /*$("#id_form2-marital_status").change(function(){
      if($(this).val() == 'Menikah'){
      } else {
      }
  });*/

  function get_radio_yesno_val(id_radio){
    var radio_0 = $("#"+id_radio+"_0").val();
    var radio_1 = $("#"+id_radio+"_0").val();
  }

  //Show modal voice
  function ShowModalVoice(voice_id){
    var csrftoken = getCookie('csrftoken');
    $.each({{ json_voice_list|safe }}, function(i, obj) {
       var src_id = $("#myVoice");
      $.each(obj, function(i, obj_item) {
        if(voice_id == obj.pk){
          src_id.attr('src', obj_item.presigned_url);
        }
      });
    });
    $.each({{ json_voice_list_1|safe }}, function(i, obj) {
       var src_id = $("#myVoice");
      $.each(obj, function(i, obj_item) {
        if(voice_id == obj.pk){
          src_id.attr('src', obj_item.presigned_url);
        }
      });
    });
    $('#modal-see-voice').modal('show');
    $('#modal_voice_title').html('Check Voice Agreement '+voice_id);
    $.ajax({
        url :  "{%url 'app_status:voice_records_script' %}/", // the endpoint
        type : "GET", // http method
        data : {
                application_id : '{{ app_obj.id|default:"-"|safe  }}',
                 csrfmiddlewaretoken : csrftoken,
                }, // data sent with the get request

        // handle a successful response
        success : function(json) {
            if (json.result == "successful!"){
              //console.log(json.reason);
              $('#text_agreement').html(json.reason);
            }
            else {
              toast_danger("Error", json.reason);
            }
        },

        // handle a non-successful response
        error : function(xhr,errmsg,err) {
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            toast_danger("Error", json.reason);
        }
    }); // end of ajax
  }

  //Event Modal
  $("#id_btn_close_voice").click(function(){
    var x = document.getElementById("myVoice");
    x.pause();
  });

  function SaveSkipTrace(){
    var obj_skiptrace = GetFormSkipTrace();
    var result = ValidateFormSkipTrace(obj_skiptrace);
    //console.log(obj_skiptrace);
    if(result.isValid){
      $.ajax({
          url :  "{% url 'payment_status:add_skiptrace' %}/",
          type : "POST",
          data : {
                application : {{app_obj.id}},
                contact_name : obj_skiptrace.name,
                contact_source : obj_skiptrace.source,
                phone_number: obj_skiptrace.number_phone
          },

          statusCode: {
            404: function(json) {
              toast_warning('Warning 404!',json['responseText']);
            },
            400: function(json) {
              toast_warning('Warning 400!',json['responseText']);
            },
            405: function(json) {
              toast_warning('Warning 405!',json['responseText']);
            },
            200: function(json) {
              toast_success('Success','Add skiptrace '+json.data.contact_name);
              GLOBAL_TABLE.row.add( {
                "NAME": json.data.contact_name,
                "SOURCE": json.data.contact_source,
                "OPERATOR": formating(json.data.phone_operator),
                "EFF": formating(json.data.effectiveness),
                "REC": formatingDate(json.data.recency),
                "FREQ": formating(json.data.frequency),
                "ID": json.data.id,
                "NUMBER_PHONE": json.data.phone_number,
                "ACTION": '<button type="button" id="id_call_skip_trace" class="btn btn btn-success btn-rounded"> <i class="fa fa-chevron-circle-down"></i></button>'
              } ).order( [ 3, 'desc' ], [ 6, 'asc' ] ).draw(false);
              ResetFormSkipTrace();
              HideFormSkipTrace();
            },
          },

          // handle a successful response
          success : function(json) {
              //console.log("success add: "+json.data);
          },
          // handle a non-successful response
          error : function(xhr, errmsg, err) {
              console.log(xhr.status + ": " + xhr.responseText);
          }
      });
    }else{
      toast_warning('Warning',result.reason);
    }
  }

  function UpdateSkipTrace(){
    var obj_skiptrace = GetFormSkipTrace();
    var result = ValidateFormSkipTrace(obj_skiptrace);
    if(result.isValid){
      $.ajax({
          url :  "{% url 'payment_status:update_skiptrace' %}/",
          type : "POST",
          data : {
                skiptrace_id: obj_skiptrace.id,
                application : {{app_obj.id}},
                contact_name : obj_skiptrace.name,
                contact_source : obj_skiptrace.source,
                phone_number: obj_skiptrace.number_phone
          },

          statusCode: {
            404: function(json) {
              toast_warning('Warning 404!',json['responseText']);
            },
            400: function(json) {
              toast_warning('Warning 400!',json['responseText']);
            },
            405: function(json) {
              toast_warning('Warning 405!',json['responseText']);
            },
            200: function(json) {
              toast_success('Success','Update skiptrace '+json.data.contact_name);
              var tr = $(obj_skiptrace.row_table).parents('tr').prev();
              var data = GLOBAL_TABLE.row( tr ).data();
              var row = GLOBAL_TABLE.row( tr );
              row.child.hide();
              tr.removeClass('shown');
              data.NAME =  json.data.contact_name;
              data.SOURCE = json.data.contact_source;
              data.OPERATOR = formating(json.data.phone_operator);
              data.EFF = formating(json.data.effectiveness);
              data.REC = formatingDate(json.data.recency);
              data.FREQ = formating(json.data.frequency);
              data.ID = json.data.id;
              data.NUMBER_PHONE = json.data.phone_number;
              data.ACTION = '<button type="button" id="id_call_skip_trace" class="btn btn btn-success btn-rounded"> <i class="fa fa-chevron-circle-down"></i></button>';
              GLOBAL_TABLE.row(tr)
                    .data(data)
                    .order( [ 3, 'desc' ], [ 6, 'asc' ] ).draw(false);
              ResetFormSkipTrace();
              HideFormSkipTrace();
            },
          },

          // handle a successful response
          success : function(json) {
              //console.log("success update: "+json.data);
          },
          // handle a non-successful response
          error : function(xhr, errmsg, err) {
              console.log(xhr.status + ": " + xhr.responseText);
          }
      });
    }else{
      toast_warning('Warning',result.reason);
    }
  }

    function ActionCall(id,skiptrace_id, self){
      var obj = {};
      var obj_time = GetTS(skiptrace_id);
      obj.id = id ;
      obj.skiptrace_id = skiptrace_id;
      obj.application_id = {{app_obj.id}};
      obj.start_ts = obj_time.start;
      obj.end_ts = obj_time.end;
      var result = ValidateActionCall(obj);
      if(result.isValid){
        $.ajax({
            url :  "{% url 'payment_status:skiptrace_history' %}/",
            type : "POST",
            data : {
                  skiptrace : obj.skiptrace_id,
                  application : obj.application_id,
                  start_ts : obj.start_ts,
                  end_ts : obj.end_ts,
                  call_result: obj.id,
                  payment: obj.payment_id
            },
            statusCode: {
              404: function(json) {
                toast_warning('Warning 404!',json['responseText']);
              },
              400: function(json) {
                toast_warning('Warning 400!',json['responseText']);
              },
              405: function(json) {
                toast_warning('Warning 405!',json['responseText']);
              },
              200: function(json) {
                if(json.data){
                  var tr = $(self).parents('tr').prev();
                  var data = GLOBAL_TABLE.row( tr ).data();
                  var row = GLOBAL_TABLE.row( tr );
                  row.child.hide();
                  tr.removeClass('shown');
                  data.NAME =  json.data.contact_name;
                  data.SOURCE = json.data.contact_source;
                  data.OPERATOR = formating(json.data.phone_operator);
                  data.EFF = formating(json.data.effectiveness);
                  data.REC = formatingDate(json.data.recency);
                  data.FREQ = formating(json.data.frequency);
                  data.ID = json.data.id;
                  data.NUMBER_PHONE = json.data.phone_number;
                  data.ACTION = '<button type="button" id="id_call_skip_trace" class="btn btn btn-success btn-rounded"> <i class="fa fa-chevron-circle-down"></i></button>';
                  GLOBAL_TABLE.row(tr)
                        .data(data)
                        .order( [ 3, 'desc' ], [ 6, 'asc' ] ).draw(false);
                  ResetFormSkipTrace();
                  HideFormSkipTrace();
                  toast_success('Success',json.messages);
                }
              },
            },

            // handle a successful response
            success : function(json) {
                //console.log("success ",json);
            },
            // handle a non-successful response
            error : function(xhr, errmsg, err) {
                console.log({{payment_obj.id}})
                console.log(xhr.status + ": " + xhr.responseText);
            }
        });
      }else{
        toast_danger('Failed!!',result.reason);
      }
    }

    function autodialcall(number_phone, name){
      $.ajax({
          url :  "{% url 'app_status:trigger_autodial' %}/",
          type : "GET",
          data : {
                number_phone : number_phone,
                user_extension : GLOBAL_USER_EXTENSION,
                name: name,
                call_type: 'call',
                application_id : '{{ app_obj.id}}'
          },

          // handle a successful response
          success : function(json) {

              if (json.status == "success"){
                toast_success('Click2Call',json.message);
              } else if(json.status == "failed"){
                toast_danger('Click2Call',json.message);
              }
          },

          // handle a non-successful response
          error : function(xhr, errmsg, err) {
              toast_danger('Click2Call Failed!', err);
                }
        })
    }

    function cekAvailable(){

      $('#id_cek_saldo_doku').button('loading');

      $.ajax({

          url :  "{% url 'app_status:check_doku_balance' %}/",

          type : "POST",

          data : {

                application_id : {{app_obj.id}}

          },

          // handle a successful response

          success : function(json) {

              if (json.status == "success"){

                $('#id_cek_saldo_doku').button('reset');

                $('#id_cek_saldo_doku').hide();

                $('#id_available_saldo_doku').show();

                $('#id_available_saldo_doku').css( 'cursor', 'default' );

                $('#id_transfer_doku').attr('class', 'btn btn-primary btn-block');

                $('#id_transfer_doku').attr('onclick', 'dokuTransfer();');

                toast_success('Cek Status',json.messages);

              } else if(json.status == "failed"){

                $('#id_cek_saldo_doku').button('reset');

                $('#id_cek_saldo_doku').hide();

                $('#id_notavailable_saldo_doku').show();

                $('#id_notavailable_saldo_doku').css( 'cursor', 'default' );

                toast_danger('Cek Status',json.messages);

              }

          },

          // handle a non-successful response

          error : function(xhr, errmsg, err) {

              console.log(xhr.status + ": " + xhr.responseText);

              $('#id_cek_saldo_doku').button('reset');

              toast_danger('Cek Status Failed!!',err);

          }

      });
    }

    function dokuTransfer(){
      $('#id_modal_transfer_doku').modal('show');
    }

    function actionDisbursement(){
      $('#id_action_disbursement_doku').button('loading');
      $.ajax({
          url :  "{% url 'app_status:doku_disbursement' %}/",
          type : "POST",
          data : {
                application_id : {{app_obj.id}},
          },

          // handle a successful response
          success : function(json) {

              if (json.status == "success"){
                $('#id_action_disbursement_doku').button('reset');
                $('#id_modal_transfer_doku').modal('hide');
                toast_success('Disburse Success!!',json.messages);
                window.location.reload(true);
              } else if(json.status == "failed"){
                $('#id_action_disbursement_doku').button('reset');
                $('#id_modal_transfer_doku').modal('hide');
                toast_danger('Disburse Failed!!',json.messages);
              }
          },

          // handle a non-successful response
          error : function(xhr, errmsg, err) {
              console.log(xhr.status + ": " + xhr.responseText);
              $('#id_action_disbursement_doku').button('reset');
              $('#id_modal_transfer_doku').modal('hide');
              toast_danger('Disburse Failed!!',err);
          }

      });
    }

    function actionCalculate(){
        var csrftoken = getCookie('csrftoken');
        {% if offers %}
          GLOBAL_JSON_CALCULATE.loan_amount_request = '{{app_obj.loan_amount_request}}';
          GLOBAL_JSON_CALCULATE.loan_duration_request = '{{app_obj.loan_duration_request}}';
          GLOBAL_JSON_CALCULATE.product_line = '{{app_obj.product_line.product_line_code}}';
        {% else %}
          GLOBAL_JSON_CALCULATE.loan_amount_request = $("#id_form2-loan_amount_request").val();
          GLOBAL_JSON_CALCULATE.loan_duration_request = $("#id_form2-loan_duration_request").val();
          GLOBAL_JSON_CALCULATE.product_line = $("#id_form2-product_line").val();
        {% endif %}
        GLOBAL_JSON_CALCULATE.status = false;
        GLOBAL_JSON_CALCULATE.monthly_income = $("#id_form2-monthly_income").val();
        GLOBAL_JSON_CALCULATE.payday = $("#id_form2-payday").val();
        GLOBAL_JSON_CALCULATE.job_type = '{{app_obj.job_type}}';
        GLOBAL_JSON_CALCULATE.monthly_expense = $("#id_form2-monthly_expenses").val();
        GLOBAL_JSON_CALCULATE.monthly_housing_cost = $("#id_form2-monthly_housing_cost").val();
        GLOBAL_JSON_CALCULATE.dependent = $("#id_form2-dependent").val();
        GLOBAL_JSON_CALCULATE.job_start = $("#id_form2-job_start").val();
        GLOBAL_JSON_CALCULATE.other_income = $("#id_form2-other_income_amount").val();
        GLOBAL_JSON_CALCULATE.undisclosed_expense = 0;
        //calculate total expense
        for (i = 1; i <= GLOBAL_LENGTH_EXPENSE; i++) {
          var id_stat = '#undisclosed_expense_stat_'+i;
          var stat = $(id_stat).val();
          var id_amount = '#undisclosed_expense_amount_'+i;
          var amount = $(id_amount).val();
          if(stat == 'activate'){
            GLOBAL_JSON_CALCULATE.undisclosed_expense += Number(amount);
          }else if(stat == 'added'){
            GLOBAL_JSON_CALCULATE.undisclosed_expense += Number(amount);
          }
        }
        console.log(GLOBAL_JSON_CALCULATE);
        $.ajax({
            url :  "{%url 'app_status:calculate_suggested_offer' %}/", // the endpoint
            type : "POST", // http method
            data : {
                  application_id   : '{{app_obj.id}}',
                  monthly_income   : GLOBAL_JSON_CALCULATE.monthly_income,
                  job_type   : GLOBAL_JSON_CALCULATE.job_type,
                  monthly_expense   : GLOBAL_JSON_CALCULATE.monthly_expense,
                  monthly_housing_cost   : GLOBAL_JSON_CALCULATE.monthly_housing_cost,
                  undisclosed_expense   : GLOBAL_JSON_CALCULATE.undisclosed_expense,
                  dependent_count   : GLOBAL_JSON_CALCULATE.dependent,
                  job_start_date   : GLOBAL_JSON_CALCULATE.job_start,
                  loan_amount_request : GLOBAL_JSON_CALCULATE.loan_amount_request,
                  loan_duration_request : GLOBAL_JSON_CALCULATE.loan_duration_request,
                  payday : GLOBAL_JSON_CALCULATE.payday,
                  other_income : GLOBAL_JSON_CALCULATE.other_income,
                  product_line_code : GLOBAL_JSON_CALCULATE.product_line,
              },

            // handle a successful response
            success : function(json) {
                if (json.status == "success"){
                  $('#calculate_offer_0').removeClass('offer-red');
                  $('#calculate_offer_0').hide();
                  {% if offers %}
                    GLOBAL_OFFER_STATUS = true;
                  {% else %}
                    GLOBAL_OFFER_STATUS = false;
                    $('#calculate_offer_1').removeClass('calculate-edited');
                    $('#calculate_offer_2').removeClass('calculate-edited');
                    $('#calculate_offer_1').addClass('calculate-choices');
                    $('#calculate_offer_2').addClass('calculate-choices');
                    $('#calculate_offer_1').hide();
                    $('#calculate_offer_2').hide();
                  {% endif %}
                  toast_success('Calculate Success');
                  console.log(json);
                  setCalculate(json.data);
                  setOffer(json.data);
                }
                else {
                  toast_danger('Calculate Failed!!',json.messages);
                  console.log(json);
                }
            },

            // handle a non-successful response
            error : function(xhr,errmsg,err) {
                console.log(xhr.status + ": " + xhr.responseText);
            }
        });
    }


    $("#id_compute_installment" ).click(function() {
      toast_warning('Sending', 'Wait until it is done');

      var product = $("#id_form2-product option:selected").val();
      var loan_amount = $("#id_form2-loan_amount_offer").val();
      var loan_duration = $("#id_form2-loan_duration_offer").val();
      var product_line = Number($("#id_form2-product_line").val());
      var STL = [20, 21];
      var stl_found = STL.indexOf(product_line) > -1;
      err_msg = "";
      if(product==""){
        err_msg = "Silahkan Pilih Product dahulu!";
      }
      else if(loan_amount=="0"){
        err_msg = "Silahkan Inputkan Loan Amount dahulu!";
      }
      else if(loan_duration=="0"){
        err_msg = "Silahkan Inputkan Loan Duration dahulu!";
      }
      else {
        if (stl_found){
          simulate_adjusted_payment(product, loan_amount, loan_duration, product_line);
        } else{
          compute_installment(product, loan_amount, loan_duration);
          simulate_adjusted_payment(product, loan_amount, loan_duration, product_line);
        }
      }

      if(err_msg!=""){
        //show Error Msg on modal view
        $("#compute_modal_body").html(""+ err_msg);
        $('#responsive-compute-modal').modal('show');
        //alert(""+ err_msg);
      }
    });

    function simulate_adjusted_payment(product, loan_amount, loan_duration, product_line){
      //check using ajax
      var csrftoken = getCookie('csrftoken');
      var product_line = Number($("#id_form2-product_line").val());
      var STL = [20, 21];
      var stl_found = STL.indexOf(product_line) > -1;

      $.ajax({
          url :  "{%url 'offers:simulated_first_installment' %}/", // the endpoint
          type : "GET", // http method
          data : { product: product,
                   new_due_date: $("#p_installment_date").val(),
                   loan_amount: loan_amount,
                   loan_duration: loan_duration,
                   csrfmiddlewaretoken: csrftoken,
                  }, // data sent with the get request

          // handle a successful response
          success : function(json) {
              // console.log(json); // log the returned json to the console
              if (json.result == "successful!"){
                // console.log("sukses");
                toast_success('Success');
                $("#p_installment_amount").val(json.output);
                if (stl_found){
                  $("#id_form2-installment_amount_offer").val(''+json.output);
                  set_disable_simpan_btn(0);
                }

              }
              else {
                //failed
                toast_danger('Computed Failed',json.reason);
                console.log(json.reason);
              }
          },

          // handle a non-successful response
          error : function(xhr,errmsg,err) {
              console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
          }
      }); // end of ajax
    }//end of function

  function compute_installment(product, loan_amount, loan_duration){
    //console.log("hohoho check data dulu ya" + product + " , " + loan_amount+ + ", "+ loan_duration);
    //check using ajax
    var csrftoken = getCookie('csrftoken');

    $.ajax({
        url :  "{%url 'offers:ajax_compute_installment' %}/", // the endpoint
        type : "GET", // http method
        data : { product: product,
                 loan_amount: loan_amount,
                 loan_duration: loan_duration,
                 csrfmiddlewaretoken: csrftoken,
                }, // data sent with the get request

        // handle a successful response
        success : function(json) {
            //console.log(json); // log the returned json to the console
            if (json.result == "successful!"){
              //redirect this page
              //console.log("sukses");
              $("#id_form2-installment_amount_offer").val(''+json.reason);
              set_disable_simpan_btn(0);
            }
            else {
              //show notification that app was locked
              //console.log(json.reason);
              //$("#compute_modal_title").html("Lock Gagal");
              $("#compute_modal_body").html(""+ json.reason);
              $('#responsive-compute-modal').modal('show');
              set_disable_simpan_btn(1);
            }
            toast_success("Done", "Compute Installment Amount Success");
        },

        // handle a non-successful response
        error : function(xhr,errmsg,err) {
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            //$("#compute_modal_title").html("!! Error !!");
            $("#compute_modal_body").html("Error on getting data from server"+ err_msg);
            $('#responsive-compute-modal').modal('show');
        }
    }); // end of ajax

  } // endof function

  function autoComputeInstalment(oEvent) {
    set_disable_simpan_btn(1);
  }

  function simulate_adjusted_payment_auto(oEvent) {
    if($('#p_installment_date').val() != "" ){
      var product = $("#id_form2-product option:selected").val();
      var l_amount = $("#id_form2-loan_amount_offer").val();
      var l_duration = $("#id_form2-loan_duration_offer").val();
      var offer_id = GLOBAL_OFFER_ID;
      simulate_adjusted_payment(product, l_amount, l_duration);
    } else {
      alert("simulate_adjusted_payment_auto failed");
    }
  }
  function disableDay(){
    //var disabledDates = [{}];
    var disabledDates = [];
    var csrftoken = getCookie('csrftoken');

    $.ajax({
        url :  "{%url 'offers:ajax_get_unavailable_due_dates_by_application' %}/", // the endpoint
        type : "GET", // http method
        data : { application_id: {{app_obj.id}},
                 csrfmiddlewaretoken: csrftoken,
                }, // data sent with the get request

        // handle a successful response
        success : function(json) {
            console.log(json); // log the returned json to the console
            if (json.result == "successful!"){
              // console.log("sukses");
              for (var i in json.output){
                disabledDates.push(json.output[i]);
                //console.log(disabledDates);
                console.log(disabledDates[2]);
              }
              return disabledDates;
                //return '28-7-2017';
            }
            else {
              //failed
              console.log(json.reason);
            }
        },

        // handle a non-successful response
        error : function(xhr,errmsg,err) {
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
        }
      })
      .then(function(value) {
        disabledDates = value.output;
        // return value.output;
        jQuery('.odatepicker, #p_installment_date').datepicker({
                   datesDisabled: disabledDates,
                   startDate: value.start,
                   endDate: value.end,
                   format: 'dd-mm-yyyy',
                   buttonClasses: ['btn', 'btn-sm'],
                   applyClass: 'btn-danger',
                   cancelClass: 'btn-inverse',
                   dateLimit: {
                       days: 6
                   },
                   autoclose: true,
                   todayHighlight: true,
                   todayBtn: "linked",
        });
      });

  }

  function updateCourtesy(){
    $.ajax({
        url :  "{% url 'app_status:ajax_update_courtesy' %}/",
        type : "POST",
        data : {
              application_id : {{app_obj.id}}
        },

        // handle a successful response
        success : function(json) {
            if (json.status == "success"){
              toast_success('Call Succesfully',json.messages);
              $("#responsive-sphp-call-modals").modal('hide');
              setTimeout(function(){
                window.location.reload(true);
              }, 1500);
            } else if(json.status == "failed"){
              console.log(json);
              toast_danger('Call Failed',json.messages);
            }

        },
        // handle a non-successful response
        error : function(xhr, errmsg, err) {
            console.log(xhr.status + ": " + xhr.responseText);
        }
    });
  }

  function emailCourtesy(){
    $.ajax({
        url :  "{% url 'app_status:ajax_courtesy_email' %}/",
        type : "POST",
        data : {
              application_id : {{app_obj.id}},
              content : GLOBAL_TEMPLATE_EMAIL1,
        },

        // handle a successful response
        success : function(json) {
            if (json.status == "success"){
              toast_success('Send Email Succesfully',json.messages);
              $("#responsive-sphp-call-modals").modal('hide');
              setTimeout(function(){
                window.location.reload(true);
              }, 1500);
            } else if(json.status == "failed"){
              console.log(json);
              toast_danger('Send Email Failed',json.messages);
            }
        },
        // handle a non-successful response
        error : function(xhr, errmsg, err) {
            console.log(xhr.status + ": " + xhr.responseText);
        }
    });
  }
  function sendEmail(){
    var to_email = $('#to_email').val();
    var cc_email = $('#cc_email').val();
    var email_subject = $('#email_subject').val();
    var email_content = tinymce.get('email_content').getContent();

    if (to_email == ''){
      $("#email_error_message").text("email tujuan tidak boleh kosong")
      $("#email_error_message").css("display", "block");
      $("#email_error_div").show();
    }
    if (email_subject == ''){
      $("#email_error_message").text("subject email tidak boleh kosong")
      $("#email_error_message").css("display", "block");
      $("#email_error_div").show();
    }
    if (email_content == ''){
      $("#email_error_message").text("content email tidak boleh kosong")
      $("#email_error_message").css("display", "block");
      $("#email_error_div").show();
    }

    $.ajax({
          url :  "{% url 'app_status:ajax_custom_email' %}/",
          type : "POST",
          data : {
                application_id: {{app_obj.id}},
                content: postProccessEmailContent(email_content),
                email_sender: GLOBAL_EMAIL_SENDER,
                email_receiver: to_email,
                email_cc: cc_email,
                subject: email_subject,
          },
           // handle a successful response
          success : function(json) {
              console.log(json);
              if (json.status == "success"){
                $('#responsive-modal-email').modal('hide');
                $('#responsive-modal-success-email').modal('show');
              } else if(json.status == "failed"){
                $("#email_error_message").text(json.messages)
                $("#email_error_message").css("display", "block");
                $("#email_error_div").show();
              }
          },

          // handle a non-successful response
          error : function(xhr, errmsg, err) {
              console.log(xhr.status + ": " + xhr.responseText);
          }
    }); // end of ajax
  } // end of function send_email

  function send_email_onclick(){
    if(GLOBAL_EMAIL_STATUS){
      $('#email_error_message').hide();
      $('#email_subject').val('JULO INFO');
      $('#to_email').val('{{ app_email }}');
      $('#cc_email').val('');
      if('121' == '{{ app_obj.application_status.status_code|default:"-"|safe }}' || '132' == '{{ app_obj.application_status.status_code|default:"-"|safe }}'){
        GLOBAL_EMAIL_SENDER = 'cs131@julofinance.com';
        tinymce.activeEditor.setContent(GLOBAL_TEMPLATE_EMAIL2);
      }else if( '138' == '{{ app_obj.application_status.status_code|default:"-"|safe }}'){
        GLOBAL_EMAIL_SENDER = 'cs138@julofinance.com';
        tinymce.activeEditor.setContent(GLOBAL_TEMPLATE_EMAIL3);
      }
      GLOBAL_EMAIL_STATUS=false;
    }
  }


  var canned_responses = {{canned_responses|safe}};
  var canned_ajax_url = "{%url 'app_status:ajax_canned_email' %}/";
  var token_for_canned = "{{csrf_token}}";
  var canned_section = ["Insert", "Save", "Delete"];
  var email_app_params = {{email_app_params|safe}}

  function html_unescape(s) {
    var div = document.createElement("div");
    div.innerHTML = s;
    return div.textContent || div.innerText;
  }

  function updateApplicationBankInfo(id, application_field_name) {
    value = $("#"+id).val();
    application_field = application_field_name
    console.log({field: application_field, value: value})
    var csrftoken = getCookie('csrftoken');
    $.ajax({
        url :  "{%url 'app_status:ajax_update_application_bank' %}/",
        type : "POST",
        data : {
          application_id   : '{{app_obj.id}}',
          application_field: application_field,
          value: value
        },
        success : function(json) {
          if (json.status == "success"){
            toast_success("Success update " + application_field);
            window.location.reload(true);
          }
          else {
            toast_danger("Failed update " + application_field, json.messages);
            console.log(json);
          }
        },
        error : function(xhr,errmsg,err) {
          console.log(xhr.status + ": " + xhr.responseText);
        }
    });
  }

  function updateValidation(id, field_name, application_field_name) {
    console.log('here clicked');
    value = $("#"+id).val();
    field = field_name
    application_field = application_field_name
    console.log({field: field_name, value: value})
    var csrftoken = getCookie('csrftoken');
    $.ajax({
        url :  "{%url 'app_status:ajax_update_name_bank_validation' %}/",
        type : "POST",
        data : {
          name_bank_validation_id   : '{{name_bank_validation.id}}',
          field: field,
          application_field: application_field,
          value: value,
          application_id   : '{{app_obj.id}}'
        },
        success : function(json) {
          if (json.status == "success"){
            toast_success("Success update " + field);
            window.location.reload(true);
          }
          else {
            toast_danger("Failed update " + field, json.messages);
            console.log(json);
          }
        },
        error : function(xhr,errmsg,err) {
          console.log(xhr.status + ": " + xhr.responseText);
        }
    });
  }
  function updateDisbursement(id, field_name) {
    value = $("#"+id).val();
    field = field_name
    console.log({field: field_name, value: value})
    var csrftoken = getCookie('csrftoken');
    $.ajax({
        url :  "{%url 'app_status:ajax_change_disbursement_method' %}/",
        type : "POST",
        data : {
          disbursement_id : '{{disbursement2.id}}',
          method: value
        },
        success : function(json) {
          if (json.status == "success"){
            toast_success("Success update " + field);
            window.location.reload(true);
          }
          else {
            toast_danger("Failed update " + field);
            console.log(json);
          }
        },
        error : function(xhr,errmsg,err) {
          console.log(xhr.status + ": " + xhr.responseText);
        }
    });
  }
  function display_rupiah(value){
    var amount = value.toString()
    var remainder = amount.length % 3
    var front = amount.substr(0, remainder)
    var back = amount.substr(remainder).match(/\d{3}/gi)
    if (back) {
      var seperator = remainder ? '.' : '';
      var rupiah = ' Rp ' + front + seperator + back.join('.')
      return rupiah
    }

  }
  function updateCashback() {
  <!-- disabled buttons -->
    $("#id_update_cashback").addClass("disabled");
    $("#id_update_cashback").attr("disabled", true);
    $("#retry_redeem_cashback").attr("disabled", true);
    $("#complete_redeem_cashback").attr("disabled", true);
    $("#reject_redeem_cashback").attr("disabled", true);

    var redeem_amount = $("#id_cashback_redeem_amount").val();
    var bank_name = $("#id_cashback_bank_name").val();
    var name_in_bank = $("#id_cashback_name_in_bank").val();
    var bank_number = $("#id_cashback_bank_number").val();
    var partner_transfer = $("#id_cashback_partner_transfer").val();
    var transfer_amount = Number(redeem_amount) - 4000;

    var old_redeem_amount = "{{ cashback_transfer.redeem_amount }}";
    var old_bank_name = "{{ cashback_transfer.bank_name }}";
    var old_name_in_bank = "{{ cashback_transfer.name_in_bank }}";
    var old_bank_number = "{{ cashback_transfer.bank_number }}";

    if (redeem_amount == '') {
      toast_danger("Redeem Amout could not be Empty!!");
    } else if (bank_name == '') {
      toast_danger("Bank Name could not be Empty!!");
    } else if (name_in_bank == '') {
      toast_danger("Name in Bank could not be Empty!!");
    } else if (bank_number == '') {
      toast_danger("Bank Number could not be Empty!!");
    } else {
      if (redeem_amount !== old_redeem_amount) {
        $("#id_cashback_transfer_amount").text(display_rupiah(transfer_amount))
      }
      $.ajax({
          url :  "{%url 'app_status:ajax_update_cashback' %}/",
          type : "POST",
          data : {
            cashback_transfer_id : "{{cashback_transfer.id}}",
            redeem_amount: redeem_amount,
            transfer_amount: transfer_amount,
            bank_name: bank_name,
            name_in_bank: name_in_bank,
            bank_number: bank_number,
            partner_transfer: partner_transfer,
            old_redeem_amount: old_redeem_amount,
            old_bank_name: old_bank_name,
            old_name_in_bank: old_name_in_bank,
            old_bank_number: old_bank_number
          },
          success : function(json) {
            if (json.status == "success"){
              toast_success("Success update cashback_transfer data");
              window.location.reload(true);
            }
            else {
              toast_danger("Failed update", json.messages);
              console.log(json);
            }
          },
          error : function(xhr,errmsg,err) {
            console.log(xhr.status + ": " + xhr.responseText);
          }
      });
    }
  }
  function retryCashbackTransfer() {
    $("#retry_redeem_cashback").attr("disabled", true);
    $("#complete_redeem_cashback").attr("disabled", true);
    $("#reject_redeem_cashback").attr("disabled", true);
    var note_text = $("#cashback_note_id").val();
    $.ajax({
      url :  "{%url 'app_status:ajax_retry_cashback_transfer' %}/",
      type : "POST",
      data : {
        cashback_transfer_id : "{{cashback_transfer.id}}",
        note_text: note_text,
      },
      // handle a successful response
      success : function(json) {
          console.log(json); // log the returned json to the console
          if (json.result == "successful!"){
            toast_success("Success", json.reason);
            setTimeout(reload_btn());
          }
          else {
            //console.log(json.reason);
            $("#modal_reload_title").html("process retry cashback transfer Gagal");
            $("#modal_reload_body").html(""+ json.reason);
            $("#modal-success-reload").modal('show');
          }
      },

      // handle a non-successful response
      error : function(xhr,errmsg,err) {
          console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
          $("#modal_reload_title").html("!! Error !!");
          $("#modal_reload_body").html("Error on getting data from server");
          $('#modal-success-reload').modal('show');
      }
    });

  }
  function sendResetPinEmail() {
    swal({
        html:true,
        title: '',
        text: 'Apakah Anda yakin untuk mengirimkan reset ke email yang terdaftar?',
        imageUrl: '{% static 'theme/plugins/images/question.png' %}',
        imageWidth: 600,
        imageHeight: 600,
        showCancelButton: true,
        showConfirmButton: true,
        confirmButtonClass: "btn-primary",
        cancelButtonClass: "btn-default",

        cancelButtonText: "Tidak",
        closeOnCancel: true,
        confirmButtonText: "Ya",
        closeOnConfirm: false,
        showLoaderOnConfirm: true
    },
    function() {
        setTimeout(function () {
            var csrftoken = getCookie('csrftoken');
            $.ajax({
                url :  "{%url 'app_status:ajax_send_reset_pin_email' %}/",
                type : "POST",
                async: false,
                data : {
                      application_id : '{{app_obj.id}}',
                },
                // handle a successful response
                success : function(json) {
                    if(json.status == 'success') {
                        swal("Sukses !", "Email berhasil dikirimkan", "success");
                    } else {
                        swal("Failed !", json.message, "error");
                    }
                },
                // handle a non-successful response
                error : function(xhr,errmsg,err) {
                    swal("Failed !", "something went wrong", "error");
                    console.log(xhr.status + ": " + xhr.responseText);
                }
            });
        }, 5000);
    });
  }
  function changeEmail() {
    var new_email = $("#id_new_email").val();
    if (!expr.test($("#id_new_email").val())) {
        $('#errEmail').html("<font color='red' size='2px'>Please enter valid email.</font>");
    }
    else {
        $('#errEmail').hide();
        if(new_email != old_email) {
            var csrftoken = getCookie('csrftoken');
            $.ajax({
                url :  "{%url 'app_status:ajax_change_email' %}/",
                type : "POST",
                async: false,
                data : {
                      customer_id   : '{{app_obj.customer_id}}',
                      application_id : '{{app_obj.id}}',
                      new_email: new_email,
                      old_email: old_email,
                },
                // handle a successful response
                success : function(json) {
                    if(json.status == 'success') {
                        $('#errEmail').html('<font color="#00c292" size="2px">'+json.message+'</font>');
                    } else {
                         $('#errEmail').html('<font color="red" size="2px">'+json.message+'</font>');
                    }
                    $('#errEmail').show();
                    if(json.status == 'success') {
                        old_email = new_email;
                        $('#email_lama').text(old_email);
                    }
                },
                // handle a non-successful response
                error : function(xhr,errmsg,err) {
                    $('#errEmail').html("<font color='red' size='2px'>Something went wrong</font>");
                    $('#errEmail').show();
                    console.log(xhr.status + ": " + xhr.responseText);
                }
            });
        } else {
            $('#errEmail').html("<font color='red' size='2px'>Email lama and email baru are same.</font>");
            $('#errEmail').show();
        }
    }
  }

  // Identify Watermark Text
  var watermark_text = 'INTERNAL USE ONLY ({{ user.id }})'
{% endblock %}

{% block script_end %}
{% load static from staticfiles %}
   <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAAJJdPbXuV-t1aFlTHp1pq_6JHddC27rw&callback=initMap" async defer></script> -->
  <script type="text/javascript" charset="utf8" src="{% static 'default/js/change.status.email.js' %}"></script>
{% endblock %}
