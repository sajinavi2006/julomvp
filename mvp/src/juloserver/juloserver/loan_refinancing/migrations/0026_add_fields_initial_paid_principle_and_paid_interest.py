# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2020-05-17 15:26
from __future__ import unicode_literals

from django.db import migrations, models
from django.db.models import Sum
from juloserver.loan_refinancing.constants import CovidRefinancingConst
from juloserver.loan_refinancing.services.loan_related import get_unpaid_payments, \
    get_sum_of_principal_paid_and_late_fee_amount


def retroload_initial_paid_interest_and_paid_principal(apps, schema_editor):
    LoanRefinancingRequest = apps.get_model("loan_refinancing", "LoanRefinancingRequest")
    loan_refinancing_requests = LoanRefinancingRequest.objects.filter(
        status=CovidRefinancingConst.STATUSES.approved,
        initial_paid_principal__isnull=True,
        initial_paid_interest__isnull=True,
    )
    for loan_refinancing_request in loan_refinancing_requests:
        unpaid_payments = get_unpaid_payments(loan_refinancing_request.loan)
        total = unpaid_payments. \
            aggregate(Sum('paid_principal'),
                      Sum('paid_interest'))
        loan_refinancing_request.initial_paid_principal = total['paid_principal__sum']
        loan_refinancing_request.initial_paid_interest = total['paid_principal__sum']
        loan_refinancing_request.save(update_fields=["initial_paid_principal", "initial_paid_interest"])


class Migration(migrations.Migration):
    dependencies = [
        ('loan_refinancing', '0025_alter_loan_refinancing_request_add_url'),
    ]

    operations = [
        migrations.AddField(
            model_name='loanrefinancingrequest',
            name='initial_paid_interest',
            field=models.BigIntegerField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='loanrefinancingrequest',
            name='initial_paid_principal',
            field=models.BigIntegerField(blank=True, null=True),
        ),
        migrations.RunPython(retroload_initial_paid_interest_and_paid_principal),
    ]
