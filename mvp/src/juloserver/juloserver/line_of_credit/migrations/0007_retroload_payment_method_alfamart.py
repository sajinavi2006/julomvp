# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2018-07-23 08:04
from __future__ import unicode_literals

from django.db import migrations
from juloserver.julo.payment_methods import PaymentMethodCodes, PaymentMethodManager
from juloserver.line_of_credit.constants import LocConst


def retroload_alfamart_payment_method(apps, schema_editor):
    PaymentMethod = apps.get_model("julo", "PaymentMethod")
    VirtualAccountSuffix = apps.get_model("julo", "VirtualAccountSuffix")
    LineOfCredit = apps.get_model("line_of_credit", "LineOfCredit")

    existing_loc_list = LineOfCredit.objects.exclude(status=LocConst.STATUS_INACTIVE)
    for existing_loc in existing_loc_list:
        has_alfamart_payment_method = existing_loc.paymentmethod_set.filter(
            payment_method_code=PaymentMethodCodes.ALFAMART).last()

        if not has_alfamart_payment_method:
            va_suffix = VirtualAccountSuffix.objects.filter(line_of_credit=existing_loc).first()
            alfamart_payment_method = PaymentMethodManager.get_or_none(
                PaymentMethodCodes.ALFAMART)

            virtual_account = "".join([
                alfamart_payment_method.faspay_payment_code,
                va_suffix.virtual_account_suffix
            ])

            PaymentMethod.objects.create(
                payment_method_code=alfamart_payment_method.faspay_payment_code,
                payment_method_name=alfamart_payment_method.name,
                bank_code='',
                line_of_credit=existing_loc,
                virtual_account=virtual_account,
                is_shown=True
            )


class Migration(migrations.Migration):

    dependencies = [
        ('line_of_credit', '0006_lineofcreditnote'),
    ]

    operations = [
        migrations.RunPython(retroload_alfamart_payment_method, migrations.RunPython.noop)
    ]
