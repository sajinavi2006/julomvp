# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2016-06-24 01:19
from __future__ import unicode_literals

import logging

from django.db import migrations


logger = logging.getLogger(__name__)


def change_the_application_status_code_for_verification_call_successful(
        apps, schema_editor):

    # The status codes are hardcoded because the value in ApplicationStatusCodes
    # itself is being changed so using it would not work. Those applicants in 150
    # at the time this migration is run, they have been given an offer. This is
    # because pre migration, offer is given first before verification call. As a
    # result, the change is to 141 the state in which an offer is given. If a new
    # application reaches successful verification call the status would have been
    # 130
    old_status_code = 150
    new_status_code = 141

    Application = apps.get_model("julo", "Application")
    StatusLookup = apps.get_model("julo", "StatusLookup")
    applications = Application.objects.filter(application_status=old_status_code)

    for application in applications:
        new_status = StatusLookup.objects.get(status_code=new_status_code)
        logger.info({
            'application': application,
            'old_status': old_status_code,
            'new_status': new_status_code,
            'action': 'changing_status'
        })
        application.application_status = new_status
        application.save()


class Migration(migrations.Migration):

    dependencies = [
        ('julo', '0030_paymentevent_event_due_amount'),
    ]

    operations = [
        migrations.RunPython(
            change_the_application_status_code_for_verification_call_successful
        ),
    ]
