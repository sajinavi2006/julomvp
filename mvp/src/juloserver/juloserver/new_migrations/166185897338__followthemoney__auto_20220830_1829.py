# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2022-08-30 11:29
from __future__ import unicode_literals

from django.db import migrations
from django.db.models.aggregates import Max, Count
from juloserver.followthemoney.models import LoanAgreementTemplate

def remove_duplicate_loan_agreement(apps, _schema_editor):
    loan_agreements = LoanAgreementTemplate.objects.values('lender', 'agreement_type').annotate(
        max_id=Max('id'), row_count=Count('id')
    )
    for loan_agreement in loan_agreements:
        if loan_agreement['row_count'] > 1:
            print(loan_agreement)
            detail_loan_agreements = LoanAgreementTemplate.objects.filter(
                lender=loan_agreement['lender'], agreement_type=loan_agreement['agreement_type']
            )
            for detail_loan_agreement in detail_loan_agreements:
                print(detail_loan_agreement.is_active, detail_loan_agreement.id)
                if not detail_loan_agreement.is_active \
                        or detail_loan_agreement.id != loan_agreement['max_id']:
                    detail_loan_agreement.delete()


class Migration(migrations.Migration):

    dependencies = [
    ]

    operations = [
        migrations.RunPython(remove_duplicate_loan_agreement, migrations.RunPython.noop),
        migrations.AlterUniqueTogether(
            name='loanagreementtemplate',
            unique_together=set([('lender', 'agreement_type')]),
        ),
    ]
