# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2017-03-15 06:33
from __future__ import unicode_literals

import logging
from django.db import migrations


logger = logging.getLogger(__name__)


from juloserver.julo.models import Customer



from juloserver.julo.models import Application



def populate_data_from_application_to_customer(apps, schema_editor):
    """
    This migration procedure is to populating data email, fullname
    and phone number from application to customer table before the
    auto populate application to customer function created
    """

    
    

    customers = Customer.objects.filter(is_email_verified=True)

    for customer in customers:
        application = Application.objects.filter(customer=customer).order_by('cdate').last()

        if application:
            save_needed = False
            if customer.fullname == '' or customer.fullname is None:

                logger.info({
                    'customer': customer,
                    'application': application
                })

                customer.fullname = application.fullname
                save_needed = True

            if customer.phone == '' or customer.phone is None:

                logger.info({
                    'customer': customer,
                    'application': application
                })

                customer.phone = application.mobile_phone_1
                save_needed = True

            if save_needed:
                customer.save()

                logger.info({
                    'customer': customer,
                    'application': application,
                })


class Migration(migrations.Migration):

    dependencies = [
    ]

    operations = [
        migrations.RunPython(
            populate_data_from_application_to_customer
        ),
    ]
