# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2025-04-24 04:28
from __future__ import unicode_literals

from django.db import migrations

from juloserver.account.constants import AccountConstant
from juloserver.julo.constants import WorkflowConst
from juloserver.julo.models import (
    FeatureSetting,
    StatusLookup,
    Workflow,
    WorkflowStatusNode,
    WorkflowStatusPath,
)
from juloserver.julo.statuses import ApplicationStatusCodes
from juloserver.otp.constants import SessionTokenAction, SessionTokenType


def update_feature_setting_for_otp_action_type(apps, schema_editor):
    feature_setting, _ = FeatureSetting.objects.get_or_create(feature_name='otp_action_type')
    parameters = feature_setting.parameters or {}
    parameters.update({SessionTokenAction.CONSENT_WITHDRAWAL_REQUEST: SessionTokenType.SHORT_LIVED})
    feature_setting.save()


def add_consent_withdraw_status_lookup(apps, _schema_editor):
    if not StatusLookup.objects.filter(
        status_code=ApplicationStatusCodes.CUSTOMER_ON_CONSENT_WITHDRAWAL
    ).exists():
        StatusLookup.objects.create(
            status_code=ApplicationStatusCodes.CUSTOMER_ON_CONSENT_WITHDRAWAL,
            status="Customer On Consent Withdrawal",
        )

    if not StatusLookup.objects.filter(
        status_code=ApplicationStatusCodes.CUSTOMER_CONSENT_WITHDRAWED
    ).exists():
        StatusLookup.objects.create(
            status_code=ApplicationStatusCodes.CUSTOMER_CONSENT_WITHDRAWED,
            status="Customer Consent Withdrawed",
        )

    if not StatusLookup.objects.filter(
        status_code=AccountConstant.STATUS_CODE.consent_withdrawal_requested
    ).exists():
        StatusLookup.objects.create(
            status_code=AccountConstant.STATUS_CODE.consent_withdrawal_requested,
            status="Customer Consent Withdrawed",
        )

    if not StatusLookup.objects.filter(
        status_code=AccountConstant.STATUS_CODE.consent_withdrawal_requested
    ).exists():
        StatusLookup.objects.create(
            status_code=AccountConstant.STATUS_CODE.consent_withdrawed,
            status="Customer Consent Withdrawed",
        )


application_statuses = [
    ApplicationStatusCodes.NOT_YET_CREATED,
    ApplicationStatusCodes.FORM_CREATED,
    ApplicationStatusCodes.FORM_CREATED_PARTNER,
    ApplicationStatusCodes.FORM_PARTIAL,
    ApplicationStatusCodes.MERCHANT_HISTORICAL_TRANSACTION_INVALID,
    ApplicationStatusCodes.FORM_PARTIAL_EXPIRED,
    ApplicationStatusCodes.OFFER_REGULAR,
    ApplicationStatusCodes.JULO_STARTER_AFFORDABILITY_CHECK,
    ApplicationStatusCodes.JULO_STARTER_LIMIT_GENERATED,
    ApplicationStatusCodes.FORM_SUBMITTED,
    ApplicationStatusCodes.FORM_SUBMITTED_PARTNER,
    ApplicationStatusCodes.FORM_SUBMISSION_ABANDONED,
    ApplicationStatusCodes.APPLICATION_FLAGGED_FOR_FRAUD_SUSPICIOUS,
    ApplicationStatusCodes.DOCUMENTS_SUBMITTED,
    ApplicationStatusCodes.SCRAPED_DATA_VERIFIED,
    ApplicationStatusCodes.DOCUMENTS_VERIFIED,
    ApplicationStatusCodes.DOCUMENTS_VERIFIED_BY_THIRD_PARTY,
    ApplicationStatusCodes.PRE_REJECTION,
    ApplicationStatusCodes.CALL_ASSESSMENT,
    ApplicationStatusCodes.PENDING_PARTNER_APPROVAL,
    ApplicationStatusCodes.VERIFICATION_CALLS_SUCCESSFUL,
    ApplicationStatusCodes.VERIFICATION_CALLS_SUCCESSFUL_BY_THIRD_PARTY,
    ApplicationStatusCodes.APPLICANT_CALLS_ONGOING,
    ApplicationStatusCodes.TYPO_CALLS_UNSUCCESSFUL,
    ApplicationStatusCodes.CUSTOMER_IGNORES_CALLS,
    ApplicationStatusCodes.APPLICANT_CALLS_SUCCESSFUL,
    ApplicationStatusCodes.APPLICATION_RESUBMISSION_REQUESTED,
    ApplicationStatusCodes.APPLICATION_RESUBMITTED,
    ApplicationStatusCodes.APPLICATION_FLAGGED_FOR_FRAUD,
    ApplicationStatusCodes.APPLICATION_FLAGGED_FOR_SUPERVISOR,
    ApplicationStatusCodes.APPLICATION_DENIED,
    ApplicationStatusCodes.RESUBMISSION_REQUEST_ABANDONED,
    ApplicationStatusCodes.APPLICATION_CANCELED_BY_CUSTOMER,
    ApplicationStatusCodes.VERIFICATION_CALLS_ONGOING,
    ApplicationStatusCodes.VERIFICATION_CALLS_ONGOING_BY_THIRD_PARTY,
    ApplicationStatusCodes.VERIFICATION_CALLS_EXPIRED,
    ApplicationStatusCodes.OFFER_MADE_TO_CUSTOMER,
    ApplicationStatusCodes.OFFER_ACCEPTED_BY_CUSTOMER,
    ApplicationStatusCodes.OFFER_DECLINED_BY_CUSTOMER,
    ApplicationStatusCodes.OFFER_EXPIRED,
    ApplicationStatusCodes.NAME_BANK_VALIDATION_FAILED,
    ApplicationStatusCodes.DIGISIGN_FAILED,
    ApplicationStatusCodes.DIGISIGN_FACE_FAILED,
    ApplicationStatusCodes.FORM_GENERATED,
    ApplicationStatusCodes.ACTIVATION_CALL_SUCCESS_AND_BANK_VALIDATE_ONGOING,
    ApplicationStatusCodes.ACTIVATION_AUTODEBET,
    ApplicationStatusCodes.ACTIVATION_CALL_SUCCESSFUL,
    ApplicationStatusCodes.ACTIVATION_CALL_FAILED,
    ApplicationStatusCodes.LEGAL_AGREEMENT_RESUBMISSION_REQUESTED,
    ApplicationStatusCodes.LEGAL_AGREEMENT_SUBMITTED,
    ApplicationStatusCodes.NAME_VALIDATE_ONGOING,
    ApplicationStatusCodes.LENDER_APPROVAL,
    ApplicationStatusCodes.LEGAL_AGREEMENT_SIGNED,
    ApplicationStatusCodes.LEGAL_AGREEMENT_EXPIRED,
    ApplicationStatusCodes.LEGAL_AGREEMENT_SIGNED_AND_DP_PENDING,
    ApplicationStatusCodes.DOWN_PAYMENT_PAID,
    ApplicationStatusCodes.DOWN_PAYMENT_EXPIRED,
    ApplicationStatusCodes.NAME_VALIDATE_FAILED,
    ApplicationStatusCodes.KYC_IN_PROGRESS,
    ApplicationStatusCodes.FUND_DISBURSAL_ONGOING,
    ApplicationStatusCodes.BULK_DISBURSAL_ONGOING,
    ApplicationStatusCodes.FUND_DISBURSAL_SUCCESSFUL,
    ApplicationStatusCodes.FUND_DISBURSAL_FAILED,
    ApplicationStatusCodes.PARTNER_APPROVED,
    ApplicationStatusCodes.LOC_APPROVED,
    ApplicationStatusCodes.JULO_STARTER_TURBO_UPGRADE,
    ApplicationStatusCodes.JULO_STARTER_UPGRADE_ACCEPTED,
    ApplicationStatusCodes.FACE_RECOGNITION_AFTER_RESUBMIT,
]

supported_workflows = [
    {
        "workflow": WorkflowConst.JULO_ONE,
        "handlers": ["JuloOne183Handler", "JuloOne184Handler"],
    },
    {
        "workflow": WorkflowConst.JULO_STARTER,
        "handlers": ["JuloStarter183Handler", "JuloStarter184Handler"],
    },
]


def add_workflow_nodes(apps, _schema_editor):
    nodes = []

    for supported_workflow in supported_workflows:
        workflow = Workflow.objects.filter(name=supported_workflow["workflow"]).first()
        for handler in supported_workflow['handlers']:
            nodes.append(
                WorkflowStatusNode(
                    status_node=ApplicationStatusCodes.CUSTOMER_CONSENT_WITHDRAWED,
                    workflow=workflow,
                    handler=handler,
                )
            )

    if nodes:
        WorkflowStatusNode.objects.bulk_create(nodes)


def add_workflow_status_paths(apps, _schema_editor):
    workflow_status_paths = []

    # populate workflow from all statuses to status x183
    for supported_workflow in supported_workflows:
        workflow = Workflow.objects.filter(name=supported_workflow["workflow"]).first()
        for status in application_statuses:
            workflow_status_paths.append(
                WorkflowStatusPath(
                    status_previous=status,
                    status_next=ApplicationStatusCodes.CUSTOMER_ON_CONSENT_WITHDRAWAL,
                    type=WorkflowStatusPath.TYPE_CHOICES[0][0],
                    workflow=workflow,
                    customer_accessible=True,
                    agent_accessible=False,
                )
            )

    # populate workflow from status x183 to all statuses
    for supported_workflow in supported_workflows:
        workflow = Workflow.objects.filter(name=supported_workflow["workflow"]).first()
        for status in application_statuses:
            workflow_status_paths.append(
                WorkflowStatusPath(
                    status_previous=ApplicationStatusCodes.CUSTOMER_ON_CONSENT_WITHDRAWAL,
                    status_next=status,
                    type=WorkflowStatusPath.TYPE_CHOICES[0][0],
                    workflow=workflow,
                    customer_accessible=True,
                    agent_accessible=True,
                )
            )

    # populate workflow from x183 to x184
    for supported_workflow in supported_workflows:
        workflow = Workflow.objects.filter(name=supported_workflow["workflow"]).first()
        workflow_status_paths.append(
            WorkflowStatusPath(
                status_previous=ApplicationStatusCodes.CUSTOMER_ON_CONSENT_WITHDRAWAL,
                status_next=ApplicationStatusCodes.CUSTOMER_CONSENT_WITHDRAWED,
                type=WorkflowStatusPath.TYPE_CHOICES[0][0],
                workflow=workflow,
                customer_accessible=True,
                agent_accessible=True,
            )
        )

    WorkflowStatusPath.objects.bulk_create(workflow_status_paths)


class Migration(migrations.Migration):

    dependencies = []

    operations = [
        migrations.RunPython(update_feature_setting_for_otp_action_type, migrations.RunPython.noop),
        migrations.RunPython(add_consent_withdraw_status_lookup, migrations.RunPython.noop),
        migrations.RunPython(add_workflow_nodes, migrations.RunPython.noop),
        migrations.RunPython(add_workflow_status_paths, migrations.RunPython.noop),
    ]
