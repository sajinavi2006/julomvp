# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2022-11-30 04:03
from __future__ import unicode_literals

from django.db import migrations
from django.contrib.auth.models import Group, User

from juloserver.account.models import AccountLookup
from juloserver.application_flow.constants import PartnerNameConstant
from juloserver.dana.constants import DANA_BANK_NAME
from juloserver.disbursement.constants import NameBankValidationStatus
from juloserver.disbursement.models import NameBankValidation
from juloserver.julo.models import (
    Workflow, WorkflowStatusPath, WorkflowStatusNode,
    Partner, ProductLine, ProductProfile, ProductLookup
)
from juloserver.julo.constants import WorkflowConst
from juloserver.julo.product_lines import ProductLineCodes
from juloserver.portal.object.product_profile.services import generate_product_lookup


def add_dana_data_requirements(apps, _schema_editor):
    group = Group.objects.get(name="julo_partners")

    user = User.objects.create(
        username=PartnerNameConstant.DANA,
        email='DANA@dana.co.id',
    )

    user.groups.add(group)

    partner = Partner.objects.create(
        user=user,
        poc_email='DANA@dana.co.id',
        poc_phone='DANA Paylater',
        name=PartnerNameConstant.DANA,
        email='DANA@dana.co.id',
        phone='',
        type='referrer',
        company_name='',
        company_address='',
        business_type='',
        is_active=True
    )

    # Create Workflow
    workflow = Workflow.objects.create(
        name=WorkflowConst.DANA,
        desc="this is a workflow for Dana",
        is_active=True,
        handler="DanaWorkflowHandler"
    )

    # Create Workflow Status Path
    WorkflowStatusPath.objects.get_or_create(
        status_previous=105,
        status_next=135,
        type='graveyard',
        workflow=workflow
    )

    WorkflowStatusPath.objects.get_or_create(
        status_previous=105,
        status_next=133,
        type='graveyard',
        workflow=workflow
    )

    WorkflowStatusPath.objects.get_or_create(
        status_previous=105,
        status_next=130,
        type='happy',
        workflow=workflow
    )

    WorkflowStatusPath.objects.get_or_create(
        status_previous=130,
        status_next=190,
        type='happy',
        workflow=workflow
    )

    # Create Workflow Status node
    WorkflowStatusNode.objects.get_or_create(
        status_node=105,
        handler='Dana105Handler',
        workflow=workflow
    )

    WorkflowStatusNode.objects.get_or_create(
        status_node=133,
        handler='Dana133Handler',
        workflow=workflow
    )

    WorkflowStatusNode.objects.get_or_create(
        status_node=135,
        handler='Dana135Handler',
        workflow=workflow
    )

    WorkflowStatusNode.objects.get_or_create(
        status_node=130,
        handler='Dana130Handler',
        workflow=workflow
    )

    WorkflowStatusNode.objects.get_or_create(
        status_node=190,
        handler='Dana190Handler',
        workflow=workflow
    )

    product_profile = ProductProfile.objects.create(
        name="DANA",
        min_amount=50_000,
        max_amount=30_000_000,
        min_duration=1,
        max_duration=2,
        min_interest_rate=0.48,
        max_interest_rate=0.48,
        interest_rate_increment=0,
        payment_frequency="Weekly",
        min_origination_fee=0,
        max_origination_fee=0,
        origination_fee_increment=0,
        late_fee=0.06,
        cashback_initial=0,
        cashback_payment=0,
        is_active=True,
        debt_income_ratio=0,
        is_product_exclusive=True,
        is_initial=True,
        code=ProductLineCodes.DANA
    )

    product_line = ProductLine.objects.create(
        product_line_code=ProductLineCodes.DANA,
        product_line_type='DANA',
        min_amount=1_000,
        max_amount=30_000_000,
        min_duration=1,
        max_duration=2,
        min_interest_rate=0.04,
        max_interest_rate=0.04,
        payment_frequency='Weekly',
        product_profile=product_profile
    )

    # product lookup
    product_lookup_list = generate_product_lookup(product_profile, product_line)
    for product_lookup_data in product_lookup_list:
        product_lookup = ProductLookup(**product_lookup_data)
        product_lookup.save()

    AccountLookup.objects.get_or_create(
        name="DANA",
        workflow=workflow,
        payment_frequency='weekly, bi-weekly',
        partner=partner,
        moengage_mapping_number=1
    )

    # Create DANA Retroload: First retroload will be dummy data
    # But in the next can change by script
    NameBankValidation.objects.create(
        bank_code='BCA',
        account_number='9999999999999',
        name_in_bank=DANA_BANK_NAME,
        mobile_phone='087790909090',
        method='xfers',
        validation_status=NameBankValidationStatus.SUCCESS
    )


class Migration(migrations.Migration):

    dependencies = [
    ]

    operations = [
        migrations.RunPython(add_dana_data_requirements, migrations.RunPython.noop),
    ]
