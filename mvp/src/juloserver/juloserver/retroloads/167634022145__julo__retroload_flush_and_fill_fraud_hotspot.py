# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2023-02-01 03:41
from __future__ import unicode_literals

import csv
import datetime
import os

from django.db import (
    migrations,
    transaction,
)

from juloserver.julo.models import FraudHotspot
from juloserver.settings.base import BASE_DIR


def flush_and_fill_fraud_hotspot(app, schema_editor):
    csv_file_name = os.path.join(BASE_DIR, 'csv/All Fraud Hotspot.csv')
    with open(csv_file_name, 'r') as fraud_hotspot_csv, transaction.atomic():
        FraudHotspot.objects.all().delete()

        csv_reader = csv.DictReader(fraud_hotspot_csv)
        csv_data = list(csv_reader)
        dataset = [
            FraudHotspot(
                latitude=row['latitude'],
                longitude=row['longitude'],
                radius=row['radius'],
                geohash=row['geohash'],
                addition_date=datetime.datetime.strptime(row['addition_date'], '%d/%m/%Y').date() if row['addition_date'] != '' else datetime.datetime.today().date()
            )
            for row in csv_data
        ]

        FraudHotspot.objects.bulk_create(dataset)


class Migration(migrations.Migration):

    dependencies = [
    ]

    operations = [
        migrations.RunPython(flush_and_fill_fraud_hotspot)
    ]
