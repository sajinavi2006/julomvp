# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2019-09-05 10:42
from __future__ import unicode_literals

from django.db import migrations
from juloserver.julo.product_lines import ProductLineCodes
from juloserver.julo.statuses import LoanStatusCodes


from juloserver.julo.models import Loan



from juloserver.julo.models import PaymentMethod



def retro_gopay_payment_method(apps, schema_editor):
    
    

    loan_data = Loan.objects.filter(loan_status__gte=LoanStatusCodes.CURRENT,
                                    loan_status__lt=LoanStatusCodes.PAID_OFF,
                                    application__partner__isnull=True,
                                    application__product_line_id__in=ProductLineCodes.lended_by_jtp()) \
                            .values_list('pk', 'customer_id')
    for loan_id, customer_id in loan_data:
        check_existed = PaymentMethod.objects.filter(payment_method_code='1002',
                                                     payment_method_name='Gopay',
                                                     loan_id=loan_id).exists()
        if not check_existed:
            PaymentMethod.objects.create(
                payment_method_code='1002',
                payment_method_name='Gopay',
                customer_id=customer_id,
                is_shown=True,
                is_primary=False,
                loan_id=loan_id,
                virtual_account='')


class Migration(migrations.Migration):

    dependencies = [
    ]

    operations = [
        migrations.RunPython(retro_gopay_payment_method, migrations.RunPython.noop),
    ]
