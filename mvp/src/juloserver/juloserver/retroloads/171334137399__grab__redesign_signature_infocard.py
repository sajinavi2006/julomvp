# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2024-04-17 15:09
from __future__ import unicode_literals

from django.db import migrations
from juloserver.julo.statuses import (
    ApplicationStatusCodes,
    LoanStatusCodes
)
from juloserver.streamlined_communication.constant import (
    CardProperty,
    CommunicationPlatform
)
from juloserver.streamlined_communication.models import (
    StreamlinedCommunication,
    StreamlinedMessage,
    InfoCardButtonProperty
)


def get_existing_infocard():
    # revert content
    # message_content = "Lanjutkan tanda tangan digital sekarang sebelum pengajuanmu kadaluarsa."
    # title = "Lanjutkan Transaksi Anda"
    # button = "Tanda tangan SPHP"
    stream_lined_communication = StreamlinedCommunication.objects.filter(
        communication_platform=CommunicationPlatform.INFO_CARD,
        status_code_id=LoanStatusCodes.INACTIVE,
        extra_conditions=CardProperty.GRAB_INFO_CARD_AUTH_SUCCESS,
        is_active=True
    ).first()
    return stream_lined_communication


def update_infocard(stream_lined_communication):
    stream_lined_message = stream_lined_communication.message
    stream_lined_message.message_content = """Pengajuan Pinjamanmu kadaluarsa dalam <b>{expired_day} hari</b>. <b>Tanda Tangan SKRTP</b> untuk melanjutkan, ya!"""
    stream_lined_message.save()

    info_card_property = stream_lined_message.info_card_property
    info_card_property.title = "Yuk, Lanjutkan Transaksi Kamu"
    info_card_property.save()

    info_card_button_property = InfoCardButtonProperty.objects.get(
        info_card_property=info_card_property
    )
    info_card_button_property.text = "Tanda Tangan SKRTP"
    info_card_button_property.save()


def redesign_infocard(apps, _schema_editor):
    stream_lined_communication = get_existing_infocard()
    if stream_lined_communication:
        update_infocard(stream_lined_communication)


class Migration(migrations.Migration):

    dependencies = [
    ]

    operations = [
        migrations.RunPython(redesign_infocard, migrations.RunPython.noop),
    ]
