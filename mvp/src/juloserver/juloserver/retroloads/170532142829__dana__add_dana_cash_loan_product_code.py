# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2024-01-15 12:23
from __future__ import unicode_literals

from django.db import migrations
from juloserver.account.models import AccountLookup
from juloserver.application_flow.constants import PartnerNameConstant
from juloserver.julo.constants import WorkflowConst
from juloserver.julo.models import (
    Partner,
    ProductProfile,
    ProductLine,
    ProductLookup,
    Workflow,
)
from juloserver.julo.product_lines import ProductLineCodes
from juloserver.portal.object.product_profile.services import generate_product_lookup


def add_dana_cash_loan_product_code(apps, _schema_editor):
    partner = Partner.objects.filter(
        name=PartnerNameConstant.DANA
    ).last()
    if partner:
        dana_cash_loan = "DANA CASH LOAN"
        product_profile = ProductProfile.objects.create(
            name=dana_cash_loan,
            min_amount=500_000,
            max_amount=2_000_000,
            min_duration=30,
            max_duration=180,
            min_interest_rate=0.0489,
            max_interest_rate=0.0489,
            interest_rate_increment=0,
            payment_frequency="Monthly",
            min_origination_fee=0,
            max_origination_fee=0,
            origination_fee_increment=0,
            late_fee=0.003,
            cashback_initial=0,
            cashback_payment=0,
            is_active=True,
            debt_income_ratio=0,
            is_product_exclusive=True,
            is_initial=True,
            code=ProductLineCodes.DANA_CASH_LOAN
        )

        product_line = ProductLine.objects.create(
            product_line_code=ProductLineCodes.DANA_CASH_LOAN,
            product_line_type=dana_cash_loan,
            min_amount=500_000,
            max_amount=2_000_000,
            min_duration=30,
            max_duration=180,
            min_interest_rate=0.0489,
            max_interest_rate=0.0489,
            payment_frequency='Monthly',
            product_profile=product_profile
        )

        product_lookup_list = generate_product_lookup(product_profile, product_line)
        for product_lookup_data in product_lookup_list:
            if product_lookup_data.get('interest_rate'):
                product_lookup_data['interest_rate'] = 0.5868

            product_lookup = ProductLookup(**product_lookup_data)
            product_lookup.save()

        workflow = Workflow.objects.filter(
            name=WorkflowConst.DANA
        ).last()

        if workflow:
            AccountLookup.objects.update_or_create(
                workflow=workflow,
                defaults={
                    'payment_frequency': 'weekly, bi-weekly, monthly',
                }
            )

class Migration(migrations.Migration):

    dependencies = [
    ]

    operations = [
        migrations.RunPython(add_dana_cash_loan_product_code, migrations.RunPython.noop),
    ]
