# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2021-01-01 05:37
from __future__ import unicode_literals
from __future__ import print_function

from django.db import migrations
from django.db import transaction
from juloserver.utilities.models import SlackEWABucket


def add_j1_slack_ewa_bucket(apps, schema_editor):
    data_150 = {
        'status_code_id': 150,
        'order_priority': 0,
        'display_text': 'x150 - Digital Signature Registration'
    }
    buckets = SlackEWABucket.objects.all()
    buckets = list(sorted(buckets, key=lambda bucket: bucket.order_priority))
    if not buckets:
        print('no bucket found!')
        return
    start_index = 0
    is_start_founded = False
    for index, value in enumerate(buckets):
        if value.status_code_id == 141:
            is_start_founded = True
            start_index = index+1
            data_150['order_priority'] = value.order_priority + 1
    if not is_start_founded:
        print('141 status bucket not found!')
        return
    with transaction.atomic():
        # create for 150 status
        SlackEWABucket.objects.create(**data_150)
        # increase all remains buck order by one
        for bucket in buckets[start_index::]:
            bucket.update_safely(order_priority=bucket.order_priority+1)


class Migration(migrations.Migration):

    dependencies = [
    ]

    operations = [
        migrations.RunPython(add_j1_slack_ewa_bucket, migrations.RunPython.noop)
    ]
