# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2023-06-23 11:28
from __future__ import unicode_literals

from django.db import migrations

from juloserver.streamlined_communication.constant import CommunicationPlatform
from juloserver.streamlined_communication.models import StreamlinedCommunication


def update_j1_to_jturbo(streamlined_comm):
    if 'j1' not in streamlined_comm.template_code:
        return

    message = streamlined_comm.message
    message.id = None
    message.save()

    streamlined_comm.id = None
    streamlined_comm.message_id = message.id
    streamlined_comm.product = 'jturbo'
    streamlined_comm.template_code = streamlined_comm.template_code.replace('j1', 'jturbo')
    streamlined_comm.save()


def update_j1_email_to_jturbo_for_dpd_4_minus_4_and_minus_2(*args):
    streamlined_comms = StreamlinedCommunication.objects.filter(
        communication_platform=CommunicationPlatform.EMAIL,
        is_automated=True,
        time_sent__isnull=False,
        ptp__isnull=True,
        product='j1',
        dpd__in=[4, -4, -2]
    ).select_related('message')
    for streamlined_comm in streamlined_comms:
        update_j1_to_jturbo(streamlined_comm)


def update_j1_email_to_jturbo_for_ptp_minus_2_and_real_time(*args):
    streamlined_comms = StreamlinedCommunication.objects.filter(
        communication_platform=CommunicationPlatform.EMAIL,
        time_sent__isnull=False,
        is_automated=True,
        extra_conditions__isnull=True,
        dpd__isnull=True,
        ptp__isnull=False,
        product='j1',
        ptp__in=['real-time', '-2']
    ).select_related('message')
    for streamlined_comm in streamlined_comms:
        update_j1_to_jturbo(streamlined_comm)


class Migration(migrations.Migration):

    dependencies = [
    ]

    operations = [
        migrations.RunPython(update_j1_email_to_jturbo_for_dpd_4_minus_4_and_minus_2, migrations.RunPython.noop),
        migrations.RunPython(update_j1_email_to_jturbo_for_ptp_minus_2_and_real_time, migrations.RunPython.noop)
    ]
