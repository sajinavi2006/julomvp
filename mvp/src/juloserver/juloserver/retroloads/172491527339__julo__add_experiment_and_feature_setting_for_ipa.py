# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2024-08-29 07:07
from __future__ import unicode_literals

from django.db import migrations
from django.utils import timezone
from dateutil.relativedelta import relativedelta
from juloserver.julo.models import ExperimentSetting, FeatureSetting
from juloserver.julo.constants import ExperimentConst, FeatureNameConst


def run_experiment(apps, _schema_editor):
    if not ExperimentSetting.objects.filter(
        code=ExperimentConst.FDC_IPA_BANNER_EXPERIMENT_V2
    ).exists():
        ExperimentSetting.objects.create(
            code=ExperimentConst.FDC_IPA_BANNER_EXPERIMENT_V2,
            name='IPA Banner Experiment V2',
            type='IPA Banner',
            # placeholder criteria, changerun_experiment as needed
            criteria={"customer_id": [0, 1, 2, 3, 4, 5, 6, 7], "target_version": ">=8.9.0"},
            is_active=True,
            is_permanent=True,
            start_date=timezone.now(),
            end_date=timezone.now() + relativedelta(year=1),
        )


def run_feature_setting(apps, _schema_editor):
    parameters = {
        "experiment": {
            "high_fdc": {
                "title": "Asik, Kamu Bisa Dapat Limit Rp3 Juta!ðŸŽ‰",
                "message": "Kamu bisa banget dapat limit lebih besar, lho. Yuk, lengkapi data diri kamu sekarang!",
                "link_image": "/info-card/IPA_BANNER_V2_GOOD_FDC.png",
            },
            "medium_fdc": {
                "title": "Asik, Sedikit Lagi Kamu Dapat Limit!",
                "message": "Raih kesempatanmu untuk dapat limit! Lengkapi dulu data diri kamu di bawah ini, ya.",
                "link_image": "/info-card/IPA_BANNER_V2_MEDIUM_FDC.png",
            },
        },
        "control": {
            "high_fdc": {
                "title": "Asik, Kamu Bisa Dapat Limit Rp3 Juta!ðŸŽ‰",
                "message": "Kamu bisa banget dapat limit lebih besar, lho. Yuk, lengkapi data diri kamu sekarang!",
                "link_image": "/info-card/IPA_BANNER_V2_GOOD_FDC.png",
            },
            "medium_fdc": {
                "title": "Asik, Sedikit Lagi Kamu Dapat Limit!",
                "message": "Raih kesempatanmu untuk dapat limit! Lengkapi dulu data diri kamu di bawah ini, ya.",
                "link_image": "/info-card/IPA_BANNER_V2_MEDIUM_FDC.png",
            },
        },
    }

    feature_name = FeatureNameConst.IPA_BANNER_V2
    feature_setting_data = {
        'is_active': True,
        'parameters': parameters,
        'category': 'ipa banner',
        'description': 'IPA Banner V2 text and image',
    }

    if FeatureSetting.objects.filter(feature_name=feature_name).exists():
        FeatureSetting.objects.filter(feature_name=feature_name).last().update_safely(
            **feature_setting_data
        )
    else:
        FeatureSetting.objects.create(feature_name=feature_name, **feature_setting_data)


class Migration(migrations.Migration):

    dependencies = []

    operations = [
        migrations.RunPython(run_experiment, migrations.RunPython.noop),
        migrations.RunPython(run_feature_setting, migrations.RunPython.noop),
    ]
