# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2023-03-29 23:23
from __future__ import unicode_literals

from django.conf import settings
from django.contrib.auth.models import User
from django.db import migrations

from juloserver.customer_module.services.digital_signature import DigitalSignature, \
    CertificateAuthority


def generate_certificate_for_adri(apps, schema_editor):
    adri = User.objects.filter(email='adri@julo.co.id').last()
    if not adri:
        return
    signer = DigitalSignature.Signer(
        user=adri,
        key_name=f"key-{adri.id}-1",
        for_organization=True,
        organization="PT. JULO Teknologi Finansial",
        full_name="Adrianus Hitijahubessy",
        email=adri.email,
        province="DKI Jakarta",
        city="Jakarta Selatan",
        address="Eightyeight @ Kasablanka Office Tower, Lantai 10, Unit E. Jl. Casablanca Raya, Kav. 88, Menteng Dalam, Tebet",
    )
    if not signer.key_exists():
        signer.generate_key_pairs()
    if signer.signer.has_certificate():
        return
    signer.signer.generate_csr()
    CertificateAuthority(
        private_key=settings.JULO_CERTIFICATE_AUTHORITY["PRIVATE_KEY"],
        passphrase=settings.JULO_CERTIFICATE_AUTHORITY["PASSPHRASE"],
        certificate=settings.JULO_CERTIFICATE_AUTHORITY["CERTIFICATE"],
    ).make_certificate(signer.signer)

class Migration(migrations.Migration):

    dependencies = [
    ]

    operations = [
        migrations.RunPython(generate_certificate_for_adri, migrations.RunPython.noop),
    ]
