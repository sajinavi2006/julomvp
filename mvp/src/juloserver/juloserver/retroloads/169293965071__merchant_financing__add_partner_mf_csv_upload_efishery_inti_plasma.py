# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2023-08-25 05:00
from __future__ import unicode_literals

from django.contrib.auth.models import Group, User
from django.db import migrations

from juloserver.julo.models import (
    Customer,
    ProductProfile,
    ProductLine,
    ProductLookup,
    ProductLineLoanPurpose,
    Partner,
)

from juloserver.julo.product_lines import ProductLineCodes
from juloserver.portal.object.bulk_upload.constants import (
    MerchantFinancingCSVUploadPartner,
    MerchantFinancingCSVUploadPartnerDueDateType,
)

from django.conf import settings

class EfisheryIntiPlasmaConst:
    PAYMENT_FREQUENCY = 'Monthly'

def add_product_line_efishery_inti_plasma(apps, schema_editor):
    efishery_inti_plasma_product_profile = ProductProfile.objects.filter(code=ProductLineCodes.EFISHERY_INTI_PLASMA).last()
    efishery_inti_plasma_product_line = ProductLine.objects.filter(product_line_code=ProductLineCodes.EFISHERY_INTI_PLASMA).last()

    if efishery_inti_plasma_product_profile:
        efishery_inti_plasma_product_profile.update_safely(
            name=MerchantFinancingCSVUploadPartner.EFISHERY_INTI_PLASMA,
            code=ProductLineCodes.EFISHERY_INTI_PLASMA,
            min_amount=1000000,
            max_amount=2000000000,
            min_duration=1,
            max_duration=3,
            min_interest_rate=0.03,
            max_interest_rate=0.05,
            interest_rate_increment=0,
            payment_frequency=EfisheryIntiPlasmaConst.PAYMENT_FREQUENCY,
            min_origination_fee=0,
            max_origination_fee=0,
            late_fee=0.05,
            cashback_initial=0,
            cashback_payment=0,
            debt_income_ratio=0.3,
            origination_fee_increment=0,
            is_active=True,
            is_initial=False,
            is_product_exclusive=False,
        )
    else:
        efishery_inti_plasma_product_profile, _ = ProductProfile.objects.get_or_create(
            name=MerchantFinancingCSVUploadPartner.EFISHERY_INTI_PLASMA,
            code=ProductLineCodes.EFISHERY_INTI_PLASMA,
            min_amount=1000000,
            max_amount=2000000000,
            min_duration=1,
            max_duration=3,
            min_interest_rate=0.03,
            max_interest_rate=0.05,
            interest_rate_increment=0,
            payment_frequency=EfisheryIntiPlasmaConst.PAYMENT_FREQUENCY,
            min_origination_fee=0,
            max_origination_fee=0,
            late_fee=0.05,
            cashback_initial=0,
            cashback_payment=0,
            debt_income_ratio=0.3,
            origination_fee_increment=0,
            is_active=True,
            is_initial=False,
            is_product_exclusive=False,
        )

    if efishery_inti_plasma_product_line:
        efishery_inti_plasma_product_line.update_safely(
            product_line_code=ProductLineCodes.EFISHERY_INTI_PLASMA,
            product_line_type=MerchantFinancingCSVUploadPartner.EFISHERY_INTI_PLASMA,
            min_amount=200000000,
            max_amount=2000000000,
            min_duration=30,
            max_duration=180,
            min_interest_rate=0.011,
            max_interest_rate=0.011,
            payment_frequency=EfisheryIntiPlasmaConst.PAYMENT_FREQUENCY,
            product_profile=efishery_inti_plasma_product_profile
        )
    else:
        efishery_inti_plasma_product_line, _ = ProductLine.objects.get_or_create(
            product_line_code=ProductLineCodes.EFISHERY_INTI_PLASMA,
            product_line_type=MerchantFinancingCSVUploadPartner.EFISHERY_INTI_PLASMA,
            min_amount=200000000,
            max_amount=2000000000,
            min_duration=30,
            max_duration=180,
            min_interest_rate=0.011,
            max_interest_rate=0.011,
            payment_frequency=EfisheryIntiPlasmaConst.PAYMENT_FREQUENCY,
            product_profile=efishery_inti_plasma_product_profile
        )

    product_lookup = ProductLookup.objects.filter(
        product_line=efishery_inti_plasma_product_line,
        product_profile=efishery_inti_plasma_product_profile
    ).last()

    if product_lookup:
        product_lookup.update_safely(
            product_name="I.0025-O.0000-L.050-C1.000-C2.000-M",
            interest_rate=0.132,
            origination_fee_pct=0.015,
            late_fee_pct=0.05,
            cashback_initial_pct=0,
            cashback_payment_pct=0
        )
    else:
        ProductLookup.objects.get_or_create(
            product_line=efishery_inti_plasma_product_line,
            product_profile=efishery_inti_plasma_product_profile,
            product_name="I.0025-O.0000-L.050-C1.000-C2.000-M",
            interest_rate=0.132,
            origination_fee_pct=0.015,
            late_fee_pct=0.05,
            cashback_initial_pct=0,
            cashback_payment_pct=0
        )

    efishery_inti_plasma_product_line_loan_purpose = ProductLineLoanPurpose.objects.filter(
        product_line=efishery_inti_plasma_product_line
    ).last()
    if efishery_inti_plasma_product_line_loan_purpose:
        efishery_inti_plasma_product_line_loan_purpose.loan_purpose_id = 1
        efishery_inti_plasma_product_line_loan_purpose.save()
    else:
        ProductLineLoanPurpose.objects.get_or_create(
            product_line=efishery_inti_plasma_product_line,
            loan_purpose_id=1
        )


def create_partner_fishery_inti_plasma(apps, schema_editor):
    group = Group.objects.get(name="julo_partners")

    user = User.objects.create(
        username=MerchantFinancingCSVUploadPartner.EFISHERY_INTI_PLASMA,
        email='lutfie.rismawan1@efishery.com',
    )
    user.groups.add(group)

    if settings.ENVIRONMENT == 'prod':
        app_190_email_recipients = 'kabayan@efishery.com'
        disburse_email_recipients = "egi.septiar@efishery.com,james.salim@julofinance.com,ridwan.hilmy@efishery.com,emilia.mariss@efishery.com,galih.aulia@efishery.com"
    else:
        app_190_email_recipients = 'fujiatma.napitupulu@julofinance.com,rafika.solicha@julofinance.com'
        disburse_email_recipients = 'fujiatma.napitupulu@julofinance.com,rafika.solicha@julofinance.com'

    efishery_inti_plasma_product_line = ProductLine.objects.filter(
        product_line_code=ProductLineCodes.EFISHERY_INTI_PLASMA
    ).last()

    partner = Partner.objects.create(
        user=user,
        poc_email='lutfie.rismawan@efishery.com',
        poc_phone='',
        poc_name=MerchantFinancingCSVUploadPartner.EFISHERY_INTI_PLASMA,
        name=MerchantFinancingCSVUploadPartner.EFISHERY_INTI_PLASMA,
        email='lutfie.rismawan@efishery.com',
        company_name=MerchantFinancingCSVUploadPartner.EFISHERY_INTI_PLASMA,
        is_active=True,
        is_csv_upload_applicable=True,
        partner_bank_account_number='2021313108',
        partner_bank_account_name='MULTIDAYA TEKNOLOGI NUSANTAR',
        partner_bank_name='BANK NEGARA INDONESIA (PERSERO), Tbk (BNI)',
        is_disbursement_to_partner_bank_account=True,
        recipients_email_address_for_190_application=app_190_email_recipients,
        recipients_email_address_for_bulk_disbursement=disburse_email_recipients,
        sender_email_address_for_190_application='ops.efishery@julo.co.id',
        sender_email_address_for_bulk_disbursement='ops.efishery@julo.co.id',
        due_date_type=MerchantFinancingCSVUploadPartnerDueDateType.END_OF_TENOR,
        product_line=efishery_inti_plasma_product_line,
    )

    Customer.objects.create(user=user, email='lutfie.rismawan.efishery.intiplasma@efishery.com', phone=partner.phone)

    efishery_inti_plasma_product_line = ProductLine.objects.filter(product_line_code=ProductLineCodes.EFISHERY_INTI_PLASMA).last()


class Migration(migrations.Migration):

    operations = [
        migrations.RunPython(add_product_line_efishery_inti_plasma, migrations.RunPython.noop),
        migrations.RunPython(create_partner_fishery_inti_plasma, migrations.RunPython.noop),
    ]
