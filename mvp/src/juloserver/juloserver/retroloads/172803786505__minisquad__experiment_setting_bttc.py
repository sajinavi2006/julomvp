# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2024-10-04 10:31
from __future__ import unicode_literals

from django.db import migrations
from django.utils import timezone
from dateutil.relativedelta import relativedelta
from juloserver.julo.models import ExperimentSetting
from juloserver.minisquad.constants import (
    ExperimentConst,
    BTTCExperiment,
)


def run_bttc_experiment_creation(apps, schema_editor):
    now = timezone.localtime(timezone.now())
    parameters = dict(
        is_active=False,
        code=ExperimentConst.BTTC_EXPERIMENT,
        name="BTTC Experiment",
        start_date=now,
        end_date=now + relativedelta(days=15),
        schedule="",
        action="",
        type="collection",
        criteria={
            'range_experiments': ['a', 'b', 'c', 'd'],
            'bttc_time_to_call': BTTCExperiment.SENDING_TIME,
            'bttc_bucket_numbers': [-5, -3, -1, 0],
            'next_range_map': {'A': 'B', 'B': 'C', 'C': 'D'},
        },
    )
    if not ExperimentSetting.objects.filter(
        code=ExperimentConst.BTTC_EXPERIMENT,
    ).exists():
        ExperimentSetting.objects.create(**parameters)
    else:
        ExperimentSetting.objects.filter(
            code=ExperimentConst.BTTC_EXPERIMENT,
        ).last().update_safely(**parameters)


class Migration(migrations.Migration):

    dependencies = []

    operations = [migrations.RunPython(run_bttc_experiment_creation, migrations.RunPython.noop)]
